<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù…ÙŠØ¹Ø§Ø¯</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="dark light">
<style>
  .field{ margin:8px 0 }
  .field label{ display:block; font-weight:700; margin:4px 0 }
  .field input,.field select{ width:100%; padding:10px; border-radius:10px; border:1px solid rgba(59,130,246,.35) }

  .grid2{ display:grid; gap:12px; grid-template-columns:1fr }
  @media(min-width:900px){ .grid2{ grid-template-columns:1fr 1fr } }

  .events{ margin-top:12px }
  .ev{ background:var(--card); border:1px solid rgba(59,130,246,.22); border-radius:12px; padding:10px; display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px }
  .ev .meta{ display:flex; gap:8px; flex-wrap:wrap; font-size:.9rem; opacity:.9 }
  .color{ width:14px; height:14px; border-radius:4px; border:1px solid rgba(0,0,0,.1) }

  .legend{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; font-size:.9rem }
  .legend .pill{ padding:.18rem .5rem; border-radius:999px; border:1px solid rgba(59,130,246,.25) }

  .print-note{ text-align:center; margin-top:8px; opacity:.8 }

  @media print{
    .topbar,.actions-row,.controls,.btn,.toast{ display:none !important }
    .ev{ page-break-inside:avoid }
  }
</style>
</head>
<body>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <div class="topbar">
    <div class="left-actions"><a class="btn" href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></div>
    <div class="actions"><button class="btn" id="themeToggle">ğŸŒ“</button></div>
    <div class="user"><a class="btn" href="programs.html">Ù…Ø³Ø§Ø­Ø© Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ</a></div>
  </div>

  <header>
    <div class="hero">
      <h1 class="logo">Ù…Ù€ÙÙ€ÙŠØ¹Ù€Ø§Ø¯</h1>
      <div class="tag"><span class="dot"></span>Ù…ÙŠØ¹Ø§Ø¯Ùƒ Ù…Ø±Ø¢Ø© Ø§Ù„ØªØ²Ø§Ù…Ùƒâ€¦ ÙØ§Ø¬Ø¹Ù„ Ù„Ù‡ Ø£Ø«Ù€Ù€Ø±Ù‹Ø§</div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ -->
      <section class="card controls">
        <h2 class="title">Ø£Ø¶ÙÙ Ù…ÙˆØ¹Ø¯Ù‹Ø§ Ø¥Ù„Ù‰ ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</h2>
        <form id="miyad-form">
          <div class="grid2">
            <div class="field"><label>Ø§Ù„Ù…Ø§Ø¯Ø©</label><input id="m-subj" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÙˆÙ…"></div>
            <div class="field"><label>Ø§Ù„ÙØµÙ„</label><input id="m-class" placeholder="Ù…Ø«Ø§Ù„: 6/Ø¨"></div>

            <div class="field">
              <label>Ø§Ù„ÙŠÙˆÙ…</label>
              <select id="m-day">
                <option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
              </select>
            </div>

            <div class="field"><label>Ø§Ù„Ø­ØµØ© Ø±Ù‚Ù…</label><input id="m-slot" type="number" min="1" max="10" value="1"></div>

            <div class="field"><label>ØªØ§Ø±ÙŠØ® (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="m-date" type="date"></div>

            <div class="field">
              <label>Ù„ÙˆÙ†</label>
              <select id="m-color">
                <option value="#60a5fa">Ø£Ø²Ø±Ù‚</option>
                <option value="#22c55e">Ø£Ø®Ø¶Ø±</option>
                <option value="#f59e0b">Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</option>
                <option value="#ef4444">Ø£Ø­Ù…Ø±</option>
                <option value="#a78bfa">Ø¨Ù†ÙØ³Ø¬ÙŠ</option>
              </select>
            </div>
          </div>
        </form>

        <div class="actions-row">
          <button class="btn primary" id="add">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯</button>
          <button class="btn" id="export">Ù†Ø³Ø® Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</button>
          <button class="btn" id="print">Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn ghost" id="clear">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
        </div>
      </section>

      <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¹Ø¨Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ -->
      <section class="card" id="reminder-card" style="margin-top:14px">
        <h2 class="title">Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ âœ‰ï¸</h2>
        <div class="grid2">
          <div class="field inline">
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="rem-enable">
              ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
            </label>
            <div class="muted" style="margin-top:6px">
              Ø³Ù†Ø±Ø³Ù„ ØªØ°ÙƒÙŠØ±Ù‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø°ÙŠ ØªØ®ØªØ§Ø±ÙŠÙ†Ù‡.
            </div>
          </div>

          <div class="field">
            <label>Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù€</label>
            <select id="rem-days">
              <option value="1">ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯</option>
              <option value="2" selected>ÙŠÙˆÙ…ÙŠÙ†</option>
              <option value="3">3 Ø£ÙŠØ§Ù…</option>
              <option value="4">4 Ø£ÙŠØ§Ù…</option>
              <option value="5">5 Ø£ÙŠØ§Ù…</option>
              <option value="6">6 Ø£ÙŠØ§Ù…</option>
              <option value="7">7 Ø£ÙŠØ§Ù…</option>
            </select>
          </div>
        </div>

        <div class="actions-row">
          <button class="btn" id="rem-save">Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ±</button>
          <span id="rem-status" class="muted"></span>
        </div>
      </section>

      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ -->
      <section class="card">
        <h2 class="title">Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ â°</h2>
        <div class="legend">
          <span class="pill">Ø±ØªÙ‘Ø¨ Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ø­ØµØ©</span>
          <span class="pill">ÙƒÙ„ Ù…ÙˆØ¹Ø¯ ÙŠØ¸Ù‡Ø± Ù…Ø¹Ù‡ Ø§Ù„Ù„ÙˆÙ† + Ø§Ù„Ù…Ø§Ø¯Ø© + Ø§Ù„ÙØµÙ„</span>
        </div>
        <div class="events" id="list"></div>
        <p class="print-note">Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ø³ÙŠÙ…Ø¶ÙŠâ€¦ ÙˆØ³ÙŠØ¨Ù‚Ù‰ Ù…Ù†Ù‡ Ø§Ù„Ø£Ø«Ù€Ø± ğŸŒ¿</p>
      </section>
    </div>
  </main>

  <footer>
    <p class="foot-line">Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø´Ø±Ø§Ø±Ø© ØµØºÙŠØ±Ø©â€¦ ØªÙØ¶ÙŠØ¡ Ø¹Ù‚ÙˆÙ„Ù‹Ø§ ÙƒØ¨ÙŠØ±Ø©.</p>
    <p class="foot-name">Ù†Ø¯Ù‰ Ø§Ù„Ù…Ø¬ÙŠØ±Ø´</p>
  </footer>

  <div class="toast" id="toast"></div>

  <!-- ========== Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØµÙØ­Ø©: Ù…Ù†Ø·Ù‚ Ù…ÙŠØ¹Ø§Ø¯ + Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª + Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ± ========== -->
  <script>
    // ====== Ø£Ø¯ÙˆØ§Øª Ø¨Ø³ÙŠØ·Ø© ======
    const KEY='mi3ad:events';
    function toast(m){ const t=document.getElementById('toast'); if(!t) return; t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(_){ return [] } }
    function save(list){ localStorage.setItem(KEY, JSON.stringify(list)); }

    // Ø±Ù†Ø¯Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    function render(){
      const box=document.getElementById('list'); box.innerHTML='';
      const daysOrder={'Ø§Ù„Ø£Ø­Ø¯':1,'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†':2,'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡':3,'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡':4,'Ø§Ù„Ø®Ù…ÙŠØ³':5};
      const items=load().sort((a,b)=> (daysOrder[a.day]-daysOrder[b.day]) || (a.slot-b.slot));
      if(!items.length){ box.innerHTML='<p class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø¨Ø¹Ø¯.</p>'; return; }
      items.forEach((e,i)=>{
        const d=document.createElement('div'); d.className='ev';
        d.innerHTML=`
          <div class="meta">
            <span class="color" style="background:${e.color}"></span>
            <strong>${e.subj}</strong>
            <span>â€” ÙØµÙ„ ${e.cls}</span>
            <span>â€” ${e.day} (Ø­ØµØ© ${e.slot})</span>
            ${e.date?`<span>â€” ${e.date}</span>`:''}
          </div>
          <a href="#" data-i="${i}" class="btn ghost" style="padding:6px 10px">Ø­Ø°Ù</a>`;
        box.appendChild(d);
      });
    }

    // ====== ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (ÙŠØ³ØªØ¯Ø¹ÙŠ supaLogToolUsage Ø¥Ù† ÙˆÙØ¬Ø¯) ======
    function logUse(tag){
      try {
        if (typeof supaLogToolUsage === 'function') supaLogToolUsage(tag);
      } catch(_) {}
    }

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    document.addEventListener('DOMContentLoaded', ()=>{
      // ØªØ®Ø²ÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ ÙÙŠ storage.js)
      if (typeof bindAutoSave === 'function') {
        bindAutoSave('miyad', '#miyad-form');
      }

      // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ÙŠ
      render();

      // â€œÙ…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ØµÙØ­Ø©â€
      logUse('miyad:view');

      document.getElementById('add').addEventListener('click', ()=>{
        const subj=document.getElementById('m-subj').value.trim();
        const cls =document.getElementById('m-class').value.trim();
        const day =document.getElementById('m-day').value;
        const slot=+document.getElementById('m-slot').value||1;
        const date=document.getElementById('m-date').value;
        const color=document.getElementById('m-color').value;

        if(!subj||!cls){ toast('Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„ÙØµÙ„'); return; }

        const list=load(); list.push({subj,cls,day,slot,date,color});
        save(list); render(); toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ù€Ù€Ø§ÙØ© âœ…');

        // ØªØ­Ù„ÙŠÙ„
        logUse('miyad:add_event');
      });

      document.getElementById('list').addEventListener('click', (e)=>{
        const a=e.target.closest('a[data-i]'); if(!a) return; e.preventDefault();
        const i=+a.getAttribute('data-i'); const list=load(); list.splice(i,1); save(list); render();

        // ØªØ­Ù„ÙŠÙ„
        logUse('miyad:delete_event');
      });

      document.getElementById('export').addEventListener('click', ()=>{
        const txt=load().map(e=>`${e.day} | Ø­ØµØ© ${e.slot} | ${e.subj} â€” ÙØµÙ„ ${e.cls}${e.date?(' â€” '+e.date):''}`).join('\n');
        navigator.clipboard.writeText(txt||'').then(()=>{
          toast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…');
          // ØªØ­Ù„ÙŠÙ„
          logUse('miyad:export');
        });
      });

      document.getElementById('print').addEventListener('click', ()=>{
        window.print();
        // ØªØ­Ù„ÙŠÙ„
        logUse('miyad:print');
      });

      document.getElementById('clear').addEventListener('click', ()=>{
        if(confirm('Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØŸ')){
          localStorage.removeItem(KEY); render();
          // ØªØ­Ù„ÙŠÙ„
          logUse('miyad:clear_all');
        }
      });
    });

    // ====== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ± (Ø³ÙˆØ¨Ø§Ø¨ÙŠØ² + Auth0) ======
    async function getAuthUser() {
      try { return await window.auth?.getUser(); } catch (_) { return null; }
    }
    function getSupabase() {
      return window.supa || window.supabase || window.supabaseClient || null;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    async function loadReminderSettings() {
      const sb = getSupabase();
      const user = await getAuthUser();
      if (!sb || !user) return;

      const { data, error } = await sb
        .from('miyad_settings')
        .select('reminders_enabled, remind_days_before')
        .eq('user_id', user.sub)
        .single();

      if (error && error.code !== 'PGRST116') {
        console.warn('loadReminderSettings error:', error);
        return;
      }

      const enable = data?.reminders_enabled ?? false;
      const days   = data?.remind_days_before ?? 2;

      const cb  = document.getElementById('rem-enable');
      const sel = document.getElementById('rem-days');
      if (cb)  cb.checked = !!enable;
      if (sel) sel.value  = String(days);
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    async function saveReminderSettings() {
      const sb   = getSupabase();
      const user = await getAuthUser();
      if (!sb || !user) {
        (window.toast? toast('Ø³Ø¬Ù‘Ù„ÙŠ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ù‹Ø§') : alert('Ø³Ø¬Ù‘Ù„ÙŠ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ù‹Ø§'));
        return;
      }

      const cb   = document.getElementById('rem-enable');
      const sel  = document.getElementById('rem-days');
      const stat = document.getElementById('rem-status');

      const payload = {
        user_id: user.sub,
        email:   user.email || null,
        reminders_enabled: !!cb.checked,
        remind_days_before: Number(sel.value || 2)
      };

      stat.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸â€¦';
      const { error } = await sb
        .from('miyad_settings')
        .upsert(payload, { onConflict: 'user_id' });

      if (error) {
        console.error('saveReminderSettings error:', error);
        stat.textContent = 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸';
        (window.toast ? toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸') : null);
        return;
      }

      stat.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ“';
      (window.toast ? toast('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ± âœ“') : null);
    }

    // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ± + ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('rem-save')?.addEventListener('click', saveReminderSettings);

      // Ù…Ù† app.js ÙŠØµØ¯Ø± Ø­Ø¯Ø« auth0:ready Ù„Ù…Ø§ Ø§Ù„Ù€ SDK ÙŠØ¬Ù‡Ø²
      window.addEventListener('auth0:ready', loadReminderSettings);

      // Ø§Ø­ØªÙŠØ§Ø· Ù„Ùˆ ØªØ£Ø®Ø± Ø§Ù„Ø­Ø¯Ø«
      setTimeout(loadReminderSettings, 1200);
    });
  </script>

  <!-- ========== Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­ ========== -->
  <!-- Supabase -->
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/supabase-client.js"></script>

  <!-- Auth0 SDK (Ø¨Ø¯ÙˆÙ† defer Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© Ù‚Ø¨Ù„ require-auth) -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>

  <!-- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© (ÙŠØªÙˆÙ‚Ø¹ ÙˆØ¬ÙˆØ¯ SDK Ø¬Ø§Ù‡Ø²) -->
  <script defer src="assets/js/require-auth.js"></script>

  <!-- Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ù„Ø§Ø²Ù… storage Ù‚Ø¨Ù„ app.js Ù„Ø£Ù†Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… bindAutoSave) -->
  <script defer src="assets/js/storage.js"></script>
  <script defer src="app.js"></script>
</body>
</html>
