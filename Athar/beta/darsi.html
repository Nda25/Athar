<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ูููุฑุชููุฒ</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Cairo:wght@700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="style.css" />
    <meta name="color-scheme" content="dark light" />
    <link rel="stylesheet" href="assets/css/darsi.css" />
  </head>
  <body>
    <div class="global-bg"></div>

    <!-- Navbar -->
    <div id="navbar" data-component="components/navbar.html"></div>

    <!-- Header -->
    <header>
      <div class="hero">
        <div class="brand-row">
          <h1 class="brand-name">ูููุฑุชูุฒ</h1>
        </div>
        <div class="tag">
          <span class="dot"></span>ุฃุณููุงุณู ุนููู.. ููุฑุณูููุฎ ุงูุฃุซูููุฑ.
        </div>
      </div>
    </header>

    <main>
      <div class="container">
        <!-- ุงููุฏุฎูุงุช (ูุงุจูุฉ ููุทู) -->
        <section class="card inputs-wrap" id="inputs">
          <div class="inputs-head">
            <h2 class="title" style="margin: 0">ูุฏุฎูุงุช ุงูุฎุทุฉ</h2>
            <button class="btn" id="toggleInputs">ุฅุฎูุงุก ุงููุฏุฎูุงุช</button>
          </div>

          <div class="inputs-body">
            <div class="cols-3">
              <div class="field">
                <label>ููุท ุงูุฅุฏุฎุงู</label>
                <select id="f-mode">
                  <option value="topic" selected>ููุถูุน ูุฎุชุตุฑ</option>
                  <option value="text">ูุต ููุชุญููู</option>
                </select>
                <div class="muted-mini">
                  โูุต ููุชุญูููโ ูุณุชูุชุฌ ูุณุชูู ุจููู ุชููุงุฆููุง.
                </div>
              </div>

              <div class="field">
                <label>ุงููุฆุฉ ุงูุนููุฑููุฉ</label>
                <select id="f-age">
                  <option value="p1">ุงุจุชุฏุงุฆู ุฏูููุง</option>
                  <option value="p2" selected>ุงุจุชุฏุงุฆู ุนูููุง</option>
                  <option value="m">ูุชูุณุท</option>
                  <option value="h">ุซุงููู</option>
                </select>
              </div>

              <div class="field">
                <label>ุฒูู ุงูุญุตุฉ (ุฏูููุฉ)</label>
                <input
                  id="f-duration"
                  type="number"
                  min="15"
                  max="90"
                  step="5"
                  value="45"
                />
              </div>
            </div>

            <div class="cols-2" id="mode-topic">
              <div class="field">
                <label>ุงููุงุฏุฉ</label>
                <input
                  id="f-subject"
                  placeholder="ุฑูุงุถูุงุช / ุนููู / ูุบุฉ ุนุฑุจูุฉ โฆ"
                />
              </div>
              <div class="field">
                <label>ุงูููุถูุน</label>
                <input
                  id="f-topic"
                  placeholder="ุงููุณูุฑ / ุฏูุฑุฉ ุญูุงุฉ ุงููุจุงุช / ุงููุจุชุฏุฃ ูุงูุฎุจุฑ โฆ"
                />
              </div>
            </div>

            <div class="field" id="mode-text" style="display: none">
              <label>ุงููุต ููุชุญููู</label>
              <textarea
                id="f-text"
                rows="5"
                placeholder="ุฃูุตูู ููุฑุฉ ูู ุงููุตุฏุฑโฆ (ุณูุณุชูุชุฌ ุงูุฃูุฏุงู ููุณุชูู ุจููู)"
              ></textarea>
            </div>

            <div class="cols-2">
              <div class="field">
                <label>ูุณุชูู ุจููู ุงูุฃุณุงุณู</label>
                <select id="f-bloom-main">
                  <option value="remember">ุชุฐูุฑ</option>
                  <option value="understand" selected>ููู</option>
                  <option value="apply">ุชุทุจูู</option>
                  <option value="analyze">ุชุญููู</option>
                  <option value="evaluate">ุชูููู</option>
                  <option value="create">ุฅุจุฏุงุน</option>
                </select>
                <div class="muted-mini">ูุฏ ูุชุบููุฑ ุชููุงุฆููุง ุจุนุฏ ุงูุชุญููู.</div>
              </div>
              <div class="field">
                <label>ูุณุชูู ุจููู ุงูุฏุงุนู (+2)</label>
                <select id="f-bloom-support">
                  <option value="">(ุงุฎุชูุงุฑู)</option>
                  <option value="remember">ุชุฐูุฑ</option>
                  <option value="understand">ููู</option>
                  <option value="apply" selected>ุชุทุจูู</option>
                  <option value="analyze">ุชุญููู</option>
                  <option value="evaluate">ุชูููู</option>
                  <option value="create">ุฅุจุฏุงุน</option>
                </select>
              </div>
            </div>

            <div class="cols-2">
              <div class="field">
                <label>ุนุฏุฏ ุงูุฃูุฏุงู</label>
                <select id="f-goal-count">
                  <option>1</option>
                  <option selected>2</option>
                  <option>3</option>
                </select>
              </div>
              <div class="field">
                <label>ููุงุญุธุงุช ุฎุงุตุฉ (ุงุฎุชูุงุฑู)</label>
                <input id="f-notes" placeholder="ูููุฏ ุตููุฉุ ุฃุฏูุงุช ูุชุงุญุฉโฆ" />
              </div>
            </div>

            <div class="cols-2">
              <div class="field">
                <label>ุงูุชุนูู ุงูุชูููู</label>
                <select id="f-adapt">
                  <option value="off" selected>ุจุฏูู ุงุฎุชุจุงุฑ ูุจูู</option>
                  <option value="on">ูุนูู ุงุฎุชุจุงุฑ ูุจูู (3 ุฃุณุฆูุฉ)</option>
                </select>
              </div>
              <div class="field">
                <label>ุชูุฏูุฑ ุฃููู ููุณุชูู ุงูุตู</label>
                <select id="f-level">
                  <option value="mixed" selected>ูุชูุงูุช</option>
                  <option value="low">ูุญุชุงุฌ ุฏุนู</option>
                  <option value="high">ูุชูุฏู</option>
                </select>
              </div>
            </div>

            <!-- ุตู ุงูุฃุฒุฑุงุฑ ุงูุฃุณุงุณู (ุชุญููู + ุชูููุฏ) -->
            <div class="row-actions">
              <button class="btn" id="btn-analyze">ุชุญููู ุงููุญุชูู</button>
              <button class="btn primary" id="btn-generate">
                ูููุฏ ูู ุงูุฎุทุฉ โจ
              </button>
            </div>
          </div>
        </section>

        <!-- ุงูุงุฎุชุจุงุฑ ุงููุจูู (ูุธูุฑ ููุท ุนูุฏ ุงูุชูุนูู) -->
        <section class="card" id="pre-quiz" style="display: none">
          <h2 class="title">ุงุฎุชุจุงุฑ ูุจูู ุณุฑูุน (3 ุฃุณุฆูุฉ)</h2>
          <p class="lead">
            ุฃุฏุฎู **ุนุฏุฏ ุงููุฎุทุฆูู** (ูู ุฃุตู ุนุฏุฏ ุงูุทูุจุฉ) ููู ุณุคุงูุ ุซู ุงุถุบุท โุชุทุจูู
            ุงูุชููููโ.
          </p>
          <div class="cols-3" id="quizWrap"></div>
          <div class="row-actions">
            <button class="btn primary" id="btn-adapt-apply">
              ุชุทุจูู ุงูุชูููู
            </button>
          </div>
        </section>

        <!-- ุฃุฒุฑุงุฑ ูุง ุจุนุฏ ุงูุชูููุฏ -->
        <section class="card" id="post-actions" style="display: none">
          <div class="row-actions">
            <button class="btn" id="btn-copy-full">ูุณุฎ ุงูุฎุทุฉ ูุงููุฉ</button>
            <button class="btn" id="btn-classroom">
              ูุณุฎ ููุงูุจ Google Classroom
            </button>
            <button class="btn" id="btn-teams">
              ูุณุฎ ููุงูุจ Microsoft Teams
            </button>
            <button class="btn" id="btn-print">ุทุจุงุนุฉ</button>
            <button class="btn" id="toggleInputs2">ุฅุธูุงุฑ/ุฅุฎูุงุก ูุฏุฎูุงุชู</button>
          </div>
        </section>

        <!-- ุงููุฎุฑุฌุงุช -->
        <section class="card" id="out-summary" style="display: none">
          <h2 class="title">ููุฎุต ุณุฑูุน</h2>
          <p class="lead" id="out-head">โ</p>
          <div
            id="out-adapt"
            class="hl"
            style="display: none; margin-top: 8px"
          ></div>
          <ul class="list" id="out-bullets" style="margin-top: 8px"></ul>
          <div style="margin-top: 8px">
            <span class="pill" id="pill-main"></span>
            <span class="pill" id="pill-sup" style="display: none"></span>
            <span class="pill" id="pill-age"></span>
          </div>
        </section>

        <section class="grid" id="out-grid" style="display: none">
          <div class="box">
            <h3>ูุฎุทุท ุงูุฏุฑุณ (ูุจู / ุฃุซูุงุก / ุจุนุฏ)</h3>
            <ul class="list" id="out-structure"></ul>
          </div>
          <div class="box">
            <h3>ุฃูุดุทุฉ ููุงุฆูุฉ ููุนูุฑ ู(ุจููู)</h3>
            <ol class="list" id="out-activities"></ol>
          </div>
          <div class="box">
            <h3>ุชูููู ุณุฑูุน ูุชุฏุฑูุฌ</h3>
            <ol class="list" id="out-assessment"></ol>
          </div>
          <div class="box">
            <h3>ุชูุงูุฒ: ุฏุนู ูุฅุซุฑุงุก</h3>
            <ul class="list" id="out-diff"></ul>
          </div>
        </section>

        <section class="card" id="out-goals" style="display: none">
          <h2 class="title">ุจุทุงูุฉ ุฃูุฏุงู (ุฌุงูุฒุฉ ููุทุจุงุนุฉ)</h2>
          <div class="printable" id="goalsCard">
            <h3 style="margin: 0 0 6px">
              ุฃูุฏุงู ุงูุฏุฑุณ: <span id="goalsTitleOut">โ</span>
            </h3>
            <ul id="goalsList" class="list" style="margin: 0"></ul>
            <p style="margin-top: 6px">
              <strong>ูุนุงููุฑ ุงููุฌุงุญ:</strong> <span id="successOut">โ</span>
            </p>
          </div>
          <div class="mini-actions">
            <button class="btn" id="btn-goals-copy">ูุณุฎ ุจุทุงูุฉ ุงูุฃูุฏุงู</button>
            <button class="btn" id="btn-goals-print">ุทุจุงุนุฉ ุงูุจุทุงูุฉ</button>
          </div>
        </section>

        <section class="card" id="out-onemin" style="display: none">
          <h2 class="title">ุฎุทุฉ ุงูุฏูููุฉ ุงููุงุญุฏุฉ</h2>
          <div class="printable" id="oneMinCard">
            <h3 style="margin: 0 0 6px">ุงูุฏูููุฉ ุงููุงุญุฏุฉ</h3>
            <div id="oneMinText" class="muted">โ</div>
          </div>
        </section>

        <section class="card" id="out-ladder" style="display: none">
          <h2 class="title">ุณูู ุชูุฏูุฑ ูุจุณูุท (ููุทูุงุจ)</h2>
          <div class="ladder" id="ladderWrap"></div>
        </section>
      </div>
    </main>

    <!-- Load shared footer component -->
    <div id="footer" data-component="components/footer.html"></div>

    <script>
      // ุณูุฉ ุชููุงุฆูุฉ ูู ุงูููุชุฑ
      (function waitSetYear(attempts) {
        attempts = attempts || 0;
        var el = document.getElementById("year");
        if (el) {
          el.textContent = new Date().getFullYear();
          return;
        }
        if (attempts < 50)
          setTimeout(function () {
            waitSetYear(attempts + 1);
          }, 100);
      })();
    </script>

    <div class="toast" id="toast"></div>

    <!-- ุณูุฑุจุช ุนุงู ุงููุดุฑูุน -->
    <script defer src="app.js"></script>

    <script>
      /* ===== ููุงููุณ ููุนููุงุช ูุญููุฉ (ููุงุณุชุฏูุงู ูุดููุฉ ูุธุงุฆู ูุณุงุนุฏุฉ) ===== */
      const BLOOM_VERBS = {
        remember: ["ูุนุฏูุฏ", "ูุณููู", "ูุฐูุฑ", "ูุชุนุฑูู"],
        understand: ["ูุดุฑุญ", "ููุฎูุต", "ูุนุทู ูุซุงููุง", "ููุณูุฑ", "ูุตููู"],
        apply: ["ูุณุชุฎุฏู", "ููุธูู", "ูุญูู", "ููููุฐ"],
        analyze: ["ููููู", "ููุงุฑู", "ูุณุชูุชุฌ", "ูุฑุจุท", "ูุตููู ุจุนูู"],
        evaluate: ["ูุจุฑูุฑ", "ูููุฏ", "ูุญูู", "ููููู"],
        create: ["ูุตููู", "ูุฑููุจ", "ูุจุชูุฑ", "ูุคูู"],
      };
      const BLOOM_HINTS = {
        analyze: ["ุญููู", "ุญูู", "ูุงุฑู", "ูุฑูู", "ุงุณุชูุชุฌ", "ุตููู", "ุฑุชูุจ"],
        evaluate: ["ูููู", "ุจุฑูุฑ", "ุงููุฏ", "ุงุญูู", "ูููู"],
        create: ["ุตููู", "ุงุจุชูุฑ", "ุฑููุจ", "ุฃููู", "ุฎุทูุท"],
        apply: ["ุทุจูู", "ูุธูู", "ุงุณุชุฎุฏู", "ุญูู", "ูููุฐ"],
        understand: ["ุงุดุฑุญ", "ูุฎูุต", "ูุซุงู", "ูุณูุฑ", "ุนุฑูู"],
        remember: ["ุงุฐูุฑ", "ุนุฏูุฏ", "ุณููู", "ุชุนุฑูู"],
      };
      const AGE_NAME = {
        p1: "ุงุจุชุฏุงุฆู ุฏูููุง",
        p2: "ุงุจุชุฏุงุฆู ุนูููุง",
        m: "ูุชูุณุท",
        h: "ุซุงููู",
      };

      function pick(a) {
        return a[Math.floor(Math.random() * a.length)] || "";
      }
      function bullets(el, arr) {
        el.innerHTML = "";
        (arr || []).filter(Boolean).forEach((t) => {
          const li = document.createElement("li");
          li.textContent = t;
          el.appendChild(li);
        });
      }
      function toastMsg(msg) {
        const t = document.getElementById("toast");
        if (!t) return;
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 1200);
      }

      /* ===== ุชุจุฏูู โููุท ุงูุฅุฏุฎุงูโ ===== */
      const modeSel = document.getElementById("f-mode");
      const modeTopic = document.getElementById("mode-topic");
      const modeText = document.getElementById("mode-text");
      modeSel.addEventListener("change", () => {
        const isText = modeSel.value === "text";
        modeText.style.display = isText ? "" : "none";
        modeTopic.style.display = isText ? "none" : "";
      });

      /* ===== ุนูุงุตุฑ DOM ===== */
      const fAge = document.getElementById("f-age");
      const fDur = document.getElementById("f-duration");
      const fMain = document.getElementById("f-bloom-main");
      const fSup = document.getElementById("f-bloom-support");
      const fGoal = document.getElementById("f-goal-count");
      const fNotes = document.getElementById("f-notes");
      const inputsWrap = document.getElementById("inputs");

      const btnAnalyze = document.getElementById("btn-analyze");
      const btnGen = document.getElementById("btn-generate");
      const btnCopy = document.getElementById("btn-copy-full");
      const btnClass = document.getElementById("btn-classroom");
      const btnTeams = document.getElementById("btn-teams");
      const btnPrint = document.getElementById("btn-print");
      const toggleInputs = document.getElementById("toggleInputs");
      const toggleInputs2 = document.getElementById("toggleInputs2");

      const outSummary = document.getElementById("out-summary");
      const outGrid = document.getElementById("out-grid");
      const outOneMin = document.getElementById("out-onemin");
      const outGoals = document.getElementById("out-goals");
      const outLadder = document.getElementById("out-ladder");
      const postActions = document.getElementById("post-actions");

      const pillMain = document.getElementById("pill-main");
      const pillSup = document.getElementById("pill-sup");
      const pillAge = document.getElementById("pill-age");

      let CURRENT = {
        subject: "",
        topic: "",
        main: "understand",
        sup: "",
        age: "p2",
        duration: 45,
        goals: [],
        success: "",
        activities: [],
        assessment: [],
        structure: [],
        oneMin: "",
        notes: "",
        adaptMsg: "",
      };
      // ูุดุบูู ุงูุฑุจุท ุจุนุฏ ุชุญููู ุงูุณูุฑุจุชุงุช (Supabase/Auth0) ุฃููุฏ
      window.addEventListener("load", () => {
        if (typeof supaEnsureUserProfile === "function") {
          supaEnsureUserProfile().catch(() => {});
        }
      });

      // โ ูุงูุชูุงุท ุจูุงูุงุช ุงูุญุงูุฉ ูุฅุฑุณุงููุง ูู meta
      function metaSnapshot() {
        return {
          mode: document.getElementById("f-mode").value,
          subject:
            (document.getElementById("f-subject")?.value || "").trim() || null,
          topic:
            (document.getElementById("f-topic")?.value || "").trim() || null,
          age: document.getElementById("f-age").value,
          duration: +document.getElementById("f-duration").value || null,
          bloom_main: document.getElementById("f-bloom-main").value,
          bloom_support:
            document.getElementById("f-bloom-support").value || null,
          goal_count: +document.getElementById("f-goal-count").value || null,
          adapt: document.getElementById("f-adapt").value === "on",
        };
      }

      /* ===== ุฅุธูุงุฑ/ุฅุฎูุงุก ุงููุฏุฎูุงุช ===== */
      function toggleInputsView() {
        inputsWrap.classList.toggle("collapsed");
        const collapsed = inputsWrap.classList.contains("collapsed");
        toggleInputs.textContent = collapsed
          ? "ุฅุธูุงุฑ ุงููุฏุฎูุงุช"
          : "ุฅุฎูุงุก ุงููุฏุฎูุงุช";
        if (toggleInputs2)
          toggleInputs2.textContent = collapsed
            ? "ุฅุธูุงุฑ ูุฏุฎูุงุชู"
            : "ุฅุฎูุงุก ูุฏุฎูุงุชู";
      }
      toggleInputs.addEventListener("click", toggleInputsView);
      if (toggleInputs2)
        toggleInputs2.addEventListener("click", toggleInputsView);

      /* ===== ุชุญููู ุงููุญุชูู (ุงุณุชุฏูุงู ุจููู ูู ูุต) ===== */
      function inferBloomFrom(text) {
        text = (text || "").replace(/[^\u0600-\u06FF\s]/g, " ");
        const rank = [
          "create",
          "evaluate",
          "analyze",
          "apply",
          "understand",
          "remember",
        ];
        for (const lvl of rank) {
          if ((BLOOM_HINTS[lvl] || []).some((k) => text.includes(k)))
            return lvl;
        }
        return "understand";
      }
      btnAnalyze.addEventListener("click", async () => {
        const mode = document.getElementById("f-mode").value;
        if (mode !== "text") {
          toastMsg("ุงุฎุชุฑ: ูุต ููุชุญููู ุฃูููุง");
          return;
        }
        const text = document.getElementById("f-text").value || "";
        if (!text.trim()) {
          toastMsg("ุงูุตูู ููุฑุฉ ููุชุญููู");
          return;
        }

        const inferred = inferBloomFrom(text);
        fMain.value = inferred;
        toastMsg(`ุชู ุงูุงุณุชุฏูุงู ุนูู ูุณุชูู ุจููู: ${inferred}`);

        // ุชุชุจูุน ุงูุชุญููู
        if (typeof supaLogToolUsage === "function") {
          try {
            await supaLogToolUsage("murtakaz_analyze", {
              ...metaSnapshot(),
              inferred,
            });
          } catch (_) {}
        }
      });

      /* ===== ูุฏุงุก Gemini ุนุจุฑ Netlify Function (ูุน Bearer) ===== */
      btnGen.addEventListener("click", async () => {
        const mode = document.getElementById("f-mode").value; // 'topic' | 'text'
        const subject =
          (document.getElementById("f-subject")?.value || "").trim() || "โ";
        const topic = (document.getElementById("f-topic")?.value || "").trim();
        const sourceText = (
          document.getElementById("f-text")?.value || ""
        ).trim();

        const age = fAge.value;
        const duration = +fDur.value || 45;
        const bloomMain = fMain.value;
        const bloomSupport = fSup.value || "";
        const goalCount = +fGoal.value || 2;
        const notes = fNotes.value.trim();
        const adapt = document.getElementById("f-adapt").value === "on";

        // ุชุญููู ุณุฑูุน
        if (mode === "topic" && !topic) {
          toastMsg("ุงูุชุจู ุงูููุถูุนโฆ");
          return;
        }
        if (mode === "text" && !sourceText) {
          toastMsg("ุงูุตูู ูุตูุง ููุชุญูููโฆ");
          return;
        }

        // ุญุงูุฉ ุงูุชุธุงุฑ
        btnGen.disabled = true;
        btnGen.dataset._label = btnGen.textContent;
        btnGen.textContent = "ููููุฏ ุฎุทุฉ ุฐููุฉโฆ โจ";

        try {
          let token;
          try {
            if (typeof window.auth === "undefined" || !window.auth) {
              console.error("Auth0 client (window.auth) not initialized.");
              toastMsg("ุฎุทุฃ: ุงููุตุงุฏูุฉ ุบูุฑ ุฌุงูุฒุฉ");
              throw new Error("Auth0 client not ready");
            }
            token = await window.auth.getTokenSilently();
          } catch (e) {
            console.error("Error getting access token", e);
            toastMsg("ุฎุทุฃ ูู ุฌูุจ ุงูุชูููุ ุญุงูู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู");
            btnGen.disabled = false;
            btnGen.textContent = btnGen.dataset._label || "ูููุฏ ูู ุงูุฎุทุฉ โจ";
            return;
          }

          const res = await fetch("/.netlify/functions/murtakaz", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({
              mode,
              subject,
              topic,
              sourceText,
              age,
              duration,
              bloomMain,
              bloomSupport,
              goalCount,
              notes,
              level: document.getElementById("f-level").value,
              adapt,
              // ุฅุฌุจุงุฑ ุงูุชูููุน ุงูุชุงู ุฏูู ุชุบููุฑ ุงููุงุฌูุฉ
              variant: Date.now(),
            }),
          });
          if (!res.ok) {
            const t = await res.text();
            throw new Error(t || "HTTP " + res.status);
          }
          const R = await res.json();

          // ุชุฎุฒูู ุญุงูู (ูููุณ ุฃุฒุฑุงุฑ ุงููุณุฎ/ุงูุทุจุงุนุฉ)
          CURRENT = {
            subject,
            topic: R.meta?.topic || topic,
            main: bloomMain,
            sup: bloomSupport,
            age,
            duration,
            goals: R.goals || [],
            success: R.success || "",
            activities: R.activities || [],
            assessment: R.assessment || [],
            structure: R.structure || [],
            oneMin: R.oneMin || "",
            notes,
          };

          // ุฑุณู ุงููุงุฌูุฉ
          document.getElementById(
            "out-head"
          ).textContent = `ุงููุงุฏุฉ: ${subject} โ ุงูููุถูุน: "${CURRENT.topic}" โ ุงูุฒูู: ${duration} ุฏูููุฉ`;

          bullets(document.getElementById("out-bullets"), [
            notes ? `ููุงุญุธุฉ ุงููุนูู: ${notes}` : null,
            bloomSupport
              ? "ุฏูุฌ ูุณุชูููู ูู ุจููู (ุฃุณุงุณู + ุฏุงุนู)."
              : "ุชุฑููุฒ ุนูู ูุณุชูู ุจููู ุฃุณุงุณู ูุงุญุฏ.",
          ]);

          const outAdapt = document.getElementById("out-adapt");
          outAdapt.style.display = "none";
          outAdapt.textContent = "";
          pillMain.textContent =
            "ุจููู (ุฃุณุงุณู): " + (R.meta?.mainBloomLabel || CURRENT.main);
          if (bloomSupport) {
            pillSup.style.display = "inline-block";
            pillSup.textContent =
              "ุจููู (+2): " + (R.meta?.supportBloomLabel || bloomSupport);
          } else {
            pillSup.style.display = "none";
          }
          pillAge.textContent =
            "ุงูุนูุฑ: " + (R.meta?.ageLabel || R.meta?.age || age);

          bullets(document.getElementById("out-structure"), CURRENT.structure);
          bullets(
            document.getElementById("out-activities"),
            CURRENT.activities
          );
          bullets(
            document.getElementById("out-assessment"),
            CURRENT.assessment
          );
          bullets(document.getElementById("out-diff"), R.diff || []);

          document.getElementById("oneMinText").textContent = CURRENT.oneMin;
          document.getElementById("goalsTitleOut").textContent = CURRENT.topic;

          const gl = document.getElementById("goalsList");
          gl.innerHTML = "";
          (CURRENT.goals || []).forEach((g) => {
            const li = document.createElement("li");
            li.textContent = g;
            gl.appendChild(li);
          });
          document.getElementById("successOut").textContent = R.success || "";

          // ุณููู ุชูุฏูุฑ ูุจุณูุท (ูุณุชููุฏ ูู ุงููุฌุงุญ)
          const ladder = document.getElementById("ladderWrap");
          ladder.innerHTML = `
          <div class="step">
            <div class="tag ok">ุฃุชูู โ๏ธ</div>
            <div>${
              R.success || "ูุทุจู ุงูููููู ุจุฏูุฉ ูู ูุซุงู ุฌุฏูุฏ ุฏูู ูุณุงุนุฏุฉ."
            }</div>
          </div>
          <div class="step">
            <div class="tag mid">ูุชูุณุท โ</div>
            <div>ูููู ุงูููุฑุฉ ุงูุฃุณุงุณูุฉ ููุญุชุงุฌ ุชูุฌูููุง ุจุณูุทูุง ุนูุฏ ุงูุชุทุจูู.</div>
          </div>
          <div class="step">
            <div class="tag need">ุจุญุงุฌุฉ ุฏุนู โณ๏ธ</div>
            <div>ููุงุฌู ุตุนูุจุฉ โ ูุฏููู ูุซุงููุง ุฅุถุงูููุง ุฃู ุชุจุณูุทูุง.</div>
          </div>
        `;

          // ุฅุธูุงุฑ ุงูุฃูุณุงู
          outSummary.style.display = "";
          outGrid.style.display = "";
          outGoals.style.display = "";
          outOneMin.style.display = "";
          outLadder.style.display = "";
          postActions.style.display = "";

          // ุทูู ุงููุฏุฎูุงุช ุฅู ูุงูุช ููุชูุญุฉ
          if (!inputsWrap.classList.contains("collapsed")) {
            inputsWrap.classList.add("collapsed");
            toggleInputs.textContent = "ุฅุธูุงุฑ ุงููุฏุฎูุงุช";
            if (toggleInputs2) toggleInputs2.textContent = "ุฅุธูุงุฑ ูุฏุฎูุงุชู";
          }

          toastMsg("ุชู ุชูููุฏ ุฎุทุฉ ุฐููุฉ ๐");

          // ุชุชุจูุน: ุชูููุฏ ุฎุทุฉ
          if (typeof supaLogToolUsage === "function") {
            try {
              await supaLogToolUsage("murtakaz_generate", metaSnapshot());
            } catch (_) {}
          }

          window.scrollTo({
            top: outSummary.offsetTop - 10,
            behavior: "smooth",
          });
        } catch (err) {
          console.error(err);
          toastMsg("ุชุนุฐูุฑ ุชูููุฏ ุงูุฎุทุฉ. ุชุญูููู ูู ุงูููุชุงุญ ุฃู ุฃุนูุฏู ุงููุญุงููุฉ.");
        } finally {
          btnGen.disabled = false;
          btnGen.textContent = btnGen.dataset._label || "ูููุฏ ูู ุงูุฎุทุฉ โจ";
        }
      });

      /* ===== ุชุทุจูู ุงูุชูููู ุจูุงุก ุนูู ุงูุงุฎุชุจุงุฑ ุงููุจูู ===== */
      document
        .getElementById("btn-adapt-apply")
        .addEventListener("click", () => {
          const inputs = Array.from(
            document.querySelectorAll('#quizWrap input[type="number"]')
          );
          if (!inputs.length) {
            toastMsg("ูููุฏู ุงูุฎุทุฉ ุฃููุงู");
            return;
          }
          const wrong = inputs.map((i) => +i.value || 0);
          const totalWrong = wrong.reduce((a, b) => a + b, 0);

          let focus = "";
          const maxIdx = wrong.indexOf(Math.max(...wrong));
          if (maxIdx === 0)
            focus = "ุชุนุฒูุฒ ุงูุชููุฆุฉ ูุงูููุงููู ุงูุฃุณุงุณูุฉ (ุชุฐููุฑ/ููู).";
          else if (maxIdx === 1)
            focus = "ุชูููุฉ ุงููุดุงุท ุงูุฑุฆูุณู ููู ุจููู ุงูุฃุณุงุณู.";
          else focus = "ุฒูุงุฏุฉ ููุงู ุงูุชุทุจูู/ุงูุชูุณูุน (ุงููุณุชูู ุงูุฏุงุนู).";

          CURRENT.adaptMsg = `ุชูููู ุชููุงุฆู: ${focus} (ุฅุฌูุงูู ุฃุฎุทุงุก: ${totalWrong}).`;
          const outAdapt = document.getElementById("out-adapt");
          outAdapt.textContent = CURRENT.adaptMsg;
          outAdapt.style.display = "";

          const extra =
            maxIdx === 0
              ? `ุฅุถุงูุฉ ุฃูุซูุฉ ูุญุณูุณุฉ ุฃูุซุฑ ูู ุงูุชููุฆุฉ.`
              : maxIdx === 1
              ? `ุชูุณูู ุงููููุฉ ุงูุฑุฆูุณูุฉ ุฅูู ุฎุทูุงุช ุฃูุถุญ.`
              : `ุชูุฑูู ุชุทุจููู ุฅุถุงูู ุจููุช ูุตูุฑ.`;

          const acts = CURRENT.activities.slice();
          acts.push(`๐ง ุชุนุฏูู ุชูููู: ${extra}`);
          bullets(document.getElementById("out-activities"), acts);

          toastMsg("ุชู ุชุทุจูู ุงูุชูููู โ");
        });

      /* ===== ูุณุฎ/ุทุจุงุนุฉ/ุชุตุฏูุฑ (ูุน ุชุชุจูุน) ===== */
      const AGE_LABEL = (k) => AGE_NAME[k] || k;
      function exportFullText(S) {
        const lines = [];
        lines.push(`ุงูุนููุงู: ${S.topic} โ (${S.subject})`);
        if (S.adaptMsg) lines.push(S.adaptMsg);
        lines.push(`ุงูุฒูู: ${S.duration} ุฏูููุฉ โ ุงูุนูุฑ: ${AGE_LABEL(S.age)}`);
        lines.push(`ุจููู (ุฃุณุงุณู): ${S.main}${S.sup ? " + " + S.sup : ""}`);
        if (S.notes) lines.push(`ููุงุญุธุงุช ุงููุนูู: ${S.notes}`);
        lines.push("\nุงูุฃูุฏุงู:");
        (S.goals || []).forEach((g) => lines.push(`- ${g}`));
        lines.push("\nูุฎุทุท ุงูุฏุฑุณ:");
        (S.structure || []).forEach((s) => lines.push(`- ${s}`));
        lines.push("\nุฃูุดุทุฉ:");
        (S.activities || []).forEach((a) => lines.push(`- ${a}`));
        lines.push("\nุชูููู ุณุฑูุน:");
        (S.assessment || []).forEach((a) => lines.push(`- ${a}`));
        lines.push("\nุชูุงูุฒ:");
        (S.diff || []).forEach((a) => lines.push(`- ${a}`));
        lines.push("\nุงูุฏูููุฉ ุงููุงุญุฏุฉ:");
        lines.push(`- ${S.oneMin}`);
        lines.push("\nูุนุงููุฑ ุงููุฌุงุญ:");
        lines.push(`- ${S.success}`);
        return lines.join("\n");
      }
      function exportClassroom(S) {
        return [
          `[Google Classroom]
ุงูุนููุงู: ${S.topic} โ ${S.subject}`,
          `ุงูุชุนูููุงุช:
- ุงูุฑุฃ/ู ุงููุฏู: ${S.goals?.[0] || "-"}.
- ูููุฐู ุงููุดุงุท ุงูุฑุฆูุณู ุซู ุฃุฑุณูู ุชุฐูุฑุฉ ุงูุฎุฑูุฌ.`,
          `ุงูููุงุฏ: (ููุญุฏูุฏ ุงููุนูู)`,
          `ุงูุชุงุฑูุฎ/ุงูููุช: (ููุญุฏูุฏ ุงููุนูู)`,
          `ุงูุชูููู ุงูุณุฑูุน:
1) ${S.assessment?.[0] || "-"}
2) ${S.assessment?.[1] || "-"}
3) ${S.assessment?.[2] || "-"}`,
          `ุชูุงูุฒ:
- ุฏุนู: ${(S.diff || [])[0] || "-"}
- ุฅุซุฑุงุก: ${(S.diff || [])[1] || "-"}`,
        ].join("\n");
      }
      function exportTeams(S) {
        return [
          `[Microsoft Teams Assignment]
Title: ${S.topic} โ ${S.subject}
Instructions:
- Goals: ${(S.goals || []).join(" | ")}
- Main Activity: ${S.activities?.[1] || "-"}
- Exit Ticket: ${S.assessment?.[0] || "-"}
Rubric: (paste from page)
Due: (set by teacher)`,
        ].join("\n");
      }
      function copyText(txt) {
        navigator.clipboard.writeText(txt).then(() => toastMsg("ุชู ุงููุณุฎ โ"));
      }

      btnCopy.addEventListener("click", async () => {
        copyText(exportFullText(CURRENT));
        if (typeof supaLogToolUsage === "function") {
          try {
            await supaLogToolUsage("murtakaz_copy_full", metaSnapshot());
          } catch (_) {}
        }
      });
      btnClass.addEventListener("click", async () => {
        copyText(exportClassroom(CURRENT));
        if (typeof supaLogToolUsage === "function") {
          try {
            await supaLogToolUsage("murtakaz_copy_classroom", metaSnapshot());
          } catch (_) {}
        }
      });
      btnTeams.addEventListener("click", async () => {
        copyText(exportTeams(CURRENT));
        if (typeof supaLogToolUsage === "function") {
          try {
            await supaLogToolUsage("murtakaz_copy_teams", metaSnapshot());
          } catch (_) {}
        }
      });
      btnPrint.addEventListener("click", async () => {
        window.print();
        if (typeof supaLogToolUsage === "function") {
          try {
            await supaLogToolUsage("murtakaz_print", metaSnapshot());
          } catch (_) {}
        }
      });

      // ูุณุฎ/ุทุจุงุนุฉ ุจุทุงูุฉ ุงูุฃูุฏุงู ููุท
      function copyGoalsCard() {
        const el = document.getElementById("goalsCard");
        if (!el) return;
        const txt = el.innerText.trim();
        navigator.clipboard
          .writeText(txt)
          .then(() => toastMsg("ุชู ูุณุฎ ุจุทุงูุฉ ุงูุฃูุฏุงู โ"));
      }
      function printElementById(id, title = "ุจุทุงูุฉ ุงูุฃูุฏุงู") {
        const node = document.getElementById(id);
        if (!node) return;
        const w = window.open("", "_blank");
        w.document.open();
        w.document.write(`<!doctype html><html lang="ar" dir="rtl"><head>
        <meta charset="utf-8"><title>${title}</title>
        <style>
          body{font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto; color:#0f172a; margin:20px}
          .box{border:1px solid #93c5fd80; border-radius:12px; padding:14px}
          h3{margin:0 0 6px; font-weight:700}
          ul{margin:0; padding-inline-start:1.2rem}
          strong{font-weight:700}
          @media print{ @page{margin:12mm} }
        </style>
      </head><body>
        <div class="box">${node.innerHTML}</div>
        <script>window.onload=()=>window.print()<\/script>
      </body></html>`);
        w.document.close();
      }
      document
        .getElementById("btn-goals-copy")
        ?.addEventListener("click", async () => {
          copyGoalsCard();
          if (typeof supaLogToolUsage === "function") {
            try {
              await supaLogToolUsage("murtakaz_goals_copy", metaSnapshot());
            } catch (_) {}
          }
        });
      document
        .getElementById("btn-goals-print")
        ?.addEventListener("click", async () => {
          printElementById("goalsCard");
          if (typeof supaLogToolUsage === "function") {
            try {
              await supaLogToolUsage("murtakaz_goals_print", metaSnapshot());
            } catch (_) {}
          }
        });
    </script>

    <!-- Supabase -->
    <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script defer src="/assets/js/supabase-client.js"></script>

    <!-- Auth0 SDK -->
    <script
      defer
      src="https://cdn.auth0.com/js/auth0-spa-js/2/auth0-spa-js.production.js"
      onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"
    ></script>
    <!-- Component loader + navbar behavior -->
    <script src="assets/js/component-loader.js"></script>
    <script src="assets/js/navbar.js"></script>
    <!-- ุญูุงูุฉ ุงูุตูุญุฉ -->
    <script defer src="/assets/js/require-auth.js"></script>
  </body>
</html>
