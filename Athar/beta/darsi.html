<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ุฏุฑุณู โ ุฎุทุฉ ุฏุฑุณ ุฐููุฉ (ุชููู + ุชุญููู ูุญุชูู)</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="dark light">
<style>
  /* ุชุญุณููุงุช ุฎูููุฉ ููู style.css */
  .field{ margin:10px 0 }
  .field label{ display:block; font-weight:700; margin:6px 0 }
  .field input,.field textarea,.field select{
    width:100%; padding:12px; border-radius:12px;
    border:1px solid rgba(59,130,246,.35); background:#fff; color:#0f172a;
  }
  .dark .field input,.dark .field textarea,.dark .field select{
    background:#0f172a; color:#f1f5f9; border-color:#3b82f6;
  }
  .muted-mini{ font-size:13px; opacity:.85 }
  .cols-2{ display:grid; gap:12px; grid-template-columns:1fr }
  .cols-3{ display:grid; gap:12px; grid-template-columns:1fr }
  @media(min-width:800px){
    .cols-2{ grid-template-columns:1fr 1fr }
    .cols-3{ grid-template-columns:1fr 1fr 1fr }
  }
  .printable{
    border:1px dashed rgba(59,130,246,.35); border-radius:12px; padding:14px; margin-top:8px;
    background:rgba(255,255,255,.5)
  }
  .dark .printable{ background:rgba(17,24,39,.35) }
  .list{ margin:0; padding-inline-start:1.2rem }
  .hl{ background:linear-gradient(90deg,#e6f2ff80,#ffffff00); border-radius:8px; padding:6px 8px }
  .pill{ display:inline-block; padding:.28rem .65rem; border-radius:999px; background:var(--sea-100); color:#0c4a6e; border:1px solid rgba(59,130,246,.25); font-size:.82rem }
  .dark .pill{ background:#0f172a; color:#e2e8f0; border-color:#3b82f6 }
  table.rubric{ width:100%; border-collapse:collapse; margin-top:8px }
  table.rubric td,table.rubric th{ border:1px solid rgba(59,130,246,.25); padding:10px; text-align:center }
  .actions-row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }

  /* ุงุฎุชุจุงุฑ ูุจูู ุตุบูุฑ */
  .quiz-quick{ display:grid; gap:10px; grid-template-columns:1fr }
  @media(min-width:800px){ .quiz-quick{ grid-template-columns:1fr 1fr 1fr } }
  .quiz-box{ border:1px solid rgba(59,130,246,.22); border-radius:12px; padding:12px; background:var(--card) }
  .quiz-box h4{ margin:0 0 6px; font-size:16px; color:var(--sea-600) }
  .quiz-box input{ width:100%; padding:10px; border-radius:10px; border:1px solid rgba(59,130,246,.35) }

  /* ููุทุจุงุนุฉ: ุฃุธูุฑ ููุท ุงููุญุชูู */
  @media print{
    .topbar,.tag,.actions-row,.quiz-quick,.field,.btn{ display:none !important }
    header{ padding-bottom:0 }
  }
</style>
</head>
<body>
  <!-- ุฎูููุงุช -->
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <!-- ุงูุดุฑูุท ุงูุนููู (ูุทุงุจู ููุฎุทุท) -->
  <div class="topbar">
    <div class="left-actions">
      <a class="btn" href="index.html" title="ุงูุฑุฆูุณูุฉ">ุงูุฑุฆูุณูุฉ</a>
      <a class="btn" id="nav-athar" href="athar.html" title="ุฃุซุฑ" style="display:none">ุฃุซููุฑ</a>
    </div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="ุงููุถุน ุงูุฏุงูู/ุงููุงุชุญ">๐</button>
    </div>
    <div class="user">
      <span id="nav-auth" style="display:none; gap:10px">
        <a class="btn" href="#" onclick="openModal('#modal-register');return false;">ุชุณุฌูู</a>
        <a class="btn" href="#" onclick="openModal('#modal-login');return false;">ุฏุฎูู</a>
      </span>
      <a id="nav-programs" class="btn" href="programs.html" style="display:inline-flex">ุจุฑุงูุฌูุง</a>
      <a id="nav-profile" class="btn" href="profile.html" style="display:none">ุงูููู ุงูุดุฎุตู</a>
    </div>
  </div>

  <!-- ุงูููุฏุฑ -->
  <header>
    <div class="hero">
      <h1 class="logo">ุฏุฑุณู</h1>
      <div class="tag"><span class="dot"></span>ุญูู ููุชูู ุงูุชุฎุทูุท ุงูุฐูู ุจุงูุชุญููู ุงูุนูููโฆ ูุชูููู ยซุฃุซุฑยป ุงูุฏุฑุณ.</div>
    </div>
  </header>

  <main>
    <div class="container">

      <!-- ุงูุฅุฏุฎุงูุงุช -->
      <section class="card">
        <h2 class="title">ูุฏุฎูุงุช ุงูุฎุทุฉ</h2>

        <!-- ุงุฎุชูุงุฑ ููุท ุงูุฅุฏุฎุงู: ููุถูุน ุฃู ูุต ููุชุญููู -->
        <div class="cols-3">
          <div class="field">
            <label>ููุท ุงูุฅุฏุฎุงู</label>
            <select id="f-mode">
              <option value="topic" selected>ููุถูุน ูุฎุชุตุฑ</option>
              <option value="text">ูุต ููุชุญููู (ููุฑุฉ ูู ุงููุชุงุจ/ูุฐูุฑุฉ)</option>
            </select>
            <div class="muted-mini">ุนูุฏ ุงุฎุชูุงุฑ โูุต ููุชุญูููโ ุณูุณุชูุชุฌ ุฃูุนุงู ุจููู ุชููุงุฆููุง.</div>
          </div>

          <div class="field">
            <label>ุงููุฆุฉ ุงูุนููุฑููุฉ</label>
            <select id="f-age">
              <option value="p1">ุงุจุชุฏุงุฆู ุฏูููุง (1โ3)</option>
              <option value="p2" selected>ุงุจุชุฏุงุฆู ุนูููุง (4โ6)</option>
              <option value="m">ูุชูุณุท</option>
              <option value="h">ุซุงููู</option>
            </select>
          </div>

          <div class="field">
            <label>ุฒูู ุงูุญุตุฉ (ุฏูููุฉ)</label>
            <input id="f-duration" type="number" min="15" max="90" step="5" value="45">
          </div>
        </div>

        <div class="cols-2" id="mode-topic">
          <div class="field">
            <label>ุงููุงุฏุฉ</label>
            <input id="f-subject" placeholder="ุฑูุงุถูุงุช / ุนููู / ูุบุฉ ุนุฑุจูุฉ โฆ">
          </div>
          <div class="field">
            <label>ุงูููุถูุน</label>
            <input id="f-topic" placeholder="ุงููุณูุฑ / ุฏูุฑุฉ ุญูุงุฉ ุงููุจุงุช / ุงููุจุชุฏุฃ ูุงูุฎุจุฑ โฆ">
          </div>
        </div>

        <div class="field" id="mode-text" style="display:none">
          <label>ุงููุต ููุชุญููู</label>
          <textarea id="f-text" rows="5" placeholder="ุฃูุตูู ููุฑุฉ ูู ุงููุตุฏุฑโฆ ุณููุชุฑุญ ุฃูุฏุงููุง ููุณุชูู ุจููู ุจูุงุกู ุนูู ุงูุฃูุนุงู ุงูุธุงูุฑุฉ (ุญููู/ูุงุฑู/ุทุจูู/ุงุฐูุฑ)โฆ"></textarea>
        </div>

        <div class="cols-2">
          <div class="field">
            <label>ูุณุชูู ุจููู ุงูุฃุณุงุณู</label>
            <select id="f-bloom-main">
              <option value="remember">ุชุฐูุฑ</option>
              <option value="understand" selected>ููู</option>
              <option value="apply">ุชุทุจูู</option>
              <option value="analyze">ุชุญููู</option>
              <option value="evaluate">ุชูููู</option>
              <option value="create">ุฅุจุฏุงุน</option>
            </select>
            <div class="muted-mini">ูููู ุฃู ููุณุชุจุฏู ุชููุงุฆููุง ุนูุฏ ุชุญููู ุงููุต.</div>
          </div>
          <div class="field">
            <label>ูุณุชูู ุจููู ุงูุฏุงุนู (+2)</label>
            <select id="f-bloom-support">
              <option value="">(ุงุฎุชูุงุฑู)</option>
              <option value="remember">ุชุฐูุฑ</option>
              <option value="understand">ููู</option>
              <option value="apply" selected>ุชุทุจูู</option>
              <option value="analyze">ุชุญููู</option>
              <option value="evaluate">ุชูููู</option>
              <option value="create">ุฅุจุฏุงุน</option>
            </select>
          </div>
        </div>

        <div class="cols-2">
          <div class="field">
            <label>ุนุฏุฏ ุงูุฃูุฏุงู</label>
            <select id="f-goal-count"><option>1</option><option selected>2</option><option>3</option></select>
          </div>
          <div class="field">
            <label>ููุงุญุธุงุช ุฎุงุตุฉ (ุงุฎุชูุงุฑู)</label>
            <input id="f-notes" placeholder="ูููุฏ ุตููุฉุ ุฃุฏูุงุช ูุชุงุญุฉโฆ">
          </div>
        </div>

        <div class="cols-2">
          <div class="field">
            <label>ุงูุชุนูู ุงูุชูููู</label>
            <select id="f-adapt">
              <option value="off" selected>ุจุฏูู ุงุฎุชุจุงุฑ ูุจูู</option>
              <option value="on">ูุนูู ุงุฎุชุจุงุฑ ูุจูู (3 ุฃุณุฆูุฉ)</option>
            </select>
            <div class="muted-mini">ุฅุฐุง ูุนููุชูู ุณููููุฏ 3 ุฃุณุฆูุฉ + ูุฏุฎู ูุชุงุฆุฌ ุณุฑูุน ูุชุนุฏูู ุงูุฎุทุฉ.</div>
          </div>
          <div class="field">
            <label>ุชูุฏูุฑ ุฃููู ููุณุชูู ุงูุตู</label>
            <select id="f-level">
              <option value="mixed" selected>ูุชูุงูุช</option>
              <option value="low">ูุญุชุงุฌ ุฏุนู</option>
              <option value="high">ูุชูุฏู</option>
            </select>
          </div>
        </div>

        <div class="actions-row">
          <button class="btn primary" id="btn-analyze">ุชุญููู ุงููุญุชูู (ุงุฎุชูุงุฑู)</button>
          <button class="btn" id="btn-generate">ุชูููุฏ ุงูุฎุทุฉ ุงูุขู</button>
          <button class="btn" id="btn-copy-full">ูุณุฎ ุงูุฎุทุฉ ูุงููุฉ</button>
          <button class="btn" id="btn-classroom">ูุณุฎ ููุงูุจ Google Classroom</button>
          <button class="btn" id="btn-teams">ูุณุฎ ููุงูุจ Microsoft Teams</button>
          <button class="btn" id="btn-print">ุทุจุงุนุฉ</button>
        </div>
      </section>

      <!-- ุนูุฏ ุชูุนูู ุงูุงุฎุชุจุงุฑ ุงููุจูู -->
      <section class="card" id="pre-quiz" style="display:none">
        <h2 class="title">ุงุฎุชุจุงุฑ ูุจูู (3 ุฃุณุฆูุฉ)</h2>
        <p class="lead">ููููู ุจุณุฑุนุฉ: ุงูุชุจู **ุนุฏุฏ ุงูุทุงูุจุงุช ุงูููุงุชู ุฃุฎููู** ูู ูู ุณุคุงู (ูู ุฃุตู ุงูุนุฏุฏ ุงูููู).</p>
        <div class="quiz-quick" id="quizWrap"></div>
        <div class="actions-row">
          <button class="btn primary" id="btn-adapt-apply">ุชุทุจูู ุงูุชุนุฏูู ุนูู ุงูุฎุทุฉ</button>
        </div>
      </section>

      <!-- ุงููุฎุฑุฌุงุช -->
      <section class="card" id="out-summary" style="display:none">
        <h2 class="title">ููุฎุต ุงูุฎุทุฉ</h2>
        <p class="lead" id="out-head">โ</p>
        <div id="out-adapt" class="hl" style="display:none; margin-top:8px"></div>
        <ul class="list" id="out-bullets" style="margin-top:8px"></ul>
        <div style="margin-top:8px">
          <span class="pill" id="pill-main"></span>
          <span class="pill" id="pill-sup" style="display:none"></span>
          <span class="pill" id="pill-age"></span>
        </div>
      </section>

      <section class="grid" id="out-grid" style="display:none">
        <div class="box">
          <h3>ูุฎุทุท ุงูุฏุฑุณ (ูุจู/ุฃุซูุงุก/ุจุนุฏ)</h3>
          <ul class="list" id="out-structure"></ul>
        </div>
        <div class="box">
          <h3>ุฃูุดุทุฉ ููุงุฆูุฉ ููุนูุฑ ู(ุจููู)</h3>
          <ol class="list" id="out-activities"></ol>
        </div>
        <div class="box">
          <h3>ุชูููู ุณุฑูุน ูุชุฏุฑูุฌ</h3>
          <ol class="list" id="out-assessment"></ol>
        </div>
        <div class="box">
          <h3>ุชูุงูุฒ: ุฏุนู ูุฅุซุฑุงุก</h3>
          <ul class="list" id="out-diff"></ul>
        </div>
      </section>

      <section class="card" id="out-onemin" style="display:none">
        <h2 class="title">ุฎุทุฉ ุงูุฏูููุฉ ุงููุงุญุฏุฉ</h2>
        <div class="actions-row">
          <button class="btn" onclick="copyEl('#oneMinText')">ูุณุฎ</button>
          <button class="btn primary" onclick="window.print()">ุทุจุงุนุฉ</button>
        </div>
        <div class="printable" id="oneMinCard">
          <h3 style="margin:0 0 6px">ุงูุฏูููุฉ ุงููุงุญุฏุฉ</h3>
          <div id="oneMinText" class="muted">โ</div>
        </div>
      </section>

      <section class="card" id="out-goals" style="display:none">
        <h2 class="title">ุจุทุงูุฉ ุฃูุฏุงู ููุทุจุงุนุฉ</h2>
        <div class="actions-row">
          <button class="btn primary" onclick="window.print()">ุทุจุงุนุฉ</button>
        </div>
        <div class="printable" id="goalsCard">
          <h3 style="margin:0 0 6px">ุฃูุฏุงู ุงูุฏุฑุณ: <span id="goalsTitleOut">โ</span></h3>
          <ul id="goalsList" class="list" style="margin:0"></ul>
          <p style="margin-top:6px"><strong>ูุนุงููุฑ ุงููุฌุงุญ:</strong> <span id="successOut">โ</span></p>
        </div>
      </section>

      <section class="card" id="out-rubric" style="display:none">
        <h2 class="title">ูุตูููุฉ ุชูููู ุณุฑูุนุฉ (ูุงุจูุฉ ููุชุนุฏูู)</h2>
        <table class="rubric" contenteditable="true">
          <thead><tr><th>ุงููุนูุงุฑ</th><th>ููุชุงุฒ</th><th>ุฌูุฏ</th><th>ุจุญุงุฌุฉ ุฏุนู</th></tr></thead>
          <tbody>
            <tr><td>ุงูููู</td><td></td><td></td><td></td></tr>
            <tr><td>ุงูุชุทุจูู</td><td></td><td></td><td></td></tr>
            <tr><td>ุงูุชูุงุตู</td><td></td><td></td><td></td></tr>
          </tbody>
        </table>
        <div class="actions-row">
          <button class="btn primary" onclick="window.print()">ุทุจุงุนุฉ</button>
        </div>
      </section>

    </div>
  </main>

  <footer>
    <p class="foot-line">ุงูุชุนููู ุดุฑุงุฑุฉ ุตุบูุฑุฉโฆ ุชูุถูุก ุนููููุง ูุจูุฑุฉ.</p>
    <p class="foot-name">ูุฏู ุงููุฌูุฑุด</p>
  </footer>

  <div class="toast" id="toast"></div>
  <script src="app.js"></script>
  <script>
    // ====== ููุงููุณ ุจููู + ููุงุชูุญ ุงูุชุญููู ======
    const BLOOM_VERBS = {
      remember:['ูุนุฏูุฏ','ูุณููู','ูุฐูุฑ','ูุชุนุฑูู'],
      understand:['ูุดุฑุญ','ููุฎูุต','ูุนุทู ูุซุงููุง','ููุณูุฑ','ูุตููู'],
      apply:['ูุณุชุฎุฏู','ููุธูู','ูุญูู','ููููุฐ'],
      analyze:['ููููู','ููุงุฑู','ูุณุชูุชุฌ','ูุฑุจุท','ูุตููู ุจุนูู'],
      evaluate:['ูุจุฑูุฑ','ูููุฏ','ูุญูู','ููููู'],
      create:['ูุตููู','ูุฑููุจ','ูุจุชูุฑ','ูุคูู']
    };
    const BLOOM_HINTS = {
      analyze:['ุญููู','ุญูู','ูุงุฑู','ูุฑูู','ุงุณุชูุชุฌ','ุตููู','ุฑุชูุจ'],
      evaluate:['ูููู','ุจุฑูุฑ','ุงููุฏ','ุงุญูู','ูููู'],
      create:['ุตููู','ุงุจุชูุฑ','ุฑููุจ','ุฃููู','ุฎุทูุท'],
      apply:['ุทุจูู','ูุธูู','ุงุณุชุฎุฏู','ุญูู','ูููุฐ'],
      understand:['ุงุดุฑุญ','ูุฎูุต','ูุซุงู','ูุณูุฑ','ุนุฑูู'],
      remember:['ุงุฐูุฑ','ุนุฏูุฏ','ุณููู','ุชุนุฑูู']
    };
    const AGE_TEMPLATES = {
      p1:{before:['ุชููุฆุฉ ุญุณููุฉ ูุตูุฑุฉ (ุจุทุงูุงุช/ุตูุฑ)','ุณุคุงู ุฏุงูุฆ ุจุณูุท','ุชุฐููุฑ ูุทูู ุจููุงุนุฏ ุงูุตู'],
          during:['ูุดุงุท ุซูุงุฆู ูุตูุฑ','ูุนุจุฉ ุชุนููููุฉ ูุฑุชุจุทุฉ ุจุงูููุถูุน','ุชูููุฑ ุจุตูุช ูุณููุน'],
          after:['ุฑุณู ูุนุจูุฑ ุนู ุงูููุฑุฉ','ุชุฐูุฑุฉ ุฎุฑูุฌ ุจูููุฉ/ุตูุฑุฉ','ุฃููู: โุชุนูููุช ุงูููู ุฃูโฆโ']},
      p2:{before:['ุตูุฑุฉ/ููุทุน ูุตูุฑ','ุชูุดูุท ุณุงุจู ูุนุฑูุฉ','ูุฏู ุงูููู ุนูู ุงูุณุจูุฑุฉ'],
          during:['ูุฌููุนุงุช ุตุบูุฑุฉ ุจุฃุฏูุงุฑ','ุชุฌุฑุจุฉ ูุจุณุทุฉ','ุจุทุงูุฉ ูููุฉ ุจุฎุทูุงุช ูุงุถุญุฉ'],
          after:['ุชุฃูู ุณุฑูุน: ูุงุฐุง ุฃุชููุ','ููุฎุต ูู 3 ุฃุณุทุฑ','ุณุคุงู ุฎุชุงูู']},
      m:{ before:['ูุดููุฉ ูุญูุฒุฉ','ุฎุฑูุทุฉ ููุงููู ุฎุงุทูุฉ','ุฅุทุงุฑ ุงููุฌุงุญ'],
          during:['ุชุนูู ุชุนุงููู','ุชุญููู/ุชุฌุฑุจุฉ ูุตูุฑุฉ','ูุณุงุฆู ุนูู ูุณุชููุงุช'],
          after:['ุชุฐูุฑุฉ ุฎุฑูุฌ ุจูุณุชูููู','ุงูุนูุงุณ ูุตูุฑ','ุชูุณุนุฉ ูููุดุฑูุน']},
      h:{ before:['ุณุคุงู ุนุงูู ุงููุณุชูู','ุชุญููุฒ ุงุณุชูุตุงุฆู ูุฑุชุจุท ุจุงูุญูุงุฉ','ุงุชูุงู ุนูู ุงูููุงุชุฌ'],
          during:['ููุงุด ููุธูู','ูููุฉ ุฃุฏุงุฆูุฉ ูุตุบุฑุฉ','ูุฑุงุกุฉ ููุฌูุฉ ูุชุญููู'],
          after:['ุณูู ุชูุฏูุฑ ุฐุงุชู','ุชุฐูุฑุฉ ุฎุฑูุฌ ููุฏูุฉ','ุชุฏููู ุงูุนูุงุณ + ูุฏู ุดุฎุตู']}
    };
    function pick(a){ return a[Math.floor(Math.random()*a.length)] || '' }
    function bullets(el, arr){ el.innerHTML=''; arr.filter(Boolean).forEach(t=>{const li=document.createElement('li'); li.textContent=t; el.appendChild(li);});}
    function showToast(msg){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }
    function copyText(txt){ navigator.clipboard.writeText(txt).then(()=>showToast('ุชู ุงููุณุฎ โ')); }
    function copyEl(sel){ const el=document.querySelector(sel); if(!el) return; copyText(el.innerText||el.textContent||''); }

    // ====== ุชุจุฏูู โููุท ุงูุฅุฏุฎุงูโ ======
    const modeSel = document.getElementById('f-mode');
    const modeTopic = document.getElementById('mode-topic');
    const modeText  = document.getElementById('mode-text');
    modeSel.addEventListener('change', ()=>{
      const isText = modeSel.value === 'text';
      modeText.style.display  = isText ? '' : 'none';
      modeTopic.style.display = isText ? 'none' : '';
    });

    // ====== ุชุญููู ุงููุญุชูู (ูุณุชูุชุฌ ุจููู + ุฃูุฏุงู) ======
    function inferBloomFrom(text){
      text = (text||'').replace(/[^\u0600-\u06FF\s]/g,' ');
      const ranks=['create','evaluate','analyze','apply','understand','remember']; // ูุนุทู ุฃููููุฉ ููุฃุนูู
      for(const lvl of ranks){
        const keys = BLOOM_HINTS[lvl]||[];
        if(keys.some(k => text.includes(k))) return lvl;
      }
      return 'understand';
    }
    function genGoals(topic,count,mainBloom,supportBloom){
      const v1 = pick(BLOOM_VERBS[mainBloom]||['ููุถุญ']);
      const v2 = supportBloom ? pick(BLOOM_VERBS[supportBloom]||[]) : null;
      const out = [];
      out.push(`${v1} ุงููุชุนููู/ูุฉ ููููู "${topic}" ุนููููุง.`);
      if(count>1) out.push(`ุฃู ${v1} ุงูููุฑุฉ ูู ููุงูู ุตููุฉ ูุตูุฑุฉ.`);
      if(count>2 && v2) out.push(`ุฃู ${v2} ููุงุชุฌ ุงูุชุนูู ุจุชูุซููุงุช ูุชุนุฏุฏุฉ.`);
      return out.slice(0,count);
    }
    function genSuccessCriteria(mainBloom){
      const v = pick(BLOOM_VERBS[mainBloom]||['ููุถุญ']);
      return `ุฃุชุญูู ุฅุฐุง ูุงู ุงูุทุงูุจ ${v} ุงูููููู ุจุฏูุฉุ ููุทุจููู ูู ูุซุงู ุฌุฏูุฏ ุฏูู ูุณุงุนุฏุฉ.`;
    }
    function genActivities(age,mainBloom,supportBloom,topic){
      const t = AGE_TEMPLATES[age] || AGE_TEMPLATES.p2;
      const v1 = pick(BLOOM_VERBS[mainBloom]||[]);
      const v2 = supportBloom ? pick(BLOOM_VERBS[supportBloom]||[]) : null;
      return [
        `ูุจู ุงูุชุนูู: ${pick(t.before)}.`,
        `ุฃุซูุงุก ุงูุชุนูู (ุงููุดุงุท ุงูุฑุฆูุณู โ ${v1}): ูุดุงุท ูุทุจูู "${topic}" ุจุฎุทูุงุช ูุงุถุญุฉ.`,
        v2 ? `ูุดุงุท ุฏุงุนู โ ${v2}: ูุบุฒ/ูููู ุชุทุจููู ูุชุนููู "${topic}".` : null,
        `ุจุนุฏ ุงูุชุนูู: ${pick(t.after)}.`
      ].filter(Boolean);
    }
    function genAssessment(mainBloom,supportBloom,topic){
      const easy='ุนุฏูุฏ ููุทุชูู ุฃุณุงุณูุชูู';
      const mid = pick(BLOOM_VERBS[mainBloom]||['ุงุดุฑุญ']);
      const adv = pick(BLOOM_VERBS[supportBloom||mainBloom]||['ูุธูู']);
      return [
        `ุณูก (ุณูู): ${easy} ุญูู "${topic}".`,
        `ุณูข (ูุชูุณุท): ${mid} ุงูููุฑุฉ ุจูุซุงู ูู ุญูุงุชู.`,
        `ุณูฃ (ูุชูุฏู): ${adv} "${topic}" ูู ูููุฉ ุตุบูุฑุฉ.`
      ];
    }
    function genDiff(age,topic){
      return [
        `ุฏุนู: ุจุทุงูุงุช ุชูููุญ/ุฃูุซูุฉ ูุญูููุฉ ูุฑุชุจุทุฉ ุจู"${topic}".`,
        `ุฅุซุฑุงุก: ุชุญุฏู ูุตูุฑ ูุฑุจุท "${topic}" ุจุณูุงู ุญูููู ุฃู ูุงุฏุฉ ุฃุฎุฑู.`,
        `ูุฑููุฉ ุงูุนุฑุถ: ูุชุงุจุฉ/ุฑุณู/ุนุฑุถ ุดููู ุญุณุจ ุชูุถูู ุงูุทุงูุจ.`
      ];
    }
    function genStructure(age,duration){
      const t = AGE_TEMPLATES[age] || AGE_TEMPLATES.p2;
      return [
        `ูุจู: ${pick(t.before)} (5โ7 ุฏ).`,
        `ุฃุซูุงุก: ุชุนูู ููุฌู + ุชุนุงูู (${Math.max(20, duration-15)} ุฏ).`,
        `ุจุนุฏ: ${pick(t.after)} (5โ8 ุฏ).`
      ];
    }
    function genOneMinute(topic){
      return `ูู ุฏูููุฉ: ูุฎูุตู "${topic}" ูู ุฌููุฉุ ุซู ุฃุนุทู ูุซุงููุง ูู ุญูุงุชู ูุฏุนู ุงูููุฑุฉ.`;
    }

    // ====== ุชูููุฏ ุฃุณุฆูุฉ ุงุฎุชุจุงุฑ ูุจูู ======
    function makePreQuiz(topic, mainBloom, supportBloom){
      const q1 = `ุณูก ุชูููุฏู: ุงุฐูุฑู (ุฃู ุนุฑููู) ููุฑุฉ ุฃุณุงุณูุฉ ุนู "${topic}".`;
      const q2 = `ุณูข ${pick(BLOOM_VERBS[mainBloom]||['ุงุดุฑุญ'])}: ุงุดุฑุญู "${topic}" ุจูุซุงู ูุจุณูุท.`;
      const q3 = `ุณูฃ ${pick(BLOOM_VERBS[supportBloom||mainBloom]||['ุทุจูู'])}: ุทุจููู "${topic}" ูู ูููู ูุตูุฑ.`;
      return [q1,q2,q3];
    }

    // ====== ุฑุจุท ุงูุฃุฒุฑุงุฑ ======
    const fAge = document.getElementById('f-age');
    const fDur = document.getElementById('f-duration');
    const fMain = document.getElementById('f-bloom-main');
    const fSup  = document.getElementById('f-bloom-support');
    const fGoal = document.getElementById('f-goal-count');
    const fNotes= document.getElementById('f-notes');
    const fAdapt= document.getElementById('f-adapt');
    const fLevel= document.getElementById('f-level');

    const btnAnalyze = document.getElementById('btn-analyze');
    const btnGen     = document.getElementById('btn-generate');
    const btnCopy    = document.getElementById('btn-copy-full');
    const btnClass   = document.getElementById('btn-classroom');
    const btnTeams   = document.getElementById('btn-teams');
    const btnPrint   = document.getElementById('btn-print');

    const outSummary = document.getElementById('out-summary');
    const outGrid    = document.getElementById('out-grid');
    const outOneMin  = document.getElementById('out-onemin');
    const outGoals   = document.getElementById('out-goals');
    const outRubric  = document.getElementById('out-rubric');

    const pillMain = document.getElementById('pill-main');
    const pillSup  = document.getElementById('pill-sup');
    const pillAge  = document.getElementById('pill-age');

    let CURRENT = { subject:'', topic:'', main:'understand', sup:'', age:'p2', duration:45, goals:[], success:'', activities:[], assessment:[], structure:[], oneMin:'', notes:'', adaptMsg:'' };

    // ุชุญููู ุงููุญุชูู
    btnAnalyze.addEventListener('click', ()=>{
      const mode = document.getElementById('f-mode').value;
      if(mode!=='text'){ showToast('ุงุฎุชุงุฑู: ูุต ููุชุญููู ุฃูููุง'); return; }
      const text = document.getElementById('f-text').value || '';
      if(!text.trim()){ showToast('ุงูุตููู ููุฑุฉ ููุชุญููู'); return; }

      const inferred = inferBloomFrom(text);
      fMain.value = inferred; // ูุญุฏูุซ ุจููู ุงูุฃุณุงุณู
      showToast(`ุชู ุงูุงุณุชุฏูุงู ุนูู ูุณุชูู ุจููู: ${inferred}`);
    });

    // ุชูููุฏ ุงูุฎุทุฉ
    btnGen.addEventListener('click', ()=>{
      const mode = document.getElementById('f-mode').value;
      const subject = (document.getElementById('f-subject')?.value||'').trim() || 'โ';
      let topic = (document.getElementById('f-topic')?.value||'').trim();
      const sourceText = (document.getElementById('f-text')?.value||'').trim();

      const age = fAge.value; const duration = +fDur.value||45;
      const main = fMain.value; const sup = fSup.value||'';
      const goalCount = +fGoal.value||2; const notes = fNotes.value.trim();
      const level = fLevel.value; const adapt = fAdapt.value==='on';

      if(mode==='topic' && !topic){ showToast('ุงูุชุจู ุงูููุถูุนโฆ'); return; }
      if(mode==='text'){
        if(!sourceText){ showToast('ุงูุตูู ูุตูุง ุฃูููุงโฆ'); return; }
        // ูู ูุง ูุชุจุช ููุถูุนุ ููุชุจุณ ุนููุงููุง ุจุณูุทูุง ูู ุฃูู ุฌููุฉ
        topic = topic || (sourceText.split(/[.!ุ\n]/)[0].slice(0,60)+'โฆ');
      }

      // ุชูููุฏ
      const goals = genGoals(topic, goalCount, main, sup);
      const structure = genStructure(age, duration);
      const activities = genActivities(age, main, sup, topic);
      const assessment = genAssessment(main, sup, topic);
      const oneMin = genOneMinute(topic);
      const success = genSuccessCriteria(main);

      // ุญูุธ ุงูุญุงูุฉ
      CURRENT = { subject, topic, main, sup, age, duration, goals, success, activities, assessment, structure, oneMin, notes, adaptMsg:'' };

      // ุชุนุจุฆุฉ ุงููุงุฌูุฉ
      document.getElementById('out-head').textContent = `ุงููุงุฏุฉ: ${subject} โ ุงูููุถูุน: "${topic}" โ ุงูุฒูู: ${duration} ุฏูููุฉ`;
      bullets(document.getElementById('out-bullets'), [
        notes ? `ููุงุญุธุฉ ุงููุนูู: ${notes}` : null,
        (sup ? 'ุฏูุฌ ูุณุชูููู ูู ุจููู (ุฃุณุงุณู + ุฏุงุนู).' : 'ุชุฑููุฒ ุนูู ูุณุชูู ุจููู ุฃุณุงุณู ูุงุญุฏ.')
      ]);
      const outAdapt = document.getElementById('out-adapt'); outAdapt.style.display='none'; outAdapt.textContent='';
      pillMain.textContent = 'ุจููู (ุฃุณุงุณู): '+main;
      pillSup.style.display = sup? 'inline-block':'none';
      if(sup) pillSup.textContent = 'ุจููู (+2): '+sup;
      pillAge.textContent = 'ุงูุนูุฑ: '+({p1:'ุงุจุชุฏุงุฆู ุฏูููุง',p2:'ุงุจุชุฏุงุฆู ุนูููุง',m:'ูุชูุณุท',h:'ุซุงููู'}[age]||age);

      bullets(document.getElementById('out-structure'), structure);
      bullets(document.getElementById('out-activities'), activities);
      bullets(document.getElementById('out-assessment'), assessment);
      bullets(document.getElementById('out-diff'), genDiff(age, topic));

      document.getElementById('oneMinText').textContent = oneMin;
      document.getElementById('goalsTitleOut').textContent = topic;
      const gl = document.getElementById('goalsList'); gl.innerHTML=''; goals.forEach(g=>{ const li=document.createElement('li'); li.textContent=g; gl.appendChild(li); });
      document.getElementById('successOut').textContent = success;

      // ุฅุธูุงุฑ ุงูุฃูุณุงู
      outSummary.style.display=''; outGrid.style.display=''; outOneMin.style.display=''; outGoals.style.display=''; outRubric.style.display='';

      // ุชูุนูู/ุฅุฎูุงุก ุงูุงุฎุชุจุงุฑ ุงููุจูู
      const pq = document.getElementById('pre-quiz');
      if(adapt){
        pq.style.display='';
        // ุจูุงุก ุฃุณุฆูุฉ
        const qs = makePreQuiz(topic, main, sup);
        const wrap = document.getElementById('quizWrap'); wrap.innerHTML='';
        qs.forEach((q,i)=>{
          const box = document.createElement('div'); box.className='quiz-box';
          box.innerHTML = `
            <h4>ุณุคุงู ${i+1}</h4>
            <div class="muted-mini">${q}</div>
            <label style="display:block; margin-top:8px">ุนุฏุฏ ุงููุฎุทูุฆูู</label>
            <input type="number" min="0" value="0" data-q="${i}">
          `;
          wrap.appendChild(box);
        });
      }else{
        pq.style.display='none';
      }

      showToast('ุชู ุชูููุฏ ุงูุฎุทุฉ ๐');
      window.scrollTo({ top: outSummary.offsetTop - 10, behavior: 'smooth' });
    });

    // ุชุทุจูู ุงูุชููู ุจูุงุกู ุนูู ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ ุงููุจูู
    document.getElementById('btn-adapt-apply').addEventListener('click', ()=>{
      const inputs = Array.from(document.querySelectorAll('#quizWrap input[type="number"]'));
      if(!inputs.length){ showToast('ูููุฏู ุงูุฎุทุฉ ุฃููุงู'); return; }
      const wrong = inputs.map(i => +i.value||0);
      const totalWrong = wrong.reduce((a,b)=>a+b,0);

      // ูุงุนุฏุฉ ุจุณูุทุฉ: ุฅุฐุง ุงูุฎุทุฃ ุงูุฃูุจุฑ ูู ุณ1 โ ูุนุฒุฒ "ุงูุชุฐูุฑ/ุงูููู"
      // ุฅุฐุง ูู ุณ2 โ ูุนุฒุฒ ุงููุณุชูู ุงูุฃุณุงุณู
      // ุฅุฐุง ูู ุณ3 โ ูุนุฒุฒ ุงููุณุชูู ุงูุฏุงุนู/ุงูุชุทุจููู
      let focus='';
      const maxIdx = wrong.indexOf(Math.max(...wrong));
      if(maxIdx===0) focus = 'ุชุนุฒูุฒ ุงูุชููุฆุฉ ูุงูููุงููู ุงูุฃุณุงุณูุฉ (ุชุฐููุฑ/ููู).';
      else if(maxIdx===1) focus = 'ุชูููุฉ ุงููุดุงุท ุงูุฑุฆูุณู ููู ุจููู ุงูุฃุณุงุณู.';
      else focus = 'ุฒูุงุฏุฉ ููุงู ุงูุชุทุจูู/ุงูุชูุณูุน (ุงููุณุชูู ุงูุฏุงุนู).';

      CURRENT.adaptMsg = `ุชูููู ุชููุงุฆู ุจูุงุก ุนูู ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ ุงููุจูู: ${focus} (ุฅุฌูุงูู ุฅุฌุงุจุงุช ุฎุงุทุฆุฉ: ${totalWrong}).`;
      const outAdapt = document.getElementById('out-adapt');
      outAdapt.textContent = CURRENT.adaptMsg;
      outAdapt.style.display = '';

      // ุชุนุฏูู ุฎููู ูู ุงูุฃูุดุทุฉ
      const extra = (maxIdx===0) ? `ุฅุถุงูุฉ ุฃูุซูุฉ ููููุณุฉ ุฃูุซุฑ ูู ุงูุชููุฆุฉ.` :
                    (maxIdx===1) ? `ุชูุณูู ุงููููุฉ ุงูุฑุฆูุณูุฉ ุฅูู ุฎุทูุงุช ุฃูุถุญ.` :
                                   `ุชูุฑูู ุชุทุจููู ุฅุถุงูู ุจููุช ูุตูุฑ.`;

      const acts = CURRENT.activities.slice();
      acts.push(`๐ง ุชุนุฏูู ุชูููู: ${extra}`);
      bullets(document.getElementById('out-activities'), acts);

      showToast('ุชู ุชุทุจูู ุงูุชูููู โ');
    });

    // ูุณุฎ ุงูุฎุทุฉ ูุงููุฉ
    btnCopy.addEventListener('click', ()=>{
      const txt = exportFullText(CURRENT);
      copyText(txt);
    });

    // ูุณุฎ ูููุงูุจ Classroom/Teams
    btnClass.addEventListener('click', ()=> copyText(exportClassroom(CURRENT)));
    btnTeams.addEventListener('click',  ()=> copyText(exportTeams(CURRENT)));

    // ุทุจุงุนุฉ
    btnPrint.addEventListener('click', ()=> window.print());

    function exportFullText(S){
      const lines = [];
      lines.push(`ุงูุนููุงู: ${S.topic} โ (${S.subject})`);
      if(S.adaptMsg) lines.push(S.adaptMsg);
      lines.push(`ุงูุฒูู: ${S.duration} ุฏูููุฉ โ ุงูุนูุฑ: ${({p1:'ุงุจุชุฏุงุฆู ุฏูููุง',p2:'ุงุจุชุฏุงุฆู ุนูููุง',m:'ูุชูุณุท',h:'ุซุงููู'}[S.age]||S.age)}`);
      lines.push(`ุจููู (ุฃุณุงุณู): ${S.main}${S.sup?(' + '+S.sup):''}`);
      if(S.notes) lines.push(`ููุงุญุธุงุช ุงููุนูู: ${S.notes}`);
      lines.push('\nุงูุฃูุฏุงู:'); S.goals.forEach((g,i)=>lines.push(`- ${g}`));
      lines.push('\nูุฎุทุท ุงูุฏุฑุณ:'); S.structure.forEach(s=>lines.push(`- ${s}`));
      lines.push('\nุฃูุดุทุฉ:'); S.activities.forEach(a=>lines.push(`- ${a}`));
      lines.push('\nุชูููู ุณุฑูุน:'); S.assessment.forEach(a=>lines.push(`- ${a}`));
      lines.push('\nุชูุงูุฒ:'); genDiff(S.age,S.topic).forEach(a=>lines.push(`- ${a}`));
      lines.push('\nุงูุฏูููุฉ ุงููุงุญุฏุฉ:'); lines.push(`- ${S.oneMin}`);
      lines.push('\nูุนุงููุฑ ุงููุฌุงุญ:'); lines.push(`- ${S.success}`);
      return lines.join('\n');
    }
    function exportClassroom(S){
      return [
`[Google Classroom]
ุงูุนููุงู: ${S.topic} โ ${S.subject}`,
`ุงูุชุนูููุงุช:
- ุงูุฑุฃ/ู ุงููุฏู: ${S.goals[0]||'-'}.
- ูููุฐู ุงููุดุงุท ุงูุฑุฆูุณู ุซู ุฃุฑุณูู ุชุฐูุฑุฉ ุงูุฎุฑูุฌ.`,
`ุงูููุงุฏ: (ููุญุฏูุฏ ุงููุนูู)`,
`ุงูุชุงุฑูุฎ/ุงูููุช: (ููุญุฏูุฏ ุงููุนูู)`,
`ุงูุชูููู ุงูุณุฑูุน:
1) ${S.assessment[0]||'-'}
2) ${S.assessment[1]||'-'}
3) ${S.assessment[2]||'-'}`,
`ุชูุงูุฒ:
- ุฏุนู: ${genDiff(S.age,S.topic)[0]}
- ุฅุซุฑุงุก: ${genDiff(S.age,S.topic)[1]}`
      ].join('\n');
    }
    function exportTeams(S){
      return [
`[Microsoft Teams Assignment]
Title: ${S.topic} โ ${S.subject}
Instructions:
- Goals: ${S.goals.join(' | ')}
- Main Activity: ${S.activities[1]||'-'}
- Exit Ticket: ${S.assessment[0]||'-'}
Rubric: (paste from page)
Due: (set by teacher)`
      ].join('\n');
    }
  </script>
</body>
</html>
