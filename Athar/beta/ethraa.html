<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¥Ø«Ø±Ø§Ø¡</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="dark light">

<!-- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ… Ù…Ø¨ÙƒØ±Ù‹Ø§ (Ù…Ø«Ù„ Ø¨Ù‚ÙŠØ© Ø§Ù„ØµÙØ­Ø§Øª) -->
<script>
  (function(){
    try{
      var c = localStorage.getItem('athar:theme');
      if (c) document.documentElement.style.setProperty('--primary', c);
    }catch(_){}
  })();
</script>

<style>
  .field{ margin:10px 0 }
  .field label{ display:block; font-weight:700; margin:6px 0 }
  .field input,.field select{ width:100%; padding:12px; border-radius:12px; border:1px solid rgba(59,130,246,.35) }
  .cards{ display:grid; gap:14px; grid-template-columns:1fr }
  @media(min-width:900px){ .cards{ grid-template-columns:1fr 1fr } }
  .idea{ background:var(--card); border:1px solid rgba(59,130,246,.22); border-radius:16px; padding:16px; box-shadow:var(--shadow) }
  .idea h4{ margin:0 0 8px; color:var(--sea-600) }
  .idea p{ margin:.2rem 0 }
  .idea ul{ margin:.3rem 0 0 0; padding-inline-start:1.2rem }
  .tags{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  .tag{ font-size:.82rem; padding:.24rem .6rem; border-radius:999px; border:1px solid rgba(59,130,246,.25); background:var(--sea-100); color:#0c4a6e }
  .dark .tag{ background:#0f172a; color:#e2e8f0; border-color:#3b82f6 }
  .muted{opacity:.75}
  .skeleton{border-radius:14px; height:110px; background:linear-gradient(90deg,#eee 0%,#f6f6f6 40%,#eee 80%); background-size:200% 100%; animation:sh 1.2s infinite}
  @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
  @media print{ .topbar,.actions-row,.field,.btn{ display:none !important } }
</style>
</head>
<body>
  <div class="global-bg"></div>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· -->
  <div class="topbar">
    <div class="left-actions"><a class="btn" href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></div>
    <div class="actions"><button class="btn" id="themeToggle">ğŸŒ“</button></div>
    <div class="user"><a class="btn" href="programs.html">Ù…Ø³Ø§Ø­Ø© Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ</a></div>
  </div>

  <header>
    <div class="hero">
      <h1 class="logo">Ø¥Ø«Ù€Ù€Ø±Ø§Ø¡</h1>
      <div class="tag"><span class="dot"></span>Ø£ÙÙƒØ§Ø± Ù…ÙÙ„Ù‡Ù…Ø©. ØªÙØ¬Ø¯Ø¯ Ø§Ù„Ø¯Ø±Ø³ ÙˆØªÙÙˆØ§ÙƒØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯.</div>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="card">
        <h2 class="title">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„Ù…Ø±Ø­Ù„Ø©</h2>
        <div class="field">
          <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
          <input id="subj" placeholder="Ø¹Ù„ÙˆÙ… / Ø±ÙŠØ§Ø¶ÙŠØ§Øª / Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© / Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª .">
        </div>
        <div class="field">
          <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
          <select id="stage">
            <option value="p1">Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ Ø¯ÙÙ†ÙŠØ§</option>
            <option value="p2" selected>Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ Ø¹ÙÙ„ÙŠØ§</option>
            <option value="m">Ù…ØªÙˆØ³Ø·</option>
            <option value="h">Ø«Ø§Ù†ÙˆÙŠ</option>
          </select>
        </div>
        <div class="field">
          <label>ØªØ±ÙƒÙŠØ² Ø§Ù„Ø¥Ø«Ø±Ø§Ø¡</label>
          <select id="focus">
            <option value="auto" selected>ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø¨Ø¯Ø§Ø¦Ù„)</option>
            <option value="latest">Ø£Ø­Ø¯Ø« Ø§Ù„Ø£Ø¨Ø­Ø§Ø«/Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</option>
            <option value="myth">Ø®Ø±Ø§ÙØ© Ø´Ø§Ø¦Ø¹Ø© + ØªØµØ­ÙŠØ­Ù‡Ø§</option>
            <option value="odd">Ù…Ø¹Ù„ÙˆÙ…Ø© ØºØ±ÙŠØ¨Ø©/Ù…Ø¯Ù‡Ø´Ø©</option>
            <option value="ideas">Ø£ÙÙƒØ§Ø± Ù†Ø´Ø§Ø·/Ù…Ø´Ø±ÙˆØ¹ ØªØ·Ø¨ÙŠÙ‚ÙŠ</option>
          </select>
        </div>
        <div class="actions-row" style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" id="gen">ÙˆÙ„Ù‘Ø¯ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</button>
          <button class="btn" id="copy" disabled>Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</button>
          <button class="btn" id="print" disabled>Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
      </section>

      <section class="card" id="out" style="display:none">
        <h2 class="title">Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø«Ø±Ø§Ø¡</h2>

        <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ -->
        <div class="cards" id="cards"></div>

        <!-- ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‚Ø¯ÙŠÙ…Ø©: Ù‚Ø³Ù… Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù…Ø¬Ø§Ù„ -->
        <div id="nearbyBox" style="display:none; margin-top:16px">
          <h3 class="title" style="margin-bottom:10px">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ù…Ø¬Ø§Ù„</h3>
          <div class="cards" id="nearby"></div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <p class="foot-line">Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø´Ø±Ø§Ø±Ø© ØµØºÙŠØ±Ø©. ØªÙØ¶ÙŠØ¡ Ø¹Ù‚ÙˆÙ„Ù‹Ø§ ÙƒØ¨ÙŠØ±Ø©.</p>
    <p class="foot-name">Ù†Ø¯Ù‰ Ø§Ù„Ù…Ø¬ÙŠØ±Ø´</p>

    <nav class="foot-links">
      <a href="privacy.html">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a><span class="sep">|</span>
      <a href="terms.html">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</a><span class="sep">|</span>
      <a href="refund-policy.html">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</a><span class="sep">|</span>
      <a href="whatsapp.html">ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</a><span class="sep">|</span>
      <a href="complaints.html">Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</a>
    </nav>

    <div class="foot-copy">Â© <span id="year"></span> Ø£Ø«Ù€Ù€Ø± â€” ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</div>
  </footer>

  <script>
    // Ø³Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© + Ù…Ø²Ø§Ù…Ù†Ø© Ù„ÙˆÙ† Ø§Ù„Ø«ÙŠÙ… Ù…Ø¹ ØªØºÙŠÙŠØ±Ù‡ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
    (function(){
      var y=document.getElementById('year');
      if(y) y.textContent=new Date().getFullYear();
      window.addEventListener('athar:theme-color', function(e){
        try{ if(e && e.detail){ document.documentElement.style.setProperty('--primary', e.detail); } }catch(_){}
      });
    })();
  </script>

  <div class="toast" id="toast"></div>

  <script>
  const STAGES = { p1:'Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ Ø¯ÙÙ†ÙŠØ§', p2:'Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ Ø¹ÙÙ„ÙŠØ§', m:'Ù…ØªÙˆØ³Ø·', h:'Ø«Ø§Ù†ÙˆÙŠ' };
  const cardsWrap = document.getElementById('cards');
  const nearbyWrap = document.getElementById('nearby');
  const nearbyBox = document.getElementById('nearbyBox');
  const out = document.getElementById('out');
  const copyBtn = document.getElementById('copy');
  const printBtn = document.getElementById('print');

  // Ø±Ø¨Ø· Auth0 Ù…Ø¹ Supabase users Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
  window.addEventListener('load', () => {
    if (typeof supaEnsureUserProfile === 'function') {
      try { supaEnsureUserProfile(); } catch(_) {}
    }
  });

  function ethraaMeta(){
    return {
      subject: (document.getElementById('subj')?.value || '').trim() || null,
      stage: document.getElementById('stage')?.value || null,
      focus: document.getElementById('focus')?.value || null
    };
  }

  function clean(t){ return String(t||'').replace(/\*\*?|##+|^\s*-\s*/gm,'').trim(); }
  function chip(t){ return `<span class="tag">${t}</span>`; }
  function toast(m){
    const t=document.getElementById('toast'); t.textContent=m;
    t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200);
  }

  function showSkeleton(n=4){
    cardsWrap.innerHTML = '';
    for(let i=0;i<n;i++){
      const sk = document.createElement('div');
      sk.className='skeleton';
      cardsWrap.appendChild(sk);
    }
    nearbyBox.style.display = 'none';
    nearbyWrap.innerHTML = '';
  }

  async function fetchEthraa(subject, stage, focus){
    const res = await fetch('/.netlify/functions/gemini-ethraa', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ subject, stage, focus })
    });
    if(!res.ok) throw new Error('fn_error');
    return res.json();
  }

  // Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¨ØµÙ…Ø©)
  const SEEN_KEY = 'ethraa_seen_v1';
  const seen = new Set((() => {
    try { return JSON.parse(sessionStorage.getItem(SEEN_KEY) || '[]'); } catch { return []; }
  })());
  function saveSeen(){
    try { sessionStorage.setItem(SEEN_KEY, JSON.stringify(Array.from(seen))); } catch(_){}
  }
  function sigOf(card){
    const s = ((card?.title||'') + '|' + (card?.idea||'')).toLowerCase();
    let h=0; for (let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; }
    return String(h);
  }

  function renderCards(container, cards, subject, stage){
    container.innerHTML = '';
    (cards || []).forEach(c=>{
      const title = clean(c.title)||'â€” Ø¨Ø·Ø§Ù‚Ø© â€”';
      const brief = clean(c.brief)||'â€”';
      const idea  = clean(c.idea)||'â€”';
      const source = c.source ? `<div class="muted" style="font-size:.82rem;margin-top:6px">Ù…ØµØ¯Ø±/Ù…Ø±Ø¬Ø¹: <a href="${c.source}" target="_blank" rel="noopener" style="text-decoration:underline">${c.source}</a></div>` : '';
      const staleMark = (c.freshness === 'general') ? `<div class="muted" style="font-size:.82rem; margin-top:6px">Ø¹Ø§Ù…</div>` : '';

      const card = document.createElement('div');
      card.className = 'idea';
      card.innerHTML = `
        <h4>â€¢ ${title}</h4>
        <p class="muted"><strong>Ù„Ù…Ø§Ø°Ø§ØŸ</strong> ${brief}</p>
        <p><strong>Ø§Ù‚ØªØ±Ø§Ø­:</strong> ${idea}</p>
        ${source}
        ${staleMark}
        <div class="tags">
          ${chip(subject)} ${chip(STAGES[stage]||stage)} ${chip('Ø¥Ø«Ø±Ø§Ø¡')}
        </div>`;
      container.appendChild(card);
    });
  }

  document.getElementById('gen').addEventListener('click', async ()=>{
    const s  = (document.getElementById('subj').value||'').trim();
    const st = document.getElementById('stage').value;
    const fc = document.getElementById('focus').value;
    if(!s){ toast('Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ù‹Ø§'); return; }

    out.style.display='block';
    showSkeleton(4);
    copyBtn.disabled = true;
    printBtn.disabled = true;

    try{
      const { ok, cards = [], nearby = undefined, _meta = {} } = await fetchEthraa(s, st, fc);

      // ÙÙ„ØªØ±Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù„Ø³Ø©
      const uniq = [];
      for (const c of cards) {
        const sig = sigOf(c);
        if (seen.has(sig)) continue;
        seen.add(sig); uniq.push(c);
      }
      saveSeen();

      renderCards(cardsWrap, uniq.length ? uniq : cards, s, st);

      if (_meta.all_stale && Array.isArray(nearby) && nearby.length) {
        renderCards(nearbyWrap, nearby, s, st);
        nearbyBox.style.display = 'block';
      } else {
        nearbyBox.style.display = 'none';
        nearbyWrap.innerHTML = '';
      }

      copyBtn.disabled = (cardsWrap.children.length === 0);
      printBtn.disabled = (cardsWrap.children.length === 0);
      toast(ok ? 'ØªÙ… âœ¨' : 'Ø¹ÙØ±Ø¶ Ø¨Ø¯ÙŠÙ„');

      if (typeof supaLogToolUsage === 'function') {
        try { await supaLogToolUsage('ethraa_generate', ethraaMeta()); } catch(_){}
      }
    }catch(e){
      console.error(e);
      cardsWrap.innerHTML = '<div class="muted">ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø«Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†.</div>';
    }
  });

  copyBtn.addEventListener('click', async ()=>{
    const text=[...document.querySelectorAll('.idea')].map(d=>d.innerText).join('\n\nâ€” â€” â€”\n\n');
    await navigator.clipboard.writeText(text);
    toast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…');
    if (typeof supaLogToolUsage === 'function') {
      try { await supaLogToolUsage('ethraa_copy', ethraaMeta()); } catch(_){}
    }
  });

  printBtn.addEventListener('click', async ()=>{
    window.print();
    if (typeof supaLogToolUsage === 'function') {
      try { await supaLogToolUsage('ethraa_print', ethraaMeta()); } catch(_){}
    }
  });
  </script>

  <!-- Auth0 SDK (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙŠÙÙØ¶Ù‘Ù„ Ø¥Ø¨Ù‚Ø§Ø¤Ù‡ Ù…Ø¹ ÙÙˆÙ„Ø¨Ø§Ùƒ) -->
  <script defer src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>

  <!-- Supabase -->
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script defer src="/assets/js/supabase-client.js"></script>

  <!-- Ø§Ù„Ø­Ù…Ø§ÙŠØ© (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø¨Ù‚ Ø£ÙŠ ÙƒÙˆØ¯ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
  <script defer src="/assets/js/require-auth.js"></script>

  <!-- Ø³ÙƒØ±Ø¨ØªØ§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ -->
  <script defer src="/app.js"></script>
</body>
</html>
