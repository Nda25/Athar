<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>إثراء — أفكار وبحوث حديثة</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="dark light">
<style>
  .field{ margin:10px 0 }
  .field label{ display:block; font-weight:700; margin:6px 0 }
  .field input,.field select{ width:100%; padding:12px; border-radius:12px; border:1px solid rgba(59,130,246,.35) }
  .cards{ display:grid; gap:14px; grid-template-columns:1fr }
  @media(min-width:900px){ .cards{ grid-template-columns:1fr 1fr } }
  .idea{ background:var(--card); border:1px solid rgba(59,130,246,.22); border-radius:16px; padding:16px; box-shadow:var(--shadow) }
  .idea h4{ margin:0 0 8px; color:var(--sea-600) }
  .idea p{ margin:.2rem 0 }
  .idea ul{ margin:.3rem 0 0 0; padding-inline-start:1.2rem }
  .tags{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  .tag{ font-size:.82rem; padding:.24rem .6rem; border-radius:999px; border:1px solid rgba(59,130,246,.25); background:var(--sea-100); color:#0c4a6e }
  .dark .tag{ background:#0f172a; color:#e2e8f0; border-color:#3b82f6 }
  @media print{ .topbar,.actions-row,.field,.btn{ display:none !important } }
</style>
</head>
<body>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <!-- الشريط -->
  <div class="topbar">
    <div class="left-actions"><a class="btn" href="index.html">الرئيسية</a></div>
    <div class="actions"><button class="btn" id="themeToggle">🌓</button></div>
    <div class="user"><a class="btn" href="programs.html">مساحة إبداعي</a></div>
  </div>

  <header>
    <div class="hero">
      <h1 class="logo">إثــراء</h1>
      <div class="tag"><span class="dot"></span>أفكار مُلهمة… تسند الدرس وتُجدد الأثر.</div>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="card">
        <h2 class="title">اختر المادة والمرحلة</h2>
        <div class="field">
          <label>المادة</label>
          <input id="subj" placeholder="علوم / رياضيات / لغة عربية / اجتماعيات …">
        </div>
        <div class="field">
          <label>المرحلة</label>
          <select id="stage">
            <option value="p1">ابتدائي دُنيا</option>
            <option value="p2" selected>ابتدائي عُليا</option>
            <option value="m">متوسط</option>
            <option value="h">ثانوي</option>
          </select>
        </div>
        <div class="actions-row" style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" id="gen">ولّدي البطاقات</button>
          <button class="btn" id="copy">نسخ جميع البطاقات</button>
          <button class="btn" id="print">طباعة</button>
        </div>
      </section>

      <section class="card" id="out" style="display:none">
        <h2 class="title">بطاقات الإثراء</h2>
        <div class="cards" id="cards"></div>
      </section>
    </div>
  </main>

  <footer>
    <p class="foot-line">التعليم شرارة صغيرة… تُضيء عقولًا كبيرة.</p>
    <p class="foot-name">ندى المجيرش</p>
  </footer>

  <div class="toast" id="toast"></div>

  <script src="app.js"></script>
  <script>
    const STAGES = { p1:'ابتدائي دُنيا', p2:'ابتدائي عُليا', m:'متوسط', h:'ثانوي' };
    const cardsEl = document.getElementById('cards');
    const outEl   = document.getElementById('out');

    function chip(txt){ return `<span class="tag">${txt}</span>`; }
    function toast(m){ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }

    async function fetchIdeas(subject, stage){
      const res = await fetch('/.netlify/functions/ethraa', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ subject, stage })
      });
      if(!res.ok) throw new Error('server_error');
      const json = await res.json();
      if(!json.ok) throw new Error(json.error||'bad_response');
      return json.items;
    }

    function paint(items, subject, stage){
      cardsEl.innerHTML = '';
      items.forEach(it=>{
        const srcHtml = (it.sources||[]).map(s=>`
          <li><strong>${s.title||''}</strong> — <span class="muted">${s.why||''}</span></li>
        `).join('');
        cardsEl.insertAdjacentHTML('beforeend', `
          <div class="idea">
            <h4>• ${it.title}</h4>
            ${it.brief? `<p class="muted"><strong>لماذا؟</strong> ${it.brief}</p>`:''}
            ${it.idea?  `<p><strong>اقتراح:</strong> ${it.idea}</p>`:''}
            ${srcHtml? `<ul class="muted">${srcHtml}</ul>`:''}
            <div class="tags" style="margin-top:8px">
              ${chip(subject)} ${chip(STAGES[stage]||stage)} ${chip('إثراء')}
            </div>
          </div>
        `);
      });
      outEl.style.display = '';
    }

    // (Fallback محلي بسيط إذا تعذّر الاستدعاء)
    const LOCAL_FALLBACK = (s)=>[
      { title:`لماذا ${s} مهم اليوم؟`, brief:`مثال حياتي معاصر يقرّب المفهوم.`, idea:`افتتح الدرس بصورة/موقف ثم سؤال موجَّه.` },
      { title:`لغز سريع في ${s}`, brief:`يستفز التفكير قبل الشرح.`, idea:`حلّ جماعي بخطوات مختصرة ثم ربط بالهدف.` },
      { title:`خرافة شائعة في ${s}`, brief:`تفنيد اعتقاد خاطئ متداول.`, idea:`نشاط "صح/خطأ" تفاعلي ثم تصحيح علمي مبسّط.` }
    ];

    document.getElementById('gen').addEventListener('click', async ()=>{
      const subject = (document.getElementById('subj').value||'').trim();
      const stage   = document.getElementById('stage').value || 'p2';
      if(!subject){ toast('اكتب المادة أولًا.'); return; }

      cardsEl.innerHTML = '';
      outEl.style.display = 'none';
      toast('نبحث لك عن أفكار حديثة…');

      try{
        const items = await fetchIdeas(subject, stage);
        if(!items.length){ paint(LOCAL_FALLBACK(subject), subject, stage); toast('لا نتائج كافية — عُرضت أفكار بديلة.'); return; }
        paint(items, subject, stage);
        toast('تم ✨');
      }catch(e){
        console.error(e);
        paint(LOCAL_FALLBACK(subject), subject, stage);
        toast('تعذّر الجلب — عُرضت أفكار بديلة.');
      }
    });

    // نسخ/طباعة
    document.getElementById('copy').addEventListener('click', ()=>{
      const text=[...document.querySelectorAll('.idea')].map(d=>d.innerText).join('\n\n— — —\n\n');
      navigator.clipboard.writeText(text).then(()=>toast('تم النسخ ✅'));
    });
    document.getElementById('print').addEventListener('click', ()=> window.print());

    // أوتو-حفظ بسيط للمادة/المرحلة
    document.addEventListener('DOMContentLoaded', ()=>{
      const subj = document.getElementById('subj');
      const stage = document.getElementById('stage');
      try{
        const s = JSON.parse(localStorage.getItem('ethraa:last')||'null');
        if(s){ subj.value = s.subject||''; stage.value = s.stage||'p2'; }
        const save = ()=> localStorage.setItem('ethraa:last', JSON.stringify({subject:subj.value, stage:stage.value}));
        subj.addEventListener('input', save); stage.addEventListener('change', save);
      }catch(_){}
    });
  </script>
</body>
</html>
