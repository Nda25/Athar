<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙØ¹Ù€Ù€ÙŠÙ† â€” Ù…ÙÙ‚Ø³ÙÙ‘Ù… Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <meta name="color-scheme" content="dark light" />
  <style>
    /* ÙŠÙ†Ø¯Ù…Ø¬ Ù…Ø¹ Ø«ÙŠÙ… Ø£Ø«Ù€Ù€Ø± + ÙŠÙ„ØªÙ‚Ø· Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
    :root{ --accent: var(--sea-500, #3b82f6); }
    .card{ overflow:hidden }
    .wizard .field{ margin:10px 0 }
    .wizard .field label{ display:block; font-weight:700; margin:6px 0 }
    .wizard input,.wizard select{ width:100%; padding:12px; border-radius:12px; border:1px solid rgba(59,130,246,.35) }
    .cols-3{ display:grid; gap:12px; grid-template-columns:1fr }
    .cols-2{ display:grid; gap:12px; grid-template-columns:1fr 1fr }
    @media(min-width:900px){ .cols-3{ grid-template-columns:1fr 1fr 1fr } }
    .actions-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:10px }
    .badge{display:inline-block; padding:2px 10px; border-radius:999px; background:#e5e7eb22; border:1px solid #e5e7eb33}
    .plan-day{ border:1px dashed rgba(59,130,246,.35); border-radius:12px; padding:12px; margin-top:12px; background:var(--card) }
    .plan-day h3{ margin:0 0 6px }
    .muted{ color: var(--muted) }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 }
    .chip{ background:color-mix(in oklab, var(--accent) 14%, #fff); padding:3px 8px; border-radius:999px; font-size:.9rem }
    .printable{ border:1px solid color-mix(in oklab, var(--accent) 40%, #cbd5e1); border-radius:12px; padding:14px; margin-top:8px; background:var(--card) }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    @media print{
      .global-bg,.backdrop,.pattern,.topbar,header,.actions-row,.wizard,.toast{ display:none !important }
      .container{ width:auto; padding:0; margin:0 }
      .printable{ width:180mm; margin:0 auto; background:#fff; border-color:#999 }
      @page{ size:A4 portrait; margin:10mm; }
    }
  </style>
</head>
<body>
  <!-- Ø®Ù„ÙÙŠØ§Øª Ø£Ø«Ù€Ù€Ø± -->
  <div class="global-bg"></div><div class="backdrop"></div><div class="pattern"></div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div class="topbar">
    <div class="left-actions"><a class="btn" href="index.html" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></div>
    <div class="actions"><button class="btn" id="themeToggle">ğŸŒ“</button></div>
    <div class="user">
      <span id="nav-auth" style="display:none;gap:10px"></span>
      <a id="nav-profile" class="btn" href="profile.html" style="display:none">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a>
    </div>
  </div>

  <!-- Ø§Ù„Ù‡ÙŠØ±Ùˆ -->
  <header>
    <div class="hero">
      <h1 class="logo">Ù…ÙØ¹Ù€Ù€Ù€ÙŠÙ†</h1>
      <div class="tag"><span class="dot"></span>ÙŠØ¨Ù†ÙŠ Ø®ÙØ·Ø· Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©â€¦ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø±Ø³Ù…ÙŠ.</div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- Ø§Ù„Ù…Ø¹Ø·ÙŠØ§Øª -->
      <section class="card wizard">
        <h2 class="title" style="margin-top:0">Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h2>
        <p class="muted" style="margin:-6px 0 10px">Ù„Ù† Ù†ÙˆÙ„Ù‘Ø¯ Ø£ÙŠ Ù‡Ø¯Ù Ø£Ùˆ Ù…ÙØ±Ø¯Ø© Ù…Ù† Ø¹Ù†Ø¯Ù†Ø§ â€” Ù†Ù‚Ø±Ø£Ù‡Ø§ ÙÙ‚Ø· Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© â€œÙ…Ù†Ù‡Ø¬ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© (Ø¢Ø®Ø± Ø¥ØµØ¯Ø§Ø±)â€.</p>

        <div class="cols-3">
          <div class="field">
            <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
            <input id="w-subject" placeholder="Ù…Ø«Ø§Ù„: ÙÙŠØ²ÙŠØ§Ø¡ / Ø£Ø­ÙŠØ§Ø¡ / Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© â€¦" />
          </div>
          <div class="field">
            <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©/Ø§Ù„ØµÙ</label>
            <select id="w-grade">
              <option value="1">Ø£ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
              <option value="2">Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
              <option value="3">Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
              <option value="4">Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
              <option value="5">Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
              <option value="6">Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
              <option value="7">Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·</option>
              <option value="8">Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·</option>
              <option value="9">Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option>
              <option value="10">Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ</option>
              <option value="11">Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ</option>
              <option value="12">Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ</option>
            </select>
          </div>
          <div class="field">
            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</label>
            <select id="w-count">
              <option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option>
            </select>
          </div>
        </div>

        <div id="lessonsWrap" class="cols-2" style="margin-top:6px"></div>

        <div class="actions-row">
          <button class="btn primary" id="btn-generate">ÙˆÙ„Ù‘Ø¯ÙŠ Ø§Ù„Ø®Ø·Ø©</button>
          <button class="btn" id="btn-copy-all" disabled>Ù†Ø³Ø® Ø§Ù„Ø®Ø·Ø© ÙƒØ§Ù…Ù„Ø©</button>
          <button class="btn" id="btn-print" disabled>Ø·Ø¨Ø§Ø¹Ø©</button>
          <span id="status" class="muted"></span>
        </div>
      </section>

      <!-- Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª -->
      <section class="card" id="out" style="display:none">
        <h2 class="title" style="margin-top:0">Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ø³Ø® ÙŠÙˆÙ…Ù‹Ø§ Ø¨ÙŠÙˆÙ…)</h2>
        <div class="printable">
          <div id="meta" class="chips"></div>
          <div id="weekWrap"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- ÙÙˆØªØ± -->
  <footer>
    <p class="foot-line">Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø´Ø±Ø§Ø±Ø© ØµØºÙŠØ±Ø©â€¦ ØªÙØ¶ÙŠØ¡ Ø¹Ù‚ÙˆÙ„Ù‹Ø§ ÙƒØ¨ÙŠØ±Ø©.</p>
    <p class="foot-name">Ù†Ø¯Ù‰ Ø§Ù„Ù…Ø¬ÙŠØ±Ø´</p>
    <div class="foot-links">
      <a href="privacy.html">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a><span class="sep">|</span>
      <a href="terms.html">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</a><span class="sep">|</span>
      <a href="refund-policy.html">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</a><span class="sep">|</span>
      <a href="whatsapp.html">ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</a><span class="sep">|</span>
      <a href="complaints.html">Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</a>
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <!-- SDKs -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js" onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>
  <script defer src="assets/js/supabase-client.js"></script>
  <script defer src="app.js"></script>

  <script>
    // ===== Ø£Ø¯ÙˆØ§Øª Ø¨Ø³ÙŠØ·Ø© =====
    const $ = (s)=>document.querySelector(s);
    const DAYS = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³"];
    const gradeLabel = (g)=>{
      const map = {1:"Ø£ÙˆÙ„ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",2:"Ø«Ø§Ù†ÙŠ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",3:"Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",4:"Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",5:"Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",6:"Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",7:"Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·",8:"Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·",9:"Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·",10:"Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ",11:"Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ",12:"Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ"};
      return map[g]||g;
    };
    function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1200); }
    function setStatus(t){ $("#status").textContent=t||""; }
    function chip(txt){ const s=document.createElement("span"); s.className="chip"; s.textContent=txt; return s; }

    // ===== Ø­Ù‚ÙˆÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© =====
    function renderLessonInputs(){
      const wrap = $("#lessonsWrap"); wrap.innerHTML="";
      const n = +$("#w-count").value || 3;
      for(let i=0;i<n;i++){
        const d=document.createElement("div"); d.className="field";
        d.innerHTML = `<label>Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø³ ${i+1}</label><input id="lesson-${i}" placeholder="Ø§ÙƒØªØ¨ÙŠÙ‡ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø±Ø³Ù…ÙŠ">`;
        wrap.appendChild(d);
      }
    }
    $("#w-count").addEventListener("change", renderLessonInputs);
    document.addEventListener("DOMContentLoaded", renderLessonInputs);

    // ===== ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø© =====
    async function callMu3een(body){
      // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¯Ø§Ù„Ø© ØªØªØ·Ù„Ø¨ JWT â€” Ù†Ø­ØµÙ„ Ø¹Ù„ÙŠÙ‡ Ù…Ù† Auth0 SPA
      const token = await window.auth.getToken({ audience: "https://api.athar" });
      const res = await fetch("/.netlify/functions/mu3een", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token },
        body: JSON.stringify(body)
      });
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(txt || ("HTTP "+res.status));
      }
      return res.json();
    }

    function dayCard(d){
      const box=document.createElement("div");
      box.className="plan-day";
      box.innerHTML = `
        <h3>${d.day} â€” <span style="color:var(--accent)">${d.lesson || "â€”"}</span></h3>
        <div class="muted">${d.found ? '<span class="badge">Ù…Ù† Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø±Ø³Ù…ÙŠ</span>' : '<span class="badge" style="background:#fee2e233;border-color:#fecaca66;color:#7f1d1d">Ù„Ø§ ØªØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³</span>'}</div>
        <h4 style="margin:8px 0 4px">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</h4>
        <ul>${(d.objectives||[]).map(o=>`<li>${o}</li>`).join("") || "<li>â€”</li>"}</ul>
        <h4 style="margin:8px 0 4px">Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h4>
        <ul>${(d.vocab||[]).map(v=>`<li>${v}</li>`).join("") || "<li>â€”</li>"}</ul>
        <h4 style="margin:8px 0 4px">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©</h4>
        <p>${d.outcomes || "â€”"}</p>
        <h4 style="margin:8px 0 4px">ÙˆØ§Ø¬Ø¨ Ù…Ù†Ø²Ù„ÙŠ Ù…Ù‚ØªØ±Ø­</h4>
        <p>${d.homework || "â€”"}</p>
        <div class="actions-row" style="justify-content:flex-start">
          <button class="btn" data-copy>Ù†Ø³Ø® Ø§Ù„ÙŠÙˆÙ…</button>
        </div>
      `;
      box.querySelector("[data-copy]").addEventListener("click", ()=>{
        const txt = `
[Ø®Ø·Ø© ${d.day}]
Ø§Ù„Ø¯Ø±Ø³: ${d.lesson||'â€”'}
Ø§Ù„Ø£Ù‡Ø¯Ø§Ù:
${(d.objectives||[]).map(x=>"- "+x).join("\n")||"- â€”"}
Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª:
${(d.vocab||[]).map(x=>"- "+x).join("\n")||"- â€”"}
Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:
- ${d.outcomes||"â€”"}
ÙˆØ§Ø¬Ø¨ Ù…Ù†Ø²Ù„ÙŠ:
- ${d.homework||"â€”"}
`.trim();
        navigator.clipboard.writeText(txt).then(()=>toast("Ù†ÙØ³Ø® ÙŠÙˆÙ… "+d.day+" âœ…"));
      });
      return box;
    }

    async function generate(){
      const subject = $("#w-subject").value.trim();
      const grade = +$("#w-grade").value;
      const count = +$("#w-count").value || 3;
      if(!subject){ toast("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ø¯Ù‚Ø©"); return; }

      const lessons=[];
      for(let i=0;i<count;i++){
        const v = $("#lesson-"+i).value.trim();
        if(!v){ toast("Ø£Ø¯Ø®Ù„ÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¯Ø±ÙˆØ³"); return; }
        lessons.push(v);
      }

      try{
        setStatus("Ø¬Ø§Ø±Ù Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©â€¦");
        $("#btn-generate").disabled = true;

        const plan = await callMu3een({ subject, grade, lessons });

        // Ø±Ø£Ø³ Ø§Ù„Ø®Ø·Ø©
        const metaBox = $("#meta"); metaBox.innerHTML="";
        metaBox.appendChild(chip("Ø§Ù„Ù…Ø§Ø¯Ø©: "+plan.meta.subject));
        metaBox.appendChild(chip("Ø§Ù„Ù…Ø±Ø­Ù„Ø©: "+gradeLabel(plan.meta.grade)));
        metaBox.appendChild(chip("Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: "+plan.meta.weekLabel));

        // Ø§Ù„Ø£ÙŠØ§Ù…
        const wrap = $("#weekWrap"); wrap.innerHTML="";
        plan.days.forEach(d=> wrap.appendChild(dayCard(d)));

        $("#out").style.display="";
        $("#btn-copy-all").disabled=false;
        $("#btn-print").disabled=false;

        toast("ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø© âœ¨");
        setStatus("");
        if (typeof supaLogToolUsage === "function") {
          try { await supaLogToolUsage("mu3een_generate", { subject, grade, count }); } catch(_){}
        }
      }catch(e){
        console.error(e);
        setStatus("ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªÙˆÙ„ÙŠØ¯");
        toast("ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªÙˆÙ„ÙŠØ¯");
      }finally{
        $("#btn-generate").disabled = false;
      }
    }

    document.getElementById("btn-generate").addEventListener("click", generate);
    document.getElementById("btn-copy-all").addEventListener("click", async ()=>{
      const text = document.querySelector(".printable").innerText.trim();
      await navigator.clipboard.writeText(text);
      toast("Ù†ÙØ³Ø®Øª Ø§Ù„Ø®Ø·Ø© ÙƒØ§Ù…Ù„Ø© âœ…");
    });
    document.getElementById("btn-print").addEventListener("click", ()=> window.print());
  </script>
</body>
</html>
