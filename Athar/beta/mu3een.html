<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ููุนูู โ ุชูุณูู ุงูุฎุทุฉ ุงูุฃุณุจูุนูุฉ</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{ --accent:#2563eb; }
    .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media(max-width:900px){ .form-grid{ grid-template-columns:1fr; } }
    .field{ margin:10px 0 }
    .field label{ display:block; font-weight:700; margin:6px 0 }
    .field input,.field select,.field textarea{
      width:100%; padding:12px; border-radius:12px;
      border:1px solid rgba(37,99,235,.35)
    }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 }
    .chip{ background:color-mix(in oklab, var(--accent) 14%, #fff); padding:4px 8px; border-radius:999px; font-size:.9rem }
    .day-card{ border:1px dashed rgba(37,99,235,.35); border-radius:10px; padding:10px; margin-top:12px; }
    .copy-row{ display:flex; gap:8px; flex-wrap:wrap; }
    .small{ font-size:.92rem; color:var(--muted) }
    .src-box{ background:color-mix(in oklab, var(--accent) 8%, #fff); border-radius:10px; padding:8px; margin-top:10px; }
    details.edit{ background:#0001; border-radius:8px; padding:6px 8px; margin:8px 0 }
    details.edit summary{ cursor:pointer; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    @media(max-width:800px){ .grid-2{ grid-template-columns:1fr; } }
    textarea.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="global-bg"></div>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <div class="topbar">
    <div class="left-actions"><a class="btn" href="index.html">ุงูุฑุฆูุณูุฉ</a></div>
    <div class="actions"><button class="btn" id="themeToggle">๐</button></div>
    <div class="user"><a class="btn" href="programs.html">ูุณุงุญุฉ ุฅุจุฏุงุนู</a></div>
  </div>

  <header>
    <div class="hero">
      <h1 class="logo">ููุนูู</h1>
      <div class="tag"><span class="dot"></span>ูููููุฏ ุฎุทุชู ุงูุฃุณุจูุนูุฉ ุจุดูู ุฐูู โ ูุน ูุตุงุฏุฑ ุฑุณููุฉ ุนูุฏ ุงูุฅููุงู โจ</div>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="card">
        <h2 class="title">ูุฏุฎูุงุช ุงูุฎุทุฉ ุงูุฃุณุจูุนูุฉ</h2>
        <p class="small">ุนูุฏ ุชูุงูุฑ ูุตุงุฏุฑ ุฑุณููุฉ ุณูุฌูุจูุง ุชููุงุฆููุง ููููุฒู ุงููููุฐุฌ ุจูุง (ุฃูุฏุงู/ููุฑุฏุงุช/ูุชุงุฆุฌ). ูุฅูุง ูุณูููุฏ ูุณูุฏุฉ ุฐููุฉ ูุงุถุญุฉ ูููุฑุงุฌุนุฉ ุงูุณุฑูุนุฉ.</p>

        <form id="mueen-form" class="form" novalidate>
          <div class="form-grid">
            <div class="field">
              <label>ุงููุงุฏุฉ</label>
              <input id="f-subject" placeholder="ูุซุงู: ุงูููุฒูุงุกุ ูุบุชูุ ุงูุฑูุงุถูุงุชโฆ" required />
            </div>
            <div class="field">
              <label>ุงููุฑุญูุฉ/ุงูุตู</label>
              <select id="f-grade" required>
                <option>ุฃูู ุงุจุชุฏุงุฆู</option><option>ุซุงูู ุงุจุชุฏุงุฆู</option><option>ุซุงูุซ ุงุจุชุฏุงุฆู</option>
                <option>ุฑุงุจุน ุงุจุชุฏุงุฆู</option><option>ุฎุงูุณ ุงุจุชุฏุงุฆู</option><option>ุณุงุฏุณ ุงุจุชุฏุงุฆู</option>
                <option>ุฃูู ูุชูุณุท</option><option>ุซุงูู ูุชูุณุท</option><option>ุซุงูุซ ูุชูุณุท</option>
                <option>ุฃูู ุซุงููู</option><option>ุซุงูู ุซุงููู</option><option selected>ุซุงูุซ ุซุงููู</option>
              </select>
            </div>
          </div>

          <div class="form-grid">
            <div class="field">
              <label>ุนุฏุฏ ุงูุฏุฑูุณ ูุฐุง ุงูุฃุณุจูุน</label>
              <select id="f-count">
                <option>1</option><option>2</option><option>3</option><option>4</option><option selected>5</option>
              </select>
            </div>
            <div class="field">
              <label>ุฃุณููุจ ุงุฎุชูุงุฑ ุงูุฏุฑูุณ</label>
              <select id="f-mode">
                <option value="manual" selected>ุฃุฏุฎู ุฃุณูุงุก ุงูุฏุฑูุณ ูุฏูููุง</option>
                <option value="ai">ุฏุน ููุนูู ูุฎุชุงุฑูุง ููู ุงููููุฌ</option>
              </select>
            </div>
          </div>

          <div id="lesson-names" class="form-grid"></div>

          <div class="actions-row" style="margin-top:10px">
            <button type="button" class="btn primary" id="btn-generate">ูููุฏู ุงูุฎุทุฉ</button>
            <button type="button" class="btn" id="btn-copy-all">ูุณุฎ ุงูุฎุทุฉ ูุงููุฉ</button>
            <span id="status" class="muted"></span>
          </div>
        </form>
      </section>

      <section class="card" id="out" style="display:none">
        <h2 class="title">ุฎุทุฉ ุงูุฃุณุจูุน</h2>
        <div class="chips" id="meta"></div>

        <div id="source-info" class="src-box" style="display:none">
          <div><strong>ุงููุตุงุฏุฑ ุงูุฑุณููุฉ ุงููุณุชุฎุฏููุฉ:</strong></div>
          <ul id="src-list" style="margin:6px 0 0"></ul>
        </div>

        <div id="days"></div>
      </section>
    </div>
  </main>

  <footer>
    <p class="foot-line">ุงูุชุนููู ุดุฑุงุฑุฉ ุตุบูุฑุฉโฆ ุชูุถูุก ุนููููุง ูุจูุฑุฉ.</p>
    <p class="foot-name">ูุฏู ุงููุฌูุฑุด</p>
    <div class="foot-links">
      <a href="privacy.html">ุณูุงุณุฉ ุงูุฎุตูุตูุฉ</a><span class="sep">|</span>
      <a href="terms.html">ุงูุดุฑูุท ูุงูุฃุญูุงู</a><span class="sep">|</span>
      <a href="refund-policy.html">ุณูุงุณุฉ ุงูุงุณุชุฑุฌุงุน</a><span class="sep">|</span>
      <a href="whatsapp.html">ุชูุงุตู ูุงุชุณุงุจ</a><span class="sep">|</span>
      <a href="complaints.html">ุงูุดูุงูู ูุงูุงูุชุฑุงุญุงุช</a>
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <!-- SDKs -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>
  <script defer src="assets/js/supabase-client.js"></script>
  <script defer src="assets/js/require-auth.js"></script>
  <script defer src="assets/js/storage.js"></script>

  <script>
    const $ = s=>document.querySelector(s);
    const daysNames = ["ุงูุฃุญุฏ","ุงูุงุซููู","ุงูุซูุงุซุงุก","ุงูุฃุฑุจุนุงุก","ุงูุฎููุณ"];

    function drawLessonInputs() {
      const n = +$('#f-count').value || 5;
      const wrap = $('#lesson-names'); wrap.innerHTML='';
      const mode = $('#f-mode').value;
      for (let i=1;i<=n;i++){
        const div=document.createElement('div'); div.className='field';
        div.innerHTML = `
          <label>ุงุณู ุงูุฏุฑุณ ${i}</label>
          <input class="ln" placeholder="${mode==='ai'?'(ุณูุฎุชุงุฑู ููุนูู ุชููุงุฆููุง)':'ุงูุชุจู ุงุณู ุงูุฏุฑุณ ููุง ูู ุงููุชุงุจ'}" ${mode==='ai'?'disabled':''}/>
        `;
        wrap.appendChild(div);
      }
    }

    function toast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display='block';
      clearTimeout(window.__t); window.__t=setTimeout(()=>t.style.display='none',1600); }

    function chip(text){ const s=document.createElement('span'); s.className='chip'; s.textContent=text; return s; }

    function linesToList(txt){ return (txt||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }
    function listToLines(arr){ return (arr||[]).join("\n"); }

    function renderSources(sources){
      const box = $('#source-info'); const ul = $('#src-list'); ul.innerHTML='';
      if (!Array.isArray(sources) || sources.length===0){ box.style.display='none'; return; }
      sources.forEach(src=>{
        const li=document.createElement('li');
        const a=document.createElement('a');
        a.href=src.url; a.textContent=src.title || src.url; a.target="_blank"; a.rel="noopener";
        li.appendChild(a);
        ul.appendChild(li);
      });
      box.style.display='';
    }

    function renderPlan(data){
      const meta = $('#meta'); meta.innerHTML='';
      meta.appendChild(chip(data.meta.subject));
      meta.appendChild(chip(`ุงูุตู: ${data.meta.grade_label}`));
      meta.appendChild(chip(`ุฃูุงู: ${data.meta.days.join('ุ ')}`));

      renderSources(data.sources||[]);

      const out = $('#days'); out.innerHTML='';
      data.week.forEach((d,idx)=>{
        const card=document.createElement('div'); card.className='day-card';
        card.innerHTML=`
          <h3 style="margin:0 0 6px">${d.day} โ <span class="lnm">${d.lesson_name||'โ'}</span>${d.unit_name?` <span class="small">(${d.unit_name})</span>`:''}</h3>
          <div class="small" style="margin-bottom:6px">${data.meta.subject} โข ${data.meta.grade_label}</div>

          <h4 style="margin:8px 0 4px">ุงูุฃูุฏุงู</h4>
          <ul class="obj-ul" style="margin:0 0 6px">${(d.objectives||[]).map(x=>`<li>${x}</li>`).join('')}</ul>

          <h4 style="margin:8px 0 4px">ุงูููุฑุฏุงุช ุงูุฌุฏูุฏุฉ</h4>
          <ul class="vocab-ul" style="margin:0 0 6px">${(d.vocab||[]).map(x=>`<li>${x}</li>`).join('')}</ul>

          ${d.outcomes?`<h4 style="margin:8px 0 4px">ุงููุชุงุฆุฌ ุงููุชููุนุฉ</h4><p class="outcomes-p">${d.outcomes}</p>`:''}
          <h4 style="margin:8px 0 4px">ูุงุฌุจ ููุฒูู ููุชุฑุญ</h4>
          <p class="homework-p">${d.homework||'โ'}</p>

          <details class="edit">
            <summary>โ๏ธ ุชุนุฏูู ุณุฑูุน</summary>
            <div class="grid-2" style="margin-top:8px">
              <div>
                <label class="small">ุงูุฃูุฏุงู (ูู ุณุทุฑ ูุฏู)</label>
                <textarea class="ta-obj mono" rows="6">${listToLines(d.objectives||[])}</textarea>
              </div>
              <div>
                <label class="small">ุงูููุฑุฏุงุช (ูู ุณุทุฑ ููุฑุฏุฉ)</label>
                <textarea class="ta-vocab mono" rows="6">${listToLines(d.vocab||[])}</textarea>
              </div>
              <div>
                <label class="small">ุงููุชุงุฆุฌ ุงููุชููุนุฉ</label>
                <textarea class="ta-out mono" rows="4">${d.outcomes||''}</textarea>
              </div>
              <div>
                <label class="small">ุงููุงุฌุจ ุงูููุฒูู</label>
                <textarea class="ta-hw mono" rows="4">${d.homework||''}</textarea>
              </div>
            </div>
            <div class="actions-row" style="margin-top:8px">
              <button type="button" class="btn" data-act="apply" data-idx="${idx}">ุญูุธ ุงูุชุนุฏูู</button>
            </div>
          </details>

          <div class="copy-row">
            <button class="btn" data-act="copy" data-idx="${idx}">ูุณุฎ ููู ${d.day}</button>
          </div>
        `;
        out.appendChild(card);
      });

      $('#out').style.display='';

      // ุชูุนูู ุฃุฒุฑุงุฑ ุงููุณุฎ/ุงูุญูุธ
      out.querySelectorAll('button[data-act="copy"]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const d = data.week[+btn.dataset.idx];
          const text = `${d.day} โ ${d.lesson_name}\n\n[ุงูุฃูุฏุงู]\n- ${(d.objectives||[]).join('\n- ')}\n\n[ุงูููุฑุฏุงุช]\n- ${(d.vocab||[]).join('\n- ')}\n\n[ุงููุชุงุฆุฌ]\n${d.outcomes||'โ'}\n\n[ุงููุงุฌุจ]\n${d.homework||'โ'}`;
          navigator.clipboard.writeText(text).then(()=>toast('ุชู ูุณุฎ ุงูููู โ'));
        });
      });

      out.querySelectorAll('button[data-act="apply"]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const idx = +btn.dataset.idx;
          const card = btn.closest('.day-card');
          const objs   = linesToList(card.querySelector('.ta-obj').value);
          const vocab  = linesToList(card.querySelector('.ta-vocab').value);
          const outc   = card.querySelector('.ta-out').value.trim();
          const hw     = card.querySelector('.ta-hw').value.trim();

          data.week[idx].objectives = objs;
          data.week[idx].vocab      = vocab;
          data.week[idx].outcomes   = outc;
          data.week[idx].homework   = hw;

          // ุฅุนุงุฏุฉ ุงูุนุฑุถ ุฏุงุฎู ุงูุจุทุงูุฉ
          card.querySelector('.obj-ul').innerHTML   = objs.map(x=>`<li>${x}</li>`).join('');
          card.querySelector('.vocab-ul').innerHTML = vocab.map(x=>`<li>${x}</li>`).join('');
          card.querySelector('.outcomes-p').textContent = outc || 'โ';
          card.querySelector('.homework-p').textContent = hw || 'โ';

          toast('ุชู ุญูุธ ุงูุชุนุฏูู โ');
        });
      });
    }

    async function authToken(){
      return window.auth.getTokenSilently({ audience: "https://api.athar" });
    }

    async function generate(){
      const subject = $('#f-subject').value.trim();
      const grade   = $('#f-grade').value;
      const mode    = $('#f-mode').value;
      const count   = +$('#f-count').value || 5;
      const names   = [...document.querySelectorAll('.ln')].map(i=>i.value.trim()).filter(Boolean);

      if (!subject){ toast('ุงูุชุจู ุงุณู ุงููุงุฏุฉ'); return; }
      $('#status').textContent='ุฌุงุฑู ุงูุชูููุฏโฆ'; $('#btn-generate').disabled=true;

      try{
        const token = await authToken();
        const res = await fetch('/.netlify/functions/mueen', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
          body: JSON.stringify({ subject, grade, lessonsMode: mode, lessonsCount: count, lessonNames: names, sourceMode: 'authoritative' })
        });
        const j = await res.json().catch(()=> ({}));
        if(!res.ok){ $('#status').textContent = j?.error || 'ุชุนุฐูุฑ ุงูุชูููุฏ'; $('#btn-generate').disabled=false; return; }
        if (j?.meta?.note) toast(j.meta.note);
        $('#status').textContent = 'ุชู โ';
        renderPlan(j);
      }catch(e){ $('#status').textContent='ุชุนุฐูุฑ ุงูุชูููุฏ'; }
      finally{ $('#btn-generate').disabled=false; }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      drawLessonInputs();
      $('#f-count').addEventListener('change', drawLessonInputs);
      $('#f-mode').addEventListener('change', drawLessonInputs);
      $('#btn-generate').addEventListener('click', generate);
      $('#btn-copy-all').addEventListener('click', ()=>{
        const txt = $('#days').innerText.trim();
        navigator.clipboard.writeText(txt).then(()=>toast('ุชู ูุณุฎ ุงูุฎุทุฉ ูููุง โ'));
      });
    });
  </script>
</body>
</html>
