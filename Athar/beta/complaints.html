<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª â€” Ø£Ø«Ù€Ù€Ø±</title>
  <link rel="stylesheet" href="style.css">
  <meta name="color-scheme" content="dark light">
  <style>
    .card{background:rgba(11,18,32,.75);border:1px solid #1f2a44;border-radius:16px;padding:16px;margin:12px 0}
    .field{margin:10px 0}
    .field label{display:block;font-weight:700;margin:6px 0}
    .field input,.field textarea,.field select{
      width:100%;padding:12px;border-radius:12px;border:1px solid rgba(59,130,246,.35);background:#0b1220;color:#fff
    }
    .actions-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.9em}
    .status-active{background:#dcfce7;color:#166534}
    .status-pending{background:#fef9c3;color:#713f12}
    .status-cancelled{background:#fee2e2;color:#7f1d1d}
    .muted{opacity:.85}
    .hidden{display:none}
    .btn{padding:10px 14px;border:1px solid rgba(59,130,246,.4);border-radius:12px;background:#0b1220;color:#fff;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#2563eb}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    a.link{color:#93c5fd;text-decoration:underline}
  </style>
</head>
<body>
  <!-- ÙŠÙ…ÙƒÙ† ØªØ¶Ù…ÙŠÙ† Ù†ÙØ³ Ø§Ù„Ù‡ÙŠØ¯Ø±/Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ù…ÙˆØ­Ø¯ÙŠÙ† Ù„Ùˆ Ø±ØºØ¨ØªÙ -->
  <header class="card" style="text-align:center">
    <h1 style="margin:0 0 6px">ğŸ“© Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</h1>
    <div class="muted">Ø­Ø±ØµÙ‹Ø§ Ø¹Ù„Ù‰ Ø±Ø¶Ø§ÙƒÙ…ØŒ ÙŠÙ…ÙƒÙ†ÙƒÙ… Ø¥Ø±Ø³Ø§Ù„ Ø´ÙƒÙˆÙ‰ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­ Ø¹Ø¨Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ§Ù„ÙŠ.</div>
    <div id="account-info" class="muted" style="margin-top:6px"></div>
  </header>

  <main class="container">
    <section class="card">
      <form id="complaintForm" novalidate>
        <div class="field">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©</label>
          <select name="type" id="f-type" required>
            <option value="complaint">Ø´ÙƒÙˆÙ‰</option>
            <option value="suggestion">Ø§Ù‚ØªØ±Ø§Ø­</option>
          </select>
        </div>

        <div class="field">
          <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input type="text" name="subject" id="f-subject" placeholder="Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ Ù…Ø®ØªØµØ±Ù‹Ø§" required>
        </div>

        <div class="field">
          <label>Ø§Ù„Ø§Ø³Ù…</label>
          <input type="text" name="name" id="f-name" placeholder="Ø§Ø³Ù…Ùƒ" required>
        </div>

        <div class="field">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input type="email" name="email" id="f-email" placeholder="example@email.com" required>
        </div>

        <div class="field">
          <label>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
          <textarea name="message" id="f-message" rows="6" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§â€¦" required></textarea>
        </div>

        <div class="field">
          <label>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input type="text" name="order_number" id="f-order" placeholder="Ø¥Ù† ÙˆØ¬Ø¯">
        </div>

        <div class="actions-row">
          <button type="button" id="btn-login" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          <button type="submit" id="btn-send" class="btn primary">Ø¥Ø±Ø³Ø§Ù„</button>
          <span id="form-status" class="muted"></span>
        </div>
      </form>
    </section>

    <section class="card">
      <h2 style="margin-top:0">Ø·Ø±Ù‚ Ø¨Ø¯ÙŠÙ„Ø© Ù„ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</h2>
      <p>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: <strong>0556795993</strong></p>
      <p>ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯: <a class="link" href="mailto:team@n-athar.co">team@n-athar.co</a></p>
      <p>ğŸ’¬ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨: <a class="link" href="https://wa.me/966556795993" target="_blank" rel="noopener">Ø§Ø¶ØºØ· Ù‡Ù†Ø§</a></p>
      <p>ğŸ“± Ø¹Ø¨Ø± X (ØªÙˆÙŠØªØ±): <a class="link" href="https://x.com/" target="_blank" rel="noopener">@n-athar</a></p>
    </section>

    <section class="card">
      <h2 style="margin-top:0">Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø¯ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</h2>
      <p>â³ ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø®Ù„Ø§Ù„ <strong>48 Ø³Ø§Ø¹Ø© Ø¹Ù…Ù„</strong>.</p>
      <p>âš–ï¸ ØªØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø®Ù„Ø§Ù„ <strong>7 Ø£ÙŠØ§Ù… Ø¹Ù…Ù„</strong>.</p>
    </section>
  </main>

  <footer class="card" style="text-align:center">
    <p style="margin:0">Â© 2025 Ù…Ù†ØµØ© Ø£Ø«Ù€Ù€Ø±</p>
  </footer>

  <!-- Auth0 SDK (Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†) -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù… Ù„Ø¯ÙŠÙƒ (ÙŠÙˆÙÙ‘Ø± window.auth) -->
  <script src="app.js"></script>

  <script>
    (function(){
      const CLAIM_NS = "https://athar.co/";
      const form = document.getElementById('complaintForm');
      const btnLogin = document.getElementById('btn-login');
      const btnSend  = document.getElementById('btn-send');
      const statusEl = document.getElementById('form-status');

      const nameEl   = document.getElementById('f-name');
      const emailEl  = document.getElementById('f-email');
      const typeEl   = document.getElementById('f-type');
      const subjEl   = document.getElementById('f-subject');
      const msgEl    = document.getElementById('f-message');
      const orderEl  = document.getElementById('f-order');

      const accountInfo = document.getElementById('account-info');

      function showStatus(msg){ statusEl.textContent = msg || ''; }
      function setLocked(locked){
        btnSend.disabled = locked;
        btnLogin.disabled = locked;
      }

      // Ù†Ù†ØªØ¸Ø± window.auth Ù…Ù† app.js
      const wait = (ms)=> new Promise(r=>setTimeout(r,ms));
      async function waitAuth(){
        for(let i=0;i<50 && !window.auth;i++){ await wait(100); }
        return !!window.auth;
      }

      async function fillFromAuth(){
        try{
          const ok = await window.auth.isAuthenticated();
          if (!ok) {
            accountInfo.innerHTML = '<span class="badge status-cancelled">ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</span> â€” Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰.';
            btnLogin.style.display = '';
            return;
          }
          btnLogin.style.display = 'none';

          const u = await window.auth.getUser();
          const claims = await window.auth.getIdTokenClaims();
          const status = claims?.[CLAIM_NS + 'status'] || '';

          // Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
          let badge = '';
          if (status === 'active') badge = '<span class="badge status-active">Ø­Ø³Ø§Ø¨Ùƒ Ù†Ø´Ø·</span>';
          else if (status === 'pending') badge = '<span class="badge status-pending">Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¹Ù„Ù‘Ù‚</span>';
          else badge = '<span class="badge status-cancelled">ØºÙŠØ± Ù†Ø´Ø·</span>';
          accountInfo.innerHTML = badge + (u?.email ? ' â€” ' + u.email : '');

          // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯
          if (u?.name && !nameEl.value)  nameEl.value  = u.name;
          if (u?.email && !emailEl.value) emailEl.value = u.email;

          // ØªÙ…ÙƒÙŠÙ†/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
          if (status !== 'active') {
            btnSend.disabled = true;
            showStatus('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¥Ù„Ø§ Ù…Ù† Ø­Ø³Ø§Ø¨ Ù†Ø´Ø·.');
          }
        }catch(e){
          console.warn(e);
        }
      }

      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      btnLogin.addEventListener('click', ()=>{
        window.auth?.login({
          authorizationParams:{ screen_hint:'login', redirect_uri: window.location.href }
        });
      });

      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ â†’ Netlify Function
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        showStatus('');

        // ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ· ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        if (!subjEl.value.trim() || !msgEl.value.trim()) {
          showStatus('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©');
          return;
        }

        // Ù„Ø§Ø²Ù… ØªÙˆÙƒÙ† (Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø³ØªØ±ÙØ¶ Ø¨Ø¯ÙˆÙ† ØªÙˆÙƒÙ†/Ø£Ùˆ Ù„Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù†Ø´Ø·)
        try{
          setLocked(true);
          showStatus('Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„â€¦');

          const token = await window.auth.getToken({ audience: "https://api.athar" });

          const payload = {
            type: (typeEl.value || 'complaint'),
            subject: subjEl.value.trim(),
            name: nameEl.value.trim(),
            email: emailEl.value.trim(),
            message: msgEl.value.trim(),
            order_number: orderEl.value.trim()
          };

          const res = await fetch('/.netlify/functions/complaints-create', {
            method: 'POST',
            headers:{
              'Content-Type':'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(payload)
          });

          const j = await res.json().catch(()=> ({}));

          if (!res.ok) {
            if (res.status === 403) {
              showStatus('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù†Ø´Ø·.');
            } else if (res.status === 401) {
              showStatus('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§.');
              btnLogin.style.display = '';
            } else {
              showStatus('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.');
            }
            setLocked(false);
            return;
          }

          // Ù†Ø¬Ø§Ø­
          showStatus('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰ âœ“');
          form.reset();
        }catch(err){
          console.error(err);
          showStatus('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.');
        }finally{
          setLocked(false);
        }
      });

      // ØªØ´ØºÙŠÙ„
      (async function run(){
        await waitAuth();
        await fillFromAuth();
      })();
    })();
  </script>
</body>
</html>
