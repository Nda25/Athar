<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุงูุดูุงูู ูุงูุงูุชุฑุงุญุงุช โ ุฃุซููุฑ</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <meta name="color-scheme" content="dark light">
</head>
<body>
  <!-- ุฎูููุงุช ุฃุซููุฑ -->
  <div class="global-bg"></div>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <!-- ุงูุดุฑูุท ุงูุนููู ุงูููุญุฏ -->
  <div class="topbar">
    <div class="left-actions">
      <a class="btn" href="index.html" title="ุงูุฑุฆูุณูุฉ">ุงูุฑุฆูุณูุฉ</a>
    </div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="ุงููุถุน ุงูุฏุงูู/ุงููุงุชุญ">๐</button>
    </div>
    <div class="user">
      <span id="nav-auth" style="display:none;gap:10px"></span>
      <a id="nav-profile" class="btn" href="profile.html" style="display:none">ุงูููู ุงูุดุฎุตู</a>
    </div>
  </div>

  <!-- ุงูููุฑู -->
  <header>
    <div class="hero">
      <h1 class="logo">ุงูุดูุงูู ูุงูุงูุชุฑุงุญุงุช</h1>
      <div class="tag"><span class="dot"></span>ุญุฑุตูุง ุนูู ุฑุถุงููโฆ ุตูุชูู ูููููุง โจ</div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- ูููุฐุฌ ุงููุฑุงุณูุฉ -->
      <section class="card">
        <h2 class="title" style="margin-top:0">ุฃุฑุณู ุฑุณุงูุฉ</h2>
        <p id="account-info" class="muted" style="margin:-6px 0 12px"></p>

        <form id="complaintForm" class="form" novalidate>
          <div class="grid" style="grid-template-columns:1fr 1fr">
            <div class="field">
              <label>ููุน ุงููุฑุงุณูุฉ</label>
              <select id="f-type" required>
                <option value="complaint">ุดููู</option>
                <option value="suggestion">ุงูุชุฑุงุญ</option>
              </select>
            </div>
            <div class="field">
              <label>ุงูุนููุงู</label>
              <input id="f-subject" type="text" placeholder="ุงูุชุจ ุนููุงููุง ูุฎุชุตุฑูุง" required />
            </div>
            <div class="field">
              <label>ุงูุงุณู</label>
              <input id="f-name" type="text" placeholder="ุงุณูู" required />
            </div>
            <div class="field">
              <label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
              <input id="f-email" type="email" placeholder="example@email.com" required />
            </div>
          </div>

          <div class="field">
            <label>ุงูุฑุณุงูุฉ</label>
            <textarea id="f-message" rows="6" placeholder="ุงูุชุจ ุงูุชูุงุตูู ููุงโฆ" required></textarea>
          </div>

          <div class="field">
            <label>ุฑูู ุงูุทูุจ (ุงุฎุชูุงุฑู)</label>
            <input id="f-order" type="text" placeholder="ุฅู ูุฌุฏ" />
          </div>

          <div class="actions-row" style="margin-top:10px">
            <button type="button" id="btn-login" class="btn">ุชุณุฌูู ุงูุฏุฎูู</button>
            <button type="submit" id="btn-send" class="btn primary">ุฅุฑุณุงู</button>
            <span id="form-status" class="muted"></span>
          </div>
        </form>
      </section>

      <!-- ุทุฑู ุจุฏููุฉ -->
      <section class="card">
        <h2 class="title" style="margin-top:0">ุทุฑู ุจุฏููุฉ ูุชูุฏูู ุงูุดูุงูู</h2>
        <p>๐ ุงููุงุชู: <strong>0556795993</strong></p>
        <p>๐ง ุงูุจุฑูุฏ: <a class="link" href="mailto:team@n-athar.co">team@n-athar.co</a></p>
        <p>๐ฌ ูุงุชุณุงุจ: <a class="link" href="https://wa.me/966556795993" target="_blank" rel="noopener">ุงุถุบุท ููุง</a></p>
        <p>๐ฑ X (ุชููุชุฑ): <a class="link" href="https://x.com/" target="_blank" rel="noopener">@n-athar</a></p>
      </section>

      <!-- ุงููุฏุฏ ุงูุฒูููุฉ ุงููุทููุจุฉ -->
      <section class="card">
        <h2 class="title" style="margin-top:0">ููุงุนูุฏ ุงูุฑุฏ ูุงููุนุงูุฌุฉ</h2>
        <p>โณ ุงูุฑุฏ ุฎูุงู <strong>48 ุณุงุนุฉ ุนูู</strong>.</p>
        <p>โ๏ธ ูุนุงูุฌุฉ ุงูุดููู ุฎูุงู <strong>7 ุฃูุงู ุนูู</strong>.</p>
      </section>
    </div>
  </main>

  <!-- ููุชุฑ ุฃุซููุฑ ุงูููุญุฏ -->
  <footer>
    <p class="foot-line">ุงูุชุนููู ุดุฑุงุฑุฉ ุตุบูุฑุฉโฆ ุชูุถูุก ุนููููุง ูุจูุฑุฉ.</p>
    <p class="foot-name">ูุฏู ุงููุฌูุฑุด</p>
    <div class="foot-links">
      <a href="privacy.html">ุณูุงุณุฉ ุงูุฎุตูุตูุฉ</a><span class="sep">|</span>
      <a href="terms.html">ุงูุดุฑูุท ูุงูุฃุญูุงู</a><span class="sep">|</span>
      <a href="refund-policy.html">ุณูุงุณุฉ ุงูุงุณุชุฑุฌุงุน</a><span class="sep">|</span>
      <a href="whatsapp.html">ุชูุงุตู ูุงุชุณุงุจ</a><span class="sep">|</span>
      <a href="complaints.html">ุงูุดูุงูู ูุงูุงูุชุฑุงุญุงุช</a>
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <!-- SDKs + ุณูุฑุจุชุงุช ุงููุดุฑูุน (ุจุฏูู require-auth ูุฃู ุงูุตูุญุฉ ุนุงูุฉ) -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>
  <script src="assets/js/supabase-client.js"></script>
  <script src="app.js"></script>

  <script>
    (function () {
      const CLAIM_NS = "https://athar.co/";
      const form     = document.getElementById('complaintForm');
      const btnLogin = document.getElementById('btn-login');
      const btnSend  = document.getElementById('btn-send');
      const statusEl = document.getElementById('form-status');
      const infoEl   = document.getElementById('account-info');

      const nameEl  = document.getElementById('f-name');
      const emailEl = document.getElementById('f-email');
      const typeEl  = document.getElementById('f-type');
      const subjEl  = document.getElementById('f-subject');
      const msgEl   = document.getElementById('f-message');
      const orderEl = document.getElementById('f-order');

      const wait = (ms)=> new Promise(r=>setTimeout(r,ms));
      async function waitAuth(){ for(let i=0;i<50 && !window.auth;i++){ await wait(100);} }

      function setStatus(m){ statusEl.textContent = m||''; }
      function setLocked(v){ btnSend.disabled=v; btnLogin.disabled=v; }

      async function fillFromAuth(){
        try{
          const ok = await window.auth.isAuthenticated();
          if (!ok) {
            infoEl.innerHTML = '<span class="badge">ุบูุฑ ูุณุฌู ุฏุฎูู</span> โ ุณุฌูู ุงูุฏุฎูู ูุฅุฑุณุงู ุงูุดููู.';
            btnLogin.style.display = '';
            return;
          }
          btnLogin.style.display = 'none';

          const u = await window.auth.getUser();
          const claims = await window.auth.getIdTokenClaims();
          const status = claims?.[CLAIM_NS+'status'] || '';

          const badge =
            status==='active'  ? '<span class="badge status-active">ุญุณุงุจู ูุดุท</span>' :
            status==='pending' ? '<span class="badge status-pending">ุญุณุงุจู ูุนููู</span>' :
                                 '<span class="badge status-cancelled">ุบูุฑ ูุดุท</span>';

          infoEl.innerHTML = badge + (u?.email ? ' โ ' + u.email : '');
          if (u?.name && !nameEl.value)  nameEl.value = u.name;
          if (u?.email && !emailEl.value) emailEl.value = u.email;

          if (status !== 'active') {
            btnSend.disabled = true;
            setStatus('ูุง ูููู ุฅุฑุณุงู ุงูุดููู ุฅูุง ูู ุญุณุงุจ ูุดุท.');
          }
        }catch{}
      }

      btnLogin.addEventListener('click', ()=>{
        window.auth?.login({ authorizationParams:{ screen_hint:'login', redirect_uri: window.location.href }});
      });

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!subjEl.value.trim() || !msgEl.value.trim()) { setStatus('ุงูุฑุฌุงุก ุชุนุจุฆุฉ ุงูุนููุงู ูุงูุฑุณุงูุฉ'); return; }

        try{
          setLocked(true); setStatus('ุฌุงุฑู ุงูุฅุฑุณุงูโฆ');
          const token = await window.auth.getToken({ audience: "https://api.athar" });

          const payload = {
            type: (typeEl.value || 'complaint'),
            subject: subjEl.value.trim(),
            name: nameEl.value.trim(),
            email: emailEl.value.trim(),
            message: msgEl.value.trim(),
            order_number: orderEl.value.trim()
          };

          const res = await fetch('/.netlify/functions/complaints-create', {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify(payload)
          });
          const j = await res.json().catch(()=> ({}));

          if (!res.ok) {
            if (res.status === 403) setStatus('ูุง ูููู ุงูุฅุฑุณุงู: ุญุณุงุจู ุบูุฑ ูุดุท.');
            else if (res.status === 401) { setStatus('ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุฃูููุง.'); btnLogin.style.display=''; }
            else setStatus('ุชุนุฐูุฑ ุงูุฅุฑุณุงูุ ุญุงูู ูุงุญููุง.');
            setLocked(false); return;
          }

          setStatus('ุชู ุงุณุชูุงู ุงูุฑุณุงูุฉ โ');
          form.reset();
        }catch{
          setStatus('ุชุนุฐูุฑ ุงูุฅุฑุณุงูุ ุญุงูู ูุงุญููุง.');
        }finally{ setLocked(false); }
      });

      (async function run(){ await waitAuth(); await fillFromAuth(); })();
    })();
  </script>

  <style>
    /* ุดุงุฑุงุช ุงูุญุงูุฉ ุจููุณ ูุบุฉ ุฃููุงู ุงููููุน */
    .badge{display:inline-block;padding:2px 10px;border-radius:999px;background:#e5e7eb22;border:1px solid #e5e7eb33}
    .status-active{background:#dcfce733;color:#166534;border-color:#bbf7d066}
    .status-pending{background:#fef9c333;color:#713f12;border-color:#fde68a66}
    .status-cancelled{background:#fee2e233;color:#7f1d1d;border-color:#fecaca66}
    .muted{opacity:.85}
  </style>
</body>
</html>
