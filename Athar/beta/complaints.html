<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุงูุดูุงูู ูุงูุงูุชุฑุงุญุงุช โ ุฃุซููุฑ</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <meta name="color-scheme" content="dark light">
  <style>
    /* ุดุงุฑุงุช ุงูุญุงูุฉ ูุน ุงุญุชุฑุงู ุงูุซูู */
    .badge{display:inline-block;padding:2px 10px;border-radius:999px;background:color-mix(in oklab, var(--sea-500) 8%, transparent);border:1px solid color-mix(in oklab, var(--sea-500) 18%, transparent)}
    .status-active{background:#dcfce733;color:#166534;border-color:#bbf7d066}
    .status-pending{background:#fef9c333;color:#713f12;border-color:#fde68a66}
    .status-cancelled{background:#fee2e233;color:#7f1d1d;border-color:#fecaca66}
    .muted{opacity:.85}
    .hint{font-size:.92rem;opacity:.8}
    .grid{display:grid;gap:12px}
    @media(min-width:880px){ .grid{grid-template-columns:1fr 1fr} }
    .actions-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
  </style>
</head>
<body>
  <!-- ุฎูููุงุช ุฃุซููุฑ -->
  <div class="global-bg"></div>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <!-- ุงูุดุฑูุท ุงูุนููู ุงูููุญุฏ -->
  <div class="topbar">
    <div class="left-actions">
      <a class="btn" href="index.html" title="ุงูุฑุฆูุณูุฉ">ุงูุฑุฆูุณูุฉ</a>
    </div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="ุงููุถุน ุงูุฏุงูู/ุงููุงุชุญ">๐</button>
    </div>
    <div class="user">
      <span id="nav-auth" style="display:none;gap:10px"></span>
      <a id="nav-profile" class="btn" href="profile.html" style="display:none">ุงูููู ุงูุดุฎุตู</a>
    </div>
  </div>

  <!-- ุงูููุฑู -->
  <header>
    <div class="hero">
      <h1 class="logo">ุงูุดูุงูู ูุงูุงูุชุฑุงุญุงุช</h1>
      <div class="tag"><span class="dot"></span>ุญุฑุตูุง ุนูู ุฑุถุงูู. ุตูุชูู ูููููุง โจ</div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- ูููุฐุฌ ุงููุฑุงุณูุฉ -->
      <section class="card">
        <h2 class="title" style="margin-top:0">ุฃุฑุณู ุฑุณุงูุฉ</h2>
        <p id="account-info" class="muted" style="margin:-6px 0 12px"></p>

        <form id="complaintForm" class="form" novalidate>
          <div class="grid">
            <div class="field">
              <label>ููุน ุงููุฑุงุณูุฉ</label>
              <select id="f-type" required>
                <option value="complaint">ุดููู</option>
                <option value="suggestion">ุงูุชุฑุงุญ</option>
              </select>
            </div>
            <div class="field">
              <label>ุงูุนููุงู</label>
              <input id="f-subject" type="text" placeholder="ุงูุชุจ ุนููุงููุง ูุฎุชุตุฑูุง" required />
            </div>
            <div class="field">
              <label>ุงูุงุณู</label>
              <input id="f-name" type="text" placeholder="ุงุณูู" required />
            </div>
            <div class="field">
              <label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
              <input id="f-email" type="email" placeholder="example@email.com" required />
            </div>
          </div>

          <div class="field">
            <label>ุงูุฑุณุงูุฉ</label>
            <textarea id="f-message" rows="6" placeholder="ุงูุชุจ ุงูุชูุงุตูู ููุง." required></textarea>
            <div class="hint">ูุง ุชุดุงุฑู ุจูุงูุงุช ุญุณุงุณุฉ. ุงุฐูุฑ ุฑูู ุงูุทูุจ ุฅู ูุงูุช ุงูุดููู ูุชุนููุฉ ุจุนูููุฉ ุดุฑุงุก.</div>
          </div>

          <div class="field">
            <label>ุฑูู ุงูุทูุจ (ุงุฎุชูุงุฑู)</label>
            <input id="f-order" type="text" placeholder="ุฅู ูุฌุฏ" />
          </div>

          <div class="actions-row">
            <button type="button" id="btn-login" class="btn">ุชุณุฌูู ุงูุฏุฎูู</button>
            <button type="submit" id="btn-send" class="btn primary">ุฅุฑุณุงู</button>
            <span id="form-status" class="muted"></span>
          </div>
        </form>
      </section>

      <!-- ุทุฑู ุจุฏููุฉ -->
      <section class="card">
        <h2 class="title" style="margin-top:0">ุทุฑู ุจุฏููุฉ ูุชูุฏูู ุงูุดูุงูู</h2>
        <p>๐ ุงููุงุชู: <strong>0556795993</strong></p>
        <p>๐ง ุงูุจุฑูุฏ: <a class="link" href="mailto:team@n-athar.co">team@n-athar.co</a></p>
        <p>๐ฌ ูุงุชุณุงุจ: <a class="link" href="https://wa.me/966556795993" target="_blank" rel="noopener">ุงุถุบุท ููุง</a></p>
        <p>๐ฑ X (ุชููุชุฑ): <a class="link" href="https://x.com/" target="_blank" rel="noopener">@n-athar</a></p>
      </section>

      <!-- ุงููุฏุฏ ุงูุฒูููุฉ ุงููุทููุจุฉ -->
      <section class="card">
        <h2 class="title" style="margin-top:0">ููุงุนูุฏ ุงูุฑุฏ ูุงููุนุงูุฌุฉ</h2>
        <p>โณ ุงูุฑุฏ ุฎูุงู <strong>48 ุณุงุนุฉ ุนูู</strong>.</p>
        <p>โ๏ธ ูุนุงูุฌุฉ ุงูุดููู ุฎูุงู <strong>7 ุฃูุงู ุนูู</strong>.</p>
      </section>
    </div>
  </main>

  <!-- ููุชุฑ ุฃุซููุฑ ุงูููุญุฏ -->
  <footer>
    <p class="foot-line">ุงูุชุนููู ุดุฑุงุฑุฉ ุตุบูุฑุฉ. ุชูุถูุก ุนููููุง ูุจูุฑุฉ.</p>
    <p class="foot-name">ูุฏู ุงููุฌูุฑุด</p>
    <div class="foot-links">
      <a href="privacy.html">ุณูุงุณุฉ ุงูุฎุตูุตูุฉ</a><span class="sep">|</span>
      <a href="terms.html">ุงูุดุฑูุท ูุงูุฃุญูุงู</a><span class="sep">|</span>
      <a href="refund-policy.html">ุณูุงุณุฉ ุงูุงุณุชุฑุฌุงุน</a><span class="sep">|</span>
      <a href="whatsapp.html">ุชูุงุตู ูุงุชุณุงุจ</a><span class="sep">|</span>
      <a href="complaints.html">ุงูุดูุงูู ูุงูุงูุชุฑุงุญุงุช</a>
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <!-- SDKs + ุณูุฑุจุชุงุช ุงููุดุฑูุน -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>
  <script src="assets/js/supabase-client.js"></script>
  <script src="app.js"></script>

  <script>
    // โ ุชููุฆุฉ ุงูุซูู ูุญูููุง (ุงุญุชูุงุทููุง ุฅู ูู ูุณุจู ูู app.js ุชูููุฐูุง ุจุณุฑุนุฉ)
    (function(){
      try{
        const saved = localStorage.getItem('athar_theme'); // 'dark'|'light'
        if(saved){ document.documentElement.classList.toggle('dark', saved==='dark'); }
      }catch(_){}
    })();
  </script>

  <script>
    (function(){
      const CLAIM_NS = "https://athar.co/";   // ููุณ ุงูููู ุณุจูุณ ูู JWT
      const btnLogin = document.getElementById('btn-login');
      const btnSend  = document.getElementById('btn-send');
      const form     = document.getElementById('complaintForm');
      const statusEl = document.getElementById('form-status');
      const infoEl   = document.getElementById('account-info');

      const typeEl = document.getElementById('f-type');
      const subjEl = document.getElementById('f-subject');
      const nameEl = document.getElementById('f-name');
      const emailEl= document.getElementById('f-email');
      const msgEl  = document.getElementById('f-message');
      const orderEl= document.getElementById('f-order');

      const wait = ms => new Promise(r => setTimeout(r, ms));
      async function waitAuth(){ for(let i=0;i<80 && !window.auth;i++){ await wait(100); } }

      function setStatus(t){ statusEl.textContent = t||''; }
      function lock(v){ btnLogin.disabled=v; btnSend.disabled=v; }

      // โ ุงูุญุตูู ุนูู ุงูุชูููู ุจุทุฑููุฉ ูุฑูุฉ ุญุณุจ ุจูุฆุชู
      async function getTokenFlexible(){
        if (!window.auth) throw new Error('Auth not ready');
        // 1) silent (ุงูููุถู)
        try{
          const t1 = await window.auth.getToken({ detailedResponse:false, audience:"https://api.athar" });
          if (t1) return t1;
        }catch(_){}
        // 2) popup
        try{
          await window.auth.login({ authorizationParams:{ prompt:"login", screen_hint:"login" }});
          const t2 = await window.auth.getToken({ audience:"https://api.n-athar" });
          if (t2) return t2;
        }catch(_){}
        // 3) local fallback (ูู ูุฏูู require-auth ูุถุน ุงูุชูููู ูู localStorage)
        try{
          const t3 = localStorage.getItem('athar_id_token') || localStorage.getItem('athar_access_token');
          if (t3) return t3;
        }catch(_){}
        throw new Error('no_token');
      }

      async function fillFromAuth(){
        try{
          const isAuth = await window.auth.isAuthenticated();
          if(!isAuth){
            infoEl.innerHTML = '<span class="badge">ุบูุฑ ูุณุฌู ุฏุฎูู</span> โ ุณุฌูู ุงูุฏุฎูู ูุฅุฑุณุงู ุงูุดููู.';
            btnLogin.style.display='';
            return;
          }
          btnLogin.style.display='none';

          const u = await window.auth.getUser();
          const claims = await window.auth.getIdTokenClaims().catch(()=> ({}));
          const status = claims?.[CLAIM_NS+'status'] || '';
          const badge =
            status==='active'  ? '<span class="badge status-active">ุญุณุงุจู ูุดุท</span>' :
            status==='pending' ? '<span class="badge status-pending">ุญุณุงุจู ูุนููู</span>' :
                                 '<span class="badge status-cancelled">ุบูุฑ ูุดุท</span>';

          infoEl.innerHTML = `${badge}${u?.email ? ' โ '+u.email : ''}`;
          if (u?.name && !nameEl.value)  nameEl.value  = u.name;
          if (u?.email && !emailEl.value) emailEl.value = u.email;

          // ูุง ูููุน ุงูุฅุฑุณุงู ููุงุ ุงูููุน ุงูุญูููู ูู ุงูุฏุงูุฉ (ุญุณุจ REQUIRE_ACTIVE)
          setStatus('');
        }catch(_){}
      }

      btnLogin.addEventListener('click', ()=>{
        window.auth?.login({ authorizationParams:{ screen_hint:'login', redirect_uri: window.location.href }});
      });

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        setStatus('');
        const subject = (subjEl.value||'').trim();
        const message = (msgEl.value||'').trim();
        if (!subject || !message){ setStatus('ุงูุฑุฌุงุก ุชุนุจุฆุฉ ุงูุนููุงู ูุงูุฑุณุงูุฉ'); return; }

        try{
          lock(true); setStatus('ุฌุงุฑู ุงูุฅุฑุณุงู.');
          const token = await getTokenFlexible();

          const payload = {
            type: (typeEl.value||'complaint'),
            subject,
            name: (nameEl.value||'').trim(),
            email:(emailEl.value||'').toLowerCase().trim(),
            message,
            order_number: (orderEl.value||'').trim() || null
          };

          const res = await fetch('/.netlify/functions/complaints-create', {
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
            body: JSON.stringify(payload)
          });

          const out = await res.json().catch(()=> ({}));
          if (!res.ok){
            if (res.status===401){ setStatus('ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุฃูููุง.'); btnLogin.style.display=''; }
            else if (res.status===403){ setStatus('ูุง ูููู ุงูุฅุฑุณุงู: ุงูุญุณุงุจ ุบูุฑ ูุดุท.'); }
            else { setStatus(out?.error || 'ุชุนุฐูุฑ ุงูุฅุฑุณุงูุ ุญุงูู ูุงุญููุง.'); }
            return;
          }

          setStatus('ุชู ุงุณุชูุงู ุงูุฑุณุงูุฉ โ');
          form.reset();
        }catch(err){
          setStatus(err?.message==='no_token' ? 'ูู ูุชููู ูู ุงููุตุงุฏูุฉ. ุณุฌูู ุงูุฏุฎูู ุซู ุฃุนุฏ ุงููุญุงููุฉ.' : 'ุชุนุฐูุฑ ุงูุฅุฑุณุงูุ ุญุงูู ูุงุญููุง.');
        }finally{ lock(false); }
      });

      (async function run(){
        await waitAuth();
        await fillFromAuth();
      })();
    })();
  </script>
</body>
</html>
