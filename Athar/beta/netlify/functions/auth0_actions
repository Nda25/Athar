/**
 * Athar Claims (Post-Login)
 * namespace: https://n-athar.co/
 * - ÙŠØ¹ÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
 * - ÙŠØ¹ÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© trial/active/inactive (+ pending Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
 * - ÙŠØ¯ÙØ¹ trial 3 Ø£ÙŠØ§Ù… Ù„Ø£ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
 */
exports.onExecutePostLogin = async (event, api) => {
  const NS = "https://n-athar.co/";

  // ===== Roles/Admin from RBAC =====
  const roles = Array.isArray(event.authorization?.roles) ? event.authorization.roles : [];
  api.idToken.setCustomClaim(NS + "roles", roles);
  api.accessToken.setCustomClaim(NS + "roles", roles);

  const isAdmin = roles.includes("admin") || (event.user.app_metadata?.role === "admin");
  if (isAdmin) {
    api.idToken.setCustomClaim(NS + "admin", true);
    api.accessToken.setCustomClaim(NS + "admin", true);
  }

  // ===== Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ =====
  const amd = event.user.app_metadata || {};
  const now = new Date();

  let status = "inactive"; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ

  // Ù„Ùˆ ØªØ¨ÙŠÙ† ØªÙ…Ù†Ø¹ÙŠÙ† Ù‚Ø¨Ù„ ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ØŒ Ø§ÙØªØ­ÙŠ Ø§Ù„Ø³Ø·Ø±ÙŠÙ† Ø§Ù„ØªØ§Ù„ÙŠÙŠÙ†
  // if (!event.user.email_verified) {
  //   status = "pending"; // Ù„Ù† ÙŠÙÙØ¹ÙÙ‘Ù„ Ø´ÙŠØ¡ Ù‚Ø¨Ù„ ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
  // } else {

  // Ù…Ø¯ÙÙˆØ¹ = Ù†Ø´Ø·
  if (amd.paid_until && new Date(amd.paid_until) > now) {
    status = "active";
  } else {
    // ØªØ¬Ø±Ø¨Ø© 3 Ø£ÙŠØ§Ù… ØªÙÙ†Ø´Ø£ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
    if (!amd.trial_started || !amd.trial_expires) {
      const started = now.toISOString();
      const expires = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000).toISOString();
      api.user.setAppMetadata("trial_started", started);
      api.user.setAppMetadata("trial_expires", expires);
      status = "trial";

      // ğŸ‘‡ Ø­Ù‚Ù† ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØªØ¬Ø±Ø¨Ø© ÙÙŠ Ø§Ù„Ù€Tokens Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
      api.idToken.setCustomClaim(NS + "trial_started", started);
      api.accessToken.setCustomClaim(NS + "trial_started", started);
      api.idToken.setCustomClaim(NS + "trial_expires", expires);
      api.accessToken.setCustomClaim(NS + "trial_expires", expires);

    } else {
      const exp = new Date(amd.trial_expires);
      status = (now <= exp) ? "trial" : "inactive";

      // ğŸ‘‡ Ø¥Ù† ÙƒØ§Ù†Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ù†Ø¶ÙŠÙÙ‡Ø§ Ø£ÙŠØ¶Ù‹Ø§ ÙÙŠ Ø§Ù„Ù€Tokens
      api.idToken.setCustomClaim(NS + "trial_started", amd.trial_started);
      api.accessToken.setCustomClaim(NS + "trial_started", amd.trial_started);
      api.idToken.setCustomClaim(NS + "trial_expires", amd.trial_expires);
      api.accessToken.setCustomClaim(NS + "trial_expires", amd.trial_expires);
    }
  }
  // }  // <-- Ø§ØºÙ„Ø§Ù‚ÙŠ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ§Ù‹ Ù„Ùˆ ÙØ¹Ù‘Ù„ØªÙ Ø­Ø¸Ø± ØºÙŠØ± Ø§Ù„Ù…ÙˆØ«ÙÙ‘Ù‚

  // Ù†ÙØµØ¯Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù€ tokens
  api.idToken.setCustomClaim(NS + "status", status);
  api.accessToken.setCustomClaim(NS + "status", status);

  // ===== Ø®Ø·Ø©/Ø®ØµØ§Ø¦Øµ Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) =====
  const plan = amd.plan || "free";
  api.idToken.setCustomClaim(NS + "plan", plan);
  if (amd.role)        api.idToken.setCustomClaim(NS + "role", amd.role);
  if (amd.signup_code) api.idToken.setCustomClaim(NS + "signup_code", amd.signup_code);

  // Ù…Ù†Ø¸Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  if (event.organization) {
    api.idToken.setCustomClaim(NS + "org_id",   event.organization.id);
    api.idToken.setCustomClaim(NS + "org_name", event.organization.display_name || event.organization.name);
  }

  // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
  if (event.user?.email) {
    api.idToken.setCustomClaim(NS + "email", event.user.email);
  }
  const fullName = event.user?.user_metadata?.full_name || event.user?.name;
  if (fullName) {
    api.idToken.setCustomClaim(NS + "full_name", fullName);
  }
};
