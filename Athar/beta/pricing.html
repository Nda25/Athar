<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ุงูุฏูุน ูุงูุฅุดุชุฑุงู โ ุฃุซููุฑ</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Amiri:wght@700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="dark light">
</head>
<body>
  <div class="global-bg"></div>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <div class="topbar">
    <div class="left-actions">
      <a class="btn" href="index.html" title="ุงูุฑุฆูุณูุฉ">ุงูุฑุฆูุณูุฉ</a>
    </div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="ุงููุถุน ุงูุฏุงูู/ุงููุงุชุญ">๐</button>
    </div>
    <div class="user" style="gap:10px">
      <button class="btn" id="login">ุงูุฏุฎูู / ุฅูุดุงุก ุญุณุงุจ</button>
      <button class="btn ghost" id="logout" style="display:none">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
    </div>
  </div>

  <header>
    <div class="hero">
      <div class="hero-plate"></div>
      <h1 class="logo">ุฃุซููููุฑ</h1>
      <div class="tag"><span class="dot"></span>ุงุฎุชุฑ ุงูุฎุทุฉ ุงูููุงุณุจุฉ ููููู ูู ุฃุซููุฑ</div>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="card" style="margin-top:-14px">
        <h2 class="title">ุงูุงุดุชุฑุงูุงุช</h2>
        <p class="lead">ูู ุงูุฎุทุท ุชููุญู ูุตูููุง ูุงูููุง ููุฃุฏูุงุช ูุงููุฒุงูุง.</p>
        <p id="whoami" class="muted" style="text-align:center; margin:8px 0 0; display:none"></p>

        <div id="choose-plan" class="plans" style="margin-top:22px">
          <div class="plan">
            <h4>ุฃุณุจูุนู</h4><div class="price">12.99 ุฑ.ุณ</div>
            <button class="btn primary" data-plan="weekly" onclick="subscribe('weekly')">ุงุดุชุฑู ุงูุขู</button>
          </div>
          <div class="plan">
            <h4>ุดูุฑู</h4><div class="price">29.99 ุฑ.ุณ</div>
            <button class="btn primary" data-plan="monthly" onclick="subscribe('monthly')">ุงุดุชุฑู ุงูุขู</button>
          </div>
          <div class="plan">
            <h4>ูุตู ุณููู</h4><div class="price">169.99 ุฑ.ุณ</div>
            <button class="btn primary" data-plan="semiannual" onclick="subscribe('semiannual')">ุงุดุชุฑู ุงูุขู</button>
          </div>
          <div class="plan">
            <h4>ุณููู</h4><div class="price">339.99 ุฑ.ุณ</div>
            <button class="btn primary" data-plan="annual" onclick="subscribe('annual')">ุงุดุชุฑู ุงูุขู</button>
          </div>
        </div>

        <div class="box" style="margin-top:18px">
          <h3>ูุฏูู ุฑูุฒ ุชุฑููุฌูุ</h3>
          <div class="form-row">
            <label for="promo">ุฃุฏุฎู ุงูุฑูุฒ</label>
            <input id="promo" name="promo" placeholder="ูุซุงู: ATHAR30" />
          </div>
          <div class="actions-row" style="justify-content:flex-start;margin-top:10px">
            <button id="redeem" class="btn">ุชูุนูู ุงูุฑูุฒ</button>
            <small class="muted" id="redeem-msg"></small>
          </div>
        </div>
      </section>

      <section class="grid">
        <div class="box">
          <h3>ููุงุฐุง ยซุฃุซููุฑยปุ</h3>
          <p>ูุฃู ููุชู ุฃุซูู ูู ุฃู ููุณุชููู ูู ุงูุชูุณูู ูุงูุจุญุซ ุงููุชูุฑุฑ. ูุฌูุน ยซุฃุซููุฑยป ุฃุฏูุงุช ุงูุชุญุถูุฑ ูู ููุงู ูุงุญุฏ ูุชุฎุชุตุฑ ุงูููุชุ ูุชุฑูุน ุฌูุฏุฉ ุฏุฑุณูุ ูุชููุญ ููุณู ูุณุญุฉ ุฃูุจุฑ ููุฅุจุฏุงุน ุฏุงุฎู ุงูุตู.</p>
          <p>ูู ุงูุงุณุชุฑุงุชูุฌูุฉ ุฅูู ุฎุทุฉ ุงูุฏุฑุณุ ููู ุงูุฌุฏูู ุฅูู ุงูุชุฐููุฑุ ููู ุงูุฃูุดุทุฉ ุฅูู ุงูุฃููุงุฑ ุงูุญุฏูุซุฉโ ูู ูุง ุชุญุชุงุฌู ุจูู ูุฏูู.</p>
        </div>
        <div class="box">
          <h3>ุฎุทูุงุช ุณูุณุฉ</h3>
          <p>ุจุนุฏ ุงุฎุชูุงุฑ ุงูุฎุทุฉ ูุชุฃููุฏ ุงูุญุณุงุจุ ูุชู ุชูุนูู ุงูุงุดุชุฑุงู ูุฑุจุท ุงูุฃุฏูุงุช ุจุญุณุงุจู ุจุดูู ููุธูุ ูุชุจุฏุฃ ุงุณุชุฎุฏุงู ยซุฃุซููุฑยป ุฏูู ุฃู ุชุนููุฏุงุช.</p>
        </div>
        <div class="box full">
          <h3>ููุงุฐุง ุงูุงุดุชุฑุงู ูุฏููุนุ</h3>
          <p>ยซุฃุซุฑยป ูุจุงุฏุฑุฉ ุชุนููููุฉ ุชุฏุนู ุงููุนูู ูุชุทููุฑ ุงูููุงุฑุณุงุช ุงูุตููุฉ. ุงูููุงุจู ุงูุฑูุฒู ูุบุทู ุงูุชุดุบูู (ุฎูุงุฏูุ ุตูุงูุฉุ ุชุทููุฑ) ููุจูู ุงููุดุฑูุน ูุณุชูุฑูุง ูููุซูููุง ๐ฟ.</p>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <p class="foot-line">ุงูุชุนููู ุดุฑุงุฑุฉ ุตุบูุฑุฉโฆ ุชูุถูุก ุนููููุง ูุจูุฑุฉ.</p>
    <p class="foot-name">ูุฏู ุงููุฌูุฑุด</p>
    <nav class="foot-links">
      <a href="privacy.html">ุณูุงุณุฉ ุงูุฎุตูุตูุฉ</a><span class="sep">|</span>
      <a href="terms.html">ุงูุดุฑูุท ูุงูุฃุญูุงู</a><span class="sep">|</span>
      <a href="refund-policy.html">ุณูุงุณุฉ ุงูุงุณุชุฑุฌุงุน</a><span class="sep">|</span>
      <a href="whatsapp.html">ุชูุงุตู ูุงุชุณุงุจ</a><span class="sep">|</span>
      <a href="complaints.html">ุงูุดูุงูู ูุงูุงูุชุฑุงุญุงุช</a>
    </nav>
    <div class="foot-copy">ยฉ <span id="year"></span> ุฃุซููุฑ โ ูู ุงูุญููู ูุญููุธุฉ.</div>
  </footer>

  <script>(function(){var y=document.getElementById('year'); if(y) y.textContent=new Date().getFullYear();})();</script>
  <div class="toast" id="toast"></div>

  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="/assets/js/supabase-client.js"></script>
  <script src="assets/js/storage.js"></script>

  <script>
  // ===== Helper for toasts =====
  const $ = (s)=>document.querySelector(s);
  const toast = (m)=>{ const t=$('#toast'); if(!t){alert(m);return;} t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1300); };

  let auth0; // will set below

  // ===== Auth0 init =====
  (async function initAuth(){
    const AUTH0_DOMAIN   = (window.__CFG && window.__CFG.auth0_domain)   || "dev-2f0fmbtj6u8o7en4.us.auth0.com";
    const AUTH0_CLIENTID = (window.__CFG && window.__CFG.auth0_clientId) || "rXaNXLwIkIOALVTWbRDA8SwJnERnI1NU";
    const REDIRECT_URI   = window.location.origin + window.location.pathname;

    auth0 = await createAuth0Client({
      domain: AUTH0_DOMAIN,
      clientId: AUTH0_CLIENTID,
      authorizationParams: { redirect_uri: REDIRECT_URI, audience: (window.__CFG && window.__CFG.api_audience) || "https://api.n-athar" }
    });

    if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
      try {
        const { appState } = await auth0.handleRedirectCallback();
        if (appState?.plan) localStorage.setItem('intended_plan', appState.plan);
      } catch(e) { console.warn("Auth0 callback error:", e); }
      window.history.replaceState({}, document.title, window.location.pathname);
      // ุจุนุฏ ุงูุนูุฏุฉ ูู ุชุณุฌูู ุงูุฏุฎูู: ูู ููู ููุฉ ุงุดุชุฑุงูุ ููููู ูุจุงุดุฑุฉ
      const intended = localStorage.getItem('intended_plan');
      if (intended) subscribe(intended);
    }

    await refreshAuthUI();
  })();

  async function isLogged(){ try { return await auth0.isAuthenticated(); } catch(_) { return false; } }

  async function refreshAuthUI(){
    const logged = await isLogged();
    const loginBtn  = $('#login');
    const logoutBtn = $('#logout');
    const whoami    = $('#whoami');

    if (logged) {
      let user=null;
      try { user = await auth0.getUser(); } catch(_){}
      loginBtn.textContent = user?.email || 'ุญุณุงุจู';
      logoutBtn.style.display = 'inline-flex';
      whoami.style.display='block';
      whoami.textContent = user?.email ? ('ูุณุฌูู ูู ' + user.email) : 'ุญุณุงุจู ูุดูุท';
      document.querySelectorAll('#choose-plan .btn[data-plan]').forEach(b=>b.textContent="ุฅููุงู ุงูุงุดุชุฑุงู");
    } else {
      loginBtn.textContent = 'ุงูุฏุฎูู / ุฅูุดุงุก ุญุณุงุจ';
      logoutBtn.style.display = 'none';
      if (whoami) whoami.style.display='none';
      document.querySelectorAll('#choose-plan .btn[data-plan]').forEach(b=>b.textContent="ุงุดุชุฑู ุงูุขู");
    }
  }

  $('#login')?.addEventListener('click', () => auth0.loginWithRedirect({ appState: { plan: localStorage.getItem('intended_plan') || null } }));
  $('#logout')?.addEventListener('click', () => auth0.logout({ logoutParams:{ returnTo: window.location.origin }}) );

  // ===== Promo redeem (ุงุฎุชูุงุฑู โ ูุจูู ููุง ูู ูููุชุญูู ุจุงูุฎุงุฏู) =====
  $('#redeem')?.addEventListener('click', async ()=>{
    const code = ($('#promo')?.value || '').trim();
    const msgEl = $('#redeem-msg'); msgEl.textContent = '';
    if (!code){ msgEl.textContent = 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุฑูุฒ'; return; }

    try{
      const token = await auth0.getTokenSilently();
      const res = await fetch('/.netlify/functions/promo-redeem', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ code })
      });
      const out = await res.text();
      if (!res.ok) { msgEl.textContent = out || 'ุชุนุฐุฑ ุชูุนูู ุงูุฑูุฒ'; return; }
      const j = JSON.parse(out);
      msgEl.textContent = 'ุชู ุงูุชูุนูู โุ ุชุงุฑูุฎ ุงูุงูุชูุงุก: ' + (new Date(j.expires_at)).toLocaleDateString('ar-SA');
    }catch(e){
      msgEl.textContent = 'ุชุนุฐุฑ ุชูุนูู ุงูุฑูุฒ';
    }
  });

  // ===== ุงูุงุดุชุฑุงู: ุฅูุดุงุก ูุงุชูุฑุฉ ููุณูุฑ ูุงูุฐูุงุจ ุฅูููุง =====
  async function subscribe(plan){
    const btn = document.querySelector(`[data-plan="${plan}"]`);
    if (!btn) return;
    localStorage.setItem('intended_plan', plan);

    // ุชุฃูุฏู ูู ุชุณุฌูู ุงูุฏุฎูู
    if (!(await isLogged())){
      await auth0.loginWithRedirect({ appState: { plan } });
      return; // ุณููุณุชุฃูู ุชููุงุฆููุง ุจุนุฏ ุงูุนูุฏุฉ
    }

    // ุงุฌูุจ ุงูุฑูุฒ ุงูุชุฑููุฌู (ุงุฎุชูุงุฑู)
    const promo = ($('#promo')?.value || '').trim() || null;

    btn.disabled = true; const old = btn.textContent; btn.textContent = "ุฌุงุฑู ุงูุชูุฌููโฆ";
    try{
      const token = await auth0.getTokenSilently();
      const res = await fetch('/.netlify/functions/payments-create-invoice', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ plan, promo })
      });
      const j = await res.json().catch(()=>({}));
      if(!res.ok || !j?.url){
        alert(j?.error || 'ุชุนุฐูุฑ ุฅูุดุงุก ุงููุงุชูุฑุฉ'); btn.disabled=false; btn.textContent=old; return;
      }
      window.location.href = j.url; // ุชุญููู ูุจุงุดุฑ ูุตูุญุฉ ุงูุฏูุน ูู ููุณูุฑ
    }catch(e){
      alert('ุฎุทุฃ ููุงุฌุฆ'); btn.disabled=false; btn.textContent=old;
    }
  }
  // ุฅุชุงุญุฉ ุงูุฏุงูุฉ ุนุงููููุง ููุฃุฒุฑุงุฑ
  window.subscribe = subscribe;

  // ุญุฏูุซ ุงููุงุฌูุฉ ุนูุฏ ุชุบููุฑ ุญุงูุฉ Auth0
  window.addEventListener('auth0:ready', refreshAuthUI);
  </script>

  <script src="assets/js/require-auth.js"></script>
</body>
</html>
