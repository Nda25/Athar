<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ุงูุฏูุน ูุงูุงุดุชุฑุงู โ ุฃุซููุฑ</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Amiri:wght@700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="dark light">
</head>
<body>
  <div class="global-bg"></div>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <div class="topbar">
    <div class="left-actions">
      <a class="btn" href="index.html" title="ุงูุฑุฆูุณูุฉ">ุงูุฑุฆูุณูุฉ</a>
    </div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="ุงููุถุน ุงูุฏุงูู/ุงููุงุชุญ">๐</button>
    </div>
    <div class="user" style="gap:10px">
      <button class="btn ghost" id="logout" style="display:none">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
    </div>
  </div>

  <header>
    <div class="hero">
      <div class="hero-plate"></div>
      <h1 class="logo">ุฃุซููููุฑ</h1>
      <div class="tag"><span class="dot"></span>ุงุฎุชุฑ ุงูุฎุทุฉ ุงูููุงุณุจุฉ ููููู ูู ุฃุซููุฑ</div>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="card" style="margin-top:-14px">
        <h2 class="title">ุงูุงุดุชุฑุงูุงุช</h2>
        <p class="lead">ูู ุงูุฎุทุท ุชููุญู ูุตูููุง ูุงูููุง ููุฃุฏูุงุช ูุงููุฒุงูุง.</p>
        <p id="whoami" class="muted" style="text-align:center; margin:8px 0 0; display:none"></p>

        <div id="choose-plan" class="plans" style="margin-top:22px">
          <div class="plan">
            <h4>ุฃุณุจูุนู</h4><div class="price">12.99 ุฑ.ุณ</div>
            <button class="btn primary" type="button" data-plan="weekly"     onclick="subscribe('weekly')">ุงุดุชุฑู ุงูุขู</button>
          </div>
          <div class="plan">
            <h4>ุดูุฑู</h4><div class="price">29.99 ุฑ.ุณ</div>
            <button class="btn primary" type="button" data-plan="monthly"    onclick="subscribe('monthly')">ุงุดุชุฑู ุงูุขู</button>
          </div>
          <div class="plan">
            <h4>ูุตู ุณููู</h4><div class="price">169.99 ุฑ.ุณ</div>
            <button class="btn primary" type="button" data-plan="semiannual" onclick="subscribe('semiannual')">ุงุดุชุฑู ุงูุขู</button>
          </div>
          <div class="plan">
            <h4>ุณููู</h4><div class="price">339.99 ุฑ.ุณ</div>
            <button class="btn primary" type="button" data-plan="annual"     onclick="subscribe('annual')">ุงุดุชุฑู ุงูุขู</button>
          </div>
        </div>

        <div class="box" style="margin-top:18px">
          <h3>ูุฏูู ุฑูุฒ ุชุฑููุฌูุ</h3>
          <div class="form-row">
            <label for="promo">ุฃุฏุฎู ุงูุฑูุฒ</label>
            <input id="promo" name="promo" placeholder="ูุซุงู: ATHAR30" />
          </div>
          <div class="actions-row" style="justify-content:flex-start;margin-top:10px">
            <button id="redeem" class="btn">ุชูุนูู ุงูุฑูุฒ</button>
            <small class="muted" id="redeem-msg"></small>
          </div>
        </div>
      </section>

      <section class="grid">
        <div class="box">
          <h3>ููุงุฐุง ยซุฃุซููุฑยปุ</h3>
          <p>ูุฃู ููุชู ุฃุซูู ูู ุฃู ููุณุชููู ูู ุงูุชูุณูู ูุงูุจุญุซ ุงููุชูุฑุฑ. ูุฌูุน ยซุฃุซููุฑยป ุฃุฏูุงุช ุงูุชุญุถูุฑ ูู ููุงู ูุงุญุฏ ูุชุฎุชุตุฑ ุงูููุชุ ูุชุฑูุน ุฌูุฏุฉ ุฏุฑุณูุ ูุชููุญ ููุณู ูุณุญุฉ ุฃูุจุฑ ููุฅุจุฏุงุน ุฏุงุฎู ุงูุตู.</p>
          <p>ูู ุงูุงุณุชุฑุงุชูุฌูุฉ ุฅูู ุฎุทุฉ ุงูุฏุฑุณุ ููู ุงูุฌุฏูู ุฅูู ุงูุชุฐููุฑุ ููู ุงูุฃูุดุทุฉ ุฅูู ุงูุฃููุงุฑ ุงูุญุฏูุซุฉโ ูู ูุง ุชุญุชุงุฌู ุจูู ูุฏูู.</p>
        </div>
        <div class="box">
          <h3>ุฎุทูุงุช ุณูุณุฉ</h3>
          <p>ุจุนุฏ ุงุฎุชูุงุฑ ุงูุฎุทุฉ ูุชุฃููุฏ ุงูุญุณุงุจุ ูุชู ุชูุนูู ุงูุงุดุชุฑุงู ูุฑุจุท ุงูุฃุฏูุงุช ุจุญุณุงุจู ุจุดูู ููุธูุ ูุชุจุฏุฃ ุงุณุชุฎุฏุงู ยซุฃุซููุฑยป ุฏูู ุฃู ุชุนููุฏุงุช.</p>
        </div>
        <div class="box full">
          <h3>ููุงุฐุง ุงูุงุดุชุฑุงู ูุฏููุนุ</h3>
          <p>ยซุฃุซุฑยป ูุจุงุฏุฑุฉ ุชุนููููุฉ ุชุฏุนู ุงููุนูู ูุชุทููุฑ ุงูููุงุฑุณุงุช ุงูุตููุฉ. ุงูููุงุจู ุงูุฑูุฒู ูุบุทู ุงูุชุดุบูู (ุฎูุงุฏูุ ุตูุงูุฉุ ุชุทููุฑ) ููุจูู ุงููุดุฑูุน ูุณุชูุฑูุง ูููุซูููุง ๐ฟ.</p>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <p class="foot-line">ุงูุชุนููู ุดุฑุงุฑุฉ ุตุบูุฑุฉโฆ ุชูุถูุก ุนููููุง ูุจูุฑุฉ.</p>
    <p class="foot-name">ูุฏู ุงููุฌูุฑุด</p>
    <nav class="foot-links">
      <a href="privacy.html">ุณูุงุณุฉ ุงูุฎุตูุตูุฉ</a><span class="sep">|</span>
      <a href="terms.html">ุงูุดุฑูุท ูุงูุฃุญูุงู</a><span class="sep">|</span>
      <a href="refund-policy.html">ุณูุงุณุฉ ุงูุงุณุชุฑุฌุงุน</a><span class="sep">|</span>
      <a href="whatsapp.html">ุชูุงุตู ูุงุชุณุงุจ</a><span class="sep">|</span>
      <a href="complaints.html">ุงูุดูุงูู ูุงูุงูุชุฑุงุญุงุช</a>
    </nav>
    <div class="foot-copy">ยฉ <span id="year"></span> ุฃุซููุฑ โ ูู ุงูุญููู ูุญููุธุฉ.</div>
  </footer>

  <script>(function(){var y=document.getElementById('year'); if(y) y.textContent=new Date().getFullYear();})();</script>
  <div class="toast" id="toast"></div>

  <!-- SDKs -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.2/auth0-spa-js.production.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="/assets/js/supabase-client.js"></script>
  <script src="assets/js/storage.js"></script>

  <!-- ุงูุญุงุฑุณ (ูููุดุฆ window.auth ููุถุจุท CALLBACK ุงูุซุงุจุช) -->
  <script src="assets/js/require-auth.js"></script>

  <!-- ุฑุณุงูุฉ ูุฌุงุญ ุงูุฏูุน ุนูุฏ ุงูุนูุฏุฉ ุจู ?paid=1 -->
  <script>
    (function(){
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('paid') === '1') {
        const msg = document.createElement('div');
        msg.textContent = "๐ ุชู ุงูุฏูุน ุจูุฌุงุญ! ุดูุฑูุง ูุงุดุชุฑุงูู ูู ุฃุซุฑ.";
        msg.style.position = "fixed";
        msg.style.top = "20px";
        msg.style.left = "50%";
        msg.style.transform = "translateX(-50%)";
        msg.style.background = "#16a34a";
        msg.style.color = "white";
        msg.style.padding = "14px 22px";
        msg.style.borderRadius = "10px";
        msg.style.fontSize = "16px";
        msg.style.zIndex = "9999";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 5000);
      }
    })();
  </script>

  <!-- ููุทู ุงูุตูุญุฉ -->
  <script>
  const $ = (s)=>document.querySelector(s);
  const toast = (m)=>{ const t=$('#toast'); if(!t){alert(m);return;} t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); };

  (function(){
    const btn = document.getElementById('themeToggle');
    if (!btn) return;
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      const root = document.documentElement;
      const dark = root.classList.toggle('dark');
      try { localStorage.setItem('theme', dark ? 'dark' : 'light'); } catch(_){}
      toast(dark ? 'ุชู ุชูุนูู ุงููุถุน ุงูุฏุงูู' : 'ุชู ุชูุนูู ุงููุถุน ุงููุงุชุญ');
    });
    try { if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark'); } catch(_){}
  })();

  async function isLogged(){
    try { return await window.auth?.isAuthenticated?.(); } catch(_) { return false; }
  }

  async function refreshAuthUI(){
    const logged = await isLogged();
    const logoutBtn = $('#logout');
    const whoami    = $('#whoami');

    if (logged) {
      let user=null;
      try { user = await window.auth.getUser(); } catch(_){}
      if (logoutBtn) logoutBtn.style.display = 'inline-flex';
      if (whoami) { whoami.style.display='block'; whoami.textContent = user?.email ? ('ูุณุฌูู ูู ' + user.email) : 'ุญุณุงุจู ูุดูุท'; }
      document.querySelectorAll('#choose-plan .btn[data-plan]').forEach(b=>b.textContent="ุฅููุงู ุงูุงุดุชุฑุงู");
    } else {
      if (logoutBtn) logoutBtn.style.display = 'none';
      if (whoami) whoami.style.display='none';
      document.querySelectorAll('#choose-plan .btn[data-plan]').forEach(b=>b.textContent="ุงุดุชุฑู ุงูุขู");
    }
  }

  // ุงูุฎุฑูุฌ (ุงูุญุงุฑุณ ููุฌู ููู RETURN_TO)
  $('#logout')?.addEventListener('click', () => {
    window.auth?.logout?.();
  });

  // ุชูุนูู ุงูุฑูุฒ (ุงุฎุชูุงุฑู)
  $('#redeem')?.addEventListener('click', async ()=>{
    const code = ($('#promo')?.value || '').trim();
    const msgEl = $('#redeem-msg'); msgEl.textContent = '';
    if (!code){ msgEl.textContent = 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุฑูุฒ'; return; }

    try{
      const token = await window.auth.getTokenSilently();
      const res = await fetch('/.netlify/functions/promo-redeem', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ code })
      });
      const out = await res.text();
      if (!res.ok) { msgEl.textContent = out || 'ุชุนุฐูุฑ ุชูุนูู ุงูุฑูุฒ'; return; }
      const j = JSON.parse(out);
      msgEl.textContent = 'ุชู ุงูุชูุนูู โุ ุชุงุฑูุฎ ุงูุงูุชูุงุก: ' + (new Date(j.expires_at)).toLocaleDateString('ar-SA');
    }catch(e){
      msgEl.textContent = 'ุชุนุฐูุฑ ุชูุนูู ุงูุฑูุฒ';
    }
  });

  <!-- ุณูุฑุจุช ุงูุงุดุชุฑุงู ุงููุญุฏูุซ -->
  </script>
  <script>
    async function isLogged(){  // ููุฑุฑ ููุง ูุง ุจุฃุณ (scope ูููุตู)
      try { return await window.auth?.isAuthenticated?.(); } catch(_) { return false; }
    }

    async function getToken() {
      try {
        return await window.auth.getTokenSilently();
      } catch (e) {
        console.warn('getTokenSilently failed, trying popup', e);
        if (window.auth?.getTokenWithPopup) {
          return await window.auth.getTokenWithPopup();
        }
        throw e;
      }
    }

    async function subscribe(plan){
      const btn = document.querySelector(`[data-plan="${plan}"]`);
      if (!btn) return;
      try { localStorage.setItem('intended_plan', plan); } catch(_){}

      // ุชุฃูุฏ ูู ุชุณุฌูู ุงูุฏุฎูู
      if (!(await isLogged())){
        try { localStorage.setItem('afterLogin', '/pricing.html'); } catch(_){}
        return window.auth?.loginWithRedirect?.();
      }

      // ููุน ุงูููุฑ ุงูููุฑุฑ
      if (btn.dataset.loading === '1') return;
      btn.dataset.loading = '1';
      const old = btn.textContent;
      btn.disabled = true; btn.textContent = "ุฌุงุฑู ุงูุชูุฌููโฆ";

      const promo = (document.getElementById('promo')?.value || '').trim() || null;

      try{
        const token = await getToken();
        if (!token) throw new Error('no_token');

        const res = await fetch('/.netlify/functions/payments-create-invoice?ts=' + Date.now(), {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ plan, promo })
        });

        const raw = await res.text();
        let j = {};
        try { j = JSON.parse(raw); } catch { j = {}; }

        if (!res.ok || !j?.url) {
          console.error('create-invoice failed', { status: res.status, raw });
          alert(j?.error || `ุชุนุฐูุฑ ุฅูุดุงุก ุงููุงุชูุฑุฉ (status ${res.status}).`);
          btn.disabled=false; btn.textContent=old; btn.dataset.loading=''; return;
        }

        // ุงูุชุญ ุตูุญุฉ ููุณูุฑ
        window.location.replace(j.url);

      } catch(e){
        console.error('subscribe error:', e);
        alert('ุชุนุฐูุฑ ุฅูุดุงุก ุงููุงุชูุฑุฉ. ุฌุฑูุจู ุชุณุฌูู ุงูุฎุฑูุฌ ุซู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู.');
        btn.disabled=false; btn.textContent=old; btn.dataset.loading='';
      }
    }
    window.subscribe = subscribe;

    // ุชุญุฏูุซ ุงููุงุฌูุฉ ุนูุฏ ุฌุงูุฒูุฉ Auth0 + ุชุบููุฑ ูุต ุงูุฃุฒุฑุงุฑ
    window.addEventListener('auth0:ready', async ()=>{
      await refreshAuthUI();
      try {
        if (await isLogged()) {
          document.querySelectorAll('#choose-plan .btn[data-plan]')
            .forEach(b=>b.textContent="ุฅููุงู ุงูุงุดุชุฑุงู");
        }
      } catch(_){}
    });
  </script>

  <!-- ุดุฑูุท ุฑุณุงูุฉ ุชุญููู ูู require-auth.js (toPricing) -->
  <script>
  (function(){
    try {
      const msg = sessionStorage.getItem("athar:msg");
      if (!msg) return;
      sessionStorage.removeItem("athar:msg");

      if (typeof window.toast === 'function') { toast(msg); return; }

      const bar = document.createElement('div');
      bar.dir = 'rtl';
      bar.style.cssText = "background:#1f2937;color:#fff;padding:12px 16px;text-align:center;font:500 14px/1.6 system-ui;border-radius:10px;margin:12px auto;max-width:960px";
      bar.textContent = msg;
      document.body.prepend(bar);
    } catch(_) {}
  })();
  </script>
</body>
</html>
