<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙÙ€Ù„Ù€Ù‡Ù€Ù…</title>

  <!-- Ø®Ø· + Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…ÙˆÙ‚Ø¹ (ÙŠØ­ØªÙˆÙŠ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ) -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <meta name="color-scheme" content="dark light" />

  <style>
    :root{ --accent:#3b82f6; }

    .field{ margin:10px 0 }
    .field label{ display:block; font-weight:700; margin:6px 0 }
    .field input,.field select{
      width:100%; padding:12px; border-radius:12px;
      border:1px solid rgba(59,130,246,.35)
    }

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
    .cols-3{ display:grid; gap:12px; grid-template-columns:1fr }
    @media(min-width:900px){ .cols-3{ grid-template-columns:1fr 1fr 1fr } }

    /* Ø´Ø¨ÙƒØ© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…ÙˆØ¶ÙˆØ¹ + Ø§Ù„Ù…Ø±Ø­Ù„Ø© */
    .cols-2 { display:grid; gap:12px; grid-template-columns:1fr 1fr; }

    /* ===== Ø®ÙŠØ§Ø±Ø§Øª Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Ø³ÙˆÙŠØªØ´ Ù…Ø¹ Ù†Øµ Ø®Ø§ÙØª ===== */
    .field.inline label{
      display:flex; align-items:center; gap:10px;
      font-size:.95rem; font-weight:600; color: var(--muted);
      line-height:1.5; white-space:normal;
    }
    .field.inline input[type="checkbox"]{
      appearance:none; -webkit-appearance:none;
      width:46px; height:26px; border-radius:999px;
      background:#e2e8f0; border:1px solid #cbd5e1; position:relative;
      outline:none; cursor:pointer; transition: background .18s ease, border-color .18s ease;
      flex:0 0 46px; margin:0;
    }
    .field.inline input[type="checkbox"]::after{
      content:""; position:absolute; top:1px; inset-inline-start:1px;
      width:22px; height:22px; border-radius:50%; background:#fff;
      box-shadow:0 1px 3px rgba(0,0,0,.18); transition: inset-inline-start .18s ease;
    }
    .field.inline input[type="checkbox"]:checked{ background:var(--sea-500); border-color:var(--sea-500) }
    .field.inline input[type="checkbox"]:checked::after{ inset-inline-start: calc(100% - 23px) }
    .field.inline input[type="checkbox"]:focus-visible{ box-shadow:0 0 0 3px rgba(59,130,246,.25) }
    .dark .field.inline input[type="checkbox"]{ background:#1f2937; border-color:#334155 }
    .dark .field.inline input[type="checkbox"]:checked{ background:#3b82f6; border-color:#3b82f6 }

    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØµÙ ÙˆØ§Ø­Ø¯ Ø¨Ø§Ù„ÙˆØ³Ø· */
    .actions-row{ display:flex; justify-content:center; align-items:center; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .actions-row .btn{ min-width:140px; }
    @media (max-width:480px){ .actions-row .btn{ min-width:120px; } }

    /* Ù…Ù†Ø¹ Ø£ÙŠ Ø®Ø±ÙˆØ¬ Ø¨ØµØ±ÙŠ Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
    .card{ overflow:hidden; }

    .printable{
      border:1px solid color-mix(in oklab, var(--accent) 40%, #cbd5e1);
      border-radius:12px; padding:14px; margin-top:8px; background:var(--card);
    }
    .set-card{ border:1px dashed rgba(59,130,246,.35); border-radius:10px; padding:10px; margin-top:12px }
    .set-card h3{ margin:0 0 6px }
    .muted{ color: var(--muted) }
    .list{ margin:0; padding-inline-start:1.2rem }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 }
    .chip{ background:color-mix(in oklab, var(--accent) 14%, #fff); padding:4px 8px; border-radius:999px; font-size:.9rem }
    .diff-box{ background:color-mix(in oklab, var(--accent) 10%, #fff); border-radius:8px; padding:8px; margin-top:8px; font-size:.95rem }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }

    /* ØªØ¬Ø§ÙˆØ¨ */
    @media (max-width: 900px){
      .cols-3{ grid-template-columns: 1fr !important; }
      .cols-2{ grid-template-columns: 1fr !important; }
    }

    /* ==== ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„Ø¬ÙˆØ§Ù„/Ø§Ù„Ø¢ÙŠØ¨Ø§Ø¯ ==== */
    @media print{
      html,body{ background:#fff !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      .global-bg,.backdrop,.pattern,.topbar,header,.actions-row,form,.toast{ display:none !important; }
      #out{ display:block !important; }
      .container{ width:auto; margin:0; padding:0; }
      .printable{
        width: 180mm !important;
        margin: 0 auto !important;
        border-color:#999 !important;
        box-shadow:none !important;
        background:#fff !important;
      }
      @page{ size:A4 portrait; margin:10mm; }
    }

    /* ÙˆØ¶Ø¹ Ø·Ø¨Ø§Ø¹Ø© ÙŠØ¯ÙˆÙŠ */
    body.print-mode .global-bg,
    body.print-mode .backdrop,
    body.print-mode .pattern,
    body.print-mode .topbar,
    body.print-mode header,
    body.print-mode .actions-row,
    body.print-mode form,
    body.print-mode .toast{ display:none !important; }
    body.print-mode #out{ display:block !important; }
    body.print-mode .printable{
      width:180mm; margin:0 auto; background:#fff; box-shadow:none;
    }

    /* Ø´Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ */
    .badge{display:inline-block;padding:2px 10px;border-radius:999px;background:#e5e7eb22;border:1px solid #e5e7eb33}
    .status-active{background:#dcfce733;color:#166534;border-color:#bbf7d066}
    .status-pending{background:#fef9c333;color:#713f12;border-color:#fde68a66}
    .status-cancelled{background:#fee2e233;color:#7f1d1d;border-color:#fecaca66}
  </style>
</head>
<body>
  <div class="global-bg"></div>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <div class="topbar">
    <div class="left-actions"><a class="btn" href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></div>
    <div class="actions"><button class="btn" id="themeToggle">ğŸŒ“</button></div>
    <div class="user"><a class="btn" href="programs.html">Ù…Ø³Ø§Ø­Ø© Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ</a></div>
  </div>

  <header>
    <div class="hero">
      <h1 class="logo">Ù…Ù€ÙÙ„Ù€Ù‡Ù€Ù…</h1>
      <div class="tag"><span class="dot"></span>ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© ØªØ­Ù…Ù„ ÙÙƒØ±Ø©ØŒ ÙˆÙƒÙ„ ÙÙƒØ±Ø© ØªÙØ®Ù„Ù‘Ø¯ Ø£Ø«Ø±Ù‹Ø§</div>
      <div id="acct-badge" class="muted" style="margin-top:8px"></div>
    </div>
  </header>

  <main>
    <div class="container">

      <!-- Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª -->
      <section class="card">
        <h2 class="title">Ù…Ø¯Ø®Ù„Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h2>
        <form id="mulham-form">
          <div class="cols-3">
            <div class="field"><label>Ø§Ù„Ù…Ø§Ø¯Ø©</label><input id="s-subj" name="s-subj" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª"></div>

            <div class="field"><label>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ§Ø­ (Ø¯Ù‚ÙŠÙ‚Ø©)</label>
              <select id="s-time" name="s-time">
                <option>10</option><option selected>20</option><option>30</option><option>40</option>
              </select>
            </div>

            <div class="field"><label>Ù…Ø³ØªÙˆÙ‰ Ø¨Ù„ÙˆÙ…</label>
              <select id="s-bloom" name="s-bloom">
                <option value="remember">ØªØ°ÙƒÙ‘Ø±</option>
                <option value="understand" selected>ÙÙ‡Ù…</option>
                <option value="apply">ØªØ·Ø¨ÙŠÙ‚</option>
                <option value="analyze">ØªØ­Ù„ÙŠÙ„</option>
                <option value="create">Ø§Ø¨ØªÙƒØ§Ø±</option>
              </select>
            </div>
          </div>

          <!-- Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ + Ø§Ù„Ù…Ø±Ø­Ù„Ø© -->
          <div class="cols-2">
            <div class="field">
              <label>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
              <input id="s-topic" name="s-topic" required placeholder="Ø§ÙƒØªØ¨ Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ø¯Ù‚Ø©">
            </div>

            <div class="field">
              <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
              <select id="s-age" name="s-age">
                <option value="p1">Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ Ø¯ÙÙ†ÙŠØ§</option>
                <option value="p2" selected>Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ Ø¹ÙÙ„ÙŠØ§</option>
                <option value="m">Ù…ØªÙˆØ³Ø·</option>
                <option value="h">Ø«Ø§Ù†ÙˆÙŠ</option>
              </select>
            </div>
          </div>

          <!-- Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª -->
          <div class="cols-3">
            <div class="field inline">
              <label><input type="checkbox" id="s-noTools"> Ø¨Ø¯ÙˆÙ† Ø£Ø¯ÙˆØ§ØªØŒÙƒØ±ÙˆØªØŒÙ‚Øµ ÙˆÙ„ØµÙ‚ </label>
            </div>
            <div class="field inline">
              <label><input type="checkbox" id="s-adaptLow"> Ù…Ù„Ø§Ø¡Ù…Ø© Ù„Ù„ØªØ­ÙÙŠØ² Ø§Ù„Ù…Ù†Ø®ÙØ¶</label>
            </div>
            <div class="field inline">
              <label><input type="checkbox" id="s-adaptDiff"> Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„ÙØ±ÙˆÙ‚ Ø§Ù„ÙØ±Ø¯ÙŠØ©</label>
            </div>
          </div>
        </form>

        <div class="actions-row">
          <button class="btn primary" id="go">ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</button>
          <button class="btn" id="more">Ø£Ù†Ø´Ø·Ø© Ø£Ø®Ø±Ù‰</button>
          <button class="btn" id="copy">Ù†Ø³Ø®</button>
          <button class="btn" id="print">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</button>
        </div>
      </section>

      <!-- Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª -->
      <section class="card" id="out" style="display:none">
        <h2 class="title">Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</h2>
        <div class="printable" id="printArea">

          <div id="meta" class="chips"></div>

          <div class="set-card" id="set-mv">
            <h3>Ù†Ø´Ø§Ø· ØµÙÙ‘ÙŠ Ø­Ø±ÙƒÙŠ</h3>
            <p class="muted" id="mv-idea"><strong>Ù…Ø¯Ø®Ù„ Ø§Ù„ÙÙƒØ±Ø©:</strong> â€”</p>
            <p id="mv-desc" class="muted">â€”</p>
            <div class="chips"><span class="chip" id="mv-dur">â€”</span></div>
            <h4 style="margin:8px 0 4px">Ø§Ù„Ù…ÙˆØ§Ø¯</h4>
            <ul id="mv-mats" class="list"></ul>
            <h4 style="margin:8px 0 4px">Ø§Ù„Ø®Ø·ÙˆØ§Øª</h4>
            <ol id="mv-steps" class="list"></ol>
            <h4 style="margin:8px 0 4px">ØªØ°ÙƒØ±Ø© Ø®Ø±ÙˆØ¬</h4>
            <p id="mv-exit">â€”</p>
            <h4 style="margin:8px 0 4px">Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</h4>
            <p id="mv-impact">â€”</p>
            <div id="mv-diff" class="diff-box" style="display:none"></div>
          </div>

          <div class="set-card" id="set-gr">
            <h3>Ù†Ø´Ø§Ø· ØµÙÙ‘ÙŠ Ø¬Ù…Ø§Ø¹ÙŠ</h3>
            <p class="muted" id="gr-idea"><strong>Ù…Ø¯Ø®Ù„ Ø§Ù„ÙÙƒØ±Ø©:</strong> â€”</p>
            <p id="gr-desc" class="muted">â€”</p>
            <div class="chips"><span class="chip" id="gr-dur">â€”</span></div>
            <h4 style="margin:8px 0 4px">Ø§Ù„Ù…ÙˆØ§Ø¯</h4>
            <ul id="gr-mats" class="list"></ul>
            <h4 style="margin:8px 0 4px">Ø§Ù„Ø®Ø·ÙˆØ§Øª</h4>
            <ol id="gr-steps" class="list"></ol>
            <h4 style="margin:8px 0 4px">ØªØ°ÙƒØ±Ø© Ø®Ø±ÙˆØ¬</h4>
            <p id="gr-exit">â€”</p>
            <h4 style="margin:8px 0 4px">Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</h4>
            <p id="gr-impact">â€”</p>
            <div id="gr-diff" class="diff-box" style="display:none"></div>
          </div>

          <div class="set-card" id="set-in">
            <h3>Ù†Ø´Ø§Ø· ØµÙÙ‘ÙŠ ÙØ±Ø¯ÙŠ</h3>
            <p class="muted" id="in-idea"><strong>Ù…Ø¯Ø®Ù„ Ø§Ù„ÙÙƒØ±Ø©:</strong> â€”</p>
            <p id="in-desc" class="muted">â€”</p>
            <div class="chips"><span class="chip" id="in-dur">â€”</span></div>
            <h4 style="margin:8px 0 4px">Ø§Ù„Ù…ÙˆØ§Ø¯</h4>
            <ul id="in-mats" class="list"></ul>
            <h4 style="margin:8px 0 4px">Ø§Ù„Ø®Ø·ÙˆØ§Øª</h4>
            <ol id="in-steps" class="list"></ol>
            <h4 style="margin:8px 0 4px">ØªØ°ÙƒØ±Ø© Ø®Ø±ÙˆØ¬</h4>
            <p id="in-exit">â€”</p>
            <h4 style="margin:8px 0 4px">Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</h4>
            <p id="in-impact">â€”</p>
            <div id="in-diff" class="diff-box" style="display:none"></div>
          </div>

          <div class="set-card">
            <h3>ØªÙ„Ù…ÙŠØ­Ø§Øª</h3>
            <ul id="tips" class="list"></ul>
          </div>

        </div>
      </section>

    </div>
  </main>

  <footer>
    <p class="foot-line">Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø´Ø±Ø§Ø±Ø© ØµØºÙŠØ±Ø©â€¦ ØªÙØ¶ÙŠØ¡ Ø¹Ù‚ÙˆÙ„Ù‹Ø§ ÙƒØ¨ÙŠØ±Ø©.</p>
    <p class="foot-name">Ù†Ø¯Ù‰ Ø§Ù„Ù…Ø¬ÙŠØ±Ø´</p>

    <nav class="foot-links">
      <a href="privacy.html">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a><span class="sep">|</span>
      <a href="terms.html">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</a><span class="sep">|</span>
      <a href="refund-policy.html">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</a><span class="sep">|</span>
      <a href="whatsapp.html">ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</a><span class="sep">|</span>
      <a href="complaints.html">Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</a>
    </nav>

    <div class="foot-copy">Â© <span id="year"></span> Ø£Ø«Ù€Ù€Ø± â€” ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</div>
  </footer>

  <script>
    // Ø³Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    (function(){
      var y=document.getElementById('year');
      if(y) y.textContent=new Date().getFullYear();
    })();
  </script>

  <div class="toast" id="toast"></div>

  <!-- Ù†ÙØ³ ØªØ±ØªÙŠØ¨ Ù…Ù†Ø¸ÙˆÙ…ØªÙƒ -->
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/supabase-client.js"></script>

  <!-- Auth0 (Ù…Ø¹ Ø¨Ø¯ÙŠÙ„ Ù…Ø­Ù„ÙŠ ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ CDN) -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>

  <!-- Ø§Ù„Ø­Ø§Ø±Ø³ (ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­Ù…Ø§ÙŠØ©) -->
  <script defer src="assets/js/require-auth.js"></script>

  <script defer src="assets/js/storage.js"></script>
  <script defer src="app.js"></script>

  <script>
  // ===== Utilities =====
  window.$ = window.$ || ((s)=>document.querySelector(s));
  const liFill=(ul,items)=>{ ul.innerHTML=''; (items||[]).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); }); }
  const olFill=(ol,items)=>{ ol.innerHTML=''; (items||[]).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ol.appendChild(li); }); }

  // Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Auth0 claims (namespace Ù…Ø«Ù„ Ø¨Ù‚ÙŠØ© Ø§Ù„Ù…Ù†ØµØ©)
  const CLAIM_NS = "https://athar.co/";

  // ØªÙˆØ³Øª
  (function(){ const box = document.getElementById('toast'); if(!box) return;
    window.toast = (msg, ms=1600)=>{ box.textContent = msg; box.style.display='block';
      clearTimeout(window.__t); window.__t=setTimeout(()=>box.style.display='none', ms); };
  })();

  // upsert Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø±Ø¨Ø· Ù…Ø¹ Supabase
  window.addEventListener('load', () => {
    if (typeof supaEnsureUserProfile === 'function') {
      try { supaEnsureUserProfile(); } catch(_) {}
    }
  });

  // Ø£ÙˆØªÙˆ-Ø­ÙØ¸
  document.addEventListener('DOMContentLoaded', ()=>{ bindAutoSave('mulham', '#mulham-form'); });

  // ===== Auth helpers =====
  const wait = (ms)=> new Promise(r=>setTimeout(r,ms));
  async function waitAuth(){ for(let i=0;i<80 && !window.auth;i++){ await wait(100); } }

  async function showAccountBadge(){
    try{
      const el = document.getElementById('acct-badge');
      if(!window.auth){ el.textContent=''; return; }
      const ok = await window.auth.isAuthenticated();
      if(!ok){ el.innerHTML = '<span class="badge status-cancelled">ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</span>'; return; }
      const u   = await window.auth.getUser();
      const cl  = await window.auth.getIdTokenClaims();
      const st  = cl?.[CLAIM_NS + 'status'] || 'active';
      const badge =
        st==='active'  ? '<span class="badge status-active">Ø­Ø³Ø§Ø¨Ùƒ Ù†Ø´Ø·</span>' :
        st==='pending' ? '<span class="badge status-pending">Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¹Ù„Ù‘Ù‚</span>' :
                         '<span class="badge status-cancelled">ØºÙŠØ± Ù†Ø´Ø·</span>';
      el.innerHTML = badge + (u?.email ? ' â€” ' + u.email : '');
    }catch{}
  }

  // meta Ù„ØªØªØ¨Ù‘Ø¹
  function mulhamMeta(){
    const get = id => document.getElementById(id);
    return {
      subject:  (get('s-subj')?.value || '').trim() || null,
      topic:    (get('s-topic')?.value || '').trim() || null,
      time:     Number(get('s-time')?.value || 0) || null,
      bloom:    get('s-bloom')?.value || null,
      age:      get('s-age')?.value || null,
      noTools:  !!get('s-noTools')?.checked,
      adaptLow: !!get('s-adaptLow')?.checked,
      adaptDiff:!!get('s-adaptDiff')?.checked
    };
  }

  // ===== Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø¹ Authorization =====
  async function callMulham(body) {
    // Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ ØªÙˆÙƒÙ† JWT Ø¨Ù†ÙØ³ Ø§Ù„Ù€ audience Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ _auth
    const token = await window.auth.getToken({ audience: "https://api.athar" });
    const res = await fetch("/.netlify/functions/mulham", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      // Ø±Ø³Ø§Ø¦Ù„ Ù…ÙÙŠØ¯Ø©
      if (res.status === 401) throw new Error("ØºÙŠØ± Ù…ØµØ±Ø­ â€” Ø³Ø¬Ù‘Ù„ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„");
      if (res.status === 402) throw new Error("Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ØºÙŠØ± Ù†Ø´Ø· â€” ÙØ¶Ù„Ø§Ù‹ ÙØ¹Ù‘Ù„ÙŠ Ø§Ø´ØªØ±Ø§ÙƒÙƒ");
      if (res.status === 403) throw new Error("Ù„Ø§ ØªÙ…Ù„ÙƒÙŠÙ† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„");
      const t = await res.text().catch(()=> "");
      throw new Error(t || "Mulham function failed");
    }
    return res.json();
  }

  function readParams(withVariant=false){
    const subject = $('#s-subj').value.trim() || '';
    const topic   = $('#s-topic').value.trim() || subject;
    const time    = +$('#s-time').value || 20;
    const bloom   = $('#s-bloom').value || 'understand';
    const age     = $('#s-age').value || 'p2';
    const noTools = !!$('#s-noTools').checked;
    const adaptLow= !!$('#s-adaptLow').checked;
    const adaptDiff=!!$('#s-adaptDiff').checked;
    // Ø¨Ø°Ø±Ø© Ø¯Ø§Ø¦Ù…Ù‹Ø§ (Ø­ØªÙ‰ Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„) Ø¹Ù„Ø´Ø§Ù† Ù…Ø§ ØªØªÙƒØ±Ø± Ù†ÙØ³ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    const variant = String(Date.now()) + (withVariant ? '_more' : '_base');
    return { subject, topic, time, bloom, age, noTools, adaptLow, adaptDiff, variant };
  }

  function renderSet(prefix, set, showDiff){
    $(`#${prefix}-idea`).innerHTML   = `<strong>Ù…Ø¯Ø®Ù„ Ø§Ù„ÙÙƒØ±Ø©:</strong> ${set.ideaHook || 'â€”'}`;
    $(`#${prefix}-desc`).textContent = set.desc || 'â€”';
    $(`#${prefix}-dur`).textContent  = `Ø§Ù„Ù…Ø¯Ø©: ${set.duration ?? 'â€”'} Ø¯`;
    liFill($(`#${prefix}-mats`), set.materials || []);
    olFill($(`#${prefix}-steps`), set.steps || []);
    $(`#${prefix}-exit`).textContent    = set.exitTicket || 'â€”';
    $(`#${prefix}-impact`).textContent  = set.expectedImpact || 'â€”';

    const diffEl = $(`#${prefix}-diff`);
    if(showDiff && (set.diff?.lowMotivation || set.diff?.differentiation)){
      diffEl.style.display = '';
      diffEl.innerHTML = `
        ${set.diff?.lowMotivation ? `<div><strong>Ù„Ù„ØªØ­ÙÙŠØ² Ø§Ù„Ù…Ù†Ø®ÙØ¶:</strong> ${set.diff.lowMotivation}</div>` : ''}
        ${set.diff?.differentiation ? `<div style="margin-top:6px"><strong>ÙØ±ÙˆÙ‚ ÙØ±Ø¯ÙŠØ©:</strong> ${set.diff.differentiation}</div>` : ''}
      `;
    }else{
      diffEl.style.display = 'none';
      diffEl.innerHTML = '';
    }
  }

  function renderAll(data){
    const meta = data.meta || {};
    const metaBox = $('#meta'); metaBox.innerHTML = '';
    const ageMap = {p1:'Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ Ø¯ÙÙ†ÙŠØ§',p2:'Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ Ø¹ÙÙ„ÙŠØ§',m:'Ù…ØªÙˆØ³Ø·',h:'Ø«Ø§Ù†ÙˆÙŠ'};
    const chips = [
      meta.subject, meta.topic,
      `Ù…Ø±Ø­Ù„Ø©: ${ageMap[meta.age]||meta.age||'â€”'}`,
      `Ø¨Ù„ÙˆÙ…: ${meta.bloom||'â€”'}`,
      `Ø²Ù…Ù†: ${meta.time||meta.timeMins||'â€”'} Ø¯`
    ];
    chips.forEach(v=>{
      if(v && String(v).trim()!==''){
        const chip=document.createElement('span');
        chip.className='chip';
        chip.textContent=v;
        metaBox.appendChild(chip);
      }
    });

    const showDiff = !!(meta.adaptLow || meta.adaptDiff);

    renderSet('mv', data.sets?.movement || {}, showDiff);
    renderSet('gr', data.sets?.group || {}, showDiff);
    renderSet('in', data.sets?.individual || {}, showDiff);

    liFill($('#tips'), data.tips || []);
    $('#out').style.display = '';
  }

  async function generate(withVariant=false){
    const goBtn   = document.getElementById('go');
    const moreBtn = document.getElementById('more');
    const busyBtn = withVariant ? moreBtn : goBtn;

    try{
      busyBtn.disabled = true;
      const oldText = busyBtn.textContent;
      busyBtn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªÙÙƒÙŠØ±â€¦';

      await waitAuth();
      await showAccountBadge();

      const params = readParams(withVariant);
      const data = await callMulham(params);
      renderAll(data);

      toast(withVariant ? 'ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø£Ù†Ø´Ø·Ø© Ø£Ø®Ø±Ù‰ âœ¨' : 'ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø© âœ¨');

      if (typeof supaLogToolUsage === 'function') {
        const tag = withVariant ? 'mulham_more' : 'mulham_generate';
        try { await supaLogToolUsage(tag, mulhamMeta()); } catch(_){}
      }

      busyBtn.textContent = oldText;
      busyBtn.disabled = false;
    }catch(e){
      console.error(e);
      toast(String(e.message||e) || 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªÙˆÙ„ÙŠØ¯ØŒ Ø­Ø§ÙˆÙ„ÙŠ Ø«Ø§Ù†ÙŠØ©.');
      if (busyBtn){
        busyBtn.textContent = withVariant ? 'Ø£Ù†Ø´Ø·Ø© Ø£Ø®Ø±Ù‰' : 'ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø©';
        busyBtn.disabled = false;
      }
    }
  }

  // Ø£Ø²Ø±Ø§Ø±
  document.getElementById('go').addEventListener('click', ()=>generate(false));
  document.getElementById('more').addEventListener('click', ()=>generate(true));

  document.getElementById('copy').addEventListener('click', async ()=>{
    const grab=(sel)=>$(sel)?.innerText?.trim() || 'â€”';
    const pack=(sel)=>[...document.querySelectorAll(sel+' li')].map(li=>'- '+li.innerText).join('\n') || 'â€”';

    const txt =
`[Ù…ÙÙ„Ù‡Ù… â€” ${new Date().toLocaleString()}]
${$('#meta').innerText}

[Ø­Ø±ÙƒÙŠ]
${grab('#mv-idea')}
${grab('#mv-desc')}
Ù…ÙˆØ§Ø¯:
${pack('#mv-mats')}
Ø®Ø·ÙˆØ§Øª:
${pack('#mv-steps')}
ØªØ°ÙƒØ±Ø© Ø®Ø±ÙˆØ¬: ${grab('#mv-exit')}
Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${grab('#mv-impact')}

[Ø¬Ù…Ø§Ø¹ÙŠ]
${grab('#gr-idea')}
${grab('#gr-desc')}
Ù…ÙˆØ§Ø¯:
${pack('#gr-mats')}
Ø®Ø·ÙˆØ§Øª:
${pack('#gr-steps')}
ØªØ°ÙƒØ±Ø© Ø®Ø±ÙˆØ¬: ${grab('#gr-exit')}
Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${grab('#gr-impact')}

[ÙØ±Ø¯ÙŠ]
${grab('#in-idea')}
${grab('#in-desc')}
Ù…ÙˆØ§Ø¯:
${pack('#in-mats')}
Ø®Ø·ÙˆØ§Øª:
${pack('#in-steps')}
ØªØ°ÙƒØ±Ø© Ø®Ø±ÙˆØ¬: ${grab('#in-exit')}
Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${grab('#in-impact')}

[ØªÙ„Ù…ÙŠØ­Ø§Øª]
${pack('#tips')}
`;

    await navigator.clipboard.writeText(txt);
    toast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…');

    if (typeof supaLogToolUsage === 'function') {
      try { await supaLogToolUsage('mulham_copy', mulhamMeta()); } catch(_){}
    }
  });

  // Ø·Ø¨Ø§Ø¹Ø© Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ù„Ø¬ÙˆØ§Ù„/Ø§Ù„Ø¢ÙŠØ¨Ø§Ø¯
  document.getElementById('print').addEventListener('click', async ()=>{
    document.body.classList.add('print-mode');
    setTimeout(()=>{ window.print(); setTimeout(()=>document.body.classList.remove('print-mode'), 400); }, 60);

    if (typeof supaLogToolUsage === 'function') {
      try { await supaLogToolUsage('mulham_print', mulhamMeta()); } catch(_){}
    }
  });

  // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©
  (async function run(){ await waitAuth(); await showAccountBadge(); })();
  </script>
</body>
</html>
