<!-- admin.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ููุญุฉ ุงูุฅุฏุงุฑุฉ โ ุฃุซุฑ</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="dark light" />
<style>
  .card{ margin:16px 0 }
  .grid{ display:grid; gap:12px; grid-template-columns:1fr }
  @media(min-width:1100px){ .grid-2{ grid-template-columns:1fr 1fr } .grid-3{ grid-template-columns: 1fr 1fr 1fr } }
  .field{ margin:10px 0 }
  .field label{ display:block; font-weight:700; margin:6px 0 }
  .field input,.field select, .field textarea{
    width:100%; padding:12px; border-radius:12px; border:1px solid rgba(59,130,246,.35)
  }
  .muted{ opacity:.8 }
  .actions-row{ margin-top:8px; display:flex; gap:10px; flex-wrap:wrap }
  .pill{ background:rgba(59,130,246,.12); padding:2px 8px; border-radius:999px; }
  .table{ width:100%; border-collapse:collapse; }
  .table th,.table td{ padding:10px; border-bottom:1px solid #e5e7eb33; vertical-align:top }
  .table th{ text-align:right; font-weight:700 }
  .status-new{background:#fef9c3; color:#713f12}
  .status-in_progress{background:#e0f2fe; color:#0c4a6e}
  .status-resolved{background:#dcfce7; color:#14532d}
  .status-rejected{background:#fee2e2; color:#7f1d1d}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="topbar">
    <div class="left-actions"><a class="btn" href="index.html">ุงูุฑุฆูุณูุฉ</a></div>
    <div class="actions"><button class="btn" id="themeToggle">๐</button></div>
    <div class="user"><span class="muted" id="whoami"></span></div>
  </div>

  <header>
    <div class="hero">
      <h1 class="logo">ููุญุฉ ุงูุฅุฏุงุฑุฉ</h1>
      <div class="tag"><span class="dot"></span>ูุฑูู ุฃุซุฑ</div>
    </div>
  </header>

  <main class="container">
    <!-- ุงููุตูู ูุฑููุถ -->
    <section class="card" id="denyCard" style="display:none">
      <h2 class="title">ุงููุตูู ูุฑููุถ</h2>
      <p>ูุฐู ุงูุตูุญุฉ ูููุดุฑููู ููุท.</p>
    </section>

    <!-- ุชุจููุจุงุช -->
    <section class="card" id="tabsCard" style="display:none">
      <div class="actions-row" style="gap:6px">
        <button class="btn" data-tab="t-activate">ุงูุชูุนูู ุงููุฏูู</button>
        <button class="btn" data-tab="t-ann">ุงูุฅุนูุงูุงุช</button>
        <button class="btn primary" data-tab="t-complaints">ุงูุดูุงูู ูุงูุงูุชุฑุงุญุงุช</button>
      </div>
    </section>

    <!-- ุงูุชูุนูู -->
    <section class="card" id="t-activate" style="display:none">
      <h2 class="title">ุงูุชูุนูู ุงููุฏูู ููุงุดุชุฑุงู</h2>
      <div class="grid grid-3">
        <div class="field">
          <label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูููุณุชุฎุฏู</label>
          <input id="act-email" type="email" placeholder="example@email.com" />
        </div>
        <div class="field">
          <label>UID (ุงุฎุชูุงุฑู)</label>
          <input id="act-userid" type="text" placeholder="Auth0 sub ุฅู ูุงู ูุชุงุญูุง" />
        </div>
        <div class="field">
          <label>ุงููุฏูุฉ</label>
          <div style="display:flex; gap:8px; align-items:center">
            <input id="act-amount" type="number" min="1" value="12" style="max-width:120px" />
            <select id="act-unit" style="max-width:140px">
              <option value="months" selected>ุดูุฑ/ุฃุดูุฑ</option>
              <option value="days">ููู/ุฃูุงู</option>
              <option value="years">ุณูุฉ/ุณููุงุช</option>
            </select>
          </div>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>ููุงุญุธุฉ (ุงุฎุชูุงุฑู)</label>
          <input id="act-note" type="text" placeholder="ุณุจุจ/ูุฑุฌุน"/>
        </div>
      </div>
      <div class="actions-row">
        <button class="btn primary" id="btn-activate">ุชูุนูู/ุชูุฏูุฏ</button>
        <span id="act-status" class="muted"></span>
      </div>
    </section>

    <!-- ุงูุฅุนูุงูุงุช -->
    <section class="card" id="t-ann" style="display:none">
      <h2 class="title">ุฅุนูุงู ุนุงู</h2>
      <div class="field">
        <label>ูุต ุงูุฅุนูุงู</label>
        <textarea id="ann-text" rows="3" placeholder="ุณูุธูุฑ ููุณุชุฎุฏูู ุงููููุน"></textarea>
      </div>

      <div class="grid grid-3">
        <div class="field">
          <label>ุงูุญุงูุฉ</label>
          <select id="ann-active">
            <option value="true" selected>ูููุนูู</option>
            <option value="false">ููููู</option>
          </select>
        </div>

        <div class="field">
          <label>ุชุงุฑูุฎ ุงูุจุฏุก (ุงุฎุชูุงุฑู)</label>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <select id="ann-start-cal" style="max-width:140px">
              <option value="greg" selected>ูููุงุฏู</option>
              <option value="hijri">ูุฌุฑู</option>
            </select>
            <input id="ann-start-g" type="date" />
            <input id="ann-start-h" type="text" inputmode="numeric" placeholder="ูุซุงู: 1447-02-10" style="display:none" />
          </div>
        </div>

        <div class="field">
          <label>ุชุงุฑูุฎ ุงูุงูุชูุงุก (ุงุฎุชูุงุฑู)</label>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <select id="ann-end-cal" style="max-width:140px">
              <option value="greg" selected>ูููุงุฏู</option>
              <option value="hijri">ูุฌุฑู</option>
            </select>
            <input id="ann-end-g" type="date" />
            <input id="ann-end-h" type="text" inputmode="numeric" placeholder="ูุซุงู: 1447-02-15" style="display:none" />
          </div>
        </div>
      </div>

      <div class="actions-row">
        <button class="btn" id="btn-publish">ูุดุฑ/ุชุญุฏูุซ</button>
        <span id="ann-status" class="muted"></span>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 class="title" style="margin:0 0 8px">ุงูุฅุนูุงูุงุช</h3>
        <div id="ann-current" class="muted" style="margin-bottom:8px">โ</div>
        <div id="ann-list" class="grid" style="grid-template-columns:1fr"></div>
      </div>
    </section>

    <!-- ุงูุดูุงูู ูุงูุงูุชุฑุงุญุงุช -->
    <section class="card" id="t-complaints" style="display:none">
      <h2 class="title">ุงูุดูุงูู ูุงูุงูุชุฑุงุญุงุช</h2>

      <!-- ุดุฑูุท ุฃุฏูุงุช -->
      <div class="toolbar">
        <select id="c-type">
          <option value="">ุงููู</option>
          <option value="complaint">ุดูุงูู</option>
          <option value="suggestion">ุงูุชุฑุงุญุงุช</option>
        </select>

        <select id="c-status">
          <option value="">ูู ุงูุญุงูุงุช</option>
          <option value="new">ุฌุฏูุฏุฉ</option>
          <option value="in_progress">ููุฏ ุงููุนุงูุฌุฉ</option>
          <option value="resolved">ูุบููุฉ</option>
          <option value="rejected">ูุฑููุถุฉ</option>
        </select>

        <input id="c-q" type="search" placeholder="ุจุญุซ (ุนููุงู/ูุต/ุฅูููู)" style="flex:1;min-width:200px">
        <button class="btn" id="c-refresh">ุชุญุฏูุซ</button>
      </div>

      <div class="grid grid-2" style="margin-top:12px">
        <!-- ุงููุงุฆูุฉ -->
        <div class="card">
          <table class="table" id="c-table">
            <thead>
              <tr>
                <th>ุงูุนููุงู</th>
                <th>ุงููุฑุณู</th>
                <th>ุงูููุน</th>
                <th>ุงูุญุงูุฉ</th>
                <th>ุงูุชุงุฑูุฎ</th>
              </tr>
            </thead>
            <tbody id="c-rows">
              <tr><td colspan="5" class="muted">โ</td></tr>
            </tbody>
          </table>
        </div>

        <!-- ุงูุชูุงุตูู -->
        <div class="card" id="c-detail">
          <h3 style="margin-top:0">ุงูุชูุงุตูู</h3>
          <div id="c-empty" class="muted">ุงุฎุชุฑ ุนูุตุฑูุง ูู ุงููุงุฆูุฉโฆ</div>

          <div id="c-box" class="hidden">
            <p><strong>ุงูุนููุงู:</strong> <span id="cd-subject">โ</span></p>
            <p><strong>ุงููุฑุณู:</strong> <span id="cd-user">โ</span></p>
            <p><strong>ุงูุทูุจ:</strong> <span id="cd-kind">โ</span></p>
            <p><strong>ุงูุญุงูุฉ:</strong> <span id="cd-status" class="pill">โ</span></p>
            <div class="field">
              <label>ุณุฌู ุงูุฑุณุงุฆู</label>
              <div id="cd-thread" style="border:1px solid #e5e7eb33;border-radius:10px;padding:10px;max-height:340px;overflow:auto"></div>
            </div>

            <div class="grid">
              <div class="field">
                <label>ุชุบููุฑ ุงูุญุงูุฉ</label>
                <select id="cd-next">
                  <option value="">ูุง ุชุบููุฑ</option>
                  <option value="in_progress">ููุฏ ุงููุนุงูุฌุฉ</option>
                  <option value="resolved">ูุบููุฉ</option>
                  <option value="rejected">ูุฑููุถุฉ</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label>ุงูุฑุฏ ุนูู ุงููุฑุณู</label>
              <textarea id="cd-reply" rows="4" placeholder="ุงูุชุจ ุงูุฑุฏ ููุงโฆ"></textarea>
            </div>
            <div class="actions-row">
              <button class="btn primary" id="cd-send">ุฅุฑุณุงู ุงูุฑุฏ</button>
              <span id="cd-statusmsg" class="muted"></span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <!-- Auth0 SDK -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>

  <!-- Supabase (ูุทููุจ ููุฅุนูุงูุงุช/ุงูุชูุนูู ุฅู ูุงู ูุฏูู ุงุณุชุฏุนุงุกุงุช ูุจุงุดุฑุฉ) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="assets/js/supabase-client.js"></script>

  <!-- ุงูุญุงุฑุณ ุงูุนุงู ุฅู ุฑุบุจุช -->
  <script src="assets/js/require-auth.js"></script>

  <!-- moment + hijri -->
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/min/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment-hijri@2.3.1/moment-hijri.js"></script>

  <!-- ุณูุฑุจุช ุนุงู -->
  <script src="app.js"></script>

  <script>
  const toast = (m)=>{ const t=document.getElementById('toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',1400); };

  // ===== ุชุจููุจุงุช ุจุณูุทุฉ
  const tabs = ["t-activate","t-ann","t-complaints"];
  function showTab(id){
    tabs.forEach(x=> document.getElementById(x).style.display = (x===id)?'':'none');
    document.querySelectorAll('[data-tab]').forEach(b => b.classList.toggle('primary', b.dataset.tab===id));
  }
  document.addEventListener('click',(e)=>{
    const b = e.target.closest('[data-tab]'); if(!b) return;
    showTab(b.dataset.tab);
  });

  // ===== ุตูุงุญูุงุช ุงูุฃุฏูู
  async function isAdmin(){
    try{
      const u = await window.auth.getUser();
      document.getElementById('whoami').textContent = u?.email || '';
      if (!u) return false;

      const claims = await window.auth.getIdTokenClaims();
      const roles = claims?.["https://n-athar.co/roles"] || claims?.["https://n-athar/roles"] || [];
      const flag  = claims?.["https://n-athar.co/admin"] === true || claims?.["https://athar/admin"] === true;
      return (Array.isArray(roles) && roles.includes("admin")) || flag;
    }catch(_){ return false; }
  }
  async function authToken(){ return await window.auth.getToken({ audience: "https://api.n-athar" }); }

  // ===== ุฃุฏูุงุช ูุณุงุนุฏุฉ
  function toIso(calSelId, gId, hId) {
    const mode = document.getElementById(calSelId).value;
    if (mode === 'greg') {
      const v = document.getElementById(gId).value;
      if (!v) return null;
      return new Date(v + 'T00:00:00Z').toISOString();
    } else {
      const v = document.getElementById(hId).value.trim();
      if (!v) return null;
      const m = moment(v, 'iYYYY-iMM-iDD', true);
      if (!m.isValid()) return null;
      return new Date(m.format('YYYY-MM-DD') + 'T00:00:00Z').toISOString();
    }
  }

  // ===== ุฅุนูุงูุงุช (ุฑุจุท ูุน admin-announcement*)
  async function fetchAnnouncements() {
    try {
      const [latestRes, listRes] = await Promise.all([
        fetch('/.netlify/functions/admin-announcement?latest=1'),
        fetch('/.netlify/functions/admin-announcement?list=1')
      ]);
      const latest = latestRes.ok ? (await latestRes.json()).latest : null;
      const list = listRes.ok ? (await listRes.json()).items || [] : [];

      const curBox = document.getElementById('ann-current');
      curBox.innerHTML = latest ? `ุงูููุดูุฑ ุงูุญุงูู: <span class="pill">${latest.text}</span>` : 'ูุง ููุฌุฏ ุฅุนูุงู ููุดูุฑ ุญุงูููุง.';

      const wrap = document.getElementById('ann-list');
      wrap.innerHTML = '';
      list.forEach(a=>{
        const liveNow = a.active && (!a.start_at || new Date(a.start_at)<=new Date()) && (!a.expires_at || new Date(a.expires_at)>new Date());
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
            <div>
              <div><strong>${a.active ? 'โ' : 'โธ๏ธ'} ${a.text}</strong></div>
              <div class="muted" style="font-size:.9em">
                ูุจุฏุฃ: ${a.start_at ? new Date(a.start_at).toLocaleDateString('ar-SA') : 'ููุฑู'}
                โข ููุชูู: ${a.expires_at ? new Date(a.expires_at).toLocaleDateString('ar-SA') : 'โ'}
                ${liveNow ? '<span class="pill" style="margin-inline-start:6px">ููุดูุฑ ุญุงูููุง</span>' : ''}
              </div>
            </div>
            <div class="actions-row" style="margin:0">
              <button class="btn" data-repub="${a.id}">ุฅุนุงุฏุฉ ูุดุฑ</button>
              ${a.active ? '<button class="btn" data-stop="'+a.id+'">ุฅููุงู</button>' : ''}
              <button class="btn" data-del="${a.id}">ุญุฐู</button>
            </div>
          </div>
        `;
        wrap.appendChild(card);
      });

      wrap.querySelectorAll('[data-repub]').forEach(b=>{
        b.onclick = async ()=>{
          const id = b.getAttribute('data-repub');
          await updateAnnouncement({ id, active:true, start:null }); // ูุจุฏุฃ ููุฑููุง
          await fetchAnnouncements();
        };
      });
      wrap.querySelectorAll('[data-stop]').forEach(b=>{
        b.onclick = async ()=>{
          const id = b.getAttribute('data-stop');
          await updateAnnouncement({ id, active:false });
          await fetchAnnouncements();
        };
      });
      wrap.querySelectorAll('[data-del]').forEach(b=>{
        b.onclick = async ()=>{
          const id = b.getAttribute('data-del');
          if (!confirm('ุญุฐู ุงูุฅุนูุงูุ')) return;
          await deleteAnnouncement(id);
          await fetchAnnouncements();
        };
      });

    } catch(e) { console.warn(e); }
  }
  async function updateAnnouncement(payload) {
    const res = await fetch('/.netlify/functions/admin-announcement', {
      method:'PUT',
      headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${await authToken()}` },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }
  async function deleteAnnouncement(id) {
    const res = await fetch('/.netlify/functions/admin-announcement?id='+encodeURIComponent(id), {
      method:'DELETE',
      headers:{ 'Authorization': `Bearer ${await authToken()}` }
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // ูุดุฑ/ุชุญุฏูุซ ุฅุนูุงู
  document.addEventListener('click', async (e)=>{
    if(e.target.id !== 'btn-publish') return;
    const text    = document.getElementById('ann-text').value.trim();
    const active  = document.getElementById('ann-active').value === 'true';
    const start   = toIso('ann-start-cal','ann-start-g','ann-start-h');
    const expires = toIso('ann-end-cal','ann-end-g','ann-end-h');
    const stat = document.getElementById('ann-status');
    stat.textContent = 'ุฌุงุฑู ุงููุดุฑโฆ';
    try{
      const res = await fetch('/.netlify/functions/admin-announcement', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${await authToken()}` },
        body: JSON.stringify({ text, active, start, expires })
      });
      const j = await res.json();
      if(!res.ok) throw new Error(j?.error || 'failed');
      stat.textContent = 'ููุดุฑ โ';
      toast('ุชู ูุดุฑ/ุชุญุฏูุซ ุงูุฅุนูุงู');
      document.getElementById('ann-text').value = '';
      await fetchAnnouncements();
    }catch(err){
      console.error(err);
      stat.textContent = 'ุชุนุฐูุฑ ุงููุดุฑ';
      toast('ุชุนุฐูุฑ ุงููุดุฑ');
    }
  });

  // ===== ุชูุนูู/ุชูุฏูุฏ ุนุถููุฉ
  document.addEventListener('click', async (e)=>{
    if(e.target.id !== 'btn-activate') return;
    const email   = document.getElementById('act-email').value.trim();
    const user_id = document.getElementById('act-userid').value.trim();
    const amount  = Math.max(1, Number(document.getElementById('act-amount').value||'1')|0);
    const unit    = document.getElementById('act-unit').value;
    const note    = document.getElementById('act-note').value.trim() || null;
    const stat = document.getElementById('act-status');
    stat.textContent = 'ุฌุงุฑู ุงูุชูุนููโฆ';
    try{
      const res = await fetch('/.netlify/functions/admin-activate', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${await authToken()}` },
        body: JSON.stringify({ email: email || null, user_id: user_id || null, amount, unit, note })
      });
      const j = await res.json();
      if(!res.ok) throw new Error(j?.error || 'failed');
      stat.textContent = `ุชู ุงูุชูุนูู โ ููุชูู: ${j.expires_at || 'โ'}`;
      toast('ุชู ุงูุชูุนูู');
    }catch(err){
      console.error(err);
      stat.textContent = 'ุชุนุฐูุฑ ุงูุชูุนูู';
      toast('ุชุนุฐูุฑ ุงูุชูุนูู');
    }
  });

  // ===== ุงูุดูุงูู/ุงูุงูุชุฑุงุญุงุช (ุฑุจุท ูุน complaints-*)
  let currentComplaintId = null;

  async function loadComplaints(){
    const type = document.getElementById('c-type').value;
    const status = document.getElementById('c-status').value;
    const q = document.getElementById('c-q').value.trim();
    const qs = new URLSearchParams();
    if (type) qs.set('type', type);
    if (status) qs.set('status', status);
    if (q) qs.set('q', q);
    const res = await fetch('/.netlify/functions/complaints-list?'+qs.toString(), {
      headers: { 'Authorization': `Bearer ${await authToken()}` }
    });
    const j = await res.json();
    const tbody = document.getElementById('c-rows');
    tbody.innerHTML = '';
    (j.rows || []).forEach(row=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a href="#" data-open="${row.id}">${row.subject}</a></td>
        <td>${row.user_name || 'โ'}<br><span class="muted">${row.user_email}</span></td>
        <td>${row.type === 'complaint' ? 'ุดููู' : 'ุงูุชุฑุงุญ'}</td>
        <td><span class="pill status-${row.status}">${row.status}</span></td>
        <td>${new Date(row.created_at).toLocaleString('ar-SA')}</td>
      `;
      tbody.appendChild(tr);
    });
    if ((j.rows || []).length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="5" class="muted">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</td>`;
      tbody.appendChild(tr);
    }
  }

  async function openComplaint(id){
    currentComplaintId = id;
    const res = await fetch('/.netlify/functions/complaints-get?id='+encodeURIComponent(id), {
      headers: { 'Authorization': `Bearer ${await authToken()}` }
    });
    const j = await res.json();
    const c = j.complaint;
    const msgs = j.messages || [];

    document.getElementById('c-empty').classList.add('hidden');
    document.getElementById('c-box').classList.remove('hidden');

    document.getElementById('cd-subject').textContent = c.subject;
    document.getElementById('cd-user').textContent = (c.user_name? c.user_name+' โ ' : '') + c.user_email;
    document.getElementById('cd-kind').textContent = (c.type === 'complaint' ? 'ุดููู' : 'ุงูุชุฑุงุญ');
    const st = document.getElementById('cd-status');
    st.textContent = c.status;
    st.className = 'pill status-'+c.status;

    const thread = document.getElementById('cd-thread');
    thread.innerHTML = '';
    msgs.forEach(m=>{
      const bubble = document.createElement('div');
      bubble.style.margin = '8px 0';
      bubble.innerHTML = `
        <div class="pill" style="display:inline-block;${m.sender==='admin'?'background:#e2e8f0;color:#0f172a;':'background:#f1f5f9;color:#0f172a;'}">
          ${m.sender==='admin'?'ูุฑูู ุฃุซุฑ':'ุงูุนููู'}
        </div>
        <div>${(m.body||'').replace(/\n/g,'<br>')}</div>
        <div class="muted" style="font-size:.85em">${new Date(m.created_at).toLocaleString('ar-SA')}</div>
      `;
      thread.appendChild(bubble);
    });

    document.getElementById('cd-reply').value = '';
    document.getElementById('cd-next').value = '';
    document.getElementById('cd-statusmsg').textContent = '';
  }

  // ุฃุญุฏุงุซ ุงููุงุฆูุฉ/ุงูููุชุฑุฉ
  document.getElementById('c-refresh').addEventListener('click', loadComplaints);
  document.getElementById('c-type').addEventListener('change', loadComplaints);
  document.getElementById('c-status').addEventListener('change', loadComplaints);
  document.getElementById('c-q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadComplaints(); });
  document.getElementById('c-rows').addEventListener('click', (e)=>{
    const a = e.target.closest('[data-open]'); if(!a) return;
    e.preventDefault();
    openComplaint(a.getAttribute('data-open'));
  });

  // ุฅุฑุณุงู ุงูุฑุฏ
  document.getElementById('cd-send').addEventListener('click', async ()=>{
    if (!currentComplaintId) return;
    const msg  = document.getElementById('cd-reply').value.trim();
    const next = document.getElementById('cd-next').value || null;
    const stat = document.getElementById('cd-statusmsg');
    if (!msg) { toast('ุฃูุชุจ ุงูุฑุฏ'); return; }
    stat.textContent = 'ุฌุงุฑู ุงูุฅุฑุณุงูโฆ';
    try{
      const res = await fetch('/.netlify/functions/complaints-reply', {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization': `Bearer ${await authToken()}`
        },
        body: JSON.stringify({ complaint_id: currentComplaintId, message: msg, next_status: next })
      });
      const j = await res.json();
      if(!res.ok) throw new Error(j?.error || 'failed');
      stat.textContent = 'ุชู ุงูุฅุฑุณุงู โ';
      toast('ุชู ุฅุฑุณุงู ุงูุฑุฏ');
      await openComplaint(currentComplaintId);
      await loadComplaints();
    }catch(err){
      console.error(err);
      stat.textContent = 'ุชุนุฐูุฑ ุงูุฅุฑุณุงู';
      toast('ุชุนุฐูุฑ ุงูุฅุฑุณุงู');
    }
  });

  // ===== ุชุดุบูู ุงูุตูุญุฉ
  document.addEventListener('DOMContentLoaded', async ()=>{
    // ุงูุชุธุงุฑ ุชููุฆุฉ window.auth ูู app.js
    for (let i=0; i<50 && !window.auth; i++) { await new Promise(r=>setTimeout(r,100)); }

    // ุชุญูู ุฃุฏูู
    const ok = await isAdmin();
    document.getElementById('tabsCard').style.display = ok ? '' : 'none';
    document.getElementById('denyCard').style.display = ok ? 'none' : '';
    if (!ok) return;

    // ุงูุชุญู ุชุจููุจ ุงูุดูุงูู ุงูุชุฑุงุถููุง
    showTab('t-complaints');

    // ุฌูุฒู ุงูุฅุนูุงูุงุช
    await fetchAnnouncements();

    // ุญูููู ุงูุดูุงูู
    await loadComplaints();
  });
  </script>
</body>
</html>
