<!-- admin.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ØµÙØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ù†Ø¯Ùˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="dark light" />
<style>
  .card{ margin:16px 0 }
  .grid{ display:grid; gap:12px; grid-template-columns:1fr }
  @media(min-width:900px){ .grid{ grid-template-columns:1fr 1fr } }
  .field{ margin:10px 0 }
  .field label{ display:block; font-weight:700; margin:6px 0 }
  .field input,.field select, .field textarea{
    width:100%; padding:12px; border-radius:12px; border:1px solid rgba(59,130,246,.35)
  }
  .muted{ opacity:.8 }
  .actions-row{ margin-top:8px; display:flex; gap:10px; flex-wrap:wrap }
  .pill{ background:rgba(59,130,246,.12); padding:2px 8px; border-radius:999px; }
</style>
</head>
<body>
  <div class="topbar">
    <div class="left-actions"><a class="btn" href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></div>
    <div class="actions"><button class="btn" id="themeToggle">ğŸŒ“</button></div>
    <div class="user"><span class="muted" id="whoami"></span></div>
  </div>

  <header>
    <div class="hero">
      <h1 class="logo">ØµÙØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ù†Ø¯Ùˆ</h1>
      <div class="tag"><span class="dot"></span>Ø§Ù†ØªÙŠ Ø£Ø¹Ø¸Ù… Ø£Ø¯Ù…Ù† Ø¨Ø§Ù„Ø¹Ø§Ù„Ù…</div>
    </div>
  </header>

  <main class="container">
    <!-- Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø±ÙÙˆØ¶ -->
    <section class="card" id="denyCard" style="display:none">
      <h2 class="title">Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø±ÙÙˆØ¶</h2>
      <p>Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·.</p>
    </section>

    <!-- Ø§Ù„ØªÙØ¹ÙŠÙ„ -->
    <section class="card" id="adminCard" style="display:none">
      <h2 class="title">Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h2>
      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="act-email" type="email" placeholder="example@email.com" />
        </div>
        <div class="field">
          <label>UID (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="act-userid" type="text" placeholder="Auth0 sub Ø¥Ù† ÙƒØ§Ù† Ù…ØªØ§Ø­Ù‹Ø§" />
        </div>
        <div class="field">
          <label>Ø§Ù„Ù…Ø¯Ù‘Ø©</label>
          <div style="display:flex; gap:8px; align-items:center">
            <input id="act-amount" type="number" min="1" value="12" style="max-width:120px" />
            <select id="act-unit" style="max-width:140px">
              <option value="months" selected>Ø´Ù‡Ø±/Ø£Ø´Ù‡Ø±</option>
              <option value="days">ÙŠÙˆÙ…/Ø£ÙŠØ§Ù…</option>
              <option value="years">Ø³Ù†Ø©/Ø³Ù†ÙˆØ§Øª</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="act-note" type="text" placeholder="Ø³Ø¨Ø¨/Ù…Ø±Ø¬Ø¹"/>
        </div>
      </div>
      <div class="actions-row">
        <button class="btn primary" id="btn-activate">ØªÙØ¹ÙŠÙ„/ØªÙ…Ø¯ÙŠØ¯</button>
        <span id="act-status" class="muted"></span>
      </div>
    </section>

    <!-- Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª -->
    <section class="card" id="annCard" style="display:none">
      <h2 class="title">Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù…</h2>

      <div class="field">
        <label>Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
        <textarea id="ann-text" rows="4" placeholder="Ø³ÙŠØ¸Ù‡Ø± Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹"></textarea>
      </div>

      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="ann-active">
            <option value="true" selected>Ù…ÙÙØ¹Ù‘Ù„</option>
            <option value="false">Ù…ÙˆÙ‚Ù‘Ù</option>
          </select>
        </div>

        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <select id="ann-start-cal" style="max-width:140px">
              <option value="greg" selected>Ù…ÙŠÙ„Ø§Ø¯ÙŠ</option>
              <option value="hijri">Ù‡Ø¬Ø±ÙŠ</option>
            </select>
            <input id="ann-start-g" type="date" />
            <input id="ann-start-h" type="text" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 1447-02-10" style="display:none" />
          </div>
        </div>

        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <select id="ann-end-cal" style="max-width:140px">
              <option value="greg" selected>Ù…ÙŠÙ„Ø§Ø¯ÙŠ</option>
              <option value="hijri">Ù‡Ø¬Ø±ÙŠ</option>
            </select>
            <input id="ann-end-g" type="date" />
            <input id="ann-end-h" type="text" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 1447-02-15" style="display:none" />
          </div>
        </div>
      </div>

      <div class="actions-row">
        <button class="btn" id="btn-publish">Ù†Ø´Ø±/ØªØ­Ø¯ÙŠØ«</button>
        <span id="ann-status" class="muted"></span>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 class="title" style="margin:0 0 8px">Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h3>
        <div id="ann-current" class="muted" style="margin-bottom:8px">â€”</div>
        <div id="ann-list" class="grid" style="grid-template-columns:1fr"></div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <!-- Auth0 SDK -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="assets/js/supabase-client.js"></script>

  <!-- Ø§Ù„Ø­Ø§Ø±Ø³ -->
  <script src="assets/js/require-auth.js"></script>

  <!-- moment + hijri -->
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/min/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment-hijri@2.3.1/moment-hijri.js"></script>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø¹Ø§Ù… -->
  <script src="app.js"></script>

  <script>
  const ADMIN_CLAIM = "https://athar/admin";
  const toast = (m)=>{ const t=document.getElementById('toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',1400); };

  async function isAdmin(){
    try{
      const u = await window.auth.getUser();
      document.getElementById('whoami').textContent = u?.email || '';
      if (!u) return false;

      const claims = await window.auth.getIdTokenClaims();
      const roles = (claims && claims["https://athar/roles"]) || [];
      if (Array.isArray(roles) && roles.includes("admin")) return true;
      if (claims && (claims[ADMIN_CLAIM] === true || claims["https://athar/admin"] === true)) return true;
      return false;
    }catch(_){ return false; }
  }

  function toIso(calSelId, gId, hId) {
    const mode = document.getElementById(calSelId).value;
    if (mode === 'greg') {
      const v = document.getElementById(gId).value;
      if (!v) return null;
      return new Date(v + 'T00:00:00Z').toISOString();
    } else {
      const v = document.getElementById(hId).value.trim();
      if (!v) return null;
      const m = moment(v, 'iYYYY-iMM-iDD', true);
      if (!m.isValid()) return null;
      return new Date(m.format('YYYY-MM-DD') + 'T00:00:00Z').toISOString();
    }
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†Ù…Ø·
    const hook = (selId, gId, hId)=>{
      const sel = document.getElementById(selId), g = document.getElementById(gId), h = document.getElementById(hId);
      sel.addEventListener('change', ()=>{
        const hijri = sel.value === 'hijri';
        g.style.display = hijri ? 'none' : '';
        h.style.display = hijri ? '' : 'none';
      });
    };
    hook('ann-start-cal','ann-start-g','ann-start-h');
    hook('ann-end-cal','ann-end-g','ann-end-h');

    // Ù†Ù†ØªØ¸Ø± window.auth Ù…Ù† app.js
    const wait = (ms)=> new Promise(r=>setTimeout(r,ms));
    for (let i=0; i<30 && !window.auth; i++) { await wait(100); }

    const ok = await isAdmin();
    document.getElementById('adminCard').style.display = ok ? '' : 'none';
    document.getElementById('annCard').style.display   = ok ? '' : 'none';
    document.getElementById('denyCard').style.display  = ok ? 'none' : '';
    if (!ok) return;

    async function authToken() {
      return await window.auth.getToken({ audience: "https://api.athar" });
    }

    async function fetchAnnouncements() {
      try {
        const [latestRes, listRes] = await Promise.all([
          fetch('/.netlify/functions/admin-announcement?latest=1'),
          fetch('/.netlify/functions/admin-announcement?list=1')
        ]);
        const latest = latestRes.ok ? (await latestRes.json()).latest : null;
        const list = listRes.ok ? (await listRes.json()).items || [] : [];

        const curBox = document.getElementById('ann-current');
        curBox.innerHTML = latest
          ? `Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: <span class="pill">${latest.text}</span>`
          : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù† Ù…Ù†Ø´ÙˆØ± Ø­Ø§Ù„ÙŠÙ‹Ø§.';

        const wrap = document.getElementById('ann-list');
        wrap.innerHTML = '';
        list.forEach(a=>{
          const liveNow = a.active
            && (!a.start_at   || new Date(a.start_at)   <= new Date())
            && (!a.expires_at || new Date(a.expires_at) >  new Date());

          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
              <div>
                <div><strong>${a.active ? 'âœ…' : 'â¸ï¸'} ${a.text}</strong></div>
                <div class="muted" style="font-size:.9em">
                  ÙŠØ¨Ø¯Ø£: ${a.start_at ? new Date(a.start_at).toLocaleDateString('ar-SA') : 'ÙÙˆØ±ÙŠ'}
                  â€¢ ÙŠÙ†ØªÙ‡ÙŠ: ${a.expires_at ? new Date(a.expires_at).toLocaleDateString('ar-SA') : 'â€”'}
                  ${liveNow ? '<span class="pill" style="margin-inline-start:6px">Ù…Ù†Ø´ÙˆØ± Ø­Ø§Ù„ÙŠÙ‹Ø§</span>' : ''}
                </div>
              </div>
              <div class="actions-row" style="margin:0">
                <button class="btn" data-repub="${a.id}">Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø±</button>
                ${a.active ? '<button class="btn" data-stop="'+a.id+'">Ø¥ÙŠÙ‚Ø§Ù</button>' : ''}
                <button class="btn" data-del="${a.id}">Ø­Ø°Ù</button>
              </div>
            </div>
          `;
          wrap.appendChild(card);
        });

        wrap.querySelectorAll('[data-repub]').forEach(b=>{
          b.onclick = async ()=>{
            const id = b.getAttribute('data-repub');
            await updateAnnouncement({ id, active:true, start:null }); // ÙŠØ¨Ø¯Ø£ ÙÙˆØ±ÙŠÙ‹Ø§
            await fetchAnnouncements();
          };
        });
        wrap.querySelectorAll('[data-stop]').forEach(b=>{
          b.onclick = async ()=>{
            const id = b.getAttribute('data-stop');
            await updateAnnouncement({ id, active:false });
            await fetchAnnouncements();
          };
        });
        wrap.querySelectorAll('[data-del]').forEach(b=>{
          b.onclick = async ()=>{
            const id = b.getAttribute('data-del');
            if (!confirm('Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ')) return;
            await deleteAnnouncement(id);
            await fetchAnnouncements();
          };
        });

      } catch(e) { console.warn(e); }
    }

    async function updateAnnouncement(payload) {
      const res = await fetch('/.netlify/functions/admin-announcement', {
        method:'PUT',
        headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${await authToken()}` },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    async function deleteAnnouncement(id) {
      const res = await fetch('/.netlify/functions/admin-announcement?id='+encodeURIComponent(id), {
        method:'DELETE',
        headers:{ 'Authorization': `Bearer ${await authToken()}` }
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    // Ù†Ø´Ø±/ØªØ­Ø¯ÙŠØ«
    document.getElementById('btn-publish').addEventListener('click', async ()=>{
      const text    = document.getElementById('ann-text').value.trim();
      const active  = document.getElementById('ann-active').value === 'true';
      const start   = toIso('ann-start-cal','ann-start-g','ann-start-h'); // Ù‚Ø¯ ØªÙƒÙˆÙ† null
      const expires = toIso('ann-end-cal','ann-end-g','ann-end-h');       // Ù‚Ø¯ ØªÙƒÙˆÙ† null
      const stat = document.getElementById('ann-status');
      stat.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ù†Ø´Ø±â€¦';

      try{
        const res = await fetch('/.netlify/functions/admin-announcement', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${await authToken()}` },
          body: JSON.stringify({ text, active, start, expires })
        });
        const j = await res.json();
        if(!res.ok) throw new Error(j?.error || 'failed');
        stat.textContent = 'Ù†ÙØ´Ø± âœ“';
        toast('ØªÙ… Ù†Ø´Ø±/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†');
        document.getElementById('ann-text').value = '';
        await fetchAnnouncements();
      }catch(e){
        console.error(e);
        stat.textContent = 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø´Ø±';
        toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø´Ø±');
      }
    });

    // ØªÙØ¹ÙŠÙ„/ØªÙ…Ø¯ÙŠØ¯
    document.getElementById('btn-activate').addEventListener('click', async ()=>{
      const email   = document.getElementById('act-email').value.trim();
      const user_id = document.getElementById('act-userid').value.trim();
      const amount  = Math.max(1, Number(document.getElementById('act-amount').value||'1')|0);
      const unit    = document.getElementById('act-unit').value; // days | months | years
      const note    = document.getElementById('act-note').value.trim() || null;

      const stat = document.getElementById('act-status');
      stat.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªÙØ¹ÙŠÙ„â€¦';
      try{
        const res = await fetch('/.netlify/functions/admin-activate', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${await await window.auth.getToken({ audience: "https://api.athar" })}` },
          body: JSON.stringify({ email: email || null, user_id: user_id || null, amount, unit, note })
        });
        const j = await res.json();
        if(!res.ok) throw new Error(j?.error || 'failed');
        stat.textContent = `ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ âœ“ ÙŠÙ†ØªÙ‡ÙŠ: ${j.expires_at || 'â€”'}`;
        toast('ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„');
      }catch(e){
        console.error(e);
        stat.textContent = 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„';
        toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„');
      }
    });

    await fetchAnnouncements();
  });
  </script>
</body>
</html>
