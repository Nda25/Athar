<!-- admin.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” Ø£Ø«Ø±</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="dark light" />
<style>
  .card{ margin:16px 0 }
  .grid{ display:grid; gap:12px; grid-template-columns:1fr }
  @media(min-width:1100px){ .grid-2{ grid-template-columns:1fr 1fr } .grid-3{ grid-template-columns: 1fr 1fr 1fr } }
  .field{ margin:10px 0 }
  .field label{ display:block; font-weight:700; margin:6px 0 }
  .field input,.field select, .field textarea{
    width:100%; padding:12px; border-radius:12px; border:1px solid rgba(59,130,246,.35)
  }
  .muted{ opacity:.8 }
  .actions-row{ margin-top:8px; display:flex; gap:10px; flex-wrap:wrap }
  .pill{ background:rgba(59,130,246,.12); padding:2px 8px; border-radius:999px; }
  .table{ width:100%; border-collapse:collapse; }
  .table th,.table td{ padding:10px; border-bottom:1px solid #e5e7eb33; vertical-align:top }
  .table th{ text-align:right; font-weight:700 }
  .status-new{background:#fef9c3; color:#713f12}
  .status-in_progress{background:#e0f2fe; color:#0c4a6e}
  .status-resolved{background:#dcfce7; color:#14532d}
  .status-rejected{background:#fee2e2; color:#7f1d1d}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="topbar">
    <div class="left-actions"><a class="btn" href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></div>
    <div class="actions"><button class="btn" id="themeToggle">ğŸŒ“</button></div>
    <div class="user"><span class="muted" id="whoami"></span></div>
  </div>

  <header>
    <div class="hero">
      <h1 class="logo">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <div class="tag"><span class="dot"></span>ÙØ±ÙŠÙ‚ Ø£Ø«Ø±</div>
    </div>
  </header>

  <main class="container">
    <!-- Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø±ÙÙˆØ¶ -->
    <section class="card" id="denyCard" style="display:none">
      <h2 class="title">Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø±ÙÙˆØ¶</h2>
      <p>Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·.</p>
    </section>

    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <section class="card" id="tabsCard" style="display:none">
      <div class="actions-row" style="gap:6px">
        <button class="btn" data-tab="t-activate">Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ</button>
        <button class="btn" data-tab="t-ann">Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</button>
        <button class="btn primary" data-tab="t-complaints">Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</button>
      </div>
    </section>

    <!-- Ø§Ù„ØªÙØ¹ÙŠÙ„ -->
    <section class="card" id="t-activate" style="display:none">
      <h2 class="title">Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h2>
      <div class="grid grid-3">
        <div class="field">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="act-email" type="email" placeholder="example@email.com" />
        </div>
        <div class="field">
          <label>UID (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="act-userid" type="text" placeholder="Auth0 sub Ø¥Ù† ÙƒØ§Ù† Ù…ØªØ§Ø­Ù‹Ø§" />
        </div>
        <div class="field">
          <label>Ø§Ù„Ù…Ø¯Ù‘Ø©</label>
          <div style="display:flex; gap:8px; align-items:center">
            <input id="act-amount" type="number" min="1" value="12" style="max-width:120px" />
            <select id="act-unit" style="max-width:140px">
              <option value="months" selected>Ø´Ù‡Ø±/Ø£Ø´Ù‡Ø±</option>
              <option value="days">ÙŠÙˆÙ…/Ø£ÙŠØ§Ù…</option>
              <option value="years">Ø³Ù†Ø©/Ø³Ù†ÙˆØ§Øª</option>
            </select>
          </div>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="act-note" type="text" placeholder="Ø³Ø¨Ø¨/Ù…Ø±Ø¬Ø¹"/>
        </div>
      </div>
      <div class="actions-row">
        <button class="btn primary" id="btn-activate">ØªÙØ¹ÙŠÙ„/ØªÙ…Ø¯ÙŠØ¯</button>
        <span id="act-status" class="muted"></span>
      </div>
    </section>

    <!-- Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª -->
    <section class="card" id="t-ann" style="display:none">
      <h2 class="title">Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù…</h2>
      <div class="field">
        <label>Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
        <textarea id="ann-text" rows="3" placeholder="Ø³ÙŠØ¸Ù‡Ø± Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹"></textarea>
      </div>

      <div class="grid grid-3">
        <div class="field">
          <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="ann-active">
            <option value="true" selected>Ù…ÙÙØ¹Ù‘Ù„</option>
            <option value="false">Ù…ÙˆÙ‚Ù‘Ù</option>
          </select>
        </div>

        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <select id="ann-start-cal" style="max-width:140px">
              <option value="greg" selected>Ù…ÙŠÙ„Ø§Ø¯ÙŠ</option>
              <option value="hijri">Ù‡Ø¬Ø±ÙŠ</option>
            </select>
            <input id="ann-start-g" type="date" />
            <input id="ann-start-h" type="text" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 1447-02-10" style="display:none" />
          </div>
        </div>

        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <select id="ann-end-cal" style="max-width:140px">
              <option value="greg" selected>Ù…ÙŠÙ„Ø§Ø¯ÙŠ</option>
              <option value="hijri">Ù‡Ø¬Ø±ÙŠ</option>
            </select>
            <input id="ann-end-g" type="date" />
            <input id="ann-end-h" type="text" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 1447-02-15" style="display:none" />
          </div>
        </div>
      </div>

      <div class="actions-row">
        <button class="btn" id="btn-publish">Ù†Ø´Ø±/ØªØ­Ø¯ÙŠØ«</button>
        <span id="ann-status" class="muted"></span>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 class="title" style="margin:0 0 8px">Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h3>
        <div id="ann-current" class="muted" style="margin-bottom:8px">â€”</div>
        <div id="ann-list" class="grid" style="grid-template-columns:1fr"></div>
      </div>
    </section>

    <!-- Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª -->
    <section class="card" id="t-complaints" style="display:none">
      <h2 class="title">Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</h2>

      <!-- Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª -->
      <div class="toolbar">
        <select id="c-type">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          <option value="complaint">Ø´ÙƒØ§ÙˆÙ‰</option>
          <option value="suggestion">Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</option>
        </select>

        <select id="c-status">
          <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="new">Ø¬Ø¯ÙŠØ¯Ø©</option>
          <option value="in_progress">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
          <option value="resolved">Ù…ØºÙ„Ù‚Ø©</option>
          <option value="rejected">Ù…Ø±ÙÙˆØ¶Ø©</option>
        </select>

        <input id="c-q" type="search" placeholder="Ø¨Ø­Ø« (Ø¹Ù†ÙˆØ§Ù†/Ù†Øµ/Ø¥ÙŠÙ…ÙŠÙ„)" style="flex:1;min-width:200px">
        <button class="btn" id="c-refresh">ØªØ­Ø¯ÙŠØ«</button>
      </div>

      <div class="grid grid-2" style="margin-top:12px">
        <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
        <div class="card">
          <table class="table" id="c-table">
            <thead>
              <tr>
                <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                <th>Ø§Ù„Ù…Ø±Ø³Ù„</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              </tr>
            </thead>
            <tbody id="c-rows">
              <tr><td colspan="5" class="muted">â€”</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
        <div class="card" id="c-detail">
          <h3 style="margin-top:0">Ø§Ù„ØªÙØ§ØµÙŠÙ„</h3>
          <div id="c-empty" class="muted">Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©â€¦</div>

          <div id="c-box" class="hidden">
            <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> <span id="cd-subject">â€”</span></p>
            <p><strong>Ø§Ù„Ù…Ø±Ø³Ù„:</strong> <span id="cd-user">â€”</span></p>
            <p><strong>Ø§Ù„Ø·Ù„Ø¨:</strong> <span id="cd-kind">â€”</span></p>
            <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span id="cd-status" class="pill">â€”</span></p>
            <div class="field">
              <label>Ø³Ø¬Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</label>
              <div id="cd-thread" style="border:1px solid #e5e7eb33;border-radius:10px;padding:10px;max-height:340px;overflow:auto"></div>
            </div>

            <div class="grid">
              <div class="field">
                <label>ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</label>
                <select id="cd-next">
                  <option value="">Ù„Ø§ ØªØºÙŠÙŠØ±</option>
                  <option value="in_progress">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                  <option value="resolved">Ù…ØºÙ„Ù‚Ø©</option>
                  <option value="rejected">Ù…Ø±ÙÙˆØ¶Ø©</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label>Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø³Ù„</label>
              <textarea id="cd-reply" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯ Ù‡Ù†Ø§â€¦"></textarea>
            </div>
            <div class="actions-row">
              <button class="btn primary" id="cd-send">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
              <span id="cd-statusmsg" class="muted"></span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <!-- Auth0 SDK -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>

  <!-- Supabase (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª/Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¥Ù† ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="assets/js/supabase-client.js"></script>

  <!-- Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ø¹Ø§Ù… Ø¥Ù† Ø±ØºØ¨Øª -->
  <script src="assets/js/require-auth.js"></script>

  <!-- moment + hijri -->
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/min/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment-hijri@2.3.1/moment-hijri.js"></script>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø¹Ø§Ù… -->
  <script src="app.js"></script>

  <script>
  const toast = (m)=>{ const t=document.getElementById('toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',1400); };

  // ===== ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø¨Ø³ÙŠØ·Ø©
  const tabs = ["t-activate","t-ann","t-complaints"];
  function showTab(id){
    tabs.forEach(x=> document.getElementById(x).style.display = (x===id)?'':'none');
    document.querySelectorAll('[data-tab]').forEach(b => b.classList.toggle('primary', b.dataset.tab===id));
  }
  document.addEventListener('click',(e)=>{
    const b = e.target.closest('[data-tab]'); if(!b) return;
    showTab(b.dataset.tab);
  });

  // ===== ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
  async function isAdmin(){
    try{
      const u = await window.auth.getUser();
      document.getElementById('whoami').textContent = u?.email || '';
      if (!u) return false;

      const claims = await window.auth.getIdTokenClaims();
      const roles = claims?.["https://n-athar.co/roles"] || claims?.["https://n-athar/roles"] || [];
      const flag  = claims?.["https://n-athar.co/admin"] === true || claims?.["https://athar/admin"] === true;
      return (Array.isArray(roles) && roles.includes("admin")) || flag;
    }catch(_){ return false; }
  }
  async function authToken(){ return await window.auth.getToken({ audience: "https://api.n-athar" }); }

  // ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
  function toIso(calSelId, gId, hId) {
    const mode = document.getElementById(calSelId).value;
    if (mode === 'greg') {
      const v = document.getElementById(gId).value;
      if (!v) return null;
      return new Date(v + 'T00:00:00Z').toISOString();
    } else {
      const v = document.getElementById(hId).value.trim();
      if (!v) return null;
      const m = moment(v, 'iYYYY-iMM-iDD', true);
      if (!m.isValid()) return null;
      return new Date(m.format('YYYY-MM-DD') + 'T00:00:00Z').toISOString();
    }
  }

  // ===== Ø¥Ø¹Ù„Ø§Ù†Ø§Øª (Ø±Ø¨Ø· Ù…Ø¹ admin-announcement*)
  async function fetchAnnouncements() {
    try {
      const [latestRes, listRes] = await Promise.all([
        fetch('/.netlify/functions/admin-announcement?latest=1'),
        fetch('/.netlify/functions/admin-announcement?list=1')
      ]);
      const latest = latestRes.ok ? (await latestRes.json()).latest : null;
      const list = listRes.ok ? (await listRes.json()).items || [] : [];

      const curBox = document.getElementById('ann-current');
      curBox.innerHTML = latest ? `Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ: <span class="pill">${latest.text}</span>` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù† Ù…Ù†Ø´ÙˆØ± Ø­Ø§Ù„ÙŠÙ‹Ø§.';

      const wrap = document.getElementById('ann-list');
      wrap.innerHTML = '';
      list.forEach(a=>{
        const liveNow = a.active && (!a.start_at || new Date(a.start_at)<=new Date()) && (!a.expires_at || new Date(a.expires_at)>new Date());
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
            <div>
              <div><strong>${a.active ? 'âœ…' : 'â¸ï¸'} ${a.text}</strong></div>
              <div class="muted" style="font-size:.9em">
                ÙŠØ¨Ø¯Ø£: ${a.start_at ? new Date(a.start_at).toLocaleDateString('ar-SA') : 'ÙÙˆØ±ÙŠ'}
                â€¢ ÙŠÙ†ØªÙ‡ÙŠ: ${a.expires_at ? new Date(a.expires_at).toLocaleDateString('ar-SA') : 'â€”'}
                ${liveNow ? '<span class="pill" style="margin-inline-start:6px">Ù…Ù†Ø´ÙˆØ± Ø­Ø§Ù„ÙŠÙ‹Ø§</span>' : ''}
              </div>
            </div>
            <div class="actions-row" style="margin:0">
              <button class="btn" data-repub="${a.id}">Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø±</button>
              ${a.active ? '<button class="btn" data-stop="'+a.id+'">Ø¥ÙŠÙ‚Ø§Ù</button>' : ''}
              <button class="btn" data-del="${a.id}">Ø­Ø°Ù</button>
            </div>
          </div>
        `;
        wrap.appendChild(card);
      });

      wrap.querySelectorAll('[data-repub]').forEach(b=>{
        b.onclick = async ()=>{
          const id = b.getAttribute('data-repub');
          await updateAnnouncement({ id, active:true, start:null }); // ÙŠØ¨Ø¯Ø£ ÙÙˆØ±ÙŠÙ‹Ø§
          await fetchAnnouncements();
        };
      });
      wrap.querySelectorAll('[data-stop]').forEach(b=>{
        b.onclick = async ()=>{
          const id = b.getAttribute('data-stop');
          await updateAnnouncement({ id, active:false });
          await fetchAnnouncements();
        };
      });
      wrap.querySelectorAll('[data-del]').forEach(b=>{
        b.onclick = async ()=>{
          const id = b.getAttribute('data-del');
          if (!confirm('Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ')) return;
          await deleteAnnouncement(id);
          await fetchAnnouncements();
        };
      });

    } catch(e) { console.warn(e); }
  }
  async function updateAnnouncement(payload) {
    const res = await fetch('/.netlify/functions/admin-announcement', {
      method:'PUT',
      headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${await authToken()}` },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }
  async function deleteAnnouncement(id) {
    const res = await fetch('/.netlify/functions/admin-announcement?id='+encodeURIComponent(id), {
      method:'DELETE',
      headers:{ 'Authorization': `Bearer ${await authToken()}` }
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // Ù†Ø´Ø±/ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ù„Ø§Ù†
  document.addEventListener('click', async (e)=>{
    if(e.target.id !== 'btn-publish') return;
    const text    = document.getElementById('ann-text').value.trim();
    const active  = document.getElementById('ann-active').value === 'true';
    const start   = toIso('ann-start-cal','ann-start-g','ann-start-h');
    const expires = toIso('ann-end-cal','ann-end-g','ann-end-h');
    const stat = document.getElementById('ann-status');
    stat.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ù†Ø´Ø±â€¦';
    try{
      const res = await fetch('/.netlify/functions/admin-announcement', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${await authToken()}` },
        body: JSON.stringify({ text, active, start, expires })
      });
      const j = await res.json();
      if(!res.ok) throw new Error(j?.error || 'failed');
      stat.textContent = 'Ù†ÙØ´Ø± âœ“';
      toast('ØªÙ… Ù†Ø´Ø±/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†');
      document.getElementById('ann-text').value = '';
      await fetchAnnouncements();
    }catch(err){
      console.error(err);
      stat.textContent = 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø´Ø±';
      toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø´Ø±');
    }
  });

  // ===== ØªÙØ¹ÙŠÙ„/ØªÙ…Ø¯ÙŠØ¯ Ø¹Ø¶ÙˆÙŠØ©
  document.addEventListener('click', async (e)=>{
    if(e.target.id !== 'btn-activate') return;
    const email   = document.getElementById('act-email').value.trim();
    const user_id = document.getElementById('act-userid').value.trim();
    const amount  = Math.max(1, Number(document.getElementById('act-amount').value||'1')|0);
    const unit    = document.getElementById('act-unit').value;
    const note    = document.getElementById('act-note').value.trim() || null;
    const stat = document.getElementById('act-status');
    stat.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªÙØ¹ÙŠÙ„â€¦';
    try{
      const res = await fetch('/.netlify/functions/admin-activate', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${await authToken()}` },
        body: JSON.stringify({ email: email || null, user_id: user_id || null, amount, unit, note })
      });
      const j = await res.json();
      if(!res.ok) throw new Error(j?.error || 'failed');
      stat.textContent = `ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ âœ“ ÙŠÙ†ØªÙ‡ÙŠ: ${j.expires_at || 'â€”'}`;
      toast('ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„');
    }catch(err){
      console.error(err);
      stat.textContent = 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„';
      toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„');
    }
  });

  // ===== Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰/Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª (Ø±Ø¨Ø· Ù…Ø¹ complaints-*)
  let currentComplaintId = null;

  async function loadComplaints(){
    const type = document.getElementById('c-type').value;
    const status = document.getElementById('c-status').value;
    const q = document.getElementById('c-q').value.trim();
    const qs = new URLSearchParams();
    if (type) qs.set('type', type);
    if (status) qs.set('status', status);
    if (q) qs.set('q', q);
    const res = await fetch('/.netlify/functions/complaints-list?'+qs.toString(), {
      headers: { 'Authorization': `Bearer ${await authToken()}` }
    });
    const j = await res.json();
    const tbody = document.getElementById('c-rows');
    tbody.innerHTML = '';
    (j.rows || []).forEach(row=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a href="#" data-open="${row.id}">${row.subject}</a></td>
        <td>${row.user_name || 'â€”'}<br><span class="muted">${row.user_email}</span></td>
        <td>${row.type === 'complaint' ? 'Ø´ÙƒÙˆÙ‰' : 'Ø§Ù‚ØªØ±Ø§Ø­'}</td>
        <td><span class="pill status-${row.status}">${row.status}</span></td>
        <td>${new Date(row.created_at).toLocaleString('ar-SA')}</td>
      `;
      tbody.appendChild(tr);
    });
    if ((j.rows || []).length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="5" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td>`;
      tbody.appendChild(tr);
    }
  }

  async function openComplaint(id){
    currentComplaintId = id;
    const res = await fetch('/.netlify/functions/complaints-get?id='+encodeURIComponent(id), {
      headers: { 'Authorization': `Bearer ${await authToken()}` }
    });
    const j = await res.json();
    const c = j.complaint;
    const msgs = j.messages || [];

    document.getElementById('c-empty').classList.add('hidden');
    document.getElementById('c-box').classList.remove('hidden');

    document.getElementById('cd-subject').textContent = c.subject;
    document.getElementById('cd-user').textContent = (c.user_name? c.user_name+' â€” ' : '') + c.user_email;
    document.getElementById('cd-kind').textContent = (c.type === 'complaint' ? 'Ø´ÙƒÙˆÙ‰' : 'Ø§Ù‚ØªØ±Ø§Ø­');
    const st = document.getElementById('cd-status');
    st.textContent = c.status;
    st.className = 'pill status-'+c.status;

    const thread = document.getElementById('cd-thread');
    thread.innerHTML = '';
    msgs.forEach(m=>{
      const bubble = document.createElement('div');
      bubble.style.margin = '8px 0';
      bubble.innerHTML = `
        <div class="pill" style="display:inline-block;${m.sender==='admin'?'background:#e2e8f0;color:#0f172a;':'background:#f1f5f9;color:#0f172a;'}">
          ${m.sender==='admin'?'ÙØ±ÙŠÙ‚ Ø£Ø«Ø±':'Ø§Ù„Ø¹Ù…ÙŠÙ„'}
        </div>
        <div>${(m.body||'').replace(/\n/g,'<br>')}</div>
        <div class="muted" style="font-size:.85em">${new Date(m.created_at).toLocaleString('ar-SA')}</div>
      `;
      thread.appendChild(bubble);
    });

    document.getElementById('cd-reply').value = '';
    document.getElementById('cd-next').value = '';
    document.getElementById('cd-statusmsg').textContent = '';
  }

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©/Ø§Ù„ÙÙ„ØªØ±Ø©
  document.getElementById('c-refresh').addEventListener('click', loadComplaints);
  document.getElementById('c-type').addEventListener('change', loadComplaints);
  document.getElementById('c-status').addEventListener('change', loadComplaints);
  document.getElementById('c-q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadComplaints(); });
  document.getElementById('c-rows').addEventListener('click', (e)=>{
    const a = e.target.closest('[data-open]'); if(!a) return;
    e.preventDefault();
    openComplaint(a.getAttribute('data-open'));
  });

  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
  document.getElementById('cd-send').addEventListener('click', async ()=>{
    if (!currentComplaintId) return;
    const msg  = document.getElementById('cd-reply').value.trim();
    const next = document.getElementById('cd-next').value || null;
    const stat = document.getElementById('cd-statusmsg');
    if (!msg) { toast('Ø£ÙƒØªØ¨ Ø§Ù„Ø±Ø¯'); return; }
    stat.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„â€¦';
    try{
      const res = await fetch('/.netlify/functions/complaints-reply', {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization': `Bearer ${await authToken()}`
        },
        body: JSON.stringify({ complaint_id: currentComplaintId, message: msg, next_status: next })
      });
      const j = await res.json();
      if(!res.ok) throw new Error(j?.error || 'failed');
      stat.textContent = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ“';
      toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯');
      await openComplaint(currentComplaintId);
      await loadComplaints();
    }catch(err){
      console.error(err);
      stat.textContent = 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
      toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
    }
  });

  // ===== ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  document.addEventListener('DOMContentLoaded', async ()=>{
    // Ø§Ù†ØªØ¸Ø§Ø± ØªÙ‡ÙŠØ¦Ø© window.auth Ù…Ù† app.js
    for (let i=0; i<50 && !window.auth; i++) { await new Promise(r=>setTimeout(r,100)); }

    // ØªØ­Ù‚Ù‚ Ø£Ø¯Ù…Ù†
    const ok = await isAdmin();
    document.getElementById('tabsCard').style.display = ok ? '' : 'none';
    document.getElementById('denyCard').style.display = ok ? 'none' : '';
    if (!ok) return;

    // Ø§ÙØªØ­ÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
    showTab('t-complaints');

    // Ø¬Ù‡Ø²ÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
    await fetchAnnouncements();

    // Ø­Ù…Ù‘Ù„ÙŠ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰
    await loadComplaints();
  });
  </script>
</body>
</html>
