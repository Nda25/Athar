<!-- admin.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…ÙÙ†</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="dark light" />
<style>
  .card{ margin:16px 0 }
  .grid{ display:grid; gap:12px; grid-template-columns:1fr }
  @media(min-width:900px){ .grid{ grid-template-columns:1fr 1fr } }
  .field{ margin:10px 0 }
  .field label{ display:block; font-weight:700; margin:6px 0 }
  .field input,.field select, .field textarea{
    width:100%; padding:12px; border-radius:12px; border:1px solid rgba(59,130,246,.35)
  }
  .muted{ opacity:.8 }
  .hidden{ display:none !important }
  .actions-row{ margin-top:8px; display:flex; gap:10px; flex-wrap:wrap }
</style>
</head>
<body>
  <div class="topbar">
    <div class="left-actions"><a class="btn" href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></div>
    <div class="actions"><button class="btn" id="themeToggle">ğŸŒ“</button></div>
    <div class="user"><span class="muted" id="whoami"></span></div>
  </div>

  <header>
    <div class="hero">
      <h1 class="logo">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…ÙÙ†</h1>
      <div class="tag"><span class="dot"></span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div>
    </div>
  </header>

  <main class="container">
    <!-- Ø±Ø³Ø§Ù„Ø© Ø±ÙØ¶ -->
    <section class="card" id="denyCard" style="display:none">
      <h2 class="title">Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø±ÙÙˆØ¶</h2>
      <p>Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·.</p>
    </section>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† -->
    <section class="card" id="adminCard" style="display:none">
      <h2 class="title">Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h2>
      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="act-email" type="email" placeholder="example@email.com" />
        </div>
        <div class="field">
          <label>UID (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="act-userid" type="text" placeholder="Auth0 sub Ø¥Ù† ÙƒØ§Ù† Ù…ØªØ§Ø­Ù‹Ø§" />
        </div>
        <div class="field">
          <label>Ø§Ù„Ù…Ø¯Ø© (Ø£Ø´Ù‡Ø±)</label>
          <input id="act-months" type="number" min="1" value="12" />
        </div>
        <div class="field">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="act-note" type="text" placeholder="Ø³Ø¨Ø¨/Ù…Ø±Ø¬Ø¹"/>
        </div>
      </div>
      <div class="actions-row">
        <button class="btn primary" id="btn-activate">ØªÙØ¹ÙŠÙ„/ØªÙ…Ø¯ÙŠØ¯</button>
        <span id="act-status" class="muted"></span>
      </div>
    </section>

    <section class="card" id="annCard" style="display:none">
      <h2 class="title">Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù…</h2>
      <div class="field">
        <label>Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
        <textarea id="ann-text" rows="4" placeholder="Ø³ÙŠØ¸Ù‡Ø± Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹"></textarea>
      </div>
      <div class="grid">
        <div class="field">
          <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="ann-active">
            <option value="true" selected>Ù…ÙÙØ¹Ù‘Ù„</option>
            <option value="false">Ù…ÙˆÙ‚Ù‘Ù</option>
          </select>
        </div>
        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="ann-expires" type="date" />
        </div>
      </div>
      <div class="actions-row">
        <button class="btn" id="btn-publish">Ù†Ø´Ø±/ØªØ­Ø¯ÙŠØ«</button>
        <span id="ann-status" class="muted"></span>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 class="title" style="margin:0 0 8px">Ø¢Ø®Ø± Ø¥Ø¹Ù„Ø§Ù† Ù…Ù†Ø´ÙˆØ±</h3>
        <pre id="ann-preview" class="muted" style="white-space:pre-wrap">â€”</pre>
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <!-- SDKs (Ù†ÙØ³ ØªØ±ØªÙŠØ¨ Ù…Ø´Ø±ÙˆØ¹Ùƒ) -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/supabase-client.js"></script>
  <!-- Ø§Ù„Ø­Ø§Ø±Ø³: ÙŠØ¬Ø¨Ø± Ø¹Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆÙŠØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ø£Ø¯Ù…Ù† -->
  <script defer src="assets/js/require-auth.js"></script>
  <!-- Ø³ÙƒØ±Ø¨Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø¹Ø§Ù… (ÙÙŠÙ‡ initAuth0 ÙˆØºÙŠØ±Ù‡) -->
  <script defer src="app.js"></script>

  <script>
  // â€”â€”â€” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª (Claims) â€”â€”â€”
  const ADMIN_CLAIM = "https://athar/admin"; // Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù„ÙŠ Ø¶ÙÙ†Ø§Ù‡ ÙÙŠ Action
  const toast = (m)=>{ const t=document.getElementById('toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',1400); };

  async function isAdmin(){
    try{
      const u = await window.auth.getUser();
      document.getElementById('whoami').textContent = u?.email || '';
      if (!u) return false;

      const claims = await window.auth.getIdTokenClaims();

      // 1) roles = ['admin', ...]
      const roles = (claims && claims["https://athar/roles"]) || [];
      if (Array.isArray(roles) && roles.includes("admin")) return true;

      // 2) ÙÙ„Ø§Øº Ø³Ø±ÙŠØ¹
      if (claims && (claims[ADMIN_CLAIM] === true || claims["https://athar/admin"] === true)) return true;

      // 3) ÙˆØ§ÙŠØª Ù„ÙŠØ³Øª Ø·ÙˆØ§Ø±Ø¦ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” Ø£ÙØ±ØºÙŠÙ‡Ø§ Ø¥Ù† Ù…Ø§ ÙˆØ¯Ùƒ
      const ADMIN_EMAILS = []; // ["you@example.com"]
      if (u.email && ADMIN_EMAILS.includes(String(u.email).toLowerCase())) return true;

      return false;
    }catch(_){ return false; }
  }

  async function fetchCurrentAnnouncement(){
    try{
      const res = await fetch('/.netlify/functions/admin-announcement?latest=1');
      if(!res.ok) return;
      const j = await res.json();
      document.getElementById('ann-preview').textContent = j?.latest
        ? JSON.stringify(j.latest, null, 2)
        : 'â€”';
    }catch(_){}
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    // Ø¨Ø¹Ø¯ Ù…Ø§ app.js ÙŠØ¬Ù‡Ù‘Ø² Auth0 Ø¨ÙŠØ±Ø³Ù„ Ø­Ø¯Ø« auth0:ready. ÙƒØ§Ø­ØªÙŠØ§Ø· Ù†Ù†ØªØ¸Ø± Ø´ÙˆÙŠ.
    const wait = (ms)=> new Promise(r=>setTimeout(r,ms));
    for (let i=0; i<30 && !window.auth; i++) { await wait(100); }

    const ok = await isAdmin();
    document.getElementById('adminCard').style.display = ok ? '' : 'none';
    document.getElementById('annCard').style.display   = ok ? '' : 'none';
    document.getElementById('denyCard').style.display  = ok ? 'none' : '';

    if (!ok) return;

    await fetchCurrentAnnouncement();

    // â€”â€”â€” ØªÙØ¹ÙŠÙ„/ØªÙ…Ø¯ÙŠØ¯ â€”â€”â€”
    document.getElementById('btn-activate').addEventListener('click', async ()=>{
      const email   = document.getElementById('act-email').value.trim();
      const user_id = document.getElementById('act-userid').value.trim();
      const months  = Math.max(1, Number(document.getElementById('act-months').value||'12')|0);
      const note    = document.getElementById('act-note').value.trim() || null;

      const stat = document.getElementById('act-status');
      stat.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªÙØ¹ÙŠÙ„â€¦';
      try{
        // Ø®Ø°ÙŠ Access Token Ø¨Ø£ÙˆØ¯ÙŠÙ†Ø³ Athar API
        const token = await window.auth.getToken({ audience: "https://api.athar" });

        const res = await fetch('/.netlify/functions/admin-activate', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ email: email || null, user_id: user_id || null, months, note })
        });
        const j = await res.json();
        if(!res.ok) throw new Error(j?.error || 'failed');
        stat.textContent = `ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ âœ“ ÙŠÙ†ØªÙ‡ÙŠ: ${j.expires_at || 'â€”'}`;
        toast('ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„');
      }catch(e){
        console.error(e);
        stat.textContent = 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„';
        toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„');
      }
    });

    // â€”â€”â€” Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† â€”â€”â€”
    document.getElementById('btn-publish').addEventListener('click', async ()=>{
      const text    = document.getElementById('ann-text').value.trim();
      const active  = document.getElementById('ann-active').value === 'true';
      const expires = document.getElementById('ann-expires').value || null;
      const stat = document.getElementById('ann-status');
      stat.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ù†Ø´Ø±â€¦';

      try{
        const token = await window.auth.getToken({ audience: "https://api.athar" });

        const res = await fetch('/.netlify/functions/admin-announcement', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ text, active, expires })
        });
        const j = await res.json();
        if(!res.ok) throw new Error(j?.error || 'failed');
        stat.textContent = 'Ù†ÙØ´Ø± âœ“';
        toast('ØªÙ… Ù†Ø´Ø±/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†');
        document.getElementById('ann-preview').textContent = JSON.stringify(j.latest || j, null, 2);
      }catch(e){
        console.error(e);
        stat.textContent = 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø´Ø±';
        toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø´Ø±');
      }
    });
  });
  </script>
</body>
</html>
