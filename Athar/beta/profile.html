<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„Ø£Ø«Ø± â€” Ø£Ø«Ù€Ù€Ø±</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Amiri:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <meta name="color-scheme" content="dark light">

  <!-- ØªØ­Ø³ÙŠÙ†Ø§Øª CSS Ø®ÙÙŠÙØ© Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© (Ù„Ø§ ØªØºÙŠÙ‘Ø± ÙˆØ¸Ø§Ø¦Ù Ù‚Ø¯ÙŠÙ…Ø©) -->
  <style>
    :root { --primary: #6366f1; }
    .card .title { display:flex; align-items:center; gap:10px; }
    .subheading { font-size:14px; color:#6b7280; font-weight:600; }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 800px){ .grid { grid-template-columns: 1fr; } }
    .profile-box { display:grid; grid-template-columns:auto 1fr; gap:16px; align-items:center; }
    .avatar-wrap { position:relative; width:92px; height:92px; }
    .avatar { width:92px; height:92px; border-radius:50%; object-fit:cover; border:3px solid #eef; background:#f5f7ff; }
    .edit-badge { position:absolute; right:-6px; bottom:-6px; background:var(--primary); color:#fff; border-radius:16px; padding:4px 8px; font-size:12px; cursor:pointer; border:1px solid #fff; }
    .name-row { display:flex; align-items:center; gap:8px; font-weight:800; font-size:20px; }
    .icon-btn { border:1px solid #e5e7eb; background:#fff; cursor:pointer; padding:4px 8px; border-radius:8px; }
    .badge { padding:6px 10px; border:1px solid transparent; border-radius:10px; font-weight:700; display:inline-block; }
    .muted { color:#6b7280 }
    .row-actions { display:flex; gap:10px; flex-wrap:wrap; }
    .btn.ghost { background:#fff; border:1px solid #e5e7eb; }
    .section-title { font-weight:800; margin-bottom:8px; }
    .theme-picker { display:flex; gap:10px; }
    .theme-picker button { width:28px; height:28px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 0 1px #e5e7eb; cursor:pointer; }
    .theme-note { font-size:12px; color:#6b7280; margin-top:6px; }
    .pill { padding:6px 10px; border-radius:999px; font-weight:700; border:1px solid #e5e7eb; background:#fff; }
    .divider { height:1px; background:#f1f5f9; margin:12px 0; }

    /* Ø²Ø± ÙÙˆØ§ØªÙŠØ± "Ù‚Ø±ÙŠØ¨Ù‹Ø§" */
    .soon { opacity:.6; cursor:not-allowed; }
  </style>
</head>

<body>
  <div class="global-bg"></div>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <div class="topbar">
    <div class="left-actions">
      <a class="btn" href="index.html" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†/Ø§Ù„ÙØ§ØªØ­">ğŸŒ“</button>
      <a class="btn primary" href="pricing.html">Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ</a>
    </div>
  </div>

  <header>
    <div class="hero">
      <div class="hero-plate"></div>
      <h1 class="logo">Ø£Ø«Ù€Ù€Ø±</h1>
      <div class="tag"><span class="dot"></span>Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</div>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="card">
        <h2 class="title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„Ø£Ø«Ø± <span class="subheading">â€” ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ®Øµ Ø­Ø³Ø§Ø¨Ùƒ</span></h2>

        <div class="grid">
          <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„Ù‡ÙˆÙŠØ© -->
          <div class="box profile-box">
            <div class="avatar-wrap">
              <img id="u-avatar" class="avatar" src="assets/img/avatar-placeholder.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨">
              <label class="edit-badge" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©">
                âœ
                <input id="avatarInput" type="file" accept="image/*" hidden>
              </label>
            </div>

            <div>
              <div class="name-row">
                <span id="displayName" class="js-user-name">â€”</span>
                <button id="editNameBtn" class="icon-btn" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…">âœ</button>
              </div>

              <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> <span id="u-email">â€”</span></p>
              <p><strong>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:</strong> <span id="u-sub">â€”</span></p>
              <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</strong> <span id="u-joined">â€”</span></p>

              <div class="divider"></div>

              <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <span class="section-title">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨:</span>
                <span id="u-status">â€”</span>
                <span id="sub-state" class="badge" style="display:none"></span>
              </div>

              <div class="row-actions" style="margin-top:12px">
                <a class="btn" href="pricing.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</a>
                <button id="invoicesBtn" class="btn ghost soon" title="Ù‚Ø±ÙŠØ¨Ù‹Ø§" disabled>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
              </div>
              <div class="muted" style="margin-top:6px">Ø§Ù„ÙÙˆØ§ØªÙŠØ±: <strong>Ù‚Ø±ÙŠØ¨Ù‹Ø§</strong> â€” Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ ÙÙˆØ± Ø±Ø¨Ø· Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹.</div>
            </div>
          </div>

          <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù†: ØªØ®ØµÙŠØµ -->
          <div class="box">
            <h3 class="section-title">ØªØ®ØµÙŠØµ Ù„ÙˆÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</h3>
       <div id="themePicker" class="theme-picker" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ù„ÙˆÙ† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬">
  <button data-color="#6366f1" title="Ø¨Ù†ÙØ³Ø¬ÙŠ"></button>
  <button data-color="#f472b6" title="Ø²Ù‡Ø±ÙŠ"></button>
  <button data-color="#22c55e" title="Ø£Ø®Ø¶Ø±"></button>
  <button data-color="#06b6d4" title="Ø³Ù…Ø§ÙˆÙŠ"></button>
  <button data-color="#f59e0b" title="Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ"></button>
  <button data-reset="true" title="Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ">â†º</button>
</div>
            <div class="theme-note">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù„ÙˆÙ†Ùƒ Ø§Ù„Ù…ÙØ¶Ù„ Ù„Ø¹Ù†ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ. ÙŠÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>

            <div class="divider"></div>

            <h3 class="section-title">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h3>
            <p class="muted">Ù„Ù„ØªÙØ¹ÙŠÙ„ Ø£Ùˆ Ø§Ù„ØªØ±Ù‚ÙŠØ© ØªÙØ¶Ù„ Ø¨Ø²ÙŠØ§Ø±Ø© ØµÙØ­Ø© <a href="pricing.html">Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ</a>.</p>
            <p class="muted">Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø³ØªØ¸Ù‡Ø± ØªÙØ§ØµÙŠÙ„ Ø¨Ø§Ù‚ØªÙƒ ÙˆÙÙˆØ§ØªÙŠØ±Ùƒ Ù‡Ù†Ø§.</p>

            <div class="divider"></div>

            <div class="row-actions">
              <button id="logout" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <p class="foot-line">Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø´Ø±Ø§Ø±Ø© ØµØºÙŠØ±Ø©â€¦ ØªÙØ¶ÙŠØ¡ Ø¹Ù‚ÙˆÙ„Ù‹Ø§ ÙƒØ¨ÙŠØ±Ø©.</p>
    <p class="foot-name">Ù†Ø¯Ù‰ Ø§Ù„Ù…Ø¬ÙŠØ±Ø´</p>
    <nav class="foot-links">
      <a href="privacy.html">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a><span class="sep">|</span>
      <a href="terms.html">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</a><span class="sep">|</span>
      <a href="refund-policy.html">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</a><span class="sep">|</span>
      <a href="whatsapp.html">ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</a><span class="sep">|</span>
      <a href="complaints.html">Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</a>
    </nav>
    <div class="foot-copy">Â© <span id="year"></span> Ø£Ø«Ù€Ù€Ø± â€” ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</div>
  </footer>

  <script>(function(){ var y=document.getElementById('year'); if(y) y.textContent=new Date().getFullYear(); })();</script>
  <div class="toast"></div>

  <!-- Supabase SDK + ØªÙ‡ÙŠØ¦Ø© (Ù‚Ø¨Ù„ Ø£ÙŠ Ø³ÙƒØ±Ø¨Øª ÙŠØ³ØªØ®Ø¯Ù…Ù‡ Ù…Ø«Ù„ storage.js) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    window.__CFG = Object.assign({}, window.__CFG || {}, {
      supabase_url:  "YOUR_SUPABASE_URL",        // Ù…Ø«Ø§Ù„: https://abcd1234.supabase.co
      supabase_anon: "YOUR_SUPABASE_ANON_KEY"    // Ù…Ù† Project Settings â†’ API
    });
    window.supabase = window.supabase || supabase.createClient(
      window.__CFG.supabase_url,
      window.__CFG.supabase_anon,
      { auth: { persistSession: false } }
    );
  </script>

  <!-- Ø³ÙƒØ±Ø¨ØªØ§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹ -->
  <script src="app.js"></script>
  <script src="assets/js/storage.js"></script>

  <!-- Ù…Ù†Ø§Ø¯Ø§Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆÙ…Ù„Ù Ø§Ù„ØªØ¹Ø±ÙŠÙ -->
  <script>
    async function initProfile(){
      const client = window.auth0Client;
      if (!client) return;

      const logged = await client.isAuthenticated().catch(()=>false);
      if (!logged) {
        await client.loginWithRedirect({ authorizationParams:{ redirect_uri: window.location.href } });
        return;
      }

      // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Claims
      let user=null, claims=null;
      try { user = await client.getUser(); } catch(_){}
      try { claims = await client.getIdTokenClaims(); } catch(_){}

      const name = user?.name || user?.nickname || 'â€”';
      document.querySelectorAll('.js-user-name,#displayName').forEach(n=> n.textContent = name);
      document.getElementById('u-email').textContent = user?.email || 'â€”';
      document.getElementById('u-sub').textContent   = user?.sub   || 'â€”';
      const joined = user?.updated_at || user?.created_at || null;
      document.getElementById('u-joined').textContent = joined ? new Date(joined).toLocaleDateString('ar-SA') : 'â€”';

      // Ø§Ù„ØµÙˆØ±Ø© (Ù…Ø¹ ØªÙØ¶ÙŠÙ„Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª)
      const avatarEl = document.getElementById('u-avatar');
      if (user?.picture) avatarEl.src = user.picture;

      // Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (NS Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…)
      const NS_NEW = "https://n-athar.co/";
      const NS_OLD = "https://athar.co/";
      const st = (claims && (claims[NS_NEW + "status"] || claims[NS_OLD + "status"])) || "";
      document.getElementById('u-status').textContent = st || 'â€”';

      const colorBy = {
        active:  {bg:'#dcfce7', fg:'#166534', br:'#bbf7d0', text:'Ù…ÙØ¹Ù„'},
        trial:   {bg:'#dbeafe', fg:'#1e3a8a', br:'#bfdbfe', text:'ØªØ¬Ø±ÙŠØ¨ÙŠ'},
        pending: {bg:'#fef9c3', fg:'#854d0e', br:'#fde68a', text:'Ù…Ø¹Ù„Ù‚'},
        inactive:{bg:'#fee2e2', fg:'#991b1b', br:'#fecaca', text:'ØºÙŠØ± Ù†Ø´Ø·'}
      };
      const badge = document.getElementById('sub-state');
      if (st) {
        const m = colorBy[st] || colorBy.inactive;
        badge.style.display='inline-block';
        badge.textContent=m.text; badge.style.background=m.bg; badge.style.color=m.fg; badge.style.borderColor=m.br;
      }

      // Ø¬Ù„Ø¨ ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø³Ù…/ØµÙˆØ±Ø©/Ù„ÙˆÙ†)
      try {
        if (window.supabase && user?.sub) {
          const { data: pref } = await window.supabase
            .from('user_prefs').select('*').eq('user_sub', user.sub).maybeSingle();
          if (pref?.display_name) document.querySelectorAll('.js-user-name,#displayName').forEach(n=> n.textContent = pref.display_name);
          if (pref?.avatar_url)   avatarEl.src = pref.avatar_url;
          if (pref?.theme_color)  document.documentElement.style.setProperty('--primary', pref.theme_color);
        }
      } catch(_){}

      // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… (ÙŠØ­ÙØ¸ ÙÙŠ user_prefs)
      document.getElementById('editNameBtn').onclick = async () => {
        const cur = document.getElementById('displayName').textContent.trim();
        const newName = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶:", cur || name);
        if (!newName || !newName.trim()) return;
        document.querySelectorAll('.js-user-name,#displayName').forEach(n=> n.textContent = newName.trim());
        try {
          if (window.supabase && user?.sub) {
            await window.supabase.from('user_prefs').upsert(
              { user_sub: user.sub, display_name: newName.trim() },
              { onConflict: 'user_sub' }
            );
          }
        } catch(e){ console.error(e); }
      };

      // Ø±ÙØ¹ ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© Ø¥Ù„Ù‰ Storage (bucket: avatars)
      document.getElementById('avatarInput').onchange = async (ev) => {
        const file = ev.target.files?.[0]; if (!file) return;
        try {
          const safe = user?.sub?.replace(/[|]/g,'_') || 'u';
          const path = `${safe}/${Date.now()}_${file.name}`;
          const up = await window.supabase.storage.from('avatars').upload(path, file, { upsert:true });
          if (up.error) throw up.error;
          const { data } = window.supabase.storage.from('avatars').getPublicUrl(path);
          avatarEl.src = data.publicUrl;
          await window.supabase.from('user_prefs').upsert({ user_sub: user.sub, avatar_url: data.publicUrl }, { onConflict: 'user_sub' });
        } catch(e){ console.error(e); alert("ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©."); }
      };
    }

    // Ù…ÙÙ†ØªÙ‚ÙŠ Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (ÙŠØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆÙÙŠ user_prefs)
    (function themeInit(){
      const saved = localStorage.getItem('athar:theme');
      if (saved) document.documentElement.style.setProperty('--primary', saved);
      const picker = document.getElementById('themePicker');
      if (!picker) return;
      picker.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-color]'); if (!btn) return;
        const color = btn.getAttribute('data-color');
        document.documentElement.style.setProperty('--primary', color);
        localStorage.setItem('athar:theme', color);
        try {
          const u = await window.auth0Client?.getUser();
          if (u?.sub && window.supabase) {
            await window.supabase.from('user_prefs').upsert(
              { user_sub: u.sub, theme_color: color }, { onConflict: 'user_sub' }
            );
          }
        } catch(_){}
      });
    })();

    // Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.id === 'logout') {
        window.auth0Client?.logout({ logoutParams:{ returnTo: window.location.origin } });
      }
    });

    // ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø­Ø§Ø±Ø³
    window.addEventListener('auth0:ready', initProfile);
    if (window.auth0Client) initProfile();
  </script>

  <!-- Ø­Ø§Ø±Ø³ Ø§Ù„ÙˆØµÙˆÙ„ -->
  <script src="assets/js/require-auth.js"></script>
</body>
</html>
