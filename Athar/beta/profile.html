<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„Ø£Ø«Ø± â€” Ø£Ø«Ù€Ù€Ø±</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Amiri:wght@700&display=swap" rel="stylesheet">

  <!-- Ø­Ù…Ù‘Ù„ÙŠ Ù„ÙˆÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø§Ø³Ù…/Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ù…Ø¨ÙƒØ±Ù‹Ø§ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ÙˆÙ…ÙŠØ¶ -->
  <script>
    (function(){
      try{
        var c  = localStorage.getItem('athar:theme');
        if (c) document.documentElement.style.setProperty('--primary', c);

        var dn = localStorage.getItem('athar:displayName');
        if (dn) document.addEventListener('DOMContentLoaded', function(){
          document.querySelectorAll('.js-user-name,#displayName').forEach(n=> n.textContent = dn);
        });

        var av = localStorage.getItem('athar:avatar');
        if (av) document.addEventListener('DOMContentLoaded', function(){
          var img = document.getElementById('u-avatar');
          if (img) img.src = av;
        });
      }catch(_){}
    })();
  </script>

  <link rel="stylesheet" href="style.css">
  <meta name="color-scheme" content="dark light">

  <style>
    :root { --primary: var(--sea-600); }

    /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
    .container{ width:100%; max-width: 980px; margin: 0 auto; padding: 0 16px; }

    /* Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
    .card .title { display:flex; align-items:center; gap:10px; }
    .subheading { font-size:14px; color:#6b7280; font-weight:600; }

    /* Ø§Ù„Ø´Ø¨ÙƒØ© */
    .grid { display:grid; gap:16px; grid-template-columns: 1fr 1fr; align-items:start; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }

    /* Ø§Ù„Ù‡ÙˆÙŠØ© */
    .profile-box { display:grid; grid-template-columns:auto 1fr; gap:16px; align-items:center; }
    .avatar-wrap { position:relative; width:96px; height:96px; flex:0 0 auto; }
    .avatar { width:96px; height:96px; border-radius:50%; object-fit:cover; border:3px solid #eef; background:#f5f7ff; }
    .edit-badge { position:absolute; right:-6px; bottom:-6px; background:var(--primary); color:#fff; border-radius:16px; padding:4px 8px; font-size:12px; cursor:pointer; border:1px solid #fff; }
    .name-row { display:flex; align-items:center; gap:8px; font-weight:800; font-size:20px; flex-wrap:wrap; }
    .icon-btn { border:1px solid #e5e7eb; background:#fff; cursor:pointer; padding:4px 8px; border-radius:8px; }
    .badge { padding:6px 10px; border:1px solid transparent; border-radius:10px; font-weight:700; display:inline-block; }
    .muted { color:#6b7280 }
    .row-actions { display:flex; gap:10px; flex-wrap:wrap; }
    .btn.ghost { background:#fff; border:1px solid #e5e7eb; }
    .section-title { font-weight:800; margin-bottom:8px; }
    #u-email, #u-sub { word-break: break-word; overflow-wrap: anywhere; }

    /* Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø·ÙŠØ¡ */
    .card[data-ready="0"] { opacity:.0; }
    .card[data-ready="1"] { opacity:1; transition:opacity .18s ease; }

    /* Ø§Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 900px){
      .profile-box { grid-template-columns: 1fr; justify-items:center; text-align:center; }
      .avatar-wrap { width:84px; height:84px; }
      .avatar { width:84px; height:84px; }
      .name-row, .row-actions { justify-content:center; }
      .hero .logo { font-size: 40px !important; }
    }

    /* Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
    .theme-picker { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .theme-picker button{
      all: unset; display:inline-block; width:28px; height:28px; border-radius:50%;
      border:2px solid #fff; box-shadow:0 0 0 1px #e5e7eb; cursor:pointer;
    }
    .theme-picker button[data-reset]{ background:#111827; }
    .theme-picker button.is-active{
      outline: 3px solid color-mix(in oklab, var(--primary) 65%, white);
      outline-offset: 2px;
    }
    .theme-note { font-size:12px; color:#6b7280; margin-top:6px; }
    .divider { height:1px; background:#f1f5f9; margin:12px 0; }
    .soon { opacity:.6; cursor:not-allowed; }
    .state { padding:6px 10px; border-radius:999px; font-weight:800; border:1px solid #e5e7eb; background:#fff; }

    /* Ù…Ø­Ø±Ù‘Ø± Ø§Ù„Ù‚Øµ */
    .modal{ position:fixed; inset:0; background:#0009; display:none; align-items:center; justify-content:center; z-index:2147483000; }
    .modal.show{ display:flex; }
    .modal .panel{ width:min(96vw, 760px); background:#0b1324; color:#e5e7eb; border-radius:14px; border:1px solid #1f2a44; box-shadow:0 20px 60px #0006; overflow:hidden; }
    .panel .head{ padding:10px 14px; border-bottom:1px solid #1f2a44; display:flex; align-items:center; justify-content:space-between }
    .panel .body{ padding:14px; display:grid; gap:12px; grid-template-columns:1fr 260px; }
    .crop-stage{ position:relative; background:#0f172a; border:1px solid #1f2a44; border-radius:10px; height:440px; overflow:hidden; }
    .crop-canvas{ position:absolute; inset:0; width:100%; height:100%; }
    .crop-overlay{ position:absolute; inset:0; pointer-events:none; }
    .ctrls{ display:grid; gap:10px; align-content:start; }
    .ctrls .row{ display:flex; align-items:center; gap:8px; }
    .ctrls label{ font-size:12px; opacity:.85 }
    .ctrls select,.ctrls input[type="range"]{ width:100% }
    .panel .foot{ padding:12px 14px; border-top:1px solid #1f2a44; display:flex; gap:10px; justify-content:flex-end; }
    .btn.small{ padding:8px 12px; font-size:14px }
    @media (max-width: 900px){
      .panel .body{ grid-template-columns:1fr; }
      .crop-stage{ height: 320px; }
      .panel .foot{ justify-content:space-between; }
    }
  </style>
</head>

<body>
  <div class="global-bg"></div>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <div class="topbar">
    <div class="left-actions"><a class="btn" href="index.html" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†/Ø§Ù„ÙØ§ØªØ­">ğŸŒ“</button>
      <a class="btn primary" href="pricing.html">Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ</a>
    </div>
  </div>

  <header>
    <div class="hero">
      <div class="hero-plate"></div>
      <h1 class="logo">Ø£Ø«Ù€Ù€Ø±</h1>
      <div class="tag"><span class="dot"></span>ØµÙØ­ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©</div>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="card" id="profileCard" data-ready="0">
        <h2 class="title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„Ø£Ø«Ø± <span class="subheading">â€” ÙƒÙ„ Ù…Ø§ ÙŠØ®Øµ Ø­Ø³Ø§Ø¨Ùƒ ÙˆØªØ®ØµÙŠØµ ÙˆØ§Ø¬Ù‡ØªÙƒ</span></h2>

        <div class="grid">
          <!-- Ø§Ù„Ù‡ÙˆÙŠØ© -->
          <div class="box profile-box">
            <div class="avatar-wrap">
              <!-- fallback SVG Ù„Ùˆ Ù…Ù„Ù placeholder ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ -->
              <img id="u-avatar" class="avatar"
                   src="assets/img/avatar-placeholder.png"
                   alt="ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨"
                   onerror="this.onerror=null; this.src='data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2296%22 height=%2296%22 viewBox=%220 0 96 96%22%3E%3Cdefs/%3E%3Crect width=%2296%22 height=%2296%22 rx=%2248%22 fill=%22%23eef%22/%3E%3Ccircle cx=%2248%22 cy=%2248%22 r=%2230%22 fill=%22%23c7d2fe%22/%3E%3Ctext x=%2250%25%22 y=%2252%25%22 font-size=%2230%22 text-anchor=%22middle%22 fill=%22%23333%22 font-family=%22Cairo,Arial%22%3EğŸ™‚%3C/text%3E%3C/svg%3E';">
              <label class="edit-badge" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©">
                âœ
                <input id="avatarInput" type="file" accept="image/*" hidden>
              </label>
            </div>

            <div>
              <div class="name-row">
                <span id="displayName" class="js-user-name">â€”</span>
                <button id="editNameBtn" class="icon-btn" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…">âœ</button>
              </div>

              <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> <span id="u-email">â€”</span></p>
              <p><strong>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:</strong> <span id="u-sub">â€”</span></p>
              <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</strong> <span id="u-joined">â€”</span></p>

              <div class="divider"></div>

              <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <span class="section-title">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨:</span>
                <span id="u-status">â€”</span>
                <span id="sub-state" class="badge" style="display:none"></span>
              </div>

              <div class="row-actions" style="margin-top:12px">
                <a class="btn" href="pricing.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</a>
                <button id="invoicesBtn" class="btn ghost soon" title="Ù‚Ø±ÙŠØ¨Ù‹Ø§" disabled>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
              </div>
              <div class="muted" style="margin-top:6px">Ø§Ù„ÙÙˆØ§ØªÙŠØ±: <strong>Ù‚Ø±ÙŠØ¨Ù‹Ø§</strong> â€” Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ ÙÙˆØ± Ø±Ø¨Ø· Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹.</div>
            </div>
          </div>

          <!-- ØªØ®ØµÙŠØµ -->
          <div class="box">
            <h3 class="section-title">ØªØ®ØµÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</h3>

            <div id="themePicker" class="theme-picker" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ù„ÙˆÙ† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬" data-v2="1">
              <button data-reset title="Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ"></button>
              <button data-color="#6366f1" title="Ø¨Ù†ÙØ³Ø¬ÙŠ"></button>
              <button data-color="#f472b6" title="Ø²Ù‡Ø±ÙŠ"></button>
              <button data-color="#22c55e" title="Ø£Ø®Ø¶Ø±"></button>
              <button data-color="#06b6d4" title="Ø³Ù…Ø§ÙˆÙŠ"></button>
              <button data-color="#f59e0b" title="Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ"></button>
            </div>
            <div class="theme-note">Ø§Ø®ØªØ± Ù„ÙˆÙ†Ùƒ Ø§Ù„Ù…ÙØ¶Ù„â€¦ ğŸª„.</div>

            <div class="divider"></div>

            <h3 class="section-title">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h3>
            <p class="muted">Ù„Ù„ØªÙØ¹ÙŠÙ„ Ø£Ùˆ Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù‚Ù… Ø¨Ø²ÙŠØ§Ø±Ø© ØµÙØ­Ø© <a href="pricing.html">Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ</a>.</p>
            <p class="muted">Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø³ØªØ¸Ù‡Ø± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø© ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ± Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</p>

            <div class="divider"></div>

            <div class="row-actions">
              <button id="logout" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <p class="foot-line">Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø´Ø±Ø§Ø±Ø© ØµØºÙŠØ±Ø©â€¦ ØªÙØ¶ÙŠØ¡ Ø¹Ù‚ÙˆÙ„Ù‹Ø§ ÙƒØ¨ÙŠØ±Ø©.</p>
    <p class="foot-name">Ù†Ø¯Ù‰ Ø§Ù„Ù…Ø¬ÙŠØ±Ø´</p>
    <nav class="foot-links">
      <a href="privacy.html">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a><span class="sep">|</span>
      <a href="terms.html">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</a><span class="sep">|</span>
      <a href="refund-policy.html">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</a><span class="sep">|</span>
      <a href="whatsapp.html">ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</a><span class="sep">|</span>
      <a href="complaints.html">Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</a>
    </nav>
    <div class="foot-copy">Â© <span id="year"></span> Ø£Ø«Ù€Ù€Ø± â€” ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</div>
  </footer>

  <script>(function(){ var y=document.getElementById('year'); if(y) y.textContent=new Date().getFullYear(); })();</script>
  <div class="toast" id="toast"></div>

  <!-- Modal Ø§Ù„Ù‚ØµÙ‘ -->
  <div id="cropModal" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="Ù‚ØµÙ‘ Ø§Ù„ØµÙˆØ±Ø©">
      <div class="head">
        <strong>Ù‚ØµÙ‘ Ø§Ù„ØµÙˆØ±Ø©</strong>
        <button class="btn small" data-close>Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="body">
        <div class="crop-stage">
          <canvas id="cropCanvas" class="crop-canvas"></canvas>
          <canvas id="cropOverlay" class="crop-overlay"></canvas>
        </div>
        <div class="ctrls">
          <div class="row">
            <label>Ø§Ù„Ù†Ø³Ø¨Ø©:</label>
            <select id="cropAspect">
              <option value="1">1:1 (Ù…Ø±Ø¨Ù‘Ø¹)</option>
              <option value="1.3333333">4:3 (Ø£ÙÙ‚ÙŠ)</option>
              <option value="0.75">3:4 (Ø¹Ù…ÙˆØ¯ÙŠ)</option>
            </select>
          </div>
          <div class="row">
            <label>Ø§Ù„ØªÙ‚Ø±ÙŠØ¨:</label>
            <input id="cropZoom" type="range" min="0.5" max="3" step="0.01" value="1">
          </div>
          <div class="row">
            <label>Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¶ØºØ·:</label>
            <input id="cropQuality" type="range" min="0.6" max="0.95" step="0.01" value="0.82">
          </div>
          <div class="row">
            <label>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£Ù‚ØµÙ‰ (px):</label>
            <input id="cropMax" type="number" min="256" max="2048" step="64" value="768">
          </div>
          <div class="row muted" style="font-size:12px">Ø§Ø³Ø­Ø¨ÙŠ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¶Ø¹ØŒ ÙˆØ§Ø³ØªØ®Ø¯Ù…ÙŠ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø±ÙŠØ¨.</div>
        </div>
      </div>
      <div class="foot">
        <button id="cropCancel" class="btn">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="cropConfirm" class="btn primary">Ø­ÙØ¸ ÙˆØ±ÙØ¹</button>
      </div>
    </div>
  </div>

  <!-- SDKs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/supabase-client.js"></script>

  <!-- Ø³ÙƒØ±Ø¨ØªØ§Øª Ø¹Ø§Ù…Ø© -->
  <script src="app.js"></script>
  <script src="assets/js/storage.js"></script>

  <!-- Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© -->
  <script>
    function toast(msg){
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1800);
    }

    // â€”â€” Ù…Ø­Ø±Ù‘Ø± Ø§Ù„Ù‚Øµ (cover + minZoom + ØªØ«Ø¨ÙŠØª Ø§Ù„Ø³Ø­Ø¨) â€”â€”
    const cropper = (function(){
      let modal, canvas, ctx, overlay, octx, img = null;
      let dragging = false, lastX=0, lastY=0;
      let state = { zoom:1, minZoom:1, ox:0, oy:0, aspect:1, quality:0.82, max:768 };

      function getCropBox(W,H){
        const stageRatio = W/H;
        let cw = W, ch = H;
        if (stageRatio > state.aspect) { cw = H * state.aspect; ch = H; }
        else { cw = W; ch = W / state.aspect; }
        const cx = (W - cw)/2, cy = (H - ch)/2;
        return {cx, cy, cw, ch};
      }
      function clampPan(){
        if (!img || !canvas) return;
        const W = canvas.width, H = canvas.height;
        const {cx, cy, cw, ch} = getCropBox(W,H);
        const iw = img.width * state.zoom;
        const ih = img.height * state.zoom;
        const minX = cx + cw - iw, maxX = cx;
        const minY = cy + ch - ih, maxY = cy;
        if (iw <= cw) state.ox = cx + (cw - iw)/2; else state.ox = Math.max(minX, Math.min(maxX, state.ox));
        if (ih <= ch) state.oy = cy + (ch - ih)/2; else state.oy = Math.max(minY, Math.min(maxY, state.oy));
      }
      function computeMinZoom(){
        const W = canvas.width, H = canvas.height;
        const {cw, ch} = getCropBox(W,H);
        return Math.max(cw / img.width, ch / img.height);
      }
      function draw(){
        if (!img) return;
        const W = canvas.width, H = canvas.height;
        ctx.clearRect(0,0,W,H); ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,W,H);
        const {cx, cy, cw, ch} = getCropBox(W,H);
        clampPan();
        ctx.save(); ctx.beginPath(); ctx.rect(cx, cy, cw, ch); ctx.clip();
        ctx.drawImage(img, state.ox, state.oy, img.width*state.zoom, img.height*state.zoom);
        ctx.restore();
        octx.clearRect(0,0,W,H);
        octx.fillStyle = '#0008'; octx.fillRect(0,0,W,H);
        octx.clearRect(cx, cy, cw, ch);
        octx.strokeStyle = '#fff'; octx.lineWidth = 2; octx.strokeRect(cx+1, cy+1, cw-2, ch-2);
      }
      function setCanvasSize(){
        const stage = canvas.parentElement;
        const rect = stage.getBoundingClientRect();
        canvas.width  = Math.max(320, Math.round(rect.width));
        canvas.height = Math.max(240, Math.round(rect.height));
        overlay.width = canvas.width;
        overlay.height= canvas.height;
      }
      function setZoom(newZoom, fx, fy){
        const prev = state.zoom;
        newZoom = Math.max(state.minZoom, Math.min(state.minZoom*3, newZoom));
        if (!img || newZoom === prev) { state.zoom = newZoom; clampPan(); draw(); return; }
        const W = canvas.width, H = canvas.height;
        const {cx, cy, cw, ch} = getCropBox(W,H);
        fx = (fx ?? (cx + cw/2)); fy = (fy ?? (cy + ch/2));
        const imgXBefore = (fx - state.ox) / prev;
        const imgYBefore = (fy - state.oy) / prev;
        state.zoom = newZoom;
        state.ox = fx - imgXBefore * newZoom;
        state.oy = fy - imgYBefore * newZoom;
        clampPan(); draw();
      }
      function open(fileOrURL){
        modal = document.getElementById('cropModal');
        canvas = document.getElementById('cropCanvas');
        overlay= document.getElementById('cropOverlay');
        ctx = canvas.getContext('2d'); octx = overlay.getContext('2d');
        state.zoom = 1; state.ox = 0; state.oy = 0;

        return new Promise((resolve)=>{
          modal.classList.add('show');
          modal.setAttribute('aria-hidden','false');
          const image = new Image();
          image.onload = function(){
            img = image; setCanvasSize();
            state.minZoom = computeMinZoom();
            state.zoom = state.minZoom;
            const {cx, cy, cw, ch} = getCropBox(canvas.width, canvas.height);
            const iw = img.width * state.zoom, ih = img.height * state.zoom;
            state.ox = cx + (cw - iw)/2; state.oy = cy + (ch - ih)/2;

            const zoomRange = document.getElementById('cropZoom');
            zoomRange.min = state.minZoom.toFixed(2);
            zoomRange.max = (state.minZoom*3).toFixed(2);
            zoomRange.value = state.minZoom.toFixed(2);
            draw();
          };
          image.onerror= function(){ toast('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©'); close(); resolve(null); };
          if (fileOrURL instanceof File) image.src = URL.createObjectURL(fileOrURL);
          else image.src = fileOrURL;

          function onDown(e){ e.preventDefault(); dragging=true; lastX=(e.touches?e.touches[0].clientX:e.clientX); lastY=(e.touches?e.touches[0].clientY:e.clientY); }
          function onMove(e){ if(!dragging) return; const x=(e.touches?e.touches[0].clientX:e.clientX), y=(e.touches?e.touches[0].clientY:e.clientY); state.ox += (x-lastX); state.oy += (y-lastY); lastX=x; lastY=y; clampPan(); draw(); }
          function onUp(){ dragging=false; }

          canvas.onmousedown = onDown; canvas.onmousemove = onMove; window.onmouseup = onUp;
          canvas.ontouchstart= onDown; canvas.ontouchmove  = onMove; window.ontouchend = onUp;
          canvas.onwheel = (e)=>{ e.preventDefault(); const f = (e.deltaY<0? 1.05:0.95); const r=canvas.getBoundingClientRect(); setZoom(state.zoom*f, e.clientX-r.left, e.clientY-r.top); };

          const aspectSel = document.getElementById('cropAspect');
          const zoomRange = document.getElementById('cropZoom');
          const qRange    = document.getElementById('cropQuality');
          const maxInput  = document.getElementById('cropMax');

          aspectSel.onchange = ()=>{
            state.aspect = parseFloat(aspectSel.value)||1;
            state.minZoom = computeMinZoom();
            state.zoom = Math.max(state.zoom, state.minZoom);
            zoomRange.min = state.minZoom.toFixed(2);
            zoomRange.max = (state.minZoom*3).toFixed(2);
            if (parseFloat(zoomRange.value) < state.minZoom) zoomRange.value = state.minZoom.toFixed(2);
            const {cx, cy, cw, ch} = getCropBox(canvas.width, canvas.height);
            const iw = img.width * state.zoom, ih = img.height * state.zoom;
            state.ox = cx + (cw - iw)/2; state.oy = cy + (ch - ih)/2;
            clampPan(); draw();
          };
          zoomRange.oninput  = ()=> setZoom(parseFloat(zoomRange.value)||state.minZoom);
          qRange.oninput     = ()=> state.quality = parseFloat(qRange.value)||0.82;
          maxInput.onchange  = ()=> state.max = Math.max(256, Math.min(2048, parseInt(maxInput.value||768,10)));

          document.getElementById('cropCancel').onclick = ()=>{ close(); resolve(null); };
          document.querySelector('#cropModal [data-close]').onclick = ()=>{ close(); resolve(null); };
          document.getElementById('cropConfirm').onclick = ()=>{
            const W = canvas.width, H=canvas.height;
            const {cx, cy, cw, ch} = getCropBox(W,H);
            let outW = state.max, outH = Math.round(outW / state.aspect);
            if (state.aspect < 1) { outH = state.max; outW = Math.round(outH * state.aspect); }
            const out = document.createElement('canvas'); out.width = outW; out.height = outH;
            const o2d = out.getContext('2d');
            const tmp = document.createElement('canvas'); tmp.width = W; tmp.height = H;
            const tctx = tmp.getContext('2d');
            tctx.fillStyle = '#0f172a'; tctx.fillRect(0,0,W,H);
            tctx.save(); tctx.beginPath(); tctx.rect(cx, cy, cw, ch); tctx.clip();
            tctx.drawImage(img, state.ox, state.oy, img.width*state.zoom, img.height*state.zoom);
            tctx.restore();
            const cut = tctx.getImageData(cx, cy, cw, ch);
            const cutCanvas = document.createElement('canvas'); cutCanvas.width = cw; cutCanvas.height = ch;
            cutCanvas.getContext('2d').putImageData(cut, 0, 0);
            o2d.drawImage(cutCanvas, 0, 0, outW, outH);
            out.toBlob((blob)=>{ close(); resolve(blob); }, 'image/jpeg', state.quality);
          };

          function close(){ 
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden','true');
            window.onmouseup=null; window.ontouchend=null; canvas.onwheel=null;
          }

          const onResize = ()=>{ setCanvasSize(); state.minZoom = computeMinZoom(); if (state.zoom < state.minZoom) state.zoom = state.minZoom; clampPan(); draw(); };
          window.addEventListener('resize', onResize, { passive:true });
          modal.addEventListener('transitionend', function cleanup(){
            if (!modal.classList.contains('show')) {
              window.removeEventListener('resize', onResize);
              modal.removeEventListener('transitionend', cleanup);
            }
          });
        });
      }
      return { open };
    })();

    async function ensureBucketOnce(){
      // Ø­Ø§ÙˆÙ„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙƒØª ÙˆØ§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·ØŒ Ø«Ù… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡.
      if (window.__triedEnsureBucket__) return;
      window.__triedEnsureBucket__ = true;
      try { await fetch('/.netlify/functions/storage-ensure'); } catch(_){}
    }

    async function initProfile(){
      const card = document.getElementById('profileCard');
      card?.setAttribute('data-ready','0');

      const client = window.auth0Client || window.auth;
      if (!client) return;

      const logged = await client.isAuthenticated?.().catch(()=>false);
      if (!logged) {
        await client.loginWithRedirect({ authorizationParams:{ redirect_uri: window.location.href } });
        return;
      }

      let user=null, claims=null;
      try { user = await client.getUser(); } catch(_){}
      try { claims = await client.getIdTokenClaims(); } catch(_){}

      // Ø¹Ø±Ø¶ Ù…Ø¨Ø¯Ø¦ÙŠ
      const nameFromCache = localStorage.getItem('athar:displayName');
      const baseName = nameFromCache || user?.name || user?.nickname || 'â€”';
      document.querySelectorAll('.js-user-name,#displayName').forEach(n=> n.textContent = baseName);
      document.getElementById('u-email').textContent = user?.email || 'â€”';
      document.getElementById('u-sub').textContent   = user?.sub   || 'â€”';
      const joined = user?.updated_at || user?.created_at || null;
      document.getElementById('u-joined').textContent = joined ? new Date(joined).toLocaleDateString('ar-SA') : 'â€”';

      const avatarEl = document.getElementById('u-avatar');

      // Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
      const NS_NEW = "https://n-athar.co/";
      const NS_OLD = "https://athar.co/";
      const st = (claims && (claims[NS_NEW + "status"] || claims[NS_OLD + "status"])) || "";
      document.getElementById('u-status').textContent = st || 'â€”';
      const colorBy = {
        active:{bg:'#dcfce7', fg:'#166534', br:'#bbf7d0', text:'Ù…ÙØ¹Ù„'},
        trial:{bg:'#dbeafe', fg:'#1e3a8a', br:'#bfdbfe', text:'ØªØ¬Ø±ÙŠØ¨ÙŠ'},
        pending:{bg:'#fef9c3', fg:'#854d0e', br:'#fde68a', text:'Ù…Ø¹Ù„Ù‚'},
        inactive:{bg:'#fee2e2', fg:'#991b1b', br:'#fecaca', text:'ØºÙŠØ± Ù†Ø´Ø·'}
      };
      const badge = document.getElementById('sub-state');
      if (st) {
        const m = colorBy[st] || colorBy.inactive;
        badge.style.display='inline-block'; badge.textContent=m.text;
        badge.style.background=m.bg; badge.style.color=m.fg; badge.style.borderColor=m.br;
      }

      // ØªÙØ¶ÙŠÙ„Ø§Øª Ù…Ù† Supabase (ØªÙ‚Ø¯Ù‘Ù… Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Auth0)
      try {
        if (window.supa && user?.sub) {
          const { data: pref } = await window.supa
            .from('user_prefs').select('*').eq('user_sub', user.sub).maybeSingle();

          if (pref?.display_name) {
            document.querySelectorAll('.js-user-name,#displayName').forEach(n=> n.textContent = pref.display_name);
            localStorage.setItem('athar:displayName', pref.display_name);
          }
          if (pref?.avatar_url) {
            const url = pref.avatar_url;
            avatarEl.src = url;
            localStorage.setItem('athar:avatar', url);
          } else if (user?.picture) {
            avatarEl.src = user.picture;
          }
          if (pref?.theme_color) document.documentElement.style.setProperty('--primary', pref.theme_color);
        } else {
          // Ù„Ø§ ÙŠÙˆØ¬Ø¯ supa: Ø§Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Auth0 Ù„Ùˆ ÙˆÙØ¬Ø¯Øª
          if (!localStorage.getItem('athar:avatar') && user?.picture) avatarEl.src = user.picture;
        }
      } catch(_){}

      // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…
      document.getElementById('editNameBtn').onclick = async () => {
        const cur = document.getElementById('displayName').textContent.trim();
        const newName = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶:", cur || baseName);
        if (!newName || !newName.trim()) return;
        const clean = newName.trim();
        document.querySelectorAll('.js-user-name,#displayName').forEach(n=> n.textContent = clean);
        localStorage.setItem('athar:displayName', clean);
        try {
          if (window.supa && user?.sub) {
            await window.supa.from('user_prefs').upsert(
              { user_sub: user.sub, display_name: clean },
              { onConflict: 'user_sub' }
            );
            toast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… âœ“");
          }
        } catch(e){ console.error(e); toast("ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…"); }
      };

      // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© (Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Øµ/Ø§Ù„Ø¶ØºØ·)
      const avatarInput = document.getElementById('avatarInput');
      avatarInput.onchange = async (ev) => {
        const file = ev.target.files?.[0]; if (!file) return;
        try {
          const blob = await cropper.open(file);
          if (!blob) { ev.target.value=''; return; }
          const finalFile = new File([blob], 'avatar.jpg', { type:'image/jpeg' });

          if (!window.supa) throw new Error("Supabase ØºÙŠØ± Ù…ØªØ§Ø­");
          const safe = (user?.sub || 'u').replace(/[|]/g,'_');
          const path = `${safe}/${Date.now()}_avatar.jpg`;

          // Ø§Ù„Ø±ÙØ¹ (Ù…Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙƒØª Ø¥Ø°Ø§ Ù…ÙÙ‚ÙˆØ¯)
          let up = await window.supa.storage.from('avatars').upload(path, finalFile, { upsert:true, contentType:'image/jpeg' });
          if (up.error && /Bucket not found/i.test(up.error.message||up.error)) {
            await ensureBucketOnce();
            up = await window.supa.storage.from('avatars').upload(path, finalFile, { upsert:true, contentType:'image/jpeg' });
          }
          if (up.error) throw up.error;

          const { data } = window.supa.storage.from('avatars').getPublicUrl(path);
          const url = data.publicUrl + `?v=${Date.now()}`;
          document.getElementById('u-avatar').src = url;
          localStorage.setItem('athar:avatar', url);

          await window.supa.from('user_prefs').upsert(
            { user_sub: user.sub, avatar_url: url },
            { onConflict: 'user_sub' }
          );
          toast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© âœ“");
        } catch(e){ console.error(e); toast("ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©"); }
        finally { ev.target.value = ''; }
      };

      // Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£Ù„ÙˆØ§Ù†
      (function initThemePicker(){
        const root = document.documentElement;
        const picker = document.getElementById('themePicker');
        if (!picker) return;
        const swatches = [...picker.querySelectorAll('button')];
        picker.dataset.v2 = '1';
        swatches.forEach(b=>{
          if (b.hasAttribute('data-color')) b.style.backgroundColor = b.dataset.color;
          if (b.hasAttribute('data-reset')) b.style.background = '#111827';
        });

        const saved = localStorage.getItem('athar:theme');
        if (saved) {
          root.style.setProperty('--primary', saved);
          (swatches.find(b=>b.dataset.color === saved) || swatches.find(b=>b.hasAttribute('data-reset')))?.classList.add('is-active');
        } else {
          swatches.find(b=>b.hasAttribute('data-reset'))?.classList.add('is-active');
        }

        picker.addEventListener('click', async (e)=>{
          const btn = e.target.closest('button'); if (!btn) return;

          if (btn.hasAttribute('data-reset')) {
            localStorage.removeItem('athar:theme');
            const def = getComputedStyle(root).getPropertyValue('--sea-600').trim() || '#1e40af';
            root.style.setProperty('--primary', def);
            swatches.forEach(b=>b.classList.remove('is-active'));
            btn.classList.add('is-active');
            try { const u = await (window.auth0Client||window.auth)?.getUser(); if (window.supa && u?.sub) await window.supa.from('user_prefs').upsert({ user_sub:u.sub, theme_color:null }, { onConflict:'user_sub' }); } catch(_){}
            return;
          }

          const color = btn.dataset.color;
          if (!color) return;
          root.style.setProperty('--primary', color);
          localStorage.setItem('athar:theme', color);
          try { const u = await (window.auth0Client||window.auth)?.getUser(); if (window.supa && u?.sub) await window.supa.from('user_prefs').upsert({ user_sub:u.sub, theme_color:color }, { onConflict:'user_sub' }); } catch(_){}
          swatches.forEach(b=>b.classList.remove('is-active'));
          btn.classList.add('is-active');
        });
      })();

      card?.setAttribute('data-ready','1');
    }

    // Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.id === 'logout') {
        (window.auth0Client || window.auth)?.logout({ logoutParams:{ returnTo: window.location.origin } });
      }
    });

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø­Ø§Ø±Ø³
    window.addEventListener('auth0:ready', initProfile);
    if (window.auth0Client || window.auth) initProfile();
  </script>

  <!-- Ø­Ø§Ø±Ø³ Ø§Ù„ÙˆØµÙˆÙ„ -->
  <script src="assets/js/require-auth.js"></script>

  <!-- ØªØ¹Ø·ÙŠÙ„ Ø£ÙŠ Ù…Ù†Ø·Ù‚ Ù‚Ø¯ÙŠÙ… Ù„Ù„Ø«ÙŠÙ… ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¹Ù†ØµØ± -->
  <script>
    (function themeInitLegacyGuard(){
      const picker = document.getElementById('themePicker');
      if (picker && picker.dataset && picker.dataset.v2 === '1') { /* no-op */ }
    })();
  </script>
</body>
</html>
