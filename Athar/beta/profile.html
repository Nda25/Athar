<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„Ø£Ø«Ø± â€” Ø£Ø«Ù€Ù€Ø±</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Amiri:wght@700&display=swap" rel="stylesheet">

  <!-- Ø­Ù…Ù‘Ù„ÙŠ Ù„ÙˆÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ÙˆÙ…ÙŠØ¶ -->
  <script>
    (function(){
      try{
        var c = localStorage.getItem('athar:theme');
        if (c) document.documentElement.style.setProperty('--primary', c);
        var dn = localStorage.getItem('athar:displayName');
        if (dn) { document.addEventListener('DOMContentLoaded', function(){ 
          document.querySelectorAll('.js-user-name,#displayName').forEach(n=> n.textContent = dn);
        }); }
      }catch(_){}
    })();
  </script>

  <link rel="stylesheet" href="style.css">
  <meta name="color-scheme" content="dark light">

  <style>
    :root { --primary: var(--sea-600); }
    .card .title { display:flex; align-items:center; gap:10px; }
    .subheading { font-size:14px; color:#6b7280; font-weight:600; }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 800px){ .grid { grid-template-columns: 1fr; } }

    .profile-box { display:grid; grid-template-columns:auto 1fr; gap:16px; align-items:center; }
    .avatar-wrap { position:relative; width:96px; height:96px; }
    .avatar { width:96px; height:96px; border-radius:50%; object-fit:cover; border:3px solid #eef; background:#f5f7ff; }
    .edit-badge { position:absolute; right:-6px; bottom:-6px; background:var(--primary); color:#fff; border-radius:16px; padding:4px 8px; font-size:12px; cursor:pointer; border:1px solid #fff; }
    .name-row { display:flex; align-items:center; gap:8px; font-weight:800; font-size:20px; }
    .icon-btn { border:1px solid #e5e7eb; background:#fff; cursor:pointer; padding:4px 8px; border-radius:8px; }
    .badge { padding:6px 10px; border:1px solid transparent; border-radius:10px; font-weight:700; display:inline-block; }
    .muted { color:#6b7280 }
    .row-actions { display:flex; gap:10px; flex-wrap:wrap; }
    .btn.ghost { background:#fff; border:1px solid #e5e7eb; }
    .section-title { font-weight:800; margin-bottom:8px; }

    .theme-picker { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .theme-picker button{
      all: unset;
      display:inline-block;
      width:28px; height:28px; border-radius:50%;
      border:2px solid #fff; box-shadow:0 0 0 1px #e5e7eb; cursor:pointer;
    }
    .theme-picker button[data-reset]{ background:#111827; }
    .theme-picker button.is-active{
      outline: 3px solid color-mix(in oklab, var(--primary) 65%, white);
      outline-offset: 2px;
    }
    .theme-note { font-size:12px; color:#6b7280; margin-top:6px; }
    .divider { height:1px; background:#f1f5f9; margin:12px 0; }
    .soon { opacity:.6; cursor:not-allowed; }

    .state { padding:6px 10px; border-radius:999px; font-weight:800; border:1px solid #e5e7eb; background:#fff; }

    .card[data-ready="0"] { opacity:.0; }
    .card[data-ready="1"] { opacity:1; transition:opacity .18s ease; }

    /* â€”â€”â€” Ù…Ø­Ø±Ù‘Ø± Ø§Ù„Ù‚Øµ (Modal) â€”â€”â€” */
    .modal{ position:fixed; inset:0; background:#0009; display:none; align-items:center; justify-content:center; z-index:2147483000; }
    .modal.show{ display:flex; }
    .modal .panel{ width:min(92vw, 720px); background:#0b1324; color:#e5e7eb; border-radius:14px; border:1px solid #1f2a44; box-shadow:0 20px 60px #0006; overflow:hidden; }
    .panel .head{ padding:10px 14px; border-bottom:1px solid #1f2a44; display:flex; align-items:center; justify-content:space-between }
    .panel .body{ padding:14px; display:grid; gap:12px; grid-template-columns:1fr 260px; }
    @media (max-width:900px){ .panel .body{ grid-template-columns:1fr; } }
    .crop-stage{ position:relative; background:#0f172a; border:1px solid #1f2a44; border-radius:10px; height:420px; overflow:hidden; }
    .crop-canvas{ position:absolute; inset:0; width:100%; height:100%; }
    .crop-overlay{ position:absolute; inset:0; pointer-events:none; }
    .ctrls{ display:grid; gap:10px; align-content:start; }
    .ctrls .row{ display:flex; align-items:center; gap:8px; }
    .ctrls label{ font-size:12px; opacity:.85 }
    .ctrls select,.ctrls input[type="range"]{ width:100% }
    .panel .foot{ padding:12px 14px; border-top:1px solid #1f2a44; display:flex; gap:10px; justify-content:flex-end; }
    .btn.small{ padding:8px 12px; font-size:14px }
  </style>
</head>

<body>
  <div class="global-bg"></div>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <div class="topbar">
    <div class="left-actions">
      <a class="btn" href="index.html" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†/Ø§Ù„ÙØ§ØªØ­">ğŸŒ“</button>
      <a class="btn primary" href="pricing.html">Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ</a>
    </div>
  </div>

  <header>
    <div class="hero">
      <div class="hero-plate"></div>
      <h1 class="logo">Ø£Ø«Ù€Ù€Ø±</h1>
      <div class="tag"><span class="dot"></span>ØµÙØ­ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©</div>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="card" id="profileCard" data-ready="0">
        <h2 class="title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„Ø£Ø«Ø± <span class="subheading">â€” ÙƒÙ„ Ù…Ø§ ÙŠØ®Øµ Ø­Ø³Ø§Ø¨Ùƒ ÙˆØªØ®ØµÙŠØµ ÙˆØ§Ø¬Ù‡ØªÙƒ</span></h2>

        <div class="grid">
          <!-- Ø§Ù„Ù‡ÙˆÙŠØ© -->
          <div class="box profile-box">
            <div class="avatar-wrap">
              <img id="u-avatar" class="avatar" src="assets/img/avatar-placeholder.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨">
              <label class="edit-badge" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©">
                âœ
                <input id="avatarInput" type="file" accept="image/*" hidden>
              </label>
            </div>

            <div>
              <div class="name-row">
                <span id="displayName" class="js-user-name">â€”</span>
                <button id="editNameBtn" class="icon-btn" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…">âœ</button>
              </div>

              <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> <span id="u-email">â€”</span></p>
              <p><strong>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:</strong> <span id="u-sub">â€”</span></p>
              <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</strong> <span id="u-joined">â€”</span></p>

              <div class="divider"></div>

              <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <span class="section-title">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨:</span>
                <span id="u-status">â€”</span>
                <span id="sub-state" class="badge" style="display:none"></span>
              </div>

              <div class="row-actions" style="margin-top:12px">
                <a class="btn" href="pricing.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</a>
                <button id="invoicesBtn" class="btn ghost soon" title="Ù‚Ø±ÙŠØ¨Ù‹Ø§" disabled>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
              </div>
              <div class="muted" style="margin-top:6px">Ø§Ù„ÙÙˆØ§ØªÙŠØ±: <strong>Ù‚Ø±ÙŠØ¨Ù‹Ø§</strong> â€” Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ ÙÙˆØ± Ø±Ø¨Ø· Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹.</div>
            </div>
          </div>

          <!-- ØªØ®ØµÙŠØµ -->
          <div class="box">
            <h3 class="section-title">ØªØ®ØµÙŠØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</h3>

            <div id="themePicker" class="theme-picker" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ù„ÙˆÙ† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬" data-v2="1">
              <button data-reset title="Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ"></button>
              <button data-color="#6366f1" title="Ø¨Ù†ÙØ³Ø¬ÙŠ"></button>
              <button data-color="#f472b6" title="Ø²Ù‡Ø±ÙŠ"></button>
              <button data-color="#22c55e" title="Ø£Ø®Ø¶Ø±"></button>
              <button data-color="#06b6d4" title="Ø³Ù…Ø§ÙˆÙŠ"></button>
              <button data-color="#f59e0b" title="Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ"></button>
            </div>
            <div class="theme-note">Ø§Ø®ØªØ± Ù„ÙˆÙ†Ùƒ Ø§Ù„Ù…ÙØ¶Ù„â€¦ ğŸª„.</div>

            <div class="divider"></div>

            <h3 class="section-title">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h3>
            <p class="muted">Ù„Ù„ØªÙØ¹ÙŠÙ„ Ø£Ùˆ Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù‚Ù… Ø¨Ø²ÙŠØ§Ø±Ø© ØµÙØ­Ø© <a href="pricing.html">Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ</a>.</p>
            <p class="muted">Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø³ØªØ¸Ù‡Ø± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø© ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ± Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</p>

            <div class="divider"></div>

            <div class="row-actions">
              <button id="logout" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <p class="foot-line">Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø´Ø±Ø§Ø±Ø© ØµØºÙŠØ±Ø©â€¦ ØªÙØ¶ÙŠØ¡ Ø¹Ù‚ÙˆÙ„Ù‹Ø§ ÙƒØ¨ÙŠØ±Ø©.</p>
    <p class="foot-name">Ù†Ø¯Ù‰ Ø§Ù„Ù…Ø¬ÙŠØ±Ø´</p>
    <nav class="foot-links">
      <a href="privacy.html">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a><span class="sep">|</span>
      <a href="terms.html">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</a><span class="sep">|</span>
      <a href="refund-policy.html">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</a><span class="sep">|</span>
      <a href="whatsapp.html">ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</a><span class="sep">|</span>
      <a href="complaints.html">Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</a>
    </nav>
    <div class="foot-copy">Â© <span id="year"></span> Ø£Ø«Ù€Ù€Ø± â€” ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</div>
  </footer>

  <script>(function(){ var y=document.getElementById('year'); if(y) y.textContent=new Date().getFullYear(); })();</script>
  <div class="toast" id="toast"></div>

  <!-- Modal Ø§Ù„Ù‚ØµÙ‘ -->
  <div id="cropModal" class="modal" aria-hidden="true">
    <div class="panel">
      <div class="head">
        <strong>Ù‚ØµÙ‘ Ø§Ù„ØµÙˆØ±Ø©</strong>
        <button class="btn small" data-close>Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="body">
        <div class="crop-stage">
          <canvas id="cropCanvas" class="crop-canvas"></canvas>
          <canvas id="cropOverlay" class="crop-overlay"></canvas>
        </div>
        <div class="ctrls">
          <div class="row">
            <label>Ø§Ù„Ù†Ø³Ø¨Ø©:</label>
            <select id="cropAspect">
              <option value="1">1:1 (Ù…Ø±Ø¨Ù‘Ø¹)</option>
              <option value="1.3333333">4:3 (Ø£ÙÙ‚ÙŠ)</option>
              <option value="0.75">3:4 (Ø¹Ù…ÙˆØ¯ÙŠ)</option>
            </select>
          </div>
          <div class="row">
            <label>Ø§Ù„ØªÙ‚Ø±ÙŠØ¨:</label>
            <input id="cropZoom" type="range" min="0.5" max="3" step="0.01" value="1">
          </div>
          <div class="row">
            <label>Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¶ØºØ·:</label>
            <input id="cropQuality" type="range" min="0.6" max="0.95" step="0.01" value="0.82">
          </div>
          <div class="row">
            <label>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£Ù‚ØµÙ‰ (px):</label>
            <input id="cropMax" type="number" min="256" max="2048" step="64" value="768">
          </div>
          <div class="row muted" style="font-size:12px">Ø§Ø³Ø­Ø¨ÙŠ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¶Ø¹ØŒ ÙˆØ§Ø³ØªØ®Ø¯Ù…ÙŠ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø±ÙŠØ¨.</div>
        </div>
      </div>
      <div class="foot">
        <button id="cropCancel" class="btn">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="cropConfirm" class="btn primary">Ø­ÙØ¸ ÙˆØ±ÙØ¹</button>
      </div>
    </div>
  </div>

  <!-- SDKs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/supabase-client.js"></script>

  <!-- Ø³ÙƒØ±Ø¨ØªØ§Øª Ø¹Ø§Ù…Ø© -->
  <script src="app.js"></script>
  <script src="assets/js/storage.js"></script>

  <!-- Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© -->
  <script>
    function toast(msg){
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1800);
    }

    // â€”â€” Ù…ÙØ­Ø±Ù‘Ø± Ø§Ù„Ù‚ØµÙ‘ (Ù†Ø³Ø®Ø© Ù…ÙØ­Ø³Ù‘Ù†Ø© Ù…Ø¹ minZoom ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø³Ø­Ø¨) â€”â€”
    const cropper = (function(){
      let modal, canvas, ctx, overlay, octx, img = null;
      let dragging = false, lastX=0, lastY=0;
      let stageRect = null;
      let state = { zoom:1, minZoom:1, ox:0, oy:0, aspect:1, quality:0.82, max:768 };

      function getCropBox(W,H){
        const stageRatio = W/H;
        let cw = W, ch = H;
        if (stageRatio > state.aspect) { cw = H * state.aspect; ch = H; }
        else { cw = W; ch = W / state.aspect; }
        const cx = (W - cw)/2, cy = (H - ch)/2;
        return {cx, cy, cw, ch};
      }

      function clampPan(){
        if (!img || !canvas) return;
        const W = canvas.width, H = canvas.height;
        const {cx, cy, cw, ch} = getCropBox(W,H);
        // ÙŠØ¬Ø¨ Ø£Ù† ØªØºØ·ÙŠ Ø§Ù„ØµÙˆØ±Ø© ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù‚Øµ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„:
        const iw = img.width * state.zoom;
        const ih = img.height * state.zoom;

        // Ù†Ø­Ø³Ø¨ Ø­Ø¯ÙˆØ¯ Ø¥Ø²Ø§Ø­Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø­ÙŠØ« ØªØ¨Ù‚Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù…ØºØ·ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        const minX = cx + cw - iw; // Ø£Ù‚ØµÙ‰ Ø³Ø­Ø¨ Ù„Ù„ÙŠØ³Ø§Ø±
        const maxX = cx;           // Ø£Ù‚ØµÙ‰ Ø³Ø­Ø¨ Ù„Ù„ÙŠÙ…ÙŠÙ†
        const minY = cy + ch - ih; // Ø£Ù‚ØµÙ‰ Ø³Ø­Ø¨ Ù„Ù„Ø£Ø¹Ù„Ù‰
        const maxY = cy;           // Ø£Ù‚ØµÙ‰ Ø³Ø­Ø¨ Ù„Ù„Ø£Ø³ÙÙ„

        if (iw <= cw) { // Ù„Ùˆ Ø§Ù„ØµÙˆØ±Ø© Ø£ØµØºØ± Ù…Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø§Ù„Ø¹Ø±Ø¶ØŒ ØµÙÙŠÙ‡Ø§ ÙˆØ³Ø·
          state.ox = cx + (cw - iw)/2;
        } else {
          state.ox = Math.max(minX, Math.min(maxX, state.ox));
        }
        if (ih <= ch) { // Ù„Ùˆ Ø£ØµØºØ± Ø¨Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ØŒ ÙˆØ³Ø·
          state.oy = cy + (ch - ih)/2;
        } else {
          state.oy = Math.max(minY, Math.min(maxY, state.oy));
        }
      }

      function computeMinZoom(){
        // Ø£Ù‚Ù„ ØªÙ‚Ø±ÙŠØ¨ Ù„Ø§Ø²Ù… Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØ±Ø© ØªØºØ·ÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (cover)
        const W = canvas.width, H = canvas.height;
        const {cw, ch} = getCropBox(W,H);
        const zx = cw / img.width;
        const zy = ch / img.height;
        return Math.max(zx, zy);
      }

      function draw(){
        if (!img) return;
        const W = canvas.width, H = canvas.height;
        ctx.clearRect(0,0,W,H);
        ctx.fillStyle = '#0f172a';
        ctx.fillRect(0,0,W,H);

        const {cx, cy, cw, ch} = getCropBox(W,H);

        // Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø³Ø­Ø¨
        clampPan();

        const iw = img.width * state.zoom;
        const ih = img.height * state.zoom;
        const ix = state.ox;
        const iy = state.oy;

        ctx.save();
        ctx.beginPath();
        ctx.rect(cx, cy, cw, ch);
        ctx.clip();
        ctx.drawImage(img, ix, iy, iw, ih);
        ctx.restore();

        octx.clearRect(0,0,W,H);
        octx.fillStyle = '#00000088';
        octx.fillRect(0,0,W,H);
        octx.clearRect(cx, cy, cw, ch);
        octx.strokeStyle = '#ffffffdd';
        octx.lineWidth = 2;
        octx.strokeRect(cx+1, cy+1, cw-2, ch-2);
      }

      function setCanvasSize(){
        const stage = canvas.parentElement;
        const rect = stage.getBoundingClientRect();
        canvas.width  = Math.max(320, Math.round(rect.width));
        canvas.height = Math.max(240, Math.round(rect.height));
        overlay.width = canvas.width;
        overlay.height= canvas.height;
        stageRect = rect;
      }

      function setZoom(newZoom, centerX, centerY){
        // Ø¥Ø¨Ù‚Ø§Ø¡ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø± Ø«Ø§Ø¨Øª Ù†Ø³Ø¨ÙŠÙ‹Ø§ Ø­ÙŠÙ† Ù†ØºÙŠÙ‘Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ¨
        const prevZoom = state.zoom;
        newZoom = Math.max(state.minZoom, Math.min(state.minZoom*3, newZoom));
        if (!img || newZoom === prevZoom) { state.zoom = newZoom; clampPan(); draw(); return; }

        const W = canvas.width, H = canvas.height;
        const {cx, cy, cw, ch} = getCropBox(W,H);
        const focusX = (centerX ?? (cx + cw/2));
        const focusY = (centerY ?? (cy + ch/2));

        // Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¨ÙƒØ³Ù„ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ ÙˆØ¨Ø¹Ø¯
        const imgXBefore = (focusX - state.ox) / prevZoom;
        const imgYBefore = (focusY - state.oy) / prevZoom;

        state.zoom = newZoom;

        state.ox = focusX - imgXBefore * newZoom;
        state.oy = focusY - imgYBefore * newZoom;

        clampPan();
        draw();
      }

      function open(fileOrURL){
        modal = document.getElementById('cropModal');
        canvas = document.getElementById('cropCanvas');
        overlay= document.getElementById('cropOverlay');
        ctx  = canvas.getContext('2d');
        octx = overlay.getContext('2d');

        state.zoom = 1; state.ox = 0; state.oy = 0;

        return new Promise((resolve)=>{
          modal.classList.add('show');
          const image = new Image();
          image.onload = function(){
            img = image;
            setCanvasSize();
            // Ø­Ø³Ø§Ø¨ minZoom ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡
            state.minZoom = computeMinZoom();
            state.zoom = state.minZoom;
            // ÙˆØ³Ù‘Ø·ÙŠ Ø§Ù„ØµÙˆØ±Ø©
            const W = canvas.width, H = canvas.height;
            const {cx, cy, cw, ch} = getCropBox(W,H);
            const iw = img.width * state.zoom;
            const ih = img.height * state.zoom;
            state.ox = cx + (cw - iw)/2;
            state.oy = cy + (ch - ih)/2;

            // Ø§Ø¶Ø¨Ø·ÙŠ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø±ÙŠØ¨
            const zoomRange = document.getElementById('cropZoom');
            zoomRange.min = state.minZoom.toFixed(2);
            zoomRange.max = (state.minZoom*3).toFixed(2);
            zoomRange.value = state.minZoom.toFixed(2);

            draw();
          };
          image.onerror= function(){ toast('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©'); close(); resolve(null); };

          if (fileOrURL instanceof File) {
            const url = URL.createObjectURL(fileOrURL);
            image.src = url;
          } else {
            image.src = fileOrURL;
          }

          function onDown(e){ 
            dragging=true; 
            lastX=(e.touches?e.touches[0].clientX:e.clientX); 
            lastY=(e.touches?e.touches[0].clientY:e.clientY); 
          }
          function onMove(e){ 
            if(!dragging) return; 
            const x=(e.touches?e.touches[0].clientX:e.clientX), y=(e.touches?e.touches[0].clientY:e.clientY); 
            state.ox += (x-lastX); state.oy += (y-lastY); lastX=x; lastY=y; 
            clampPan(); draw(); 
          }
          function onUp(){ dragging=false; }

          canvas.onmousedown = onDown; canvas.onmousemove = onMove; window.onmouseup = onUp;
          canvas.ontouchstart= onDown; canvas.ontouchmove  = onMove; window.ontouchend = onUp;

          // Ø²ÙˆÙˆÙ… Ø¨Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø§ÙˆØ³ (ÙŠØ´ØªØºÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ù†ÙØ³)
          canvas.onwheel = (e)=>{
            e.preventDefault();
            const delta = -e.deltaY; // up = ØªÙƒØ¨ÙŠØ±
            const factor = (delta>0? 1.05 : 0.95);
            setZoom(state.zoom * factor, e.clientX - canvas.getBoundingClientRect().left, e.clientY - canvas.getBoundingClientRect().top);
          };

          // ØªØ­ÙƒÙ…Ø§Øª
          const aspectSel = document.getElementById('cropAspect');
          const zoomRange = document.getElementById('cropZoom');
          const qRange    = document.getElementById('cropQuality');
          const maxInput  = document.getElementById('cropMax');

          aspectSel.onchange = ()=>{
            state.aspect = parseFloat(aspectSel.value)||1;
            // Ø£Ø¹Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù„Ù€ minZoom ÙˆØ§Ù„ØªÙ…Ø±ÙƒØ²
            state.minZoom = computeMinZoom();
            state.zoom = Math.max(state.zoom, state.minZoom);
            zoomRange.min = state.minZoom.toFixed(2);
            zoomRange.max = (state.minZoom*3).toFixed(2);
            if (parseFloat(zoomRange.value) < state.minZoom) zoomRange.value = state.minZoom.toFixed(2);
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…Ø±ÙƒØ²
            const W = canvas.width, H = canvas.height;
            const {cx, cy, cw, ch} = getCropBox(W,H);
            const iw = img.width * state.zoom;
            const ih = img.height * state.zoom;
            state.ox = cx + (cw - iw)/2;
            state.oy = cy + (ch - ih)/2;
            clampPan();
            draw();
          };
          zoomRange.oninput  = ()=>{ setZoom(parseFloat(zoomRange.value)||state.minZoom); };
          qRange.oninput     = ()=>{ state.quality = parseFloat(qRange.value)||0.82; };
          maxInput.onchange  = ()=>{ state.max = Math.max(256, Math.min(2048, parseInt(maxInput.value||768,10))); };

          // Ø£Ø²Ø±Ø§Ø±
          document.getElementById('cropCancel').onclick = ()=>{ close(); resolve(null); };
          document.querySelector('#cropModal [data-close]').onclick = ()=>{ close(); resolve(null); };
          document.getElementById('cropConfirm').onclick = ()=>{
            // ØªØµØ¯ÙŠØ± Ø¬Ø²Ø¡ Ø§Ù„Ù‚Øµ Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            const W = canvas.width, H=canvas.height;
            const {cx, cy, cw, ch} = getCropBox(W,H);

            let outW = state.max, outH = Math.round(outW / state.aspect);
            if (state.aspect < 1) { outH = state.max; outW = Math.round(outH * state.aspect); }

            const out = document.createElement('canvas');
            out.width = outW; out.height = outH;
            const o2d = out.getContext('2d');

            // ØµÙˆØ±Ø© Ù…Ø¤Ù‚ØªØ© Ù„Ù†ÙØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            const tmp = document.createElement('canvas');
            tmp.width = W; tmp.height = H;
            const tctx = tmp.getContext('2d');
            tctx.fillStyle = '#0f172a'; tctx.fillRect(0,0,W,H);
            tctx.save();
            tctx.beginPath(); tctx.rect(cx, cy, cw, ch); tctx.clip();
            const iw = img.width * state.zoom;
            const ih = img.height * state.zoom;
            const ix = state.ox;
            const iy = state.oy;
            tctx.drawImage(img, ix, iy, iw, ih);
            tctx.restore();

            const cut = tctx.getImageData(cx, cy, cw, ch);
            const cutCanvas = document.createElement('canvas');
            cutCanvas.width = cw; cutCanvas.height = ch;
            cutCanvas.getContext('2d').putImageData(cut, 0, 0);
            o2d.drawImage(cutCanvas, 0, 0, outW, outH);

            out.toBlob((blob)=>{ close(); resolve(blob); }, 'image/jpeg', state.quality);
          };

          function close(){ 
            modal.classList.remove('show'); 
            window.onmouseup=null; window.ontouchend=null; 
            canvas.onwheel = null;
          }

          // Ù‚ÙŠØ§Ø³ Ø£ÙˆÙ„ÙŠ + Ø±Ø³Ù… Ø£ÙˆÙ„
          state.aspect = parseFloat(document.getElementById('cropAspect').value)||1;
          state.quality= parseFloat(document.getElementById('cropQuality').value)||0.82;
          state.max    = parseInt(document.getElementById('cropMax').value||768,10);

          // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© (Ù†Ø§Ø¯Ø±Ù‹Ø§)
          const onResize = ()=>{ setCanvasSize(); state.minZoom = computeMinZoom(); if (state.zoom < state.minZoom) state.zoom = state.minZoom; clampPan(); draw(); };
          window.addEventListener('resize', onResize, { passive:true });
          // Ù†Ù†Ø¸Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
          modal.addEventListener('transitionend', function cleanup(){
            if (!modal.classList.contains('show')) {
              window.removeEventListener('resize', onResize);
              modal.removeEventListener('transitionend', cleanup);
            }
          });
        });
      }

      return { open };
    })();

    async function initProfile(){
      const card = document.getElementById('profileCard');
      card?.setAttribute('data-ready','0');

      const client = window.auth0Client || window.auth;
      if (!client) return;

      const logged = await client.isAuthenticated?.().catch(()=>false);
      if (!logged) {
        await client.loginWithRedirect({ authorizationParams:{ redirect_uri: window.location.href } });
        return;
      }

      let user=null, claims=null;
      try { user = await client.getUser(); } catch(_){}
      try { claims = await client.getIdTokenClaims(); } catch(_){}

      const nameFromCache = localStorage.getItem('athar:displayName');
      const baseName = nameFromCache || user?.name || user?.nickname || 'â€”';
      document.querySelectorAll('.js-user-name,#displayName').forEach(n=> n.textContent = baseName);
      document.getElementById('u-email').textContent = user?.email || 'â€”';
      document.getElementById('u-sub').textContent   = user?.sub   || 'â€”';
      const joined = user?.updated_at || user?.created_at || null;
      document.getElementById('u-joined').textContent = joined ? new Date(joined).toLocaleDateString('ar-SA') : 'â€”';

      const avatarEl = document.getElementById('u-avatar');
      if (user?.picture) avatarEl.src = user.picture;

      const NS_NEW = "https://n-athar.co/";
      const NS_OLD = "https://athar.co/";
      const st = (claims && (claims[NS_NEW + "status"] || claims[NS_OLD + "status"])) || "";
      document.getElementById('u-status').textContent = st || 'â€”';

      const colorBy = {
        active:  {bg:'#dcfce7', fg:'#166534', br:'#bbf7d0', text:'Ù…ÙØ¹Ù„'},
        trial:   {bg:'#dbeafe', fg:'#1e3a8a', br:'#bfdbfe', text:'ØªØ¬Ø±ÙŠØ¨ÙŠ'},
        pending: {bg:'#fef9c3', fg:'#854d0e', br:'#fde68a', text:'Ù…Ø¹Ù„Ù‚'},
        inactive:{bg:'#fee2e2', fg:'#991b1b', br:'#fecaca', text:'ØºÙŠØ± Ù†Ø´Ø·'}
      };
      const badge = document.getElementById('sub-state');
      if (st) {
        const m = colorBy[st] || colorBy.inactive;
        badge.style.display='inline-block';
        badge.textContent=m.text; badge.style.background=m.bg; badge.style.color=m.fg; badge.style.borderColor=m.br;
      }

      // ØªÙØ¶ÙŠÙ„Ø§Øª Ù…Ù† Supabase
      try {
        if (window.supa && user?.sub) {
          const { data: pref } = await window.supa
            .from('user_prefs').select('*').eq('user_sub', user.sub).maybeSingle();

          if (pref?.display_name) {
            document.querySelectorAll('.js-user-name,#displayName').forEach(n=> n.textContent = pref.display_name);
            localStorage.setItem('athar:displayName', pref.display_name);
          }
          if (pref?.avatar_url)   avatarEl.src = pref.avatar_url;
          if (pref?.theme_color)  document.documentElement.style.setProperty('--primary', pref.theme_color);
        }
      } catch(_){}

      // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…
      document.getElementById('editNameBtn').onclick = async () => {
        const cur = document.getElementById('displayName').textContent.trim();
        const newName = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶:", cur || baseName);
        if (!newName || !newName.trim()) return;
        const clean = newName.trim();
        document.querySelectorAll('.js-user-name,#displayName').forEach(n=> n.textContent = clean);
        localStorage.setItem('athar:displayName', clean);
        try {
          if (window.supa && user?.sub) {
            await window.supa.from('user_prefs').upsert(
              { user_sub: user.sub, display_name: clean },
              { onConflict: 'user_sub' }
            );
            toast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… âœ“");
          }
        } catch(e){ console.error(e); toast("ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…"); }
      };

      // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© â€” Ù„Ø§ Ø±ÙØ¹ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‚Øµ
      const avatarInput = document.getElementById('avatarInput');
      avatarInput.onchange = async (ev) => {
        const file = ev.target.files?.[0]; if (!file) return;
        try {
          const blob = await cropper.open(file); // null Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
          if (!blob) { ev.target.value=''; return; }
          const finalFile = new File([blob], 'avatar.jpg', { type:'image/jpeg' });

          if (!window.supa) throw new Error("Supabase ØºÙŠØ± Ù…ØªØ§Ø­");
          const safe = (user?.sub || 'u').replace(/[|]/g,'_');
          const path = `${safe}/${Date.now()}_avatar.jpg`;
          const up = await window.supa.storage.from('avatars').upload(path, finalFile, { upsert:true, contentType:'image/jpeg' });
          if (up.error) throw up.error;
          const { data } = window.supa.storage.from('avatars').getPublicUrl(path);
          const url = data.publicUrl + `?v=${Date.now()}`;
          document.getElementById('u-avatar').src = url;
          await window.supa.from('user_prefs').upsert({ user_sub: user.sub, avatar_url: url }, { onConflict: 'user_sub' });
          toast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© âœ“");
        } catch(e){ console.error(e); toast("ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©"); }
        finally { ev.target.value = ''; } // ØªÙØ±ÙŠØº input Ù„Ù…Ù†Ø¹ Ø±ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø§Ø­Ù‚
      };

      // Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£Ù„ÙˆØ§Ù†
      (function initThemePicker(){
        const root   = document.documentElement;
        const picker = document.getElementById('themePicker');
        if (!picker) return;
        picker.dataset.v2 = '1';

        const swatches = [...picker.querySelectorAll('button')];
        swatches.forEach(b=>{
          if (b.hasAttribute('data-color')) b.style.backgroundColor = b.dataset.color;
          if (b.hasAttribute('data-reset')) b.style.background = '#111827';
        });

        const saved = localStorage.getItem('athar:theme');
        if (saved) {
          root.style.setProperty('--primary', saved);
          (swatches.find(b=>b.dataset.color === saved) || swatches.find(b=>b.hasAttribute('data-reset')))?.classList.add('is-active');
        } else {
          swatches.find(b=>b.hasAttribute('data-reset'))?.classList.add('is-active');
        }

        picker.addEventListener('click', async (e)=>{
          const btn = e.target.closest('button'); if (!btn) return;

          if (btn.hasAttribute('data-reset')) {
            localStorage.removeItem('athar:theme');
            const def = getComputedStyle(root).getPropertyValue('--sea-600').trim() || '#1e40af';
            root.style.setProperty('--primary', def);
            swatches.forEach(b=>b.classList.remove('is-active'));
            btn.classList.add('is-active');
            try { if (window.supa && user?.sub) await window.supa.from('user_prefs').upsert({ user_sub:user.sub, theme_color:null }, { onConflict:'user_sub' }); } catch(_){}
            window.dispatchEvent(new CustomEvent('athar:theme-color', { detail: def }));
            return;
          }

          const color = btn.dataset.color;
          if (!color) return;
          root.style.setProperty('--primary', color);
          localStorage.setItem('athar:theme', color);
          try { if (window.supa && user?.sub) await window.supa.from('user_prefs').upsert({ user_sub:user.sub, theme_color:color }, { onConflict:'user_sub' }); } catch(_){}
          swatches.forEach(b=>b.classList.remove('is-active'));
          btn.classList.add('is-active');
          window.dispatchEvent(new CustomEvent('athar:theme-color', { detail: color }));
        });
      })();

      card?.setAttribute('data-ready','1');
    }

    // Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.id === 'logout') {
        (window.auth0Client || window.auth)?.logout({ logoutParams:{ returnTo: window.location.origin } });
      }
    });

    // Ø´ØºÙ‘Ù„ÙŠ Ø¨Ø¹Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø­Ø§Ø±Ø³
    window.addEventListener('auth0:ready', initProfile);
    if (window.auth0Client || window.auth) initProfile();
  </script>

  <!-- Ø§Ù„Ø­Ø§Ø±Ø³ -->
  <script src="assets/js/require-auth.js"></script>

  <script>
    // ØªØ¹Ø·ÙŠÙ„ Ø£ÙŠ Ù…Ù†Ø·Ù‚ Ù‚Ø¯ÙŠÙ… Ù„Ù„Ø«ÙŠÙ… ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¹Ù†ØµØ±
    (function themeInitLegacyGuard(){
      const picker = document.getElementById('themePicker');
      if (picker && picker.dataset && picker.dataset.v2 === '1') {
        // no-op
      }
    })();
  </script>
</body>
</html>
