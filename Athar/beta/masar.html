<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>مســار — جدولي للترم</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="dark light">

<!-- (اختياري) لتصدير الجدول كصورة PNG — لو ما أردتِه احذفي هذا السطر -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

<style>
  /* تحسينات خفيفة فوق style.css — كلها تستخدم نفس متغيرات الهوية */
  .field{ margin:10px 0 }
  .field label{ display:block; font-weight:700; margin:6px 0 }
  .field input,.field select{
    width:100%; padding:12px; border-radius:12px;
    border:1px solid rgba(59,130,246,.35); background:#fff; color:#0f172a;
  }
  .dark .field input,.dark .field select{
    background:#0f172a; color:#f1f5f9; border-color:#3b82f6;
  }

  .cols-3{ display:grid; gap:12px; grid-template-columns:1fr }
  .cols-2{ display:grid; gap:12px; grid-template-columns:1fr }
  @media(min-width:800px){
    .cols-3{ grid-template-columns:1fr 1fr 1fr }
    .cols-2{ grid-template-columns:1fr 1fr }
  }

  .grid-mini{ display:grid; gap:10px }
  .grid-mini .cell{
    background:var(--card); border:1px solid rgba(59,130,246,.22);
    border-radius:12px; padding:10px;
  }
  .cell .row{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
  .cell h4{ margin:0 0 6px; color:var(--sea-600); font-size:15px }

  .actions-row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
  .actions-row .btn{ min-width:170px }

  /* الجدول الناتج */
  .tt-wrap{
    overflow:auto; border:1px solid rgba(59,130,246,.22);
    border-radius:16px; background:var(--card); box-shadow:var(--shadow);
  }
  table.timetable{
    width:100%; border-collapse:separate; border-spacing:0; min-width:720px;
  }
  .timetable th,.timetable td{
    border-bottom:1px solid rgba(59,130,246,.18);
    border-inline-end:1px solid rgba(59,130,246,.12);
    padding:12px; text-align:center; vertical-align:middle;
  }
  .timetable th{
    position:sticky; top:0; background:linear-gradient(180deg,#ffffffcc,#ffffffaa);
    backdrop-filter:blur(4px); font-weight:800; color:var(--sea-700);
  }
  .dark .timetable th{
    background:linear-gradient(180deg,#0f172acc,#0f172aaa); color:#93c5fd;
  }
  .timetable td .sub{
    display:inline-flex; gap:8px; align-items:center; justify-content:center;
    padding:8px 10px; border-radius:999px; font-weight:800; border:1px solid rgba(0,0,0,.06);
    box-shadow:0 6px 18px rgba(0,0,0,.12);
    white-space:nowrap;
  }
  .timetable td .cls{ display:block; font-size:12px; opacity:.85; margin-top:4px }
  .legend{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }
  .legend .chip{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
    border:1px solid rgba(59,130,246,.22); background:var(--card);
  }
  .legend .dot{ width:12px; height:12px; border-radius:50% }

  .quote{
    margin-top:14px; text-align:center; color:var(--muted); font-weight:700;
    border-top:1px dashed rgba(59,130,246,.25); padding-top:10px
  }

  /* للطباعة: نظرة نظيفة */
  @media print{
    .topbar,.inputs-card,.actions-row,.toast{ display:none !important }
    header{ padding-bottom:0 }
    .tt-wrap{ box-shadow:none; border:none }
    .quote{ border:none; padding-top:0 }
  }
</style>
</head>
<body>
  <!-- الخلفيات -->
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <!-- الشريط العلوي (مطابق لترتيب صفحة الخطط) -->
  <div class="topbar">
    <div class="left-actions">
      <a class="btn" href="index.html" title="الرئيسية">الرئيسية</a>
    </div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="الوضع الداكن/الفاتح">🌓</button>
    </div>
    <div class="user">
      <span id="nav-auth" style="display:none; gap:10px">
        <a class="btn" href="#" onclick="openModal('#modal-register');return false;">تسجيل</a>
        <a class="btn" href="#" onclick="openModal('#modal-login');return false;">دخول</a>
      </span>
      <a id="nav-programs" class="btn" href="programs.html" style="display:inline-flex">برامجنا</a>
      <a id="nav-profile" class="btn" href="profile.html" style="display:none">الملف الشخصي</a>
    </div>
  </div>

  <!-- الهيدر -->
  <header>
    <div class="hero">
      <h1 class="logo">مســار</h1>
      <div class="tag"><span class="dot"></span>رتّبي حصصك… واجعل التخطيط يمشي على مساره.</div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- المدخلات -->
      <section class="card inputs-card inputs-wrap" id="inputsCard">
        <div class="inputs-head">
          <h2 class="title" style="margin:0">مدخلات الجدول</h2>
          <button id="toggleInputs" class="btn ghost" title="طي/إظهار">طيّ</button>
        </div>

        <div class="inputs-body">
          <div class="cols-3">
            <div class="field">
              <label>عدد الحصص اليومية</label>
              <select id="periods">
                <option>5</option><option selected>6</option><option>7</option><option>8</option>
              </select>
            </div>
            <div class="field">
              <label>أيام الأسبوع</label>
              <select id="weekPreset">
                <option value="sun-thu" selected>الأحد–الخميس</option>
                <option value="mon-fri">الإثنين–الجمعة</option>
                <option value="custom">تخصيص…</option>
              </select>
            </div>
            <div class="field" id="daysCustom" style="display:none">
              <label>اختاري الأيام</label>
              <div class="grid-mini" style="grid-template-columns:repeat(5,1fr)">
                <label><input type="checkbox" class="day" value="الأحد" checked> الأحد</label>
                <label><input type="checkbox" class="day" value="الإثنين" checked> الإثنين</label>
                <label><input type="checkbox" class="day" value="الثلاثاء" checked> الثلاثاء</label>
                <label><input type="checkbox" class="day" value="الأربعاء" checked> الأربعاء</label>
                <label><input type="checkbox" class="day" value="الخميس" checked> الخميس</label>
              </div>
            </div>
          </div>

          <div id="inputsGrid" class="grid-mini" style="margin-top:14px"></div>

          <div class="actions-row">
            <button class="btn primary" id="build">ولّدي الجدول ✨</button>
            <button class="btn" id="reset">مسح المدخلات</button>
            <button class="btn" id="reload">استرجاع آخر حفظ</button>
          </div>
        </div>
      </section>

      <!-- الناتج -->
      <section class="card" id="outCard" style="display:none">
        <h2 class="title">جدول مســاري</h2>
        <div class="tt-wrap" id="ttWrap">
          <table class="timetable" id="tt"></table>
        </div>
        <div class="legend" id="legend"></div>

        <div class="actions-row">
          <button class="btn primary" id="printBtn">طباعة</button>
          <button class="btn" id="pngBtn">حفظ كـ PNG</button>
          <button class="btn" id="editBtn">تعديل المدخلات</button>
        </div>

        <div class="quote" id="quote"></div>
      </section>
    </div>
  </main>

  <footer>
    <p class="foot-line">التعليم شرارة صغيرة… تُضيء عقولًا كبيرة.</p>
    <p class="foot-name">ندى المجيرش</p>
  </footer>

  <div class="toast" id="toast"></div>
  <script src="app.js"></script>
  <script>
    // —————— أدوات صغيرة ——————
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    function toast(msg){
      let t = $('.toast'); if(!t){ t=document.createElement('div'); t.className='toast'; document.body.appendChild(t); }
      t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1500);
    }

    // حفظ/استرجاع
    const KEY = 'athar:masar';
    function saveState(obj){ localStorage.setItem(KEY, JSON.stringify(obj)); }
    function loadState(){ try{ return JSON.parse(localStorage.getItem(KEY)||'null'); }catch(_){ return null; } }

    // ألوان ثابتة لكل مادة (هاش بسيط)
    const PALETTE = [
      ['#e0f2fe','#0284c7'], ['#dbeafe','#1d4ed8'], ['#e9d5ff','#7e22ce'],
      ['#fee2e2','#b91c1c'], ['#dcfce7','#166534'], ['#fef9c3','#a16207'],
      ['#ffe4e6','#be123c'], ['#ede9fe','#6d28d9'], ['#fce7f3','#be185d']
    ];
    function colorFor(subject){
      subject = (subject||'').trim();
      let h=0; for(let i=0;i<subject.length;i++) h = (h*31 + subject.charCodeAt(i))>>>0;
      const [bg,fg] = PALETTE[h % PALETTE.length];
      return { bg, fg };
    }

    // عبارات تحفيزية (تُعرض عشوائيًا)
    const QUOTES = [
      'هذا اليوم سيمضي كما مضى الأمس… ولن يبقى منه إلا الأثر. 🌿',
      'رتّب وقتك، تزدك حرّيةً داخل الحصّة.',
      'خطة بسيطة اليوم… أثر عميق غدًا.',
      'النظام ليس تقييدًا… إنما سُلم للوصول إلى أبعد.',
      'كل حصة فرصة لصناعة أثر جديد.'
    ];

    // بناء شبكة المدخلات
    const inputsGrid = $('#inputsGrid');
    const periodsSel = $('#periods');
    const weekPreset = $('#weekPreset');
    const daysCustom = $('#daysCustom');

    function currentDays(){
      if(weekPreset.value === 'mon-fri') return ['الإثنين','الثلاثاء','الأربعاء','الخميس','الجمعة'];
      if(weekPreset.value === 'custom'){
        return $$('.day:checked', daysCustom).map(i=>i.value);
      }
      return ['الأحد','الإثنين','الثلاثاء','الأربعاء','الخميس']; // sun-thu
    }

    function rebuildInputs(){
      const days = currentDays();
      const periods = parseInt(periodsSel.value,10) || 6;
      inputsGrid.innerHTML = '';
      // لكل يوم صندوق، وفيه صفوف بعدد الحصص
      days.forEach(day=>{
        const wrap = document.createElement('div');
        wrap.className = 'cell';
        wrap.innerHTML = '<h4>'+day+'</h4>';
        for(let p=1; p<=periods; p++){
          const row = document.createElement('div');
          row.className='row';
          row.innerHTML = `
            <input type="text" placeholder="المادة (حصة ${p})" data-k="sub" data-day="${day}" data-p="${p}">
            <input type="text" placeholder="الفصل/الشعبة" data-k="cls" data-day="${day}" data-p="${p}">
          `;
          wrap.appendChild(row);
        }
        inputsGrid.appendChild(wrap);
      });
    }

    // عرض/إخفاء أيام مخصّصة
    weekPreset.addEventListener('change', ()=>{
      daysCustom.style.display = (weekPreset.value==='custom') ? '' : 'none';
      rebuildInputs();
    });
    $$('.day').forEach(ch => ch.addEventListener('change', rebuildInputs));
    periodsSel.addEventListener('change', rebuildInputs);

    // مسح/استرجاع
    $('#reset').addEventListener('click', ()=>{
      localStorage.removeItem(KEY);
      rebuildInputs();
      toast('تم مسح المدخلات.');
    });
    $('#reload').addEventListener('click', ()=>{
      const st = loadState();
      if(!st){ toast('لا يوجد حفظ سابق.'); return; }
      // استرجاع الإعدادات
      periodsSel.value = st.periods;
      weekPreset.value = st.preset;
      daysCustom.style.display = (st.preset==='custom') ? '' : 'none';
      $$('.day').forEach(ch => ch.checked = st.days.includes(ch.value));

      rebuildInputs();
      // استرجاع الخلايا
      st.cells.forEach(c=>{
        const inpSub = inputsGrid.querySelector(`input[data-k="sub"][data-day="${c.day}"][data-p="${c.p}"]`);
        const inpCls = inputsGrid.querySelector(`input[data-k="cls"][data-day="${c.day}"][data-p="${c.p}"]`);
        if(inpSub) inpSub.value = c.sub||'';
        if(inpCls) inpCls.value = c.cls||'';
      });
      toast('تم الاسترجاع.');
    });

    // حفظ تلقائي بعد أي إدخال
    inputsGrid.addEventListener('input', debounce(saveInputs, 400));
    function saveInputs(){
      const days = currentDays();
      const periods = parseInt(periodsSel.value,10) || 6;
      const cells = [];
      days.forEach(day=>{
        for(let p=1;p<=periods;p++){
          const sub = inputsGrid.querySelector(`input[data-k="sub"][data-day="${day}"][data-p="${p}"]`)?.value||'';
          const cls = inputsGrid.querySelector(`input[data-k="cls"][data-day="${day}"][data-p="${p}"]`)?.value||'';
          if(sub || cls) cells.push({day,p,sub,cls});
        }
      });
      saveState({ preset:weekPreset.value, days, periods, cells });
    }
    function debounce(fn, ms){
      let t; return function(){ clearTimeout(t); t=setTimeout(fn, ms); }
    }

    // توليد الجدول
    const outCard = $('#outCard');
    const tt = $('#tt'); const legend = $('#legend');

    $('#build').addEventListener('click', ()=>{
      const st = loadState() || {};
      const days = st.days || currentDays();
      const periods = st.periods || parseInt(periodsSel.value,10) || 6;

      // أبسط فحص: لازم يكون في معلومة واحدة على الأقل
      const filled = st.cells && st.cells.some(c=> (c.sub||'').trim());
      if(!filled){ toast('املئي مادة واحدة على الأقل.'); return; }

      // بناء الجدول
      tt.innerHTML = '';
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      trh.innerHTML = '<th>الحصة \\ اليوم</th>' + days.map(d=>`<th>${d}</th>`).join('');
      thead.appendChild(trh); tt.appendChild(thead);

      const tbody = document.createElement('tbody');
      for(let p=1;p<=periods;p++){
        const tr = document.createElement('tr');
        tr.innerHTML = `<th>الحصة ${p}</th>` + days.map(d=>{
          const cell = (st.cells||[]).find(c=> c.day===d && c.p===p) || {sub:'',cls:''};
          if(!cell.sub && !cell.cls) return '<td></td>';
          const {bg,fg} = colorFor(cell.sub);
          return `<td>
            <div class="sub" style="background:${bg}; color:${fg}">${cell.sub||'—'}</div>
            ${cell.cls? `<span class="cls">${cell.cls}</span>`:''}
          </td>`;
        }).join('');
        tbody.appendChild(tr);
      }
      tt.appendChild(tbody);

      // وسيلة إيضاح (لكل مادة لون)
      legend.innerHTML = '';
      const subjects = Array.from(new Set((st.cells||[]).map(c=>(c.sub||'').trim()).filter(Boolean)));
      subjects.slice(0,15).forEach(s=>{
        const {bg,fg} = colorFor(s);
        const chip = document.createElement('div');
        chip.className='chip';
        chip.innerHTML = `<span class="dot" style="background:${bg}"></span><span style="color:${fg}; font-weight:800">${s}</span>`;
        legend.appendChild(chip);
      });

      // اقتباس تحفيزي
      $('#quote').textContent = QUOTES[Math.floor(Math.random()*QUOTES.length)];

      outCard.style.display = '';
      window.scrollTo({ top: outCard.offsetTop - 10, behavior: 'smooth' });
      toast('تم توليد الجدول ✨');
    });

    // حفظ كصورة
    $('#pngBtn').addEventListener('click', async ()=>{
      const wrap = $('#ttWrap');
      if(!window.html2canvas){ toast('مكتبة التحويل للصورة غير محملة.'); return; }
      const canvas = await html2canvas(wrap, { scale:2, useCORS:true, backgroundColor:null });
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a'); a.href = url; a.download = 'masar.png'; a.click();
    });

    // طباعة
    $('#printBtn').addEventListener('click', ()=> window.print());

    // طيّ/إظهار المدخلات
    const inputsCard = $('#inputsCard');
    $('#toggleInputs').addEventListener('click', ()=>{
      inputsCard.classList.toggle('collapsed');
      $('#toggleInputs').textContent = inputsCard.classList.contains('collapsed') ? 'إظهار المدخلات' : 'طيّ';
    });
    $('#editBtn').addEventListener('click', ()=>{
      inputsCard.classList.remove('collapsed');
      window.scrollTo({ top: inputsCard.offsetTop - 10, behavior:'smooth' });
    });

    // تهيئة أولية
    (function init(){
      const st = loadState();
      if(st){
        periodsSel.value = st.periods || '6';
        weekPreset.value = st.preset || 'sun-thu';
        daysCustom.style.display = (weekPreset.value==='custom') ? '' : 'none';
        rebuildInputs();
        if(st.preset==='custom'){
          $$('.day').forEach(ch => ch.checked = st.days.includes(ch.value));
        }
        // تعبئة القيم
        (st.cells||[]).forEach(c=>{
          const inpSub = inputsGrid.querySelector(`input[data-k="sub"][data-day="${c.day}"][data-p="${c.p}"]`);
          const inpCls = inputsGrid.querySelector(`input[data-k="cls"][data-day="${c.day}"][data-p="${c.p}"]`);
          if(inpSub) inpSub.value = c.sub||'';
          if(inpCls) inpCls.value = c.cls||'';
        });
      }else{
        rebuildInputs();
      }
    })();
  </script>
  <script src="app.js"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  bindAutoSave('masar', '#masar-form');
});
</script>
</body>
</html>
