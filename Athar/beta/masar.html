<!-- masar.html â€” ØµÙØ­Ø© "Ù…ÙØ³Ø§Ø±" (Ù†Ø³Ø®Ø© Ù…ÙØ­Ø¯Ù‘Ø«Ø© ÙˆÙƒØ§Ù…Ù„Ø©) -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙØ³Ù€Ù€Ø§Ø± â€” Ø¬Ø¯Ø§ÙˆÙ„ Ø­ØµØµ Ø£Ù†ÙŠÙ‚Ø©</title>
  <meta name="color-scheme" content="dark light" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ================== Ø«ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ ================== */
    :root{
      --table-accent: #3b82f6;   /* Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ */
      --table-mix: 28%;          /* Ø´Ø¯Ù‘Ø© Ø®Ù„ÙÙŠØ© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
      --table-border-mix: 45%;   /* Ø´Ø¯Ù‘Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ */
      /* Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©: Ø£ØºÙ…Ù‚ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
      --table-mix-print: 38%;
      --table-border-mix-print: 60%;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø§Ù…Ø© ÙÙˆÙ‚ style.css */
    .controls .field{ margin:8px 0 }
    .controls .field label{ display:block; font-weight:700; margin:6px 0 }
    .controls .field input, .controls .field select{
      width:100%; padding:10px; border-radius:12px;
      border:1px solid rgba(59,130,246,.35); background:#fff; color:#0f172a;
    }
    .dark .controls .field input, .dark .controls .field select{
      background:#0f172a; color:#f1f5f9; border-color:#3b82f6;
    }
    .grid-4{ display:grid; gap:12px; grid-template-columns:repeat(4,1fr) }
    .grid-3{ display:grid; gap:12px; grid-template-columns:repeat(3,1fr) }
    @media(max-width:900px){ .grid-4{grid-template-columns:1fr 1fr} }
    @media(max-width:640px){ .grid-4,.grid-3{grid-template-columns:1fr} }

    /* ØºÙ„Ø§Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .table-wrap{ position: relative; isolation: isolate; overflow:auto; }

    table.schedule{ width:100%; border-collapse:separate; border-spacing:0; min-width:780px }
    .schedule th, .schedule td{
      border:1px solid color-mix(in oklab, var(--table-accent) var(--table-border-mix), #cbd5e1);
      padding:8px; vertical-align:top; background:var(--card);
    }
    .schedule th{
      background:color-mix(in oklab, var(--table-accent) var(--table-mix), white);
      color:#0c4a6e; position:sticky; top:0; z-index:1;
    }
    .dark .schedule th{
      background:color-mix(in oklab, var(--table-accent) calc(var(--table-mix) + 10%), black);
      color:#c7d2fe;
    }

    .time-col{ width:140px; white-space:nowrap; text-align:center; font-weight:700 }
    .day-col{ width:120px; text-align:center; font-weight:700 }

    .cell{
      min-height:72px; display:flex; flex-direction:column; gap:6px; padding:2px;
      background: color-mix(in oklab, var(--table-accent) 10%, transparent);
      border-radius:8px; transition:background .2s;
    }
    .cell input{
      width:100%; padding:8px 10px; border-radius:10px;
      border:1px solid rgba(59,130,246,.28); background:#fff; color:#0f172a;
    }
    .dark .cell input{ background:#0f172a; color:#f1f5f9; border-color:#3b82f6 }
    .cell .mini{ display:flex; gap:6px }
    .cell .mini input{ flex:1 }

    .row-actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
    .legend{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; font-size:.9rem; color:var(--muted) }
    .legend span{ display:inline-flex; align-items:center; gap:6px; }
    .legend i{ width:10px; height:10px; border-radius:2px; display:inline-block; background:var(--sea-300) }
@media print {
  @page { size: A4 landscape; margin: 8mm; }

  /* Ù†Ø®Ù„ÙŠ Ø¨Ø³ Ø§Ù„Ù‡ÙŠØ¯Ø± + Ø§Ù„Ø¬Ø¯ÙˆÙ„ + Ø§Ù„ÙÙˆØªØ± ÙŠØ¨Ø§Ù†ÙˆØ§ */
  body * { visibility: hidden !important; }
  header, #tableWrap, footer,
  header *, #tableWrap *, footer * {
    visibility: visible !important;
  }

  /* Ø®Ù„ÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø£Ù‚Ø±Ø¨ Ù„Ù„Ø£Ø¹Ù„Ù‰ */
  header { margin-top: -45mm !important; } /* <-- Ø¹Ø¯Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ */

  /* Ù‚Ø±Ø¨ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± */
  #tableWrap { margin-top: 1300 !important; }

  /* Ù‚Ø±Ø¨ Ø§Ù„ÙÙˆØªØ± Ø´ÙˆÙŠ ØªØ­Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
  footer { margin-top: 9 mm !important; }

  /* Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙƒØ§Ù…Ù„ Ø§Ù„ØµÙØ­Ø© */
  #tableWrap, table.schedule { width: 100% !important; min-width: auto !important; }

  body, .schedule, .schedule th, .schedule td, .cell {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    color-adjust: exact;
  }
}
  </style>
</head>
<body>
  <!-- Ø®Ù„ÙÙŠØ© Ø¹Ø§Ù…Ø© Ù…Ù† Ø«ÙŠÙ… Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div class="topbar">
    <div class="left-actions">
      <a class="btn" href="index.html" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a class="btn" href="programs.html" title="Ù…Ø³Ø§Ø­Ø© Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ">Ù…Ø³Ø§Ø­Ø© Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ</a>
    </div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†/Ø§Ù„ÙØ§ØªØ­">ğŸŒ“</button>
    </div>
    <div class="user">
      <span id="nav-auth" style="display:none; gap:10px"></span>
      <a id="nav-profile" class="btn" href="profile.html" style="display:none">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a>
    </div>
  </div>

  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± (Ù‡Ø°Ø§ Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
  <header>
    <div class="hero">
      <h1 class="logo">Ù…ÙØ³Ù€Ù€Ø§Ø±</h1>
      <div class="tag"><span class="dot"></span> Ø¨ØªØ±ØªÙŠØ¨ Ø§Ù„Ø®Ø·Ù‰ ØªÙÙ€Ù€Ù€Ø¯Ø±ÙÙƒÙ Ø§Ù„Ø£Ù‡Ù€Ù€Ø¯Ø§Ù .</div>
    </div>
  </header>

  <main class="container">
    <!-- Ø§Ù„Ø¶ÙˆØ§Ø¨Ø· -->
    <section class="card controls">
      <h2 class="title" style="margin-top:0">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„</h2>

      <div class="grid-4">
        <div class="field">
          <label>Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</label>
          <select id="days">
            <option value="sun-thu" selected>Ø§Ù„Ø£Ø­Ø¯ â†’ Ø§Ù„Ø®Ù…ÙŠØ³ (5 Ø£ÙŠØ§Ù…)</option>
            <option value="sun-wed">Ø§Ù„Ø£Ø­Ø¯ â†’ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ (4 Ø£ÙŠØ§Ù…)</option>
          </select>
        </div>
        <div class="field">
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ/Ø§Ù„ÙŠÙˆÙ…</label>
          <select id="periods"><option>5</option><option>6</option><option selected>7</option><option>8</option></select>
        </div>
        <div class="field">
          <label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…</label>
          <input id="startTime" type="time" value="07:00">
        </div>
        <div class="field">
          <label>Ù…Ø¯Ø© Ø§Ù„Ø­ØµØ© (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
          <select id="slotMins"><option>35</option><option>45</option><option selected>50</option><option>55</option><option>60</option></select>
        </div>
      </div>

      <div class="grid-3" style="margin-top:8px">
        <div class="field">
          <label>Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¬Ø¯ÙˆÙ„</label>
          <select id="orient">
            <option value="periods-rows" selected>Ø§Ù„Ø£ÙˆÙ‚Ø§Øª = ØµÙÙˆÙ</option>
            <option value="periods-cols">Ø§Ù„Ø£ÙˆÙ‚Ø§Øª = Ø£Ø¹Ù…Ø¯Ø©</option>
          </select>
        </div>
        <div class="field">
          <label>Ù„ÙˆÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„</label>
          <input id="tblColor" type="color" value="#3b82f6">
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="btn" id="printCompact">Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¶ØºÙ‘Ø·Ø©</button>
        </div>
      </div>

      <div class="grid-3" style="margin-top:8px">
        <div class="field">
          <label>Ø´Ø¯Ù‘Ø© Ø§Ù„Ù„ÙˆÙ†</label>
          <input id="tblIntensity" type="range" min="10" max="60" step="1" value="28">
        </div>
        <div class="field">
          <label>Ø´Ø¯Ù‘Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯</label>
          <input id="tblBorderIntensity" type="range" min="20" max="80" step="1" value="45">
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <span class="muted">ØªØ¤Ø«Ø± ÙÙˆØ±Ù‹Ø§ ÙˆØªÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</span>
        </div>
      </div>

      <div class="row-actions">
        <button class="btn" id="addRow">+ Ø­ØµØ© Ø¥Ø¶Ø§ÙÙŠØ©</button>
        <button class="btn" id="addCol">+ ÙŠÙˆÙ… Ø¥Ø¶Ø§ÙÙŠ (4â†’5)</button>
        <button class="btn" id="clearAll">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="btn" id="toggleColors">ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯</button>
        <button class="btn" id="exportCsv">ØªØµØ¯ÙŠØ± CSV</button>
        <button class="btn" id="savePng">Ø­ÙØ¸ ÙƒØµÙˆØ±Ø© PNG</button>
        <button class="btn" id="print">Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>

      <div class="legend">
        <span><i></i> Ø§Ù„Ø®Ø§Ù†Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ø±ÙŠØ±: <strong>Ø§Ù„Ù…Ø§Ø¯Ø©</strong>ØŒ <strong>Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„</strong>ØŒ <strong>Ø§Ù„Ø´Ø¹Ø¨Ø©</strong></span>
        <span><i style="background:#86efac"></i> Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
        <span><i style="background:#fde68a"></i> Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¯ ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</span>
      </div>
    </section>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù‡Ø°Ø§ Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
    <section class="card">
      <div class="table-wrap" id="tableWrap">
        <table class="schedule" id="tbl"></table>
      </div>
    </section>
  </main>

  <!-- Ø§Ù„ÙÙˆØªØ± (Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
  <footer>
    <p class="foot-line">Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø´Ø±Ø§Ø±Ø© ØµØºÙŠØ±Ø©â€¦ ØªÙØ¶ÙŠØ¡ Ø¹Ù‚ÙˆÙ„Ù‹Ø§ ÙƒØ¨ÙŠØ±Ø©.</p>
    <p class="foot-name">Ù†Ø¯Ù‰ Ø§Ù„Ù…Ø¬ÙŠØ±Ø´</p>
  </footer>

  <div class="toast" id="toast"></div>

  <!-- ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª Ù…Ù‡Ù… -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>
  <script defer src="assets/js/require-auth.js"></script>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/supabase-client.js"></script>
  <script defer src="assets/js/storage.js"></script>
  <script defer src="app.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØµÙØ­Ø© -->
  <script>
  (function(){
    const $ = (sel)=>document.querySelector(sel);

    /* Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
    const tbl         = $('#tbl');
    const daysSel     = $('#days');
    const periodsSel  = $('#periods');
    const startTime   = $('#startTime');
    const slotMinsSel = $('#slotMins');
    const orientSel   = $('#orient');
    const colorInp    = document.getElementById('tblColor');
    const mixInp      = document.getElementById('tblIntensity');
    const borderInp   = document.getElementById('tblBorderIntensity');
    const tableWrap   = $('#tableWrap');

    const DB_KEY = 'masar';
    const DEFAULT_DAYS = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];

    /* ===== Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù… ===== */
    function loadColorMap(){ const all = userDB.get(DB_KEY, {}); return all.__colors || {}; }
    function saveColorMap(map){ const all = userDB.get(DB_KEY, {}); all.__colors = map || {}; userDB.set(DB_KEY, all); }
    function hashColor(name){ let h=0; for(let i=0;i<name.length;i++) h=(h*31 + name.charCodeAt(i))%360; return `hsl(${h} 70% 88%)`; }
    function getColorForSubject(subj){
      if(!subj) return '';
      const map = loadColorMap();
      if(!map[subj]){ map[subj] = hashColor(subj); saveColorMap(map); }
      return map[subj];
    }
    function colorizeCells(){
      const map = loadColorMap();
      tbl.querySelectorAll('td .cell').forEach(cell=>{
        const subj = cell.querySelector('input[name^="subj_"]')?.value.trim();
        cell.style.background = (window.__colorsOn && subj) ? (map[subj] || getColorForSubject(subj)) : '';
      });
    }

    /* ===== ÙˆÙ‚Øª ===== */
    function timeToMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
    function minutesToTime(m){ const h=Math.floor(m/60), mm=String(m%60).padStart(2,'0'); return String(h).padStart(2,'0')+':'+mm; }
    function buildTimes(start, slot, count){
      const out=[]; let m=timeToMinutes(start);
      for(let i=0;i<count;i++){ const from=minutesToTime(m); m+=slot; const to=minutesToTime(m); out.push(`${from}â€”${to}`); }
      return out;
    }

    /* ===== Ø£ÙŠØ§Ù… ===== */
    function readDays(){ return (daysSel.value==='sun-wed') ? DEFAULT_DAYS.slice(0,4) : DEFAULT_DAYS.slice(); }

    /* ===== ØªØ®Ø²ÙŠÙ† ===== */
    const getSaved   = () => userDB.get(DB_KEY, {});
    const setSaved   = (obj) => userDB.set(DB_KEY, obj || {});
    const mergeSaved = (partial) => userDB.merge(DB_KEY, partial || {});

    /* ===== Ø®Ù„ÙŠØ© ===== */
    function makeCell(r,c, saved){
      const key = `r${r}c${c}`;
      const cellData = saved[key] || { subj:'', class:'', room:'' };

      const td   = document.createElement('td');
      const wrap = document.createElement('div'); wrap.className = 'cell';

      const s = document.createElement('input');
      s.placeholder = 'Ø§Ù„Ù…Ø§Ø¯Ø©'; s.value = cellData.subj || '';
      s.name = `subj_r${r}_c${c}`; s.id = s.name;

      const mini = document.createElement('div'); mini.className='mini';

      const cls = document.createElement('input');
      cls.placeholder = 'Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„'; cls.value = cellData.class || '';
      cls.name = `class_r${r}_c${c}`; cls.id = cls.name;

      const room = document.createElement('input');
      room.placeholder = 'Ø§Ù„Ø´Ø¹Ø¨Ø©'; room.value = cellData.room || '';
      room.name = `room_r${r}_c${c}`; room.id = room.name;

      mini.appendChild(cls); mini.appendChild(room);
      wrap.appendChild(s); wrap.appendChild(mini);
      td.appendChild(wrap);

      function persist(ev){
        const cur = getSaved();
        cur[key] = { subj:s.value, class:cls.value, room:room.value };
        setSaved(cur);
        wrap.classList.toggle('empty', !(s.value||cls.value||room.value));
        if(ev?.target === s) colorizeCells();
      }
      [s,cls,room].forEach(el=> el.addEventListener('input', persist));
      wrap.classList.toggle('empty', !(s.value||cls.value||room.value));

      return td;
    }

    /* ===== Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ===== */
    function buildTable(){
      const days    = readDays();
      const periods = parseInt(periodsSel?.value, 10) || 7;
      const startAt = (startTime?.value) || '07:00';
      const slotMin = parseInt(slotMinsSel?.value, 10) || 50;
      const times   = buildTimes(startAt, slotMin, periods);
      const saved   = getSaved();
      const orient  = (orientSel?.value) || 'periods-rows'; // periods-rows | periods-cols

      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      if (orient === 'periods-rows'){
        const hr = document.createElement('tr');
        const th0 = document.createElement('th'); th0.className='time-col'; th0.textContent='Ø§Ù„ÙˆÙ‚Øª \\ Ø§Ù„ÙŠÙˆÙ…';
        hr.appendChild(th0);
        days.forEach(d => { const th = document.createElement('th'); th.className='day-col'; th.textContent=d; hr.appendChild(th); });
        thead.appendChild(hr);

        for(let r=0;r<periods;r++){
          const tr = document.createElement('tr');
          const tdTime = document.createElement('td'); tdTime.className='time-col'; tdTime.textContent = times[r] || '';
          tr.appendChild(tdTime);
          for(let c=0;c<days.length;c++){ tr.appendChild(makeCell(r,c,saved)); }
          tbody.appendChild(tr);
        }
      } else {
        const hr = document.createElement('tr');
        const th0 = document.createElement('th'); th0.className='day-col'; th0.textContent='Ø§Ù„ÙŠÙˆÙ… \\ Ø§Ù„ÙˆÙ‚Øª';
        hr.appendChild(th0);
        times.forEach(t => { const th = document.createElement('th'); th.className='time-col'; th.textContent=t; hr.appendChild(th); });
        thead.appendChild(hr);

        for(let c=0;c<days.length;c++){
          const tr = document.createElement('tr');
          const tdDay = document.createElement('td'); tdDay.className='day-col'; tdDay.textContent = days[c] || '';
          tr.appendChild(tdDay);
          for(let r=0;r<periods;r++){ tr.appendChild(makeCell(r,c,saved)); }
          tbody.appendChild(tr);
        }
      }

      tbl.innerHTML=''; tbl.appendChild(thead); tbl.appendChild(tbody);

      colorizeCells();

      mergeSaved({
        __meta:{
          days, periods, startAt, slotMin,
          orient, colorsOn: !!window.__colorsOn
        }
      });
    }

    /* ===== CSV ===== */
    function tableToCsv(){
      const saved = getSaved();
      const m  = saved.__meta || {};
      const days = m.days || readDays();
      const periods = m.periods || parseInt(periodsSel.value,10) || 7;
      const times = buildTimes(m.startAt||startTime.value||'07:00', m.slotMin||parseInt(slotMinsSel.value,10)||50, periods);

      const rows=[['Ø§Ù„ÙŠÙˆÙ…','Ø§Ù„Ø²Ù…Ù†','Ø§Ù„Ù…Ø§Ø¯Ø©','Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„','Ø§Ù„Ø´Ø¹Ø¨Ø©']];
      for(let r=0;r<periods;r++){
        for(let c=0;c<days.length;c++){
          const key=`r${r}c${c}`; const cell=saved[key]||{};
          rows.push([days[c]||'', times[r]||'', cell.subj||'', cell.class||'', cell.room||'']);
        }
      }
      const bom='\uFEFF';
      const csv=rows.map(r=>r.map(x=>`"${String(x||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
      return bom+csv;
    }
    function downloadCsv(){
      const blob=new Blob([tableToCsv()],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); const stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href=url; a.download=`masar-schedule-${stamp}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /* ===== PNG ===== */
    async function saveTableAsPng(){
      try{
        const canvas=await html2canvas(tableWrap,{ backgroundColor:getComputedStyle(document.body).getPropertyValue('--bg')||null, scale:window.devicePixelRatio||2, useCORS:true });
        const a=document.createElement('a'); const stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.href=canvas.toDataURL('image/png'); a.download=`masar-schedule-${stamp}.png`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      }catch(e){ console.error(e); if(window.toast) toast('ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©.'); }
    }

    /* ===== Ø«ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù„ÙˆÙ†/Ø´Ø¯Ø©) ===== */
    function applyThemeFromControls(){
      if(colorInp)  document.documentElement.style.setProperty('--table-accent', colorInp.value);
      if(mixInp)    document.documentElement.style.setProperty('--table-mix', mixInp.value + '%');
      if(borderInp) document.documentElement.style.setProperty('--table-border-mix', borderInp.value + '%');
    }
    function saveTheme(){
      mergeSaved({ __theme:{
        accent: colorInp?.value || '#3b82f6',
        mix:    mixInp?.value   || '28',
        borderMix: borderInp?.value || '45'
      }});
    }
    function loadTheme(){
      const th = (getSaved().__theme) || {};
      if(th.accent && colorInp)  colorInp.value = th.accent;
      if(th.mix && mixInp)       mixInp.value = th.mix;
      if(th.borderMix && borderInp) borderInp.value = th.borderMix;
      applyThemeFromControls();
    }

    /* ===== Ø£Ø²Ø±Ø§Ø± ÙˆØ£Ø­Ø¯Ø§Ø« ===== */
    $('#addRow').addEventListener('click', ()=>{ periodsSel.value = String((parseInt(periodsSel.value,10)||7)+1); buildTable(); });
    $('#addCol').addEventListener('click', ()=>{ daysSel.value='sun-thu'; buildTable(); });

    $('#clearAll').addEventListener('click', ()=>{
      if(!confirm('Ù…Ø³Ø­ ÙƒÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ØŸ')) return;
      const saved=getSaved(); Object.keys(saved).forEach(k=>{ if(/^r\d+c\d+$/.test(k)) delete saved[k]; });
      setSaved(saved); buildTable(); if(window.toast) toast('ØªÙ… Ø§Ù„Ù…Ø³Ø­ âœ“');
    });

    $('#print').addEventListener('click', ()=>printArea(false));
    $('#printCompact').addEventListener('click', ()=>printArea(true));
    $('#exportCsv').addEventListener('click', downloadCsv);
    $('#savePng').addEventListener('click', saveTableAsPng);

    $('#toggleColors').addEventListener('click', ()=>{
      window.__colorsOn = !window.__colorsOn;
      $('#toggleColors').textContent = window.__colorsOn ? 'Ø¥ÙŠÙ‚Ø§Ù ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯' : 'ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯';
      const saved=getSaved(); saved.__meta=saved.__meta||{}; saved.__meta.colorsOn=!!window.__colorsOn; setSaved(saved);
      colorizeCells();
    });

    orientSel?.addEventListener('change', buildTable);

    /* ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø«ÙŠÙ… ØªØ­ÙØ¸ ÙÙˆØ±Ù‹Ø§ */
    [colorInp, mixInp, borderInp].forEach(el=>{
      if(!el) return;
      el.addEventListener('input', ()=>{ applyThemeFromControls(); saveTheme(); });
    });

    /* Ø·Ø¨Ø§Ø¹Ø© (Ø¹Ø§Ø¯ÙŠ / Ù…Ø¶ØºÙˆØ·) */
    function printArea(compact = false) {
      document.body.classList.toggle('print-compact', compact);
      window.print();
      window.addEventListener('afterprint', () => {
        document.body.classList.remove('print-compact');
      }, { once: true });
    }

    /* ØªÙ‡ÙŠØ¦Ø© */
    document.addEventListener('DOMContentLoaded', ()=>{
      loadTheme();

      const saved = getSaved(); const m = saved.__meta || {};
      periodsSel && (periodsSel.value  = String(m.periods || 7));
      startTime  && (startTime.value   = m.startAt || '07:00');
      slotMinsSel&& (slotMinsSel.value = String(m.slotMin || 50));
      orientSel  && (orientSel.value   = m.orient || 'periods-rows');
      daysSel    && (daysSel.value     = (Array.isArray(m.days) && m.days.length===4) ? 'sun-wed' : 'sun-thu');

      window.__colorsOn = (m.colorsOn!==undefined) ? !!m.colorsOn : true;
      $('#toggleColors').textContent = window.__colorsOn ? 'ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ (Ù…ÙØ¹Ù‘Ù„)' : 'ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯';

      buildTable();
    });
  })();
    </script>
  
    <script>
(function(){
  const box = document.getElementById('toast');
  // Ø³ØªØ§ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ùˆ Ù…Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯
  if (box && !box.style.position){
    box.style.position = 'fixed';
    box.style.bottom = '16px';
    box.style.insetInline = '0';
    box.style.margin = '0 auto';
    box.style.maxWidth = '320px';
    box.style.padding = '10px 14px';
    box.style.borderRadius = '10px';
    box.style.background = 'rgba(17,25,40,.9)';
    box.style.color = '#fff';
    box.style.fontWeight = '700';
    box.style.textAlign = 'center';
    box.style.zIndex = '9999';
    box.style.boxShadow = '0 8px 24px rgba(0,0,0,.25)';
    box.style.display = 'none';
  }

  window.toast = function(msg, ms=1800){
    if(!box){ alert(msg); return; } // Ø§Ø­ØªÙŠØ§Ø·
    box.textContent = msg || '';
    box.style.display = 'block';
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>{ box.style.display='none'; }, ms);
  };
})();

  </script>
</body>
</html>
