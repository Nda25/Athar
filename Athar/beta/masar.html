<!-- masar.html â€” ØµÙØ­Ø© "Ù…Ø³Ø§Ø±" Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙØ³Ù€Ù€Ø§Ø± â€” Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø­ØµØµ</title>
  <meta name="color-scheme" content="dark light" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø®ÙÙŠÙØ© ÙÙˆÙ‚ style.css */
    .controls .field{ margin:8px 0 }
    .controls .field label{ display:block; font-weight:700; margin:6px 0 }
    .controls .field input, .controls .field select{
      width:100%; padding:10px; border-radius:12px;
      border:1px solid rgba(59,130,246,.35); background:#fff; color:#0f172a;
    }
    .dark .controls .field input, .dark .controls .field select{
      background:#0f172a; color:#f1f5f9; border-color:#3b82f6;
    }
    .grid-4{ display:grid; gap:12px; grid-template-columns:repeat(4,1fr) }
    .grid-3{ display:grid; gap:12px; grid-template-columns:repeat(3,1fr) }
    .grid-2{ display:grid; gap:12px; grid-template-columns:repeat(2,1fr) }
    @media(max-width:900px){ .grid-4{grid-template-columns:1fr 1fr} }
    @media(max-width:640px){ .grid-4,.grid-3,.grid-2{grid-template-columns:1fr} }

    .table-wrap{ overflow:auto; }
    table.schedule{ width:100%; border-collapse:separate; border-spacing:0; min-width:720px }
    .schedule th,.schedule td{
      border:1px solid rgba(59,130,246,.25); padding:8px; vertical-align:top; background:var(--card);
    }
    .schedule th{ background:var(--sea-50); color:#0c4a6e; position:sticky; top:0; z-index:1 }
    .dark .schedule th{ background:#0b1220; color:#c7d2fe }
    .time-col{ width:120px; white-space:nowrap; text-align:center; font-weight:700 }
    .day-col{ width:110px; text-align:center; font-weight:700 }
    .cell{ min-height:62px; display:flex; flex-direction:column; gap:6px }
    .cell input{ width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(59,130,246,.3); background:#fff; color:#0f172a }
    .dark .cell input{ background:#0f172a; color:#f1f5f9; border-color:#3b82f6 }
    .cell .mini{ display:flex; gap:6px }
    .cell .mini input{ flex:1 }

    .row-actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
    .legend{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; font-size:.9rem; color:var(--muted) }
    .legend span{ display:inline-flex; align-items:center; gap:6px; }
    .legend i{ width:10px; height:10px; border-radius:2px; display:inline-block; background:var(--sea-300) }

    @media print{
      .topbar,.controls,.row-actions,.toast{ display:none !important }
      .card{ box-shadow:none; border:none }
      body{ background:#fff }
    }
  </style>
</head>
<body>
  <!-- Ø®Ù„ÙÙŠØ© -->
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div class="topbar">
    <div class="left-actions">
      <a class="btn" href="index.html" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a class="btn" href="programs.html" title="Ù…Ø³Ø§Ø­Ø© Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ">Ù…Ø³Ø§Ø­Ø© Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ</a>
    </div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†/Ø§Ù„ÙØ§ØªØ­">ğŸŒ“</button>
    </div>
    <div class="user">
      <span id="nav-auth" style="display:none; gap:10px"></span>
      <a id="nav-profile" class="btn" href="profile.html" style="display:none">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a>
    </div>
  </div>

  <!-- Ù‡ÙŠØ¯Ø± -->
  <header>
    <div class="hero">
      <h1 class="logo">Ù…ÙØ³Ù€Ù€Ø§Ø±</h1>
      <div class="tag"><span class="dot"></span>Ø¬Ø¯Ø§ÙˆÙ„ Ø­ØµØµ Ù…Ø±Ù†Ø© â€” Ø£Ù†ÙŠÙ‚Ø© â€” Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.</div>
    </div>
  </header>

  <main class="container">

    <!-- Ø§Ù„Ø¶ÙˆØ§Ø¨Ø· -->
    <section class="card controls">
      <h2 class="title" style="margin-top:0">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„</h2>
      <div class="grid-4">
        <div class="field">
          <label>Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</label>
          <select id="days">
            <option value="sun-thu" selected>Ø§Ù„Ø£Ø­Ø¯ â†’ Ø§Ù„Ø®Ù…ÙŠØ³ (5 Ø£ÙŠØ§Ù…)</option>
            <option value="sun-wed">Ø§Ù„Ø£Ø­Ø¯ â†’ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ (4 Ø£ÙŠØ§Ù…)</option>
            <option value="custom">Ù…Ø®ØµÙ‘Øµâ€¦</option>
          </select>
        </div>
        <div class="field">
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ/Ø§Ù„ÙŠÙˆÙ…</label>
          <select id="periods">
            <option>5</option><option selected>6</option><option>7</option><option>8</option>
          </select>
        </div>
        <div class="field">
          <label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…</label>
          <input id="startTime" type="time" value="07:00">
        </div>
        <div class="field">
          <label>Ù…Ø¯Ø© Ø§Ù„Ø­ØµØ© (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
          <select id="slotMins"><option>35</option><option selected>45</option><option>50</option><option>55</option><option>60</option></select>
        </div>
      </div>

      <div id="customDaysWrap" class="grid-2" style="display:none; margin-top:8px">
        <div class="field">
          <label>Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙŠØ§Ù… (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)</label>
          <input id="customDays" placeholder="Ø§Ù„Ø£Ø­Ø¯, Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†, Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡, Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡, Ø§Ù„Ø®Ù…ÙŠØ³">
        </div>
        <div class="field">
          <label>Ø¥Ø¶Ø§ÙØ© ÙÙˆØ§ØµÙ„/ÙØ±Ø§ØºØ§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="breakAfter" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø¹Ø¯ Ø§Ù„Ø­ØµØ© 2,5">
        </div>
      </div>

      <div class="row-actions">
        <button class="btn" id="rebuild">Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
        <button class="btn" id="addRow">+ Ø­ØµØ© Ø¥Ø¶Ø§ÙÙŠØ©</button>
        <button class="btn" id="addCol">+ ÙŠÙˆÙ… Ø¥Ø¶Ø§ÙÙŠ</button>
        <button class="btn" id="clearAll">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>

        <!-- Ø¬Ø¯ÙŠØ¯ -->
        <button class="btn" id="toggleColors">ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯</button>
        <button class="btn" id="exportCsv">ØªØµØ¯ÙŠØ± CSV</button>
        <button class="btn" id="savePng">Ø­ÙØ¸ ÙƒØµÙˆØ±Ø© PNG</button>

        <button class="btn" id="print">Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>

      <div class="legend">
        <span><i></i> Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ø±ÙŠØ±: Ø§Ù„Ù…Ø§Ø¯Ø©ØŒ Ø§Ù„Ù…Ø¹Ù„Ù…/Ù€Ø©ØŒ Ø§Ù„Ù‚Ø§Ø¹Ø©</span>
        <span><i style="background:#86efac"></i> ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…</span>
        <span><i style="background:#fde68a"></i> Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¯ ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</span>
      </div>
    </section>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <section class="card">
      <div class="table-wrap" id="tableWrap">
        <table class="schedule" id="tbl">
          <!-- ÙŠÙØ¨Ù†Ù‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ -->
        </table>
      </div>
    </section>

  </main>

  <footer>
    <p class="foot-line">Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø´Ø±Ø§Ø±Ø© ØµØºÙŠØ±Ø©â€¦ ØªÙØ¶ÙŠØ¡ Ø¹Ù‚ÙˆÙ„Ù‹Ø§ ÙƒØ¨ÙŠØ±Ø©.</p>
    <p class="foot-name">Ù†Ø¯Ù‰ Ø§Ù„Ù…Ø¬ÙŠØ±Ø´</p>
  </footer>

  <div class="toast" id="toast"></div>

  <!-- Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ù‡Ù…) -->
  <script defer src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/supabase-client.js"></script>
  <script defer src="assets/js/require-auth.js"></script>
  <script defer src="app.js"></script>
  <!-- Ø­ÙØ¸ ÙƒØµÙˆØ±Ø© -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    // Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù…Ù† app.js: $, userDB, toast(), Ø¥Ù„Ø®.
    const tbl = document.getElementById('tbl');
    const daysSel = $('#days');
    const periodsSel = $('#periods');
    const startTimeInp = $('#startTime');
    const slotMinsSel = $('#slotMins');
    const customWrap = $('#customDaysWrap');
    const customDaysInp = $('#customDays');
    const breakAfterInp = $('#breakAfter');
    const tableWrap = document.getElementById('tableWrap');

    // Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ†
    const DB_KEY = 'masar';

    // Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    const DEFAULT_DAYS = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];

    /* ================== Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¯ (ÙŠØ­ÙØ¸ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…) ================== */
    function loadColorMap(){
      const all = userDB.get(DB_KEY, {});
      return all.__colors || {};
    }
    function saveColorMap(map){
      const all = userDB.get(DB_KEY, {});
      all.__colors = map || {};
      userDB.set(DB_KEY, all);
    }
    function hashColor(name){
      // HSL Ù„Ø·ÙŠÙ Ù…Ù† Ù†Øµ Ø§Ù„Ù…Ø§Ø¯Ø© (Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© ØªÙ‚Ø±Ø£ ÙƒÙˆÙŠØ³ ÙÙŠ Ø§Ù„Ø«ÙŠÙ…ÙŠÙ†)
      let h=0; for (let i=0;i<name.length;i++) h = (h*31 + name.charCodeAt(i)) % 360;
      const s = 70, l = 88;
      return `hsl(${h} ${s}% ${l}%)`;
    }
    function getColorForSubject(subj){
      if(!subj) return '';
      const map = loadColorMap();
      if(!map[subj]){ map[subj] = hashColor(subj); saveColorMap(map); }
      return map[subj];
    }
    function colorizeCells(){
      const map = loadColorMap();
      document.querySelectorAll('#tbl tbody tr td .cell').forEach(cell=>{
        const subj = cell.querySelector('input[placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©"]')?.value.trim();
        cell.style.background = (window.__colorsOn && subj) ? (map[subj] || getColorForSubject(subj)) : '';
      });
    }

    /* ================== Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙˆÙ‚Øª ================== */
    function timeToMinutes(t){
      const [h,m] = t.split(':').map(Number);
      return h*60+m;
    }
    function minutesToTime(m){
      const h = Math.floor(m/60), mm = (m%60+'').padStart(2,'0');
      return (h+'').padStart(2,'0')+':'+mm;
    }

    function readDays(){
      if(daysSel.value === 'sun-thu') return DEFAULT_DAYS.slice();
      if(daysSel.value === 'sun-wed') return DEFAULT_DAYS.slice(0,4);
      // custom
      const raw = (customDaysInp.value||'').split(',').map(s=>s.trim()).filter(Boolean);
      return raw.length ? raw : DEFAULT_DAYS.slice();
    }

    function readBreaks(){
      // Ù…Ø«Ø§Ù„: "2,5" â†’ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ØµØ© 2 Ùˆ 5
      const raw = (breakAfterInp.value||'').split(',').map(v=>parseInt(v.trim(),10)).filter(n=>!isNaN(n));
      return new Set(raw);
    }

    function buildTimes(start, slot, count){
      const out = [];
      let m = timeToMinutes(start);
      for(let i=0;i<count;i++){
        const from = minutesToTime(m);
        m += slot;
        const to = minutesToTime(m);
        out.push(from+'â€”'+to);
      }
      return out;
    }

    /* ================== Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ================== */
    function buildTable(){
      const days = readDays();
      const periods = parseInt(periodsSel.value,10)||6;
      const startAt = startTimeInp.value || '07:00';
      const slotMins = parseInt(slotMinsSel.value,10)||45;
      const breaks = readBreaks();

      // Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù†ÙØ³ Ø§Ù„Ù‡ÙŠÙƒÙ„ (Ø¨Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù…/Ø­ØµØµ)
      const saved = userDB.get(DB_KEY, {});
      const times = buildTimes(startAt, slotMins, periods);

      // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø£Ø³
      const thead = document.createElement('thead');
      const hr = document.createElement('tr');
      const th0 = document.createElement('th');
      th0.className='time-col';
      th0.textContent = 'Ø§Ù„ÙˆÙ‚Øª \\ Ø§Ù„ÙŠÙˆÙ…';
      hr.appendChild(th0);
      days.forEach(d=>{
        const th = document.createElement('th');
        th.className='day-col';
        th.textContent=d;
        hr.appendChild(th);
      });
      thead.appendChild(hr);

      // Ø§Ù„Ø¬Ø³Ù…
      const tbody = document.createElement('tbody');
      for(let r=0;r<periods;r++){
        const tr = document.createElement('tr');

        const tdTime = document.createElement('td');
        tdTime.className='time-col';
        tdTime.textContent = times[r] || '';
        tr.appendChild(tdTime);

        for(let c=0;c<days.length;c++){
          const key = `r${r}c${c}`;
          const cellData = saved[key] || { subj:'', teacher:'', room:'' };

          const td = document.createElement('td');
          const wrap = document.createElement('div');
          wrap.className='cell';

          const inpSubj = document.createElement('input');
          inpSubj.placeholder='Ø§Ù„Ù…Ø§Ø¯Ø©';
          inpSubj.value = cellData.subj||'';

          const mini = document.createElement('div');
          mini.className='mini';

          const inpTeacher = document.createElement('input');
          inpTeacher.placeholder='Ø§Ù„Ù…Ø¹Ù„Ù…/Ù€Ø©';
          inpTeacher.value = cellData.teacher||'';

          const inpRoom = document.createElement('input');
          inpRoom.placeholder='Ø§Ù„Ù‚Ø§Ø¹Ø©';
          inpRoom.value = cellData.room||'';

          mini.appendChild(inpTeacher);
          mini.appendChild(inpRoom);

          wrap.appendChild(inpSubj);
          wrap.appendChild(mini);
          td.appendChild(wrap);
          tr.appendChild(td);

          // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ + ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆÙ† Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø§Ø¯Ø©
          [inpSubj, inpTeacher, inpRoom].forEach(el=>{
            el.addEventListener('input', ()=>{
              const cur = userDB.get(DB_KEY, {});
              cur[key] = {
                subj: inpSubj.value,
                teacher: inpTeacher.value,
                room: inpRoom.value
              };
              userDB.set(DB_KEY, cur);
              if(el === inpSubj) colorizeCells();
            });
          });
        }

        tbody.appendChild(tr);

        // ØµÙ ÙØ§ØµÙ„ (Ø§Ø³ØªØ±Ø§Ø­Ø©) Ø¥Ù† ÙƒØ§Ù† Ù…Ø­Ø¯Ø¯
        if (breaks.has(r+1)){
          const br = document.createElement('tr');
          const bt = document.createElement('td');
          bt.colSpan = days.length+1;
          bt.style.background = 'rgba(59,130,246,.08)';
          bt.style.textAlign = 'center';
          bt.style.fontWeight = '700';
          bt.textContent = 'Ø§Ø³ØªØ±Ø§Ø­Ø©';
          br.appendChild(bt);
          tbody.appendChild(br);
        }
      }

      // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
      tbl.innerHTML='';
      tbl.appendChild(thead);
      tbl.appendChild(tbody);

      // Ø®Ø²Ù‘Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ù†ÙŠØ© Ø­ØªÙ‰ Ù†Ø¹ÙŠØ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§
      const meta = userDB.get(DB_KEY, {});
      meta.__meta = {
        days, periods, startAt, slotMins,
        breaks:[...readBreaks()],
        colorsOn: !!window.__colorsOn
      };
      userDB.set(DB_KEY, meta);

      // ØªÙ„ÙˆÙŠÙ† Ø£ÙˆÙ„ÙŠ (Ù„Ùˆ Ù…ÙØ¹Ù‘Ù„)
      colorizeCells();
    }

    /* ================== CSV ================== */
    function tableToCsv(){
      const meta = userDB.get(DB_KEY, {});
      const days = (meta.__meta?.days) || ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];
      const periods = meta.__meta?.periods || (parseInt(periodsSel.value,10) || 6);
      const startAt = meta.__meta?.startAt || (startTimeInp.value || '07:00');
      const slotMins = meta.__meta?.slotMins || (parseInt(slotMinsSel.value,10) || 45);

      const times = (function(){
        const out=[]; let m=timeToMinutes(startAt);
        for(let i=0;i<periods;i++){ const from=minutesToTime(m); m+=slotMins; const to=minutesToTime(m); out.push(`${from}-${to}`); }
        return out;
      })();

      const rows = [];
      rows.push(['Ø§Ù„Ø²Ù…Ù†','Ø§Ù„ÙŠÙˆÙ…','Ø§Ù„Ù…Ø§Ø¯Ø©','Ø§Ù„Ù…Ø¹Ù„Ù…/Ù€Ø©','Ø§Ù„Ù‚Ø§Ø¹Ø©']);
      for(let r=0;r<periods;r++){
        for(let c=0;c<days.length;c++){
          const key = `r${r}c${c}`;
          const cellData = (meta[key]) || {subj:'', teacher:'', room:''};
          rows.push([
            times[r] || '',
            days[c] || '',
            (cellData.subj||''),
            (cellData.teacher||''),
            (cellData.room||'')
          ]);
        }
      }
      const bom = '\uFEFF';
      const csv = rows.map(r => r.map(x => `"${(x||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
      return bom + csv;
    }
    function downloadCsv(){
      const csv = tableToCsv();
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href = url;
      a.download = `masar-schedule-${stamp}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /* ================== Ø­ÙØ¸ ÙƒØµÙˆØ±Ø© ================== */
    async function saveTableAsPng(){
      try{
        const node = tableWrap; // ÙŠØ´Ù…Ù„ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙˆØ§Ù„ØªØ¸Ù„ÙŠÙ„
        const canvas = await html2canvas(node, {
          backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg') || null,
          scale: window.devicePixelRatio || 2,
          useCORS: true
        });
        const dataURL = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.href = dataURL;
        a.download = `masar-schedule-${stamp}.png`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      }catch(e){
        console.error(e);
        if(typeof toast === 'function') toast('ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©.');
      }
    }

    /* ================== Ø£Ø²Ø±Ø§Ø± ================== */
    $('#rebuild').addEventListener('click', buildTable);
    $('#addRow').addEventListener('click', ()=>{
      periodsSel.value = (parseInt(periodsSel.value,10)+1).toString();
      buildTable();
    });
    $('#addCol').addEventListener('click', ()=>{
      if(daysSel.value !== 'custom'){
        daysSel.value = 'custom';
        customWrap.style.display='';
        customDaysInp.value = DEFAULT_DAYS.join(', ');
      }
      const d = readDays(); d.push('ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯');
      customDaysInp.value = d.join(', ');
      buildTable();
    });
    $('#clearAll').addEventListener('click', ()=>{
      if(!confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŸ')) return;
      userDB.remove(DB_KEY);
      buildTable();
      if(typeof toast === 'function') toast('ØªÙ… Ø§Ù„Ù…Ø³Ø­ âœ“');
    });
    $('#print').addEventListener('click', ()=> window.print());

    // ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙŠØ§Ù…
    daysSel.addEventListener('change', ()=>{
      customWrap.style.display = (daysSel.value==='custom') ? '' : 'none';
    });

    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ (ØªÙØ¹ÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù) + Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
    document.getElementById('toggleColors').addEventListener('click', ()=>{
      window.__colorsOn = !window.__colorsOn;
      document.getElementById('toggleColors').textContent = window.__colorsOn ? 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ„ÙˆÙŠÙ†' : 'ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯';
      const meta = userDB.get(DB_KEY, {}); meta.__meta = meta.__meta || {}; meta.__meta.colorsOn = !!window.__colorsOn; userDB.set(DB_KEY, meta);
      colorizeCells();
    });

    // ØªØµØ¯ÙŠØ± CSV
    document.getElementById('exportCsv').addEventListener('click', downloadCsv);

    // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©
    document.getElementById('savePng').addEventListener('click', saveTableAsPng);

    // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ Ù…Ø±Ø©: Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙˆØ§Ù„Ù‚ÙŠÙ… + Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ„ÙˆÙŠÙ†
    document.addEventListener('DOMContentLoaded', ()=>{
      const saved = userDB.get(DB_KEY, {});
      const m = saved.__meta;
      if(m){
        // Ø£Ø¹Ø¯ Ù…Ù„Ø¡ Ø§Ù„Ø¶ÙˆØ§Ø¨Ø·
        startTimeInp.value = m.startAt || '07:00';
        slotMinsSel.value = (m.slotMins||45).toString();
        periodsSel.value = (m.periods||6).toString();

        // Ø£ÙŠØ§Ù…
        if(m.days && m.days.length){
          daysSel.value = 'custom';
          customWrap.style.display='';
          customDaysInp.value = m.days.join(', ');
        }
        if(m.breaks && m.breaks.length){
          breakAfterInp.value = m.breaks.join(', ');
        }
        window.__colorsOn = (m.colorsOn !== undefined) ? !!m.colorsOn : true;
      }else{
        window.__colorsOn = true;
      }
      // Ù†Øµ Ø²Ø± Ø§Ù„ØªÙ„ÙˆÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
      document.getElementById('toggleColors').textContent = window.__colorsOn ? 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ„ÙˆÙŠÙ†' : 'ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯';

      buildTable(); // Ø³ÙŠØ³ØªØ¯Ø¹ÙŠ colorizeCells() ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    });
<!-- Auth0 SDK (Ø¨Ø¯ÙˆÙ† defer Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© Ù‚Ø¨Ù„ require-auth) -->
<script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
        onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>

<!-- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©: ÙŠØªÙˆÙ‚Ø¹ SDK Ø¬Ø§Ù‡Ø² -->
<script defer src="assets/js/require-auth.js"></script>

<!-- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Supabase Ù„Ùˆ ØªØ¨ÙŠÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø¯Ø§Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ -->
<script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script defer src="assets/js/supabase-client.js"></script>

<!-- Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙˆØ£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© -->
<script defer src="assets/js/storage.js"></script>
<script defer src="app.js"></script>

<!-- Ù…ÙƒØªØ¨Ø© Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙƒØµÙˆØ±Ø© -->
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØµÙØ­Ø© (ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙˆØŒ ÙˆÙŠØ£ØªÙŠ Ø¨Ø¹Ø¯ storage/app.js) -->
<script>
  // â€¦ Ø³ÙƒØ±Ø¨Øª Ù…Ø³Ø§Ø± Ø§Ù„Ø·ÙˆÙŠÙ„ ÙƒÙ…Ø§ Ø£Ø±Ø³Ù„ØªÙŠÙ‡ (Ù„Ø§ ØªØºÙŠÙ‘Ø±ÙŠÙ†Ù‡)
</script>
</body>
</html>
