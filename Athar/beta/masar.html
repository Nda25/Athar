<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>مســار — جدولي للترم</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="dark light">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
<style>
  /* لمسات واجهة فوق style.css */
  .field{ margin:10px 0 }
  .field label{ display:block; font-weight:700; margin:6px 0 }
  .field input,.field select{
    width:100%; padding:12px 14px; border-radius:12px;
    border:1px solid rgba(59,130,246,.35); background:#fff; color:#0f172a;
  }
  .dark .field input,.dark .field select{ background:#0f172a; color:#f1f5f9; border-color:#3b82f6 }

  .row{ display:grid; gap:12px }
  .row.cols-2{ grid-template-columns:1fr 1fr }
  .row.cols-3{ grid-template-columns:1fr 1fr 1fr }
  @media(max-width:800px){ .row.cols-2,.row.cols-3{ grid-template-columns:1fr } }

  .btn{ padding:12px 18px; font-weight:800; border-radius:12px }
  .btn.primary{ padding:13px 22px }
  .actions-row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px }

  .edit-cell{ display:grid; gap:8px; grid-template-columns:120px 1fr 1fr }
  .edit-cell .tag{ font-weight:800; text-align:center; padding:6px 10px; border-radius:999px;
    border:1px solid rgba(59,130,246,.25); background:var(--card) }

  .wrap{ background:var(--card); border:1px solid rgba(59,130,246,.18); border-radius:16px; padding:14px }

  /* جدول الناتج */
  .tt-wrap{
    overflow:auto; border:1px solid rgba(59,130,246,.22);
    border-radius:16px; background:
      radial-gradient(18px 18px at 6% 14%, #e0f2fe33 10%, transparent 60%),
      radial-gradient(20px 20px at 96% 88%, #ede9fe33 10%, transparent 60%),
      var(--card);
    box-shadow:var(--shadow);
  }
  table.timetable{ width:100%; border-collapse:separate; border-spacing:0; min-width:900px }
  .timetable th,.timetable td{
    border-bottom:1px solid rgba(59,130,246,.14);
    border-inline-end:1px solid rgba(59,130,246,.10);
    padding:12px; text-align:center; vertical-align:middle;
  }
  .timetable thead th{
    position:sticky; top:0; background:linear-gradient(180deg,#ffffffcc,#ffffffaa);
    backdrop-filter:blur(4px); font-weight:800; color:var(--sea-700);
  }
  .dark .timetable thead th{ background:linear-gradient(180deg,#0f172acc,#0f172aaa); color:#93c5fd }

  .sub-chip{
    display:inline-flex; gap:8px; align-items:center; justify-content:center;
    padding:8px 12px; border-radius:999px; font-weight:800; border:1px solid rgba(0,0,0,.06);
    box-shadow:0 6px 18px rgba(0,0,0,.10); white-space:nowrap;
  }
  .meta{ display:block; font-size:12px; opacity:.85; margin-top:4px }

  .legend{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }
  .legend .chip{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px;
    border:1px solid rgba(59,130,246,.22); background:var(--card) }
  .legend .dot{ width:12px; height:12px; border-radius:50% }

  .quote{ margin-top:14px; text-align:center; color:var(--muted); font-weight:700; border-top:1px dashed rgba(59,130,246,.25); padding-top:10px }

  @media print{
    .topbar,.inputs-card,.actions-row,.toast{ display:none !important }
    header{ padding-bottom:0 }
    .tt-wrap{ box-shadow:none; border:none }
    .quote{ border:none; padding-top:0 }
  }
</style>
</head>
<body>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <div class="topbar">
    <div class="left-actions"><a class="btn" href="index.html">الرئيسية</a></div>
    <div class="actions"><button class="btn" id="themeToggle">🌓</button></div>
    <div class="user"><a class="btn" href="programs.html">مساحة إبداعي</a></div>
  </div>

  <header>
    <div class="hero">
      <h1 class="logo">مســار</h1>
      <div class="tag"><span class="dot"></span>رتّب حصصك… ودع التخطيط يمضي في مساره.</div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- لوحة الإدخال وفق تسلسل اليوم → اختيارات -->
      <section class="card inputs-card" id="inputsCard">
        <h2 class="title" style="margin-top:0">مدخلات الجدول</h2>

        <div class="row cols-3">
          <div class="field">
            <label>عدد الحصص في اليوم</label>
            <select id="dayCount">
              <option value="7" selected>7</option>
              <option value="8">8</option>
              <option value="6">6</option>
              <option value="5">5</option>
            </select>
          </div>

          <div class="field">
            <label>اختيار اليوم</label>
            <select id="daySelect">
              <option>الأحد</option><option>الإثنين</option><option>الثلاثاء</option><option>الأربعاء</option><option>الخميس</option>
            </select>
          </div>

          <div class="field">
            <label>عدد حصص هذا اليوم</label>
            <select id="slotsCount">
              <option value="0">لا يوجد</option>
              <option value="1">حصة واحدة</option>
              <option value="2">حصتان</option>
              <option value="3">3 حصص</option>
              <option value="4">4 حصص</option>
              <option value="5">5 حصص</option>
              <option value="6">6 حصص</option>
              <option value="7">7 حصص</option>
              <option value="8">8 حصص</option>
            </select>
          </div>
        </div>

        <div id="dayEditor" class="wrap" style="margin-top:10px; display:none"></div>

        <div class="actions-row">
          <button class="btn" id="saveDay">حفظ هذا اليوم</button>
          <button class="btn" id="nextDay">اليوم التالي ↦</button>
          <button class="btn primary" id="build" title="ينشئ الجدول النهائي">ولّدي الجدول ✨</button>
        </div>
      </section>

      <!-- الناتج -->
      <section class="card" id="outCard" style="display:none">
        <h2 class="title">جدول مســاري</h2>
        <div class="tt-wrap" id="ttWrap">
          <table class="timetable" id="tt"></table>
        </div>
        <div class="legend" id="legend"></div>

        <div class="actions-row" id="exportRow" style="display:none">
          <button class="btn primary" id="printBtn">طباعة</button>
          <button class="btn" id="pngBtn">حفظ كصورة PNG</button>
          <button class="btn" id="editBtn">تعديل المدخلات</button>
        </div>

        <div class="quote" id="quote"></div>
      </section>
    </div>
  </main>

  <footer>
    <p class="foot-line">التعليم شرارة صغيرة… تُضيء عقولًا كبيرة.</p>
    <p class="foot-name">ندى المجيرش</p>
  </footer>

  <div class="toast" id="toast"></div>
  <script src="app.js"></script>
  <script>
  // صغار أدوات
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  function toast(m){ let t=$('.toast'); if(!t){t=document.createElement('div');t.className='toast';document.body.appendChild(t);} t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }

  // تكوين
  const DAYS = ['الأحد','الإثنين','الثلاثاء','الأربعاء','الخميس'];
  const COLORS = [
    ['#e0f2fe','#0369a1'],['#dbeafe','#1d4ed8'],['#e9d5ff','#7e22ce'],
    ['#fee2e2','#b91c1c'],['#dcfce7','#166534'],['#fef9c3','#a16207'],
    ['#ffe4e6','#be123c'],['#ede9fe','#6d28d9']
  ];
  const QUOTES = [
    'هذا اليوم سيمضي كما مضى الأمس… ولن يبقى منه إلا الأثر. 🌿',
    'خطة بسيطة اليوم… أثر عميق غدًا.',
    'كل حصة فرصة لصناعة أثر جديد.',
    'النظام سُلّم للوصول، لا قيد.',
  ];
  const KEY='athar:masar:v2';

  // حالة داخلية: لكل يوم مصفوفة من العناصر {p,sub,cls}
  let state = load() || { periods:7, days: Object.fromEntries(DAYS.map(d=>[d,[]])) };

  // عناصر
  const dayCount  = $('#dayCount');
  const daySelect = $('#daySelect');
  const slotsCount= $('#slotsCount');
  const dayEditor = $('#dayEditor');
  const buildBtn  = $('#build');
  const saveDayBtn= $('#saveDay');
  const nextDayBtn= $('#nextDay');

  // تحميل الحالة الأولية
  dayCount.value = state.periods;
  renderDayEditor();

  dayCount.addEventListener('change', ()=>{
    state.periods = +dayCount.value || 7;
    save(); renderDayEditor();
  });

  daySelect.addEventListener('change', ()=> renderDayEditor());
  slotsCount.addEventListener('change', ()=> renderDayEditor());

  saveDayBtn.addEventListener('click', ()=>{
    const d = daySelect.value;
    const items = readEditor();
    if(!validate(items)){ toast('تحقّقي من أرقام الحصص وعدم التكرار.'); return; }
    state.days[d] = items;
    save(); toast(`حُفظ ${d}.`);
  });

  nextDayBtn.addEventListener('click', ()=>{
    const idx = DAYS.indexOf(daySelect.value);
    daySelect.value = DAYS[(idx+1)%DAYS.length];
    renderDayEditor();
  });

  buildBtn.addEventListener('click', ()=>{
    // بناء الجدول
    const allEmpty = DAYS.every(d => (state.days[d]||[]).length===0);
    if(allEmpty){ toast('أدخلي حصص يوم واحد على الأقل.'); return; }
    paintTable();
    $('#outCard').style.display = '';
    $('#exportRow').style.display = 'flex';
    window.scrollTo({ top: $('#outCard').offsetTop-10, behavior:'smooth' });
  });

  // بناء محرر اليوم
  function renderDayEditor(){
    const d = daySelect.value;
    const count = +slotsCount.value || 0;
    const maxP = +dayCount.value || 7;

    // حمل الموجود لهذا اليوم
    const prev = state.days[d] || [];
    dayEditor.innerHTML = '';
    dayEditor.style.display = count>0 ? '' : 'none';

    for(let i=0;i<count;i++){
      const row = document.createElement('div');
      row.className='edit-cell';
      const cur = prev[i] || {};
      row.innerHTML = `
        <div class="tag">الحصة</div>
        <select data-k="p">
          ${Array.from({length:maxP},(_,x)=>`<option value="${x+1}" ${cur.p==(x+1)?'selected':''}>${x+1}</option>`).join('')}
        </select>
        <input data-k="sub" placeholder="المادة" value="${cur.sub||''}">
        <input data-k="cls" placeholder="الفصل/الشعبة" value="${cur.cls||''}">
      `;
      dayEditor.appendChild(row);
    }
  }

  function readEditor(){
    return $$('.edit-cell', dayEditor).map(el=>{
      return {
        p: +$('select[data-k="p"]',el).value,
        sub: $('input[data-k="sub"]',el).value.trim(),
        cls: $('input[data-k="cls"]',el).value.trim()
      };
    }).filter(x=> x.sub || x.cls);
  }

  function validate(items){
    // لا تكرار لنفس رقم الحصة
    const ps = items.map(x=>x.p);
    return (new Set(ps)).size === ps.length;
  }

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'null'); }catch(_){ return null; } }

  // ألوان بحسب المادة
  function colorFor(s){
    s=(s||'').trim(); let h=0; for(let i=0;i<s.length;i++) h=(h*31+s.charCodeAt(i))>>>0;
    const [bg,fg]=COLORS[h%COLORS.length]; return {bg,fg};
  }

  // رسم الجدول
  function paintTable(){
    const tt = $('#tt'); const legend = $('#legend');
    const periods = +state.periods || 7;

    tt.innerHTML='';
    const thead = document.createElement('thead');
    thead.innerHTML = `<tr><th>الحصة</th>${DAYS.map(d=>`<th>${d}</th>`).join('')}</tr>`;
    tt.appendChild(thead);

    const tbody = document.createElement('tbody');

    for(let p=1;p<=periods;p++){
      const tr = document.createElement('tr');
      tr.appendChild(cellTh('الحصة '+p));
      DAYS.forEach(d=>{
        const it = (state.days[d]||[]).find(x=>x.p===p);
        const td = document.createElement('td');
        if(it){
          const {bg,fg} = colorFor(it.sub || d);
          td.innerHTML = `
            <div class="sub-chip" style="background:${bg}; color:${fg}">${it.sub||'—'}</div>
            ${it.cls? `<span class="meta">${it.cls}</span>`:''}
          `;
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
    tt.appendChild(tbody);

    // وسيلة إيضاح
    legend.innerHTML = '';
    const subs = new Set();
    DAYS.forEach(d => (state.days[d]||[]).forEach(x=> subs.add(x.sub)));
    [...subs].filter(Boolean).slice(0,15).forEach(s=>{
      const {bg,fg}=colorFor(s);
      const chip = document.createElement('div'); chip.className='chip';
      chip.innerHTML = `<span class="dot" style="background:${bg}"></span><span style="color:${fg};font-weight:800">${s}</span>`;
      legend.appendChild(chip);
    });

    $('#quote').textContent = QUOTES[Math.floor(Math.random()*QUOTES.length)];
  }
  function cellTh(t){ const th=document.createElement('th'); th.textContent=t; return th; }

  // تصدير/طباعة
  $('#printBtn').addEventListener('click', ()=>window.print());
  $('#pngBtn').addEventListener('click', async ()=>{
    const wrap = $('#ttWrap'); if(!window.html2canvas){ toast('لم تحمل مكتبة الصورة'); return; }
    const canvas = await html2canvas(wrap, { scale:2, useCORS:true, backgroundColor:null });
    const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download='masar.png'; a.click();
  });
  $('#editBtn').addEventListener('click', ()=>{
    window.scrollTo({ top: $('#inputsCard').offsetTop-10, behavior:'smooth' });
  });
  </script>
</body>
</html>
