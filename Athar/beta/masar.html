<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù…Ø³Ù€Ù€Ø§Ø± â€” Ø¬Ø¯ÙˆÙ„ÙŠ Ù„Ù„ØªØ±Ù…</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="dark light">

<!-- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙƒØµÙˆØ±Ø© -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

<style>
  /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø®ÙÙŠÙØ© ÙÙˆÙ‚ style.css â€” ÙƒÙ„Ù‡Ø§ Ø¨Ù†ÙØ³ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ© */
  .field{ margin:10px 0 }
  .field label{ display:block; font-weight:700; margin:6px 0 }
  .field input,.field select{
    width:100%; padding:12px; border-radius:12px;
    border:1px solid rgba(59,130,246,.35); background:#fff; color:#0f172a;
  }
  .dark .field input,.dark .field select{
    background:#0f172a; color:#f1f5f9; border-color:#3b82f6;
  }

  .cols-3{ display:grid; gap:12px; grid-template-columns:1fr }
  .cols-2{ display:grid; gap:12px; grid-template-columns:1fr }
  @media(min-width:800px){
    .cols-3{ grid-template-columns:1fr 1fr 1fr }
    .cols-2{ grid-template-columns:1fr 1fr }
  }

  .grid-mini{ display:grid; gap:10px }
  .grid-mini .cell{
    background:var(--card); border:1px solid rgba(59,130,246,.22);
    border-radius:12px; padding:10px;
  }
  .cell .row{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
  .cell h4{ margin:0 0 6px; color:var(--sea-600); font-size:15px }
  .dark .cell h4{ color:#93c5fd }

  .actions-row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
  .actions-row .btn{ min-width:170px }

  /* Ù…Ù†Ø·Ù‚Ø© Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø­ØµØµ */
  #timesGrid .time-row{
    display:grid; grid-template-columns:110px 1fr 1fr; gap:8px; align-items:center
  }
  #timesGrid .time-tag{
    font-weight:800; text-align:center; padding:6px 10px; border-radius:999px;
    border:1px solid rgba(59,130,246,.25); background:var(--card);
  }

  /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø§ØªØ¬ */
  .tt-wrap{
    overflow:auto; border:1px solid rgba(59,130,246,.22);
    border-radius:16px; background:var(--card); box-shadow:var(--shadow);
  }
  table.timetable{
    width:100%; border-collapse:separate; border-spacing:0; min-width:760px;
  }
  .timetable th,.timetable td{
    border-bottom:1px solid rgba(59,130,246,.18);
    border-inline-end:1px solid rgba(59,130,246,.12);
    padding:12px; text-align:center; vertical-align:middle;
  }
  .timetable th{
    position:sticky; top:0; background:linear-gradient(180deg,#ffffffcc,#ffffffaa);
    backdrop-filter:blur(4px); font-weight:800; color:var(--sea-700);
  }
  .dark .timetable th{
    background:linear-gradient(180deg,#0f172acc,#0f172aaa); color:#93c5fd;
  }
  .timetable td .sub{
    display:inline-flex; gap:8px; align-items:center; justify-content:center;
    padding:8px 10px; border-radius:999px; font-weight:800; border:1px solid rgba(0,0,0,.06);
    box-shadow:0 6px 18px rgba(0,0,0,.12);
    white-space:nowrap;
  }
  .timetable td .cls{ display:block; font-size:12px; opacity:.85; margin-top:4px }
  .timetable td .room{ display:block; font-size:12px; opacity:.8; }

  .legend{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }
  .legend .chip{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
    border:1px solid rgba(59,130,246,.22); background:var(--card);
  }
  .legend .dot{ width:12px; height:12px; border-radius:50% }

  .quote{
    margin-top:14px; text-align:center; color:var(--muted); font-weight:700;
    border-top:1px dashed rgba(59,130,246,.25); padding-top:10px
  }

  /* Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©: Ù†Ø¸Ø±Ø© Ù†Ø¸ÙŠÙØ© */
  @media print{
    .topbar,.inputs-card,.actions-row,.toast{ display:none !important }
    header{ padding-bottom:0 }
    .tt-wrap{ box-shadow:none; border:none }
    .quote{ border:none; padding-top:0 }
  }
</style>
</head>
<body>
  <!-- Ø§Ù„Ø®Ù„ÙÙŠØ§Øª -->
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ù…ÙˆØ­Ù‘Ø¯) -->
  <div class="topbar">
    <div class="left-actions">
      <a class="btn" href="index.html" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†/Ø§Ù„ÙØ§ØªØ­">ğŸŒ“</button>
    </div>
    <div class="user">
      <a id="nav-programs" class="btn" href="programs.html">Ù…Ø³Ø§Ø­Ø© Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ</a>
    </div>
  </div>

  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <header>
    <div class="hero">
      <h1 class="logo">Ù…Ø³Ù€Ù€Ø§Ø±</h1>
      <div class="tag"><span class="dot"></span>Ø±ØªÙ‘Ø¨ Ø­ØµØµÙƒâ€¦ ÙˆØ¯Ø¹ Ø§Ù„ØªØ®Ø·ÙŠØ· ÙŠÙ…Ø¶ÙŠ ÙÙŠ Ù…Ø³Ø§Ø±Ù‡.</div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª -->
      <section class="card inputs-card inputs-wrap" id="inputsCard">
        <div class="inputs-head">
          <h2 class="title" style="margin:0">Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„</h2>
          <button id="toggleInputs" class="btn ghost" title="Ø·ÙŠ/Ø¥Ø¸Ù‡Ø§Ø±">Ø·ÙŠÙ‘</button>
        </div>

        <div class="inputs-body">
          <div class="cols-3">
            <div class="field">
              <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</label>
              <select id="periods">
                <option>5</option><option selected>6</option><option>7</option><option>8</option>
              </select>
            </div>

            <div class="field">
              <label>Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</label>
              <select id="weekPreset">
                <option value="sun-thu" selected>Ø§Ù„Ø£Ø­Ø¯â€“Ø§Ù„Ø®Ù…ÙŠØ³</option>
                <option value="mon-fri">Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†â€“Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
                <option value="custom">ØªØ®ØµÙŠØµâ€¦</option>
              </select>
            </div>

            <div class="field">
              <label>Ø£Ø¯ÙˆØ§Øª Ø³Ø±ÙŠØ¹Ø©</label>
              <div class="cols-2">
                <select id="copyFrom">
                  <option value="" selected>Ø§Ù†Ø³Ø® Ù…Ù† ÙŠÙˆÙ…â€¦</option>
                </select>
                <select id="copyTo">
                  <option value="">Ø¥Ù„Ù‰ ÙŠÙˆÙ…â€¦</option>
                </select>
              </div>
              <div class="actions-row" style="margin-top:8px">
                <button class="btn" id="copyDayBtn">Ù†Ø³Ø® Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± â†¦</button>
              </div>
              <div class="muted-mini">Ø§Ù†Ø³Ø®ÙŠ Ù…Ø­ØªÙˆÙ‰ ÙŠÙˆÙ… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¥Ù„Ù‰ ÙŠÙˆÙ… Ø¢Ø®Ø±.</div>
            </div>
          </div>

          <!-- Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠØ§Ù… Ù…Ø®ØµÙ‘ØµØ© -->
          <div class="field" id="daysCustom" style="display:none">
            <label>Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø£ÙŠØ§Ù…</label>
            <div class="grid-mini" style="grid-template-columns:repeat(5,1fr)">
              <label><input type="checkbox" class="day" value="Ø§Ù„Ø£Ø­Ø¯" checked> Ø§Ù„Ø£Ø­Ø¯</label>
              <label><input type="checkbox" class="day" value="Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†" checked> Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</label>
              <label><input type="checkbox" class="day" value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡" checked> Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</label>
              <label><input type="checkbox" class="day" value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡" checked> Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</label>
              <label><input type="checkbox" class="day" value="Ø§Ù„Ø®Ù…ÙŠØ³" checked> Ø§Ù„Ø®Ù…ÙŠØ³</label>
            </div>
          </div>

          <!-- Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø­ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
          <div class="field" id="periodTimes">
            <label>Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø­ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <div id="timesGrid" class="grid-mini" style="grid-template-columns:1fr">
              <!-- ÙŠÙØ¨Ù†Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ -->
            </div>
            <div class="muted-mini">Ø§ØªØ±Ùƒ Ø§Ù„Ø®Ø§Ù†Ø§Øª ÙØ§Ø±ØºØ© Ø¥Ø°Ø§ Ù„Ø§ ØªÙ‡Ù…Ùƒ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ù„ÙˆÙ‚Øª.</div>
          </div>

          <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª (Ø§Ù„ÙŠÙˆÙ… â† Ø­ØµØµ) -->
          <div id="inputsGrid" class="grid-mini" style="margin-top:14px"></div>

          <div class="actions-row">
            <button class="btn primary" id="build">ÙˆÙ„Ù‘Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ âœ¨</button>
            <button class="btn" id="reset">Ù…Ø³Ø­ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</button>
            <button class="btn" id="reload">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ø­ÙØ¸</button>
            <button class="btn" id="exportCsv">ØªØµØ¯ÙŠØ± CSV</button>
            <button class="btn" id="copyTextBtn">Ù†Ø³Ø® Ù†ØµÙ‘ÙŠ</button>
          </div>
        </div>
      </section>

      <!-- Ø§Ù„Ù†Ø§ØªØ¬ -->
      <section class="card" id="outCard" style="display:none">
        <h2 class="title">Ø¬Ø¯ÙˆÙ„ Ù…Ø³Ù€Ù€Ø§Ø±ÙŠ</h2>
        <div class="tt-wrap" id="ttWrap">
          <table class="timetable" id="tt"></table>
        </div>
        <div class="legend" id="legend"></div>

        <div class="actions-row">
          <button class="btn primary" id="printBtn">Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn" id="pngBtn">Ø­ÙØ¸ ÙƒÙ€ PNG</button>
          <button class="btn" id="editBtn">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</button>
        </div>

        <div class="quote" id="quote"></div>
      </section>
    </div>
  </main>

  <footer>
    <p class="foot-line">Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø´Ø±Ø§Ø±Ø© ØµØºÙŠØ±Ø©â€¦ ØªÙØ¶ÙŠØ¡ Ø¹Ù‚ÙˆÙ„Ù‹Ø§ ÙƒØ¨ÙŠØ±Ø©.</p>
    <p class="foot-name">Ù†Ø¯Ù‰ Ø§Ù„Ù…Ø¬ÙŠØ±Ø´</p>
  </footer>

  <div class="toast" id="toast"></div>
  <script src="app.js"></script>
  <script>
    // â€”â€”â€”â€”â€”â€” Ø£Ø¯ÙˆØ§Øª ØµØºÙŠØ±Ø© â€”â€”â€”â€”â€”â€”
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    function toast(msg){
      let t = $('.toast'); if(!t){ t=document.createElement('div'); t.className='toast'; document.body.appendChild(t); }
      t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1500);
    }

    // Ø­ÙØ¸/Ø§Ø³ØªØ±Ø¬Ø§Ø¹ (Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©)
    const KEY = 'athar:masar';
    function saveState(obj){ localStorage.setItem(KEY, JSON.stringify(obj)); }
    function loadState(){ try{ return JSON.parse(localStorage.getItem(KEY)||'null'); }catch(_){ return null; } }

    // Ø£Ù„ÙˆØ§Ù† Ø«Ø§Ø¨ØªØ© Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø© (Ù‡Ø§Ø´ Ø¨Ø³ÙŠØ·)
    const PALETTE = [
      ['#e0f2fe','#0284c7'], ['#dbeafe','#1d4ed8'], ['#e9d5ff','#7e22ce'],
      ['#fee2e2','#b91c1c'], ['#dcfce7','#166534'], ['#fef9c3','#a16207'],
      ['#ffe4e6','#be123c'], ['#ede9fe','#6d28d9'], ['#fce7f3','#be185d']
    ];
    function colorFor(subject){
      subject = (subject||'').trim();
      let h=0; for(let i=0;i<subject.length;i++) h = (h*31 + subject.charCodeAt(i))>>>0;
      const [bg,fg] = PALETTE[h % PALETTE.length];
      return { bg, fg };
    }

    // Ø¹Ø¨Ø§Ø±Ø§Øª ØªØ­ÙÙŠØ²ÙŠØ© (ØªÙØ¹Ø±Ø¶ Ø¹Ø´ÙˆØ§Ø¦ÙŠÙ‹Ø§)
    const QUOTES = [
      'Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ø³ÙŠÙ…Ø¶ÙŠ ÙƒÙ…Ø§ Ù…Ø¶Ù‰ Ø§Ù„Ø£Ù…Ø³â€¦ ÙˆÙ„Ù† ÙŠØ¨Ù‚Ù‰ Ù…Ù†Ù‡ Ø¥Ù„Ø§ Ø§Ù„Ø£Ø«Ø±. ğŸŒ¿',
      'Ø±ØªÙ‘Ø¨ ÙˆÙ‚ØªÙƒØŒ ØªØ²Ø¯Ùƒ Ø­Ø±Ù‘ÙŠØ©Ù‹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­ØµÙ‘Ø©.',
      'Ø®Ø·Ø© Ø¨Ø³ÙŠØ·Ø© Ø§Ù„ÙŠÙˆÙ…â€¦ Ø£Ø«Ø± Ø¹Ù…ÙŠÙ‚ ØºØ¯Ù‹Ø§.',
      'Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ÙŠØ³ ØªÙ‚ÙŠÙŠØ¯Ù‹Ø§â€¦ Ø¥Ù†Ù…Ø§ Ø³ÙÙ„Ù… Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø£Ø¨Ø¹Ø¯.',
      'ÙƒÙ„ Ø­ØµØ© ÙØ±ØµØ© Ù„ØµÙ†Ø§Ø¹Ø© Ø£Ø«Ø± Ø¬Ø¯ÙŠØ¯.'
    ];

    // Ø¹Ù†Ø§ØµØ± DOM
    const inputsGrid = $('#inputsGrid');
    const periodsSel = $('#periods');
    const weekPreset = $('#weekPreset');
    const daysCustom = $('#daysCustom');
    const timesGrid  = $('#timesGrid');

    const copyFrom   = $('#copyFrom');
    const copyTo     = $('#copyTo');
    const copyDayBtn = $('#copyDayBtn');

    function currentDays(){
      if(weekPreset.value === 'mon-fri') return ['Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'];
      if(weekPreset.value === 'custom'){
        return $$('.day:checked', daysCustom).map(i=>i.value);
      }
      return ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³']; // sun-thu
    }

    // Ø¨Ù†Ø§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ù†Ø³Ø®Ø©-Ù…Ù†/Ø¥Ù„Ù‰
    function rebuildCopyDaySelectors(days){
      const make = (sel, title)=>{
        const cur = sel.value;
        sel.innerHTML = '<option value="">'+title+'</option>' + days.map(d=>`<option value="${d}">${d}</option>`).join('');
        if(days.includes(cur)) sel.value = cur; // Ø§Ø³ØªØ¹Ø§Ø¯Ø©
      };
      make(copyFrom, 'Ø§Ù†Ø³Ø® Ù…Ù† ÙŠÙˆÙ…â€¦');
      make(copyTo,   'Ø¥Ù„Ù‰ ÙŠÙˆÙ…â€¦');
    }

    // Ø¨Ù†Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø­ØµØµ
    function rebuildTimes(){
      const periods = parseInt(periodsSel.value,10) || 6;
      timesGrid.innerHTML = '';
      for(let p=1;p<=periods;p++){
        const row = document.createElement('div');
        row.className = 'time-row';
        row.innerHTML = `
          <div class="time-tag">Ø§Ù„Ø­ØµØ© ${p}</div>
          <input type="time" placeholder="Ù…Ù†" data-k="from" data-p="${p}">
          <input type="time" placeholder="Ø¥Ù„Ù‰" data-k="to"   data-p="${p}">
        `;
        timesGrid.appendChild(row);
      }
    }

    // Ø¨Ù†Ø§Ø¡ Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (ÙŠÙˆÙ… â† Ø­ØµØµ â† Ù…Ø§Ø¯Ø©/ÙØµÙ„/ØºØ±ÙØ©)
    function rebuildInputs(){
      const days = currentDays();
      const periods = parseInt(periodsSel.value,10) || 6;
      inputsGrid.innerHTML = '';

      days.forEach(day=>{
        const wrap = document.createElement('div');
        wrap.className = 'cell';
        wrap.innerHTML = '<h4>'+day+'</h4>';
        for(let p=1; p<=periods; p++){
          const row = document.createElement('div');
          row.className='row';
          row.style.gridTemplateColumns = '1fr 1fr 1fr';
          row.innerHTML = `
            <input type="text" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø© (Ø­ØµØ© ${p})" data-k="sub"  data-day="${day}" data-p="${p}">
            <input type="text" placeholder="Ø§Ù„ÙØµÙ„/Ø§Ù„Ø´Ø¹Ø¨Ø©"       data-k="cls"  data-day="${day}" data-p="${p}">
            <input type="text" placeholder="Ø§Ù„ØºØ±ÙØ©/Ø§Ù„Ù…Ø¹Ù…Ù„"      data-k="room" data-day="${day}" data-p="${p}">
          `;
          wrap.appendChild(row);
        }
        inputsGrid.appendChild(wrap);
      });

      rebuildCopyDaySelectors(days);
    }

    // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠØ§Ù… Ù…Ø®ØµÙ‘ØµØ©
    weekPreset.addEventListener('change', ()=>{
      daysCustom.style.display = (weekPreset.value==='custom') ? '' : 'none';
      rebuildTimes();
      rebuildInputs();
      restoreFromState(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø¨Ø¦Ø© Ù„Ùˆ ÙÙŠÙ‡ Ø­ÙØ¸
    });
    $$('.day').forEach(ch => ch.addEventListener('change', ()=>{
      rebuildInputs();
      restoreFromState();
    }));
    periodsSel.addEventListener('change', ()=>{
      rebuildTimes();
      rebuildInputs();
      restoreFromState();
    });

    // Ø­ÙØ¸/Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    function collectState(){
      const days = currentDays();
      const periods = parseInt(periodsSel.value,10) || 6;
      const cells = [];
      days.forEach(day=>{
        for(let p=1;p<=periods;p++){
          const sub  = inputsGrid.querySelector(`input[data-k="sub"][data-day="${day}"][data-p="${p}"]`)?.value||'';
          const cls  = inputsGrid.querySelector(`input[data-k="cls"][data-day="${day}"][data-p="${p}"]`)?.value||'';
          const room = inputsGrid.querySelector(`input[data-k="room"][data-day="${day}"][data-p="${p}"]`)?.value||'';
          if(sub || cls || room) cells.push({day,p,sub,cls,room});
        }
      });

      const times = [];
      for(let p=1;p<=periods;p++){
        const from = timesGrid.querySelector(`input[data-k="from"][data-p="${p}"]`)?.value || '';
        const to   = timesGrid.querySelector(`input[data-k="to"][data-p="${p}"]`)?.value   || '';
        if(from || to) times.push({p, from, to});
      }

      return { preset:weekPreset.value, days, periods, cells, times };
    }

    function restoreFromState(){
      const st = loadState();
      if(!st) return;

      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø®Ù„Ø§ÙŠØ§
      (st.cells||[]).forEach(c=>{
        const q = (k)=> inputsGrid.querySelector(`input[data-k="${k}"][data-day="${c.day}"][data-p="${c.p}"]`);
        const s = q('sub'), cl = q('cls'), rm = q('room');
        if(s)  s.value  = c.sub  || '';
        if(cl) cl.value = c.cls  || '';
        if(rm) rm.value = c.room || '';
      });

      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
      (st.times||[]).forEach(t=>{
        const from = timesGrid.querySelector(`input[data-k="from"][data-p="${t.p}"]`);
        const to   = timesGrid.querySelector(`input[data-k="to"][data-p="${t.p}"]`);
        if(from) from.value = t.from || '';
        if(to)   to.value   = t.to   || '';
      });
    }

    // Ø£ÙˆØªÙˆ-Ø­ÙØ¸
    function debounce(fn, ms){ let t; return function(){ clearTimeout(t); t=setTimeout(fn, ms); } }
    const autoSave = debounce(()=> saveState(collectState()), 400);
    inputsGrid.addEventListener('input', autoSave);
    timesGrid .addEventListener('input', autoSave);

    // Ù…Ø³Ø­/Ø§Ø³ØªØ±Ø¬Ø§Ø¹
    $('#reset').addEventListener('click', ()=>{
      localStorage.removeItem(KEY);
      rebuildTimes(); rebuildInputs();
      toast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª.');
    });
    $('#reload').addEventListener('click', ()=>{
      const st = loadState();
      if(!st){ toast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­ÙØ¸ Ø³Ø§Ø¨Ù‚.'); return; }
      periodsSel.value = st.periods || '6';
      weekPreset.value = st.preset  || 'sun-thu';
      daysCustom.style.display = (weekPreset.value==='custom') ? '' : 'none';

      rebuildTimes();
      rebuildInputs();

      // Ø¥Ø°Ø§ custom: Ø¹Ù„Ù… Ø§Ù„Ø£ÙŠØ§Ù… Ø­Ø³Ø¨ Ø§Ù„Ø­ÙØ¸
      if(st.preset==='custom'){
        $$('.day').forEach(ch => ch.checked = (st.days||[]).includes(ch.value));
      }
      restoreFromState();
      toast('ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹.');
    });

    // Ù†Ø³Ø® ÙŠÙˆÙ… â†¦ ÙŠÙˆÙ…
    copyDayBtn.addEventListener('click', ()=>{
      const from = copyFrom.value, to = copyTo.value;
      if(!from || !to){ toast('Ø§Ø®ØªØ± ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù†Ø³Ø®/Ø§Ù„Ù„Ø²Ù‚ Ø£ÙˆÙ„Ù‹Ø§.'); return; }
      if(from === to){ toast('Ø§Ù„ÙŠÙˆÙ…Ø§Ù† Ù…ØªØ´Ø§Ø¨Ù‡Ø§Ù†.'); return; }

      const st = collectState();
      const periods = parseInt(periodsSel.value,10) || 6;
      for(let p=1;p<=periods;p++){
        const src = (st.cells||[]).find(c=> c.day===from && c.p===p) || {sub:'',cls:'',room:''};
        const q = (k)=> inputsGrid.querySelector(`input[data-k="${k}"][data-day="${to}"][data-p="${p}"]`);
        const s = q('sub'), cl = q('cls'), rm = q('room');
        if(s)  s.value  = src.sub  || '';
        if(cl) cl.value = src.cls  || '';
        if(rm) rm.value = src.room || '';
      }
      saveState(collectState());
      toast(`ØªÙ… Ù†Ø³Ø® ${from} Ø¥Ù„Ù‰ ${to}.`);
    });

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const outCard = $('#outCard');
    const tt = $('#tt'); const legend = $('#legend');

    $('#build').addEventListener('click', ()=>{
      const st = collectState(); saveState(st);

      const days = st.days || currentDays();
      const periods = st.periods || parseInt(periodsSel.value,10) || 6;

      const filled = st.cells && st.cells.some(c=> (c.sub||c.cls||c.room||'').trim());
      if(!filled){ toast('Ø§Ù…Ù„Ø£ Ø®Ø§Ù†Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'); return; }

      // Ø¬Ø¯ÙˆÙ„
      tt.innerHTML = '';
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      trh.innerHTML = '<th>Ø§Ù„Ø­ØµØ©</th><th>Ø§Ù„ÙˆÙ‚Øª</th>' + days.map(d=>`<th>${d}</th>`).join('');
      thead.appendChild(trh); tt.appendChild(thead);

      const tbody = document.createElement('tbody');
      for(let p=1;p<=periods;p++){
        const tr = document.createElement('tr');

        // Ø¹Ù…ÙˆØ¯: Ø±Ù‚Ù… Ø§Ù„Ø­ØµØ©
        const thP = document.createElement('th'); thP.textContent = 'Ø§Ù„Ø­ØµØ© '+p; tr.appendChild(thP);

        // Ø¹Ù…ÙˆØ¯: Ø§Ù„ÙˆÙ‚Øª
        const timeCell = document.createElement('td');
        const t = (st.times||[]).find(x=>x.p===p) || {};
        timeCell.textContent = (t.from && t.to) ? `${t.from} â€“ ${t.to}` : 'â€”';
        tr.appendChild(timeCell);

        // Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„Ø£ÙŠØ§Ù…
        days.forEach(d=>{
          const cell = (st.cells||[]).find(c=> c.day===d && c.p===p) || {sub:'',cls:'',room:''};
          const td = document.createElement('td');
          if(cell.sub || cell.cls || cell.room){
            const {bg,fg} = colorFor(cell.sub || d);
            td.innerHTML = `
              <div class="sub" style="background:${bg}; color:${fg}">${cell.sub||'â€”'}</div>
              ${cell.cls? `<span class="cls">${cell.cls}</span>`:''}
              ${cell.room? `<span class="room">ğŸ“ ${cell.room}</span>`:''}
            `;
          }
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      }
      tt.appendChild(tbody);

      // ÙˆØ³ÙŠÙ„Ø© Ø¥ÙŠØ¶Ø§Ø­
      legend.innerHTML = '';
      const subjects = Array.from(new Set((st.cells||[]).map(c=>(c.sub||'').trim()).filter(Boolean)));
      subjects.slice(0,15).forEach(s=>{
        const {bg,fg} = colorFor(s);
        const chip = document.createElement('div');
        chip.className='chip';
        chip.innerHTML = `<span class="dot" style="background:${bg}"></span><span style="color:${fg}; font-weight:800">${s}</span>`;
        legend.appendChild(chip);
      });

      // Ø§Ù‚ØªØ¨Ø§Ø³ ØªØ­ÙÙŠØ²ÙŠ
      $('#quote').textContent = QUOTES[Math.floor(Math.random()*QUOTES.length)];

      outCard.style.display = '';
      window.scrollTo({ top: outCard.offsetTop - 10, behavior: 'smooth' });
      toast('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ âœ¨');
    });

    // ØªØµØ¯ÙŠØ± CSV
    $('#exportCsv').addEventListener('click', ()=>{
      const st = collectState();
      const days = st.days || currentDays();
      const periods = st.periods || parseInt(periodsSel.value,10) || 6;

      // Ø±Ø£Ø³ÙŠØ©
      let rows = [['Ø§Ù„Ø­ØµØ©','Ù…Ù†','Ø¥Ù„Ù‰', ...days]];
      for(let p=1;p<=periods;p++){
        const t = (st.times||[]).find(x=>x.p===p) || {};
        const cols = days.map(d=>{
          const c = (st.cells||[]).find(x=>x.day===d && x.p===p) || {};
          const parts = [c.sub, c.cls, c.room].filter(Boolean);
          return parts.join(' | ');
        });
        rows.push(['Ø§Ù„Ø­ØµØ© '+p, t.from||'', t.to||'', ...cols]);
      }

      const csv = rows.map(r=> r.map(x => `"${(x||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'masar.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // Ù†Ø³Ø® Ù†ØµÙ‘ÙŠ
    $('#copyTextBtn').addEventListener('click', ()=>{
      const st = collectState();
      const days = st.days || currentDays();
      const periods = st.periods || parseInt(periodsSel.value,10) || 6;

      const lines = [];
      lines.push('Ø¬Ø¯ÙˆÙ„ Ù…Ø³Ø§Ø± â€” Ù†Ø³Ø®Ø© Ù†ØµÙŠØ©');
      for(let p=1;p<=periods;p++){
        const t = (st.times||[]).find(x=>x.p===p) || {};
        lines.push(`\nØ§Ù„Ø­ØµØ© ${p} ${t.from&&t.to?`(${t.from}â€“${t.to})`:''}`);
        days.forEach(d=>{
          const c = (st.cells||[]).find(x=>x.day===d && x.p===p) || {};
          if(c.sub || c.cls || c.room){
            lines.push(`- ${d}: ${[c.sub,c.cls,c.room].filter(Boolean).join(' | ')}`);
          }
        });
      }
      const text = lines.join('\n');

      if(navigator.clipboard && window.isSecureContext){
        navigator.clipboard.writeText(text).then(()=> toast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“'));
      }else{
        const ta=document.createElement('textarea'); ta.value=text;
        document.body.appendChild(ta); ta.select();
        try{ document.execCommand('copy'); toast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“'); }
        finally{ document.body.removeChild(ta); }
      }
    });

    // Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©
    $('#pngBtn').addEventListener('click', async ()=>{
      const wrap = $('#ttWrap');
      if(!window.html2canvas){ toast('Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„ØµÙˆØ±Ø© ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©.'); return; }
      const canvas = await html2canvas(wrap, { scale:2, useCORS:true, backgroundColor:null });
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a'); a.href = url; a.download = 'masar.png'; a.click();
    });

    // Ø·Ø¨Ø§Ø¹Ø©
    $('#printBtn').addEventListener('click', ()=> window.print());

    // Ø·ÙŠÙ‘/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    const inputsCard = $('#inputsCard');
    $('#toggleInputs').addEventListener('click', ()=>{
      inputsCard.classList.toggle('collapsed');
      $('#toggleInputs').textContent = inputsCard.classList.contains('collapsed') ? 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª' : 'Ø·ÙŠÙ‘';
    });
    $('#editBtn').addEventListener('click', ()=>{
      inputsCard.classList.remove('collapsed');
      window.scrollTo({ top: inputsCard.offsetTop - 10, behavior:'smooth' });
    });

    // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
    (function init(){
      const st = loadState();
      if(st){
        periodsSel.value = st.periods || '6';
        weekPreset.value = st.preset  || 'sun-thu';
        daysCustom.style.display = (weekPreset.value==='custom') ? '' : 'none';
        rebuildTimes();
        rebuildInputs();

        if(st.preset==='custom'){
          $$('.day').forEach(ch => ch.checked = (st.days||[]).includes(ch.value));
        }
        restoreFromState();
      }else{
        rebuildTimes();
        rebuildInputs();
      }
    })();
  </script>
</body>
</html>
