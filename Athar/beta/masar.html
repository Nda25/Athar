<!-- masar.html â€” Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ© -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙØ³Ù€Ù€Ø§Ø± â€” Ø¬Ø¯Ø§ÙˆÙ„ Ø­ØµØµ Ø£Ù†ÙŠÙ‚Ø©</title>
  <meta name="color-scheme" content="dark light" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ÙÙˆÙ‚ style.css ===== */
    :root{
      --tbl-accent: #3b82f6;           /* ÙŠØªØºÙŠØ± Ù…Ù† Ø§Ø®ØªÙŠØ§Ø±Ùƒ */
      --bg-floral: radial-gradient( circle at 20% 20%, rgba(255,192,203,.25) 0 20%, transparent 21% ) ,
                   radial-gradient( circle at 80% 30%, rgba(255,192,203,.18) 0 18%, transparent 19% ),
                   radial-gradient( circle at 30% 80%, rgba(255,192,203,.20) 0 22%, transparent 23% );
      --bg-leaves: radial-gradient( 60px 60px at 20% 30%, rgba(148,210,165,.25) 0 50%, transparent 51% ),
                   radial-gradient( 80px 80px at 80% 70%, rgba(148,210,165,.18) 0 50%, transparent 51% ),
                   radial-gradient( 70px 70px at 40% 85%, rgba(148,210,165,.20) 0 50%, transparent 51% );
    }
    body.bg-floral .pattern{ background-image: var(--bg-floral); }
    body.bg-leaves .pattern{ background-image: var(--bg-leaves); }
    .pattern{ position:fixed; inset:0; pointer-events:none; opacity:.5; background-size: 500px 500px; }

    .controls .field{ margin:8px 0 }
    .controls .field label{ display:block; font-weight:700; margin:6px 0 }
    .controls .field input, .controls .field select{
      width:100%; padding:10px; border-radius:12px;
      border:1px solid rgba(59,130,246,.35); background:#fff; color:#0f172a;
    }
    .dark .controls .field input, .dark .controls .field select{
      background:#0f172a; color:#f1f5f9; border-color:var(--tbl-accent);
    }
    .grid-4{ display:grid; gap:12px; grid-template-columns:repeat(4,1fr) }
    .grid-3{ display:grid; gap:12px; grid-template-columns:repeat(3,1fr) }
    @media(max-width:900px){ .grid-4{grid-template-columns:1fr 1fr} }
    @media(max-width:640px){ .grid-4,.grid-3{grid-template-columns:1fr} }

    .row-actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }

    .table-wrap{ overflow:auto; }
    table.schedule{ width:100%; border-collapse:separate; border-spacing:0; min-width:780px }
    .schedule th,.schedule td{
      border:1px solid color-mix(in oklab, var(--tbl-accent) 32%, transparent);
      padding:8px; vertical-align:top; background:var(--card);
    }
    .schedule th{
      background: color-mix(in oklab, var(--tbl-accent) 12%, white);
      color:#0c4a6e; position:sticky; top:0; z-index:1
    }
    .dark .schedule th{ background:color-mix(in oklab, var(--tbl-accent) 25%, #0b1220); color:#c7d2fe }

    .time-col{ width:140px; white-space:nowrap; text-align:center; font-weight:700 }
    .day-col{ width:120px; text-align:center; font-weight:700 }

    .cell{ min-height:72px; display:flex; flex-direction:column; gap:6px; padding:2px }
    .cell input{
      width:100%; padding:8px 10px; border-radius:10px;
      border:1px solid color-mix(in oklab, var(--tbl-accent) 35%, transparent);
      background:#fff; color:#0f172a
    }
    .dark .cell input{ background:#0f172a; color:#f1f5f9; border-color:var(--tbl-accent) }
    .cell .mini{ display:flex; gap:6px }
    .cell .mini input{ flex:1 }

    /* Ø®Ù„Ø§ÙŠØ§ ÙØ§Ø±ØºØ© */
    td.empty{ border-color: transparent; background: transparent; }
    td.empty .cell input{ border-color: transparent; background: transparent; color: transparent; }

    /* Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©: ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù† ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„ÙØ§Ø±Øº */
    @media print{
      .topbar,.controls,.row-actions,.toast{ display:none !important }
      .card{ box-shadow:none; border:none }
      body{ background:#fff }
      @page { size: A4 landscape; margin: 10mm; }
      table.schedule{ min-width:auto; table-layout:fixed; }
      .schedule th,.schedule td{ padding:4px; font-size:12px }
      .cell input{ padding:2px 4px; border:0; background:transparent }
      td.empty{ border-color: transparent; }
    }
  </style>
</head>
<body class="bg-none">
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ) -->
  <div class="topbar">
    <div class="left-actions">
      <a class="btn" href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a class="btn" href="programs.html">Ù…Ø³Ø§Ø­Ø© Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ</a>
    </div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†/Ø§Ù„ÙØ§ØªØ­">ğŸŒ“</button>
    </div>
    <div class="user">
      <span id="nav-auth" style="display:none; gap:10px"></span>
      <a id="nav-profile" class="btn" href="profile.html" style="display:none">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a>
    </div>
  </div>

  <header>
    <div class="hero">
      <h1 class="logo">Ù…ÙØ³Ù€Ù€Ø§Ø±</h1>
      <div class="tag"><span class="dot"></span>Ø¬Ø¯ÙˆÙ„ Ø­ØµØµ Ù…Ø±Ù† â€” Ø£Ù„ÙˆØ§Ù† Ø¬Ù…ÙŠÙ„Ø© â€” Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.</div>
    </div>
  </header>

  <main class="container">
    <section class="card controls">
      <h2 class="title" style="margin-top:0">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„</h2>

      <div class="grid-4">
        <div class="field">
          <label>Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</label>
          <select id="days">
            <option value="sun-thu" selected>Ø§Ù„Ø£Ø­Ø¯ â†’ Ø§Ù„Ø®Ù…ÙŠØ³ (5 Ø£ÙŠØ§Ù…)</option>
            <option value="sun-wed">Ø§Ù„Ø£Ø­Ø¯ â†’ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ (4 Ø£ÙŠØ§Ù…)</option>
          </select>
        </div>

        <div class="field">
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ/Ø§Ù„ÙŠÙˆÙ…</label>
          <select id="periods">
            <option>5</option><option>6</option><option selected>7</option><option>8</option>
          </select>
        </div>

        <div class="field">
          <label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…</label>
          <input id="startTime" type="time" value="07:00">
        </div>

        <div class="field">
          <label>Ù…Ø¯Ø© Ø§Ù„Ø­ØµØ© (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
          <select id="slotMins">
            <option>35</option><option>45</option><option selected>50</option><option>55</option><option>60</option>
          </select>
        </div>
      </div>

      <div class="grid-3" style="margin-top:6px">
        <div class="field">
          <label>Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙØ­Ø©</label>
          <select id="bg">
            <option value="none" selected>Ø¨Ø¯ÙˆÙ†</option>
            <option value="floral">ÙˆØ±ÙˆØ¯ ğŸŒ¸</option>
            <option value="leaves">ÙˆØ±Ù‚ Ø´Ø¬Ø± ğŸƒ</option>
          </select>
        </div>
        <div class="field">
          <label>Ù„ÙˆÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„</label>
          <input id="tblColor" type="color" value="#3b82f6">
        </div>
        <div class="field">
          <label style="visibility:hidden">-</label>
          <button class="btn" id="toggleColors">ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯</button>
        </div>
      </div>

      <div class="row-actions">
        <button class="btn" id="rebuild">Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
        <button class="btn" id="addRow">+ Ø­ØµØ© Ø¥Ø¶Ø§ÙÙŠØ©</button>
        <button class="btn" id="addCol">+ ÙŠÙˆÙ… Ø¥Ø¶Ø§ÙÙŠ</button>
        <button class="btn" id="clearAll">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>

        <button class="btn" id="editColors">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†</button>
        <button class="btn" id="exportCsv">ØªØµØ¯ÙŠØ± CSV</button>
        <button class="btn" id="savePng">Ø­ÙØ¸ ÙƒØµÙˆØ±Ø© PNG</button>
        <button class="btn" id="print">Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>

      <div id="colorPanel" class="card" style="display:none; margin-top:8px; padding:10px">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
          <strong>Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¯:</strong>
          <small class="muted">Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø«Ù… Ø§Ø®ØªØ§Ø±ÙŠ Ù„ÙˆÙ†Ù‡Ø§ Ù‡Ù†Ø§ â€” ØªÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</small>
        </div>
        <div id="colorList" style="display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px"></div>
      </div>

      <div class="legend" style="margin-top:6px">
        <span><i></i> Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ø±ÙŠØ±: Ø§Ù„Ù…Ø§Ø¯Ø©ØŒ Ø§Ù„Ù…Ø¹Ù„Ù…/Ù€Ø©ØŒ Ø§Ù„Ù‚Ø§Ø¹Ø©</span>
        <span><i style="background:#86efac"></i> ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…</span>
        <span><i style="background:#fde68a"></i> Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¯ ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</span>
      </div>
    </section>

    <section class="card">
      <div class="table-wrap" id="tableWrap">
        <table class="schedule" id="tbl"></table>
      </div>
    </section>
  </main>

  <footer>
    <p class="foot-line">Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø´Ø±Ø§Ø±Ø© ØµØºÙŠØ±Ø©â€¦ ØªÙØ¶ÙŠØ¡ Ø¹Ù‚ÙˆÙ„Ù‹Ø§ ÙƒØ¨ÙŠØ±Ø©.</p>
    <p class="foot-name">Ù†Ø¯Ù‰ Ø§Ù„Ù…Ø¬ÙŠØ±Ø´</p>
  </footer>

  <div class="toast" id="toast"></div>

  <!-- ===== ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª (Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹) ===== -->
  <!-- Auth0 SDK (Ø¨Ø¯ÙˆÙ† defer Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© Ù‚Ø¨Ù„ require-auth) -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>

  <!-- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© (ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Auth0) -->
  <script defer src="assets/js/require-auth.js"></script>

  <!-- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Supabase Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· -->
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/supabase-client.js"></script>

  <!-- Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ùˆ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª -->
  <script defer src="assets/js/storage.js"></script>
  <script defer src="app.js"></script>

  <!-- Ù…ÙƒØªØ¨Ø© Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙƒØµÙˆØ±Ø© -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØµÙØ­Ø© -->
  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);

    const DB_KEY='masar';
    const DEFAULT_DAYS=['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];

    const tbl = $('#tbl');
    const tableWrap = $('#tableWrap');

    const daysSel   = $('#days');
    const periodsSel= $('#periods');
    const startTime = $('#startTime');
    const slotMins  = $('#slotMins');

    const bgSel     = $('#bg');
    const colorInp  = $('#tblColor');

    /* ===== Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¯ (Ù…Ø¹ Ù„ÙˆØ­Ø©) ===== */
    function loadColorMap(){ const all=userDB.get(DB_KEY,{}); return all.__colors||{}; }
    function saveColorMap(map){ const all=userDB.get(DB_KEY,{}); all.__colors=map||{}; userDB.set(DB_KEY,all); }
    function hashColor(name){ let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))%360; return `hsl(${h} 70% 88%)`; }
    function getColorForSubject(subj){ if(!subj) return ''; const map=loadColorMap(); if(!map[subj]){ map[subj]=hashColor(subj); saveColorMap(map);} return map[subj]; }
    function colorizeCells(){
      const map=loadColorMap();
      document.querySelectorAll('#tbl tbody .cell').forEach(cell=>{
        const subj = cell.querySelector('input[placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©"]')?.value.trim();
        cell.parentElement.classList.toggle('empty', !(cell.querySelector('input[placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©"]').value.trim()
                                                     ||cell.querySelector('input[placeholder="Ø§Ù„Ù…Ø¹Ù„Ù…/Ù€Ø©"]').value.trim()
                                                     ||cell.querySelector('input[placeholder="Ø§Ù„Ù‚Ø§Ø¹Ø©"]').value.trim()));
        cell.style.background = (window.__colorsOn && subj) ? (map[subj] || getColorForSubject(subj)) : '';
      });
    }
    function collectSubjects(){
      const set=new Set();
      document.querySelectorAll('#tbl tbody input[placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©"]').forEach(i=>{
        const v=(i.value||'').trim(); if(v) set.add(v);
      });
      return [...set];
    }
    function renderColorPanel(){
      const subs=collectSubjects();
      const map=loadColorMap();
      const list=$('#colorList'); list.innerHTML='';
      if(!subs.length){ list.innerHTML='<em class="muted">Ø£Ø¯Ø®Ù„ÙŠ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø£ÙˆÙ„Ù‹Ø§ Ø«Ù… Ø§ÙØªØ­ÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙˆØ­Ø©.</em>'; return; }
      subs.forEach(name=>{
        const wrap=document.createElement('div');
        wrap.style.display='grid'; wrap.style.gridTemplateColumns='1fr auto'; wrap.style.gap='8px';
        const t=document.createElement('input'); t.type='text'; t.value=name; t.readOnly=true;
        t.style.borderRadius='10px'; t.style.border='1px solid rgba(59,130,246,.3)'; t.style.padding='8px 10px';
        const c=document.createElement('input'); c.type='color';
        // ØªØ­ÙˆÙŠÙ„ HSL Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ù„Ù‰ HEX Ø³Ø±ÙŠØ¹
        let cur=map[name]||hashColor(name);
        if(cur.startsWith('hsl')){ const m=cur.match(/hsl\((\d+)\s+(\d+)%\s+(\d+)%\)/); if(m){const h=+m[1]/360,s=+m[2]/100,l=+m[3]/100;
          const a=(1-Math.abs(2*l-1))*s, f=(n)=>(l-a/2 + a*Math.max(-1,Math.min(Math.min(n-1,3-n),1)));
          const r=f(3*h),g=f(3*h-1),b=f(3*h-2), hex=(x)=>('#'+[r,g,b].map(v=>Math.round(v*255)).map(n=>n.toString(16).padStart(2,'0')).join(''));
          cur=hex();
        }}
        c.value=cur;
        c.addEventListener('input',()=>{ const m=loadColorMap(); m[name]=c.value; saveColorMap(m); colorizeCells(); });
        wrap.appendChild(t); wrap.appendChild(c); list.appendChild(wrap);
      });
    }

    /* ===== ÙˆÙ‚Øª ===== */
    function timeToMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
    function minutesToTime(m){ const h=Math.floor(m/60), mm=(m%60+'').padStart(2,'0'); return (h+'').padStart(2,'0')+':'+mm; }
    function buildTimes(start, slot, count){ const out=[]; let m=timeToMinutes(start); for(let i=0;i<count;i++){ const f=minutesToTime(m); m+=slot; const t=minutesToTime(m); out.push(`${f}â€”${t}`);} return out; }

    function readDays(){
      return (daysSel.value==='sun-wed') ? DEFAULT_DAYS.slice(0,4) : DEFAULT_DAYS.slice();
    }

    /* ===== Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ===== */
    function makeCell(key, data){
      const td=document.createElement('td');
      const wrap=document.createElement('div'); wrap.className='cell';
      const s=document.createElement('input'); s.placeholder='Ø§Ù„Ù…Ø§Ø¯Ø©';     s.value=data.subj||'';
      const mini=document.createElement('div'); mini.className='mini';
      const t=document.createElement('input'); t.placeholder='Ø§Ù„Ù…Ø¹Ù„Ù…/Ù€Ø©';  t.value=data.teacher||'';
      const r=document.createElement('input'); r.placeholder='Ø§Ù„Ù‚Ø§Ø¹Ø©';     r.value=data.room||'';
      mini.appendChild(t); mini.appendChild(r);
      wrap.appendChild(s); wrap.appendChild(mini); td.appendChild(wrap);

      const save=()=>{ const cur=userDB.get(DB_KEY,{}); cur[key]={subj:s.value, teacher:t.value, room:r.value}; userDB.set(DB_KEY,cur); colorizeCells(); };
      [s,t,r].forEach(el=>el.addEventListener('input', save));

      // ÙˆØ³Ù… Ø§Ù„Ø®Ù„ÙŠØ© ÙØ§Ø±ØºØ©/ØºÙŠØ± ÙØ§Ø±ØºØ© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
      td.classList.toggle('empty', !(s.value.trim()||t.value.trim()||r.value.trim()));
      return td;
    }

    function build(){
      const days = readDays();
      const periods = parseInt(periodsSel.value,10)||7;
      const start   = startTime.value || '07:00';
      const mins    = parseInt(slotMins.value,10)||50;

      const saved = userDB.get(DB_KEY,{});
      const times = buildTimes(start, mins, periods);

      const thead=document.createElement('thead');
      const hr=document.createElement('tr');
      const th0=document.createElement('th'); th0.className='time-col'; th0.textContent='Ø§Ù„ÙˆÙ‚Øª \\ Ø§Ù„ÙŠÙˆÙ…'; hr.appendChild(th0);
      days.forEach(d=>{ const th=document.createElement('th'); th.className='day-col'; th.style.borderColor='color-mix(in oklab, var(--tbl-accent) 32%, transparent)'; th.textContent=d; hr.appendChild(th); });
      thead.appendChild(hr);

      const tbody=document.createElement('tbody');
      for(let r=0;r<periods;r++){
        const tr=document.createElement('tr');
        const tdTime=document.createElement('td'); tdTime.className='time-col'; tdTime.textContent=times[r]||''; tr.appendChild(tdTime);
        for(let c=0;c<days.length;c++){
          const key=`r${r}c${c}`;
          const data=saved[key]||{subj:'',teacher:'',room:''};
          tr.appendChild(makeCell(key, data));
        }
        tbody.appendChild(tr);
      }

      tbl.innerHTML=''; tbl.appendChild(thead); tbl.appendChild(tbody);

      // Ø§Ø­ÙØ¸ Ø§Ù„Ù…ÙŠØªØ§ + Ù„ÙˆÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ + Ø§Ù„Ø®Ù„ÙÙŠØ©
      const meta=userDB.get(DB_KEY,{});
      meta.__meta={days, periods, startAt:start, slotMins:mins, colorsOn:!!window.__colorsOn, bg:bgSel.value, accent: colorInp.value};
      userDB.set(DB_KEY, meta);

      document.documentElement.style.setProperty('--tbl-accent', colorInp.value);
      document.body.classList.remove('bg-none','bg-floral','bg-leaves');
      document.body.classList.add(bgSel.value==='floral'?'bg-floral':bgSel.value==='leaves'?'bg-leaves':'bg-none');

      colorizeCells();
    }

    /* ===== CSV / PNG / Ø·Ø¨Ø§Ø¹Ø© ===== */
    function tableToCsv(){
      const meta=userDB.get(DB_KEY,{});
      const days=(meta.__meta?.days)||DEFAULT_DAYS;
      const periods=meta.__meta?.periods || (parseInt(periodsSel.value,10)||7);
      const startAt=meta.__meta?.startAt || (startTime.value||'07:00');
      const slot=meta.__meta?.slotMins || (parseInt(slotMins.value,10)||50);
      const times=buildTimes(startAt, slot, periods);
      const rows=[['Ø§Ù„Ø²Ù…Ù†','Ø§Ù„ÙŠÙˆÙ…','Ø§Ù„Ù…Ø§Ø¯Ø©','Ø§Ù„Ù…Ø¹Ù„Ù…/Ù€Ø©','Ø§Ù„Ù‚Ø§Ø¹Ø©']];
      for(let r=0;r<periods;r++){
        for(let c=0;c<days.length;c++){
          const key=`r${r}c${c}`; const cell=(meta[key])||{subj:'',teacher:'',room:''};
          rows.push([times[r]||'', days[c]||'', cell.subj||'', cell.teacher||'', cell.room||'']);
        }
      }
      const bom='\uFEFF';
      return bom + rows.map(r=>r.map(x=>`"${(x||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
    }
    function downloadCsv(){
      const blob=new Blob([tableToCsv()],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob), a=document.createElement('a');
      const stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href=url; a.download=`masar-schedule-${stamp}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    async function savePng(){
      const canvas=await html2canvas(tableWrap,{ backgroundColor:getComputedStyle(document.body).getPropertyValue('--bg')||null, scale:window.devicePixelRatio||2, useCORS:true });
      const a=document.createElement('a'); const stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href=canvas.toDataURL('image/png'); a.download=`masar-schedule-${stamp}.png`; document.body.appendChild(a); a.click(); a.remove();
    }

    /* ===== Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ø¬Ù‡Ø© ===== */
    $('#rebuild').addEventListener('click', build);
    $('#addRow').addEventListener('click', ()=>{ periodsSel.value=(parseInt(periodsSel.value,10)+1).toString(); build(); });
    $('#addCol').addEventListener('click', ()=>{
      // Ù„Ù…Ø§ Ù†Ø¶ÙŠÙ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ Ù†ØªØ­ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ 6 Ø£ÙŠØ§Ù… Ù…Ø¹ Ø§Ø³Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ
      const meta=userDB.get(DB_KEY,{});
      const curDays=readDays();
      curDays.push('ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯');
      meta.__meta = meta.__meta || {};
      meta.__meta.days = curDays;
      userDB.set(DB_KEY, meta);
      // Ù†Ø¬Ø¨Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ "5 Ø£ÙŠØ§Ù…" (Ù†Ù‚Ø·Ø© Ù…Ø±Ù†Ø©) Ù„ÙƒÙ† Ù†Ø¨Ù†ÙŠ Ù…Ù† Ø§Ù„Ù…ÙŠØªØ§
      build();
    });
    $('#clearAll').addEventListener('click', ()=>{ if(!confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŸ')) return; userDB.remove(DB_KEY); build(); toast && toast('ØªÙ… Ø§Ù„Ù…Ø³Ø­ âœ“'); });
    $('#print').addEventListener('click', ()=>window.print());
    document.getElementById('exportCsv').addEventListener('click', downloadCsv);
    document.getElementById('savePng').addEventListener('click', savePng);

    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù
    document.getElementById('toggleColors').addEventListener('click', ()=>{
      window.__colorsOn = !window.__colorsOn;
      document.getElementById('toggleColors').textContent = window.__colorsOn ? 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ„ÙˆÙŠÙ†' : 'ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯';
      const meta=userDB.get(DB_KEY,{}); meta.__meta=meta.__meta||{}; meta.__meta.colorsOn=!!window.__colorsOn; userDB.set(DB_KEY, meta);
      colorizeCells();
    });

    // Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†
    document.getElementById('editColors').addEventListener('click', ()=>{
      const panel = document.getElementById('colorPanel');
      panel.style.display = (panel.style.display==='none') ? '' : 'none';
      if(panel.style.display!=='none') renderColorPanel();
    });

    // ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©/Ø§Ù„Ù„ÙˆÙ†
    bgSel.addEventListener('change', build);
    colorInp.addEventListener('input', build);

    /* ===== Helpers ===== */
    function readDays(){
      // Ø¥Ù† Ø³Ø¨Ù‚ ÙˆØ¶ÙÙ†Ø§ Ø£ÙŠØ§Ù… Ù…Ø®ØµÙ‘ØµØ© ÙÙŠ Ø§Ù„Ù…ÙŠØªØ§ (Ù…Ù† +ÙŠÙˆÙ… Ø¥Ø¶Ø§ÙÙŠ) Ù†Ø³ØªØ¹Ù…Ù„Ù‡Ø§
      const meta=userDB.get(DB_KEY,{});
      if(meta.__meta?.days && meta.__meta.days.length) return meta.__meta.days.slice();
      return (daysSel.value==='sun-wed') ? DEFAULT_DAYS.slice(0,4) : DEFAULT_DAYS.slice();
    }

    /* ===== ØªÙ‡ÙŠØ¦Ø© ===== */
    document.addEventListener('DOMContentLoaded', ()=>{
      const saved=userDB.get(DB_KEY,{});
      const m=saved.__meta;
      if(m){
        startTime.value=m.startAt||'07:00';
        slotMins.value=(m.slotMins||50).toString();
        periodsSel.value=(m.periods||7).toString();
        bgSel.value = m.bg || 'none';
        colorInp.value = m.accent || '#3b82f6';
        window.__colorsOn = (m.colorsOn!==undefined)?!!m.colorsOn:true;
      }else{
        window.__colorsOn = true;
      }
      document.getElementById('toggleColors').textContent = window.__colorsOn ? 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ„ÙˆÙŠÙ†' : 'ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯';
      build();
    });
  })();
  </script>
</body>
</html>
