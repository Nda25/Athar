<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مســار — جدولي للترم</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <meta name="color-scheme" content="dark light">

  <!-- حفظ الجدول كصورة -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <style>
    /* أزرار أعرض شوي */
    .btn{ min-width:170px }

    /* حقول أكبر ومريحة */
    .wizard{ display:grid; gap:16px }
    .field{ margin:10px 0 }
    .field label{ display:block; font-weight:700; margin:6px 0 }
    .field input,.field select{
      width:100%; padding:14px 12px; border-radius:14px; font-size:16px;
      border:1px solid rgba(59,130,246,.35); background:#fff; color:#0f172a;
    }
    .dark .field input,.dark .field select{
      background:#0f172a; color:#f1f5f9; border-color:#3b82f6;
    }

    /* أزرار أرقام الحصص */
    .slots{ display:flex; flex-wrap:wrap; gap:8px }
    .slot{
      border:1px solid rgba(59,130,246,.28); background:var(--card);
      padding:10px 14px; border-radius:999px; cursor:pointer; user-select:none;
      font-weight:700; font-size:15px;
    }
    .slot.active{
      font-weight:800; border-color:#3b82f6; background:var(--sea-100);
    }
    .dark .slot.active{ background:#0f172a; border-color:#60a5fa }

    /* إدخالات المادة/الفصل */
    .inputs{ display:grid; gap:10px }
    .row{
      display:grid; grid-template-columns:120px 1fr 1fr; gap:10px; align-items:center;
    }
    .row input{ padding:12px 10px; border-radius:12px; font-size:15px;
      border:1px solid rgba(59,130,246,.35);
    }
    .pill{
      font-weight:800; text-align:center; padding:10px 12px; border-radius:999px;
      border:1px solid rgba(59,130,246,.25); background:var(--card)
    }

    /* الجدول الناتج */
    .tt-wrap{ overflow:auto; border:1px solid rgba(59,130,246,.22);
      border-radius:16px; background:var(--card); box-shadow:var(--shadow) }
    table.timetable{ width:100%; border-collapse:separate; border-spacing:0; min-width:720px }
    .timetable th,.timetable td{
      border-bottom:1px solid rgba(59,130,246,.18);
      border-inline-end:1px solid rgba(59,130,246,.12);
      padding:12px; text-align:center; vertical-align:middle
    }
    .timetable th{
      position:sticky; top:0; background:linear-gradient(180deg,#ffffffcc,#ffffffaa);
      backdrop-filter:blur(4px); font-weight:800; color:var(--sea-700)
    }
    .dark .timetable th{ background:linear-gradient(180deg,#0f172acc,#0f172aaa); color:#93c5fd }
    .timetable td .sub{
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      padding:8px 10px; border-radius:999px; font-weight:800; border:1px solid rgba(0,0,0,.06);
      box-shadow:0 6px 18px rgba(0,0,0,.12); white-space:nowrap
    }
    .timetable td .cls{ display:block; font-size:12px; opacity:.85; margin-top:4px }

    .legend{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }
    .legend .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(59,130,246,.22); background:var(--card) }
    .legend .dot{ width:12px; height:12px; border-radius:50% }

    .quote{ margin-top:14px; text-align:center; color:var(--muted); font-weight:700;
      border-top:1px dashed rgba(59,130,246,.25); padding-top:10px }

    /* للطباعة */
    @media print{
      .topbar,.wizard-card,.toast{ display:none!important }
      header{ padding-bottom:0 }
      .tt-wrap{ box-shadow:none; border:none }
      .quote{ border:none; padding-top:0 }
    }
  </style>
</head>
<body>
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <!-- الشريط -->
  <div class="topbar">
    <div class="left-actions"><a class="btn" href="index.html">الرئيسية</a></div>
    <div class="actions"><button class="btn" id="themeToggle">🌓</button></div>
    <div class="user"><a class="btn" href="programs.html">مساحة إبداعي</a></div>
  </div>

  <!-- الهيدر -->
  <header>
    <div class="hero">
      <h1 class="logo">مســار</h1>
      <div class="tag"><span class="dot"></span>رتّب حصصك… حتى يتضح المسـار.</div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- الساحر (خطوة بخطوة) -->
      <section class="card wizard-card">
        <h2 class="title" style="margin-top:0">مدخلات الجدول</h2>

        <div class="wizard">
          <div class="field">
            <label>اختر اليوم</label>
            <select id="daySel">
              <option value="الأحد">الأحد</option>
              <option value="الإثنين">الإثنين</option>
              <option value="الثلاثاء">الثلاثاء</option>
              <option value="الأربعاء">الأربعاء</option>
              <option value="الخميس">الخميس</option>
            </select>
          </div>

          <div class="field">
            <label>عدد الحصص في الجدول (ثابت)</label>
            <select id="totalSlots">
              <option>5</option>
              <option>6</option>
              <option>7</option>
              <option selected>8</option>
            </select>
            <div class="muted-mini">يُستخدم لرسم الجدول النهائي (مثلًا 8 أعمدة للحصص).</div>
          </div>

          <div class="field">
            <label>عدد حصص هذا اليوم</label>
            <select id="countToday">
              <option value="0">لا يوجد</option>
              <option value="1">حصة</option>
              <option value="2">حصتان</option>
              <option value="3">3 حصص</option>
              <option value="4">4 حصص</option>
              <option value="5">5 حصص</option>
              <option value="6">6 حصص</option>
              <option value="7">7 حصص</option>
              <option value="8">8 حصص</option>
            </select>
          </div>

          <div class="field">
            <label>اختاري أرقام الحصص لليوم</label>
            <div id="slots" class="slots"></div>
            <div class="muted-mini">اختاري مواقع الحصص من 1 إلى العدد الكلي.</div>
          </div>

          <div id="inputs" class="inputs"></div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
            <button class="btn" id="saveDay">حفظ هذا اليوم</button>
            <button class="btn" id="nextDay">اليوم التالي →</button>
            <button class="btn primary" id="build" style="display:none">ولّد لي الجدول ✨</button>
          </div>
        </div>
      </section>

      <!-- الناتج -->
      <section class="card" id="outCard" style="display:none">
        <h2 class="title">جدول مســاري</h2>
        <div class="tt-wrap" id="ttWrap">
          <table class="timetable" id="tt"></table>
        </div>
        <div class="legend" id="legend"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <button class="btn" id="printBtn">طباعة</button>
          <button class="btn" id="pngBtn">حفظ كصورة PNG</button>
          <button class="btn" id="editBtn">تعديل المدخلات</button>
        </div>

        <div class="quote" id="quote"></div>
      </section>
    </div>
  </main>

  <footer>
    <p class="foot-line">التعليم شرارة صغيرة… تُضيء عقولًا كبيرة.</p>
    <p class="foot-name">ندى المجيرش</p>
  </footer>

  <div class="toast" id="toast"></div>

  <!-- لو عندك app.js (الثيم/التوست…) خليه هنا -->
  <script src="app.js"></script>

  <script>
    // أدوات صغيرة
    const $=(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    function toast(m){ let t=$('.toast'); if(!t){t=document.createElement('div');t.className='toast';document.body.appendChild(t);} t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); }

    // ثابت
    const DAYS=['الأحد','الإثنين','الثلاثاء','الأربعاء','الخميس'];
    const KEY='athar:masar2';

    // حالة
    let state = load() || { totalSlots:8, data:{} }; // data[day][slot]={sub,cls}

    // عناصر
    const daySel=$('#daySel');
    const totalSel=$('#totalSlots');
    const countSel=$('#countToday');
    const slotsWrap=$('#slots');
    const inputsWrap=$('#inputs');
    const buildBtn=$('#build');
    const nextBtn=$('#nextDay');

    // ألوان للمواد
    const PALETTE=[
      ['#e0f2fe','#0284c7'],['#dbeafe','#1d4ed8'],['#e9d5ff','#7e22ce'],
      ['#fee2e2','#b91c1c'],['#dcfce7','#166534'],['#fef9c3','#a16207'],
      ['#ffe4e6','#be123c'],['#ede9fe','#6d28d9'],['#fce7f3','#be185d']
    ];
    function colorFor(s){
      s=(s||'').trim();let h=0;for(let i=0;i<s.length;i++)h=(h*31+s.charCodeAt(i))>>>0;
      const [bg,fg]=PALETTE[h%PALETTE.length];return{bg,fg};
    }

    const QUOTES=[
      'هذا اليوم سيمضي كما مضى الأمس… ولن يبقى منه إلا الأثر. 🌿',
      'خطة بسيطة اليوم… أثر عميق غدًا.',
      'كل حصة فرصة لصناعة أثر جديد.'
    ];

    // تحميل/حفظ
    function load(){ try{return JSON.parse(localStorage.getItem(KEY)||'null');}catch(_){return null;} }
    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

    // رسم أزرار الحصص
    function drawSlots(){
      slotsWrap.innerHTML='';
      const N=parseInt(totalSel.value,10)||8;
      const d=daySel.value;
      const dayData = state.data[d] || {};
      for(let p=1;p<=N;p++){
        const btn=document.createElement('div');
        btn.className='slot' + (dayData[p] ? ' active' : '');
        btn.textContent=p;
        btn.dataset.p=p;
        btn.addEventListener('click',()=>{
          toggleSlot(p);
          drawSlots();
          drawInputs();
          save();
          updateCountTodayFromState();
        });
        slotsWrap.appendChild(btn);
      }
    }

    // تفعيل/تعطيل فتحة
    function toggleSlot(p){
      const d=daySel.value;
      if(!state.data[d]) state.data[d] = {};
      if(state.data[d][p]) delete state.data[d][p];
      else state.data[d][p]={sub:'',cls:''};
      limitByCountToday();
    }

    // احترام عدد حصص اليوم
    function limitByCountToday(){
      const d = daySel.value;
      const want = parseInt(countSel.value,10) || 0;
      if (want === 0) return;
      const ps = Object.keys(state.data[d]||{}).map(n=>+n).sort((a,b)=>a-b);
      if (ps.length > want) {
        ps.slice(want).forEach(p => delete state.data[d][p]);
      }
    }

    // رسم حقول المادة/الفصل
    function drawInputs(){
      inputsWrap.innerHTML='';
      const d=daySel.value;
      const dayData=state.data[d]||{};
      const ps=Object.keys(dayData).map(n=>+n).sort((a,b)=>a-b);

      ps.forEach(p=>{
        const row=document.createElement('div');
        row.className='row';
        row.innerHTML=`
          <div class="pill">الحصة ${p}</div>
          <input type="text" placeholder="المادة" data-p="\${p}" data-k="sub">
          <input type="text" placeholder="الفصل/الشعبة" data-p="\${p}" data-k="cls">
        `;
        inputsWrap.appendChild(row);
        // تعبئة محفوظ
        row.querySelector('[data-k="sub"]').value = dayData[p]?.sub||'';
        row.querySelector('[data-k="cls"]').value = dayData[p]?.cls||'';
      });

      // حفظ مباشر
      inputsWrap.oninput = (e)=>{
        const el=e.target; const p=+el.dataset.p; const k=el.dataset.k;
        if(!p||!k) return;
        if(!state.data[d]) state.data[d]={};
        state.data[d][p]=state.data[d][p]||{sub:'',cls:''};
        state.data[d][p][k]=el.value;
        save();
      };
    }

    // تحديث عدد حصص اليوم من الحالة
    function updateCountTodayFromState() {
      const d = daySel.value;
      const dayData = state.data[d] || {};
      countSel.value = String(Object.keys(dayData).length || 0);
    }

    // حفظ اليوم الحالي
    $('#saveDay').addEventListener('click', ()=>{
      state.totalSlots = parseInt(totalSel.value,10)||8;
      limitByCountToday();
      save();
      drawSlots();
      drawInputs();
      toast('تم حفظ اليوم ✓');
      updateNextBuildButtons();
    });

    // اليوم التالي
    nextBtn.addEventListener('click', ()=>{
      const i = DAYS.indexOf(daySel.value);
      if(i < DAYS.length-1){
        daySel.value = DAYS[i+1];
        afterDayChange();
      }
      updateNextBuildButtons();
    });

    // تغيّرات القيم
    daySel.addEventListener('change', afterDayChange);
    totalSel.addEventListener('change', ()=>{
      state.totalSlots=parseInt(totalSel.value,10)||8; save(); drawSlots(); drawInputs();
    });
    countSel.addEventListener('change', ()=>{
      limitByCountToday(); save(); drawSlots(); drawInputs();
    });

    function afterDayChange(){
      totalSel.value = state.totalSlots || 8;
      updateCountTodayFromState();
      drawSlots();
      drawInputs();
      updateNextBuildButtons();
    }

    function updateNextBuildButtons(){
      if(daySel.value === 'الخميس'){
        nextBtn.style.display='none';
        buildBtn.style.display='';
      }else{
        nextBtn.style.display='';
        buildBtn.style.display='none';
      }
    }

    // توليد الجدول النهائي
    const tt=$('#tt'), legend=$('#legend'), outCard=$('#outCard');
    $('#build').addEventListener('click', ()=>{
      // رأس الجدول
      const N=state.totalSlots||8;
      tt.innerHTML='';
      const thead=document.createElement('thead');
      const hr=document.createElement('tr');
      hr.innerHTML='<th>الحصة</th>'+DAYS.map(d=>`<th>${d}</th>`).join('');
      thead.appendChild(hr); tt.appendChild(thead);

      // جسم الجدول
      const tbody=document.createElement('tbody');
      for(let p=1;p<=N;p++){
        const tr=document.createElement('tr');
        tr.innerHTML=`<th>الحصة ${p}</th>` + DAYS.map(d=>{
          const item=state.data?.[d]?.[p];
          if(!item || (!item.sub && !item.cls)) return '<td></td>';
          const {bg,fg}=colorFor(item.sub||d);
          return `<td>
            <div class="sub" style="background:${bg};color:${fg}">${item.sub||'—'}</div>
            ${item.cls? `<span class="cls">${item.cls}</span>`:''}
          </td>`;
        }).join('');
        tbody.appendChild(tr);
      }
      tt.appendChild(tbody);

      // وسيلة الإيضاح
      legend.innerHTML='';
      const subjects=new Set();
      DAYS.forEach(d=>{
        Object.values(state.data[d]||{}).forEach(v=>{ if(v?.sub) subjects.add(v.sub.trim()); });
      });
      Array.from(subjects).slice(0,15).forEach(s=>{
        const {bg,fg}=colorFor(s);
        const chip=document.createElement('div'); chip.className='chip';
        chip.innerHTML=`<span class="dot" style="background:${bg}"></span><span style="color:${fg};font-weight:800">${s}</span>`;
        legend.appendChild(chip);
      });

      // عبارة تحفيزية
      $('#quote').textContent = QUOTES[Math.floor(Math.random()*QUOTES.length)];
      outCard.style.display='';
      window.scrollTo({top:outCard.offsetTop-10,behavior:'smooth'});
      toast('تم توليد الجدول ✨');
    });

    // حفظ كصورة
    $('#pngBtn').addEventListener('click', async ()=>{
      const wrap=$('#ttWrap');
      if(!window.html2canvas){ toast('مكتبة الصورة غير محمّلة.'); return; }
      const canvas=await html2canvas(wrap,{scale:2,useCORS:true,backgroundColor:null});
      const url=canvas.toDataURL('image/png'); const a=document.createElement('a');
      a.href=url; a.download='masar.png'; a.click();
    });

    // طباعة
    $('#printBtn').addEventListener('click', ()=>window.print());

    // تعديل
    $('#editBtn').addEventListener('click', ()=>{
      document.querySelector('.wizard-card').scrollIntoView({behavior:'smooth',block:'start'});
    });

    // تهيئة أولية
    (function init(){
      const firstEmpty = DAYS.find(d=>!state.data[d] || Object.keys(state.data[d]).length===0) || 'الأحد';
      daySel.value = firstEmpty;
      totalSel.value = state.totalSlots || 8;
      updateCountTodayFromState();
      drawSlots();
      drawInputs();
      updateNextBuildButtons();
    })();
  </script>

  <!-- حماية الصفحات (سيحول غير الموثّقين للصفحة العامة بحسب إعداداتك) -->
<script defer src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
<script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script defer src="assets/js/supabase-client.js"></script>
<script defer src="assets/js/require-auth.js"></script>
<script defer src="app.js"></script>
  script>
  document.getElementById('gen')?.addEventListener('click', async () => {
    await supaLogUsage('masar');
  });
</script>
</body>
</html>
