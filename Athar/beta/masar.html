<!-- masar.html â€” ØµÙØ­Ø© "Ù…ÙØ³Ø§Ø±" (Ù†Ø³Ø®Ø© Ù…ÙØ­Ø¯Ù‘Ø«Ø©) -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙØ³Ù€Ù€Ø§Ø± â€” Ø¬Ø¯Ø§ÙˆÙ„ Ø­ØµØµ Ø£Ù†ÙŠÙ‚Ø©</title>
  <meta name="color-scheme" content="dark light" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <style>
    :root{
      --table-accent:#8b5cf6; /* Ù„ÙˆÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
    }

    /* Ø®Ù„ÙÙŠØ§Øª ÙƒØ¨ÙŠØ±Ø© Ù„Ø·ÙŠÙØ© Ø¨Ø¯ÙˆÙ† ØµÙˆØ± Ø®Ø§Ø±Ø¬ÙŠØ© */
    body.bg-flowers{
      background:
        radial-gradient(24px 24px at 20px 20px #0000, #0000 22px, #fdf2f8 22px) 0 0/120px 120px,
        radial-gradient(24px 24px at 80px 80px #0000, #0000 22px, #fee2e2 22px) 0 0/120px 120px,
        var(--bg);
    }
    body.bg-leaves{
      background:
        radial-gradient(60px 12px at 50px 50px rgba(16,185,129,.12), rgba(16,185,129,.12) 12px, #0000 13px) 0 0/120px 120px,
        radial-gradient(12px 60px at 70px 70px rgba(59,130,246,.10), rgba(59,130,246,.10) 12px, #0000 13px) 0 0/120px 120px,
        var(--bg);
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª ÙÙˆÙ‚ style.css */
    .controls .field{ margin:8px 0 }
    .controls .field label{ display:block; font-weight:700; margin:6px 0 }
    .controls .field input, .controls .field select{
      width:100%; padding:10px; border-radius:12px;
      border:1px solid rgba(59,130,246,.35); background:#fff; color:#0f172a;
    }
    .dark .controls .field input, .dark .controls .field select{
      background:#0f172a; color:#f1f5f9; border-color:#3b82f6;
    }
    .grid-4{ display:grid; gap:12px; grid-template-columns:repeat(4,1fr) }
    .grid-3{ display:grid; gap:12px; grid-template-columns:repeat(3,1fr) }
    @media(max-width:900px){ .grid-4{grid-template-columns:1fr 1fr} }
    @media(max-width:640px){ .grid-4,.grid-3{grid-template-columns:1fr} }

    .table-wrap{ overflow:auto; }
    table.schedule{ width:100%; border-collapse:separate; border-spacing:0; min-width:780px }
    .schedule th,.schedule td{
      border:1px solid color-mix(in oklab, var(--table-accent) 35%, #cbd5e1);
      padding:8px; vertical-align:top; background:var(--card);
    }
    .schedule th{
      background:color-mix(in oklab, var(--table-accent) 12%, var(--sea-50));
      color:#0c4a6e; position:sticky; top:0; z-index:1
    }
    .dark .schedule th{ background:color-mix(in oklab, var(--table-accent) 28%, #0b1220); color:#c7d2fe }
    .time-col{ width:140px; white-space:nowrap; text-align:center; font-weight:700 }
    .day-col{ width:120px; text-align:center; font-weight:700 }

    .cell{ min-height:72px; display:flex; flex-direction:column; gap:6px; padding:2px; transition:background .2s }
    .cell input{
      width:100%; padding:8px 10px; border-radius:10px;
      border:1px solid rgba(59,130,246,.28); background:#fff; color:#0f172a
    }
    .dark .cell input{ background:#0f172a; color:#f1f5f9; border-color:#3b82f6 }
    .cell .mini{ display:flex; gap:6px }
    .cell .mini input{ flex:1 }

    .row-actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
    .legend{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; font-size:.9rem; color:var(--muted) }
    .legend span{ display:inline-flex; align-items:center; gap:6px; }
    .legend i{ width:10px; height:10px; border-radius:2px; display:inline-block; background:var(--sea-300) }

    /* Ø·Ø¨Ø§Ø¹Ø©: ØµÙØ­Ø© A4 Ø£ÙÙ‚ÙŠØ©ØŒ ÙˆØªØ®ÙÙ‘ÙŠ Ø§Ù„ÙØ±Ø§ØºØ§Øª */
    @media print{
      .topbar,.controls,.row-actions,.toast{ display:none !important }
      .card{ box-shadow:none; border:none }
      body{ background:#fff }
      @page { size: A4 landscape; margin: 8mm; }
      table.schedule{ min-width:auto }
      .cell input{ border:none; padding:0; }
      .cell.empty{ opacity:0 } /* ØªØ¨Ù‚Ù‰ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ù„ÙƒÙ† ÙŠÙØ®ÙÙ‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
    }
  </style>
</head>
<body>
  <!-- Ø®Ù„ÙÙŠØ© Ø¹Ø§Ù…Ø© Ù…Ù† Ø«ÙŠÙ… Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
  <div class="backdrop"></div>
  <div class="pattern"></div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div class="topbar">
    <div class="left-actions">
      <a class="btn" href="index.html" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a class="btn" href="programs.html" title="Ù…Ø³Ø§Ø­Ø© Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ">Ù…Ø³Ø§Ø­Ø© Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ</a>
    </div>
    <div class="actions">
      <button class="btn" id="themeToggle" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†/Ø§Ù„ÙØ§ØªØ­">ğŸŒ“</button>
    </div>
    <div class="user">
      <span id="nav-auth" style="display:none; gap:10px"></span>
      <a id="nav-profile" class="btn" href="profile.html" style="display:none">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a>
    </div>
  </div>

  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <header>
    <div class="hero">
      <h1 class="logo">Ù…ÙØ³Ù€Ù€Ø§Ø±</h1>
      <div class="tag"><span class="dot"></span>Ø¬Ø¯Ø§ÙˆÙ„ Ø­ØµØµ Ù…Ø±ØªÙ‘Ø¨Ø© â€” Ø£Ù†ÙŠÙ‚Ø© â€” Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.</div>
    </div>
  </header>

  <main class="container">
    <!-- Ø§Ù„Ø¶ÙˆØ§Ø¨Ø· -->
    <section class="card controls">
      <h2 class="title" style="margin-top:0">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„</h2>

      <div class="grid-4">
        <div class="field">
          <label>Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</label>
          <select id="days">
            <option value="sun-thu" selected>Ø§Ù„Ø£Ø­Ø¯ â†’ Ø§Ù„Ø®Ù…ÙŠØ³ (5 Ø£ÙŠØ§Ù…)</option>
            <option value="sun-wed">Ø§Ù„Ø£Ø­Ø¯ â†’ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ (4 Ø£ÙŠØ§Ù…)</option>
          </select>
        </div>

        <div class="field">
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ/Ø§Ù„ÙŠÙˆÙ…</label>
          <select id="periods">
            <option>5</option><option>6</option><option selected>7</option><option>8</option>
          </select>
        </div>

        <div class="field">
          <label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…</label>
          <input id="startTime" type="time" value="07:00">
        </div>

        <div class="field">
          <label>Ù…Ø¯Ø© Ø§Ù„Ø­ØµØ© (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
          <select id="slotMins"><option>35</option><option>45</option><option selected>50</option><option>55</option><option>60</option></select>
        </div>
      </div>

      <div class="grid-3" style="margin-top:6px">
        <div class="field">
          <label>Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙØ­Ø©</label>
          <select id="bgTheme">
            <option value="none" selected>Ø¨Ø¯ÙˆÙ†</option>
            <option value="flowers">ÙˆØ±Ø¯ ğŸŒ¸</option>
            <option value="leaves">ÙˆØ±Ù‚ Ø´Ø¬Ø± ğŸƒ</option>
          </select>
        </div>

        <div class="field">
          <label>Ù„ÙˆÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„</label>
          <input id="tblColor" type="color" value="#8b5cf6" />
        </div>

        <div class="field">
          <label>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</label>
          <select id="orient">
            <option value="periods-rows" selected>Ø§Ù„Ø£ÙˆÙ‚Ø§Øª = ØµÙÙˆÙ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
            <option value="periods-cols">Ø§Ù„Ø£ÙˆÙ‚Ø§Øª = Ø£Ø¹Ù…Ø¯Ø© (Ù…Ù†Ø§Ø³Ø¨ Ù„ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©)</option>
          </select>
        </div>
      </div>

      <div class="row-actions">
        <button class="btn" id="rebuild">Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
        <button class="btn" id="addRow">+ Ø­ØµØ© Ø¥Ø¶Ø§ÙÙŠØ©</button>
        <button class="btn" id="addCol">+ ÙŠÙˆÙ… Ø¥Ø¶Ø§ÙÙŠ (ÙŠØ­ÙˆÙ‘Ù„ Ù„Ù„ÙˆØ¶Ø¹ 4 Ø£ÙŠØ§Ù… â† 5 Ø£ÙŠØ§Ù…)</button>
        <button class="btn" id="clearAll">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>

        <button class="btn" id="toggleColors">ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…Ù€ÙˆØ§Ø¯</button>
        <button class="btn" id="exportCsv">ØªØµØ¯ÙŠØ± CSV</button>
        <button class="btn" id="savePng">Ø­ÙØ¸ ÙƒØµÙˆØ±Ø© PNG</button>
        <button class="btn" id="print">Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>

      <div class="legend">
        <span><i></i> Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ø±ÙŠØ±: <strong>Ø§Ù„Ù…Ø§Ø¯Ø©</strong>ØŒ <strong>Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„</strong>ØŒ <strong>Ø§Ù„Ù‚Ø§Ø¹Ø©</strong></span>
        <span><i style="background:#86efac"></i> ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…</span>
        <span><i style="background:#fde68a"></i> Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¯ ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</span>
      </div>
    </section>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <section class="card">
      <div class="table-wrap" id="tableWrap">
        <table class="schedule" id="tbl"></table>
      </div>
    </section>
  </main>

  <footer>
    <p class="foot-line">Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø´Ø±Ø§Ø±Ø© ØµØºÙŠØ±Ø©â€¦ ØªÙØ¶ÙŠØ¡ Ø¹Ù‚ÙˆÙ„Ù‹Ø§ ÙƒØ¨ÙŠØ±Ø©.</p>
    <p class="foot-name">Ù†Ø¯Ù‰ Ø§Ù„Ù…Ø¬ÙŠØ±Ø´</p>
  </footer>

  <div class="toast" id="toast"></div>

  <!-- ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª Ù…Ù‡Ù… -->
  <!-- Auth0 SDK (Ø¨Ø¯ÙˆÙ† defer) -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"
          onerror="this.onerror=null;this.src='/assets/vendor/auth0-spa-js.production.js'"></script>
  <!-- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© -->
  <script defer src="assets/js/require-auth.js"></script>
  <!-- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Supabase -->
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/supabase-client.js"></script>
  <!-- Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ Ø¹Ù†Ø¯Ùƒ) -->
  <script defer src="assets/js/storage.js"></script>
  <!-- Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø¥Ù† ÙˆÙØ¬Ø¯) -->
  <script defer src="app.js"></script>
  <!-- Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙƒØµÙˆØ±Ø© -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØµÙØ­Ø© -->
  <script>
  (function(){
    const $ = (sel)=>document.querySelector(sel);

    const tbl         = $('#tbl');
    const daysSel     = $('#days');
    const periodsSel  = $('#periods');
    const startTime   = $('#startTime');
    const slotMinsSel = $('#slotMins');
    const orientSel   = $('#orient');
    const bgThemeSel  = $('#bgTheme');
    const tblColorInp = $('#tblColor');
    const tableWrap   = $('#tableWrap');

    const DB_KEY = 'masar';
    const DEFAULT_DAYS = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];

    /* ============ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©) ============ */
    function loadColorMap(){ const all = userDB.get(DB_KEY, {}); return all.__colors || {}; }
    function saveColorMap(map){ const all = userDB.get(DB_KEY, {}); all.__colors = map || {}; userDB.set(DB_KEY, all); }
    function hashColor(name){
      let h=0; for (let i=0;i<name.length;i++) h = (h*31 + name.charCodeAt(i)) % 360;
      return `hsl(${h} 70% 88%)`;
    }
    function getColorForSubject(subj){
      if(!subj) return '';
      const map = loadColorMap();
      if(!map[subj]){ map[subj] = hashColor(subj); saveColorMap(map); }
      return map[subj];
    }
    function colorizeCells(){
      const map = loadColorMap();
      tbl.querySelectorAll('td .cell').forEach(cell=>{
        const subj = cell.querySelector('input[name^="subj_"]')?.value.trim();
        cell.style.background = (window.__colorsOn && subj) ? (map[subj] || getColorForSubject(subj)) : '';
      });
    }

    /* ============ ÙˆÙ‚Øª ============ */
    function timeToMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
    function minutesToTime(m){ const h=Math.floor(m/60), mm=String(m%60).padStart(2,'0'); return String(h).padStart(2,'0')+':'+mm; }
    function buildTimes(start, slot, count){
      const out=[]; let m=timeToMinutes(start);
      for(let i=0;i<count;i++){ const from=minutesToTime(m); m+=slot; const to=minutesToTime(m); out.push(`${from}â€”${to}`); }
      return out;
    }

    /* ============ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù… ============ */
    function readDays(){
      return (daysSel.value === 'sun-wed') ? DEFAULT_DAYS.slice(0,4) : DEFAULT_DAYS.slice();
    }

    /* ============ Ø­ÙØ¸/ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡ÙŠÙƒÙ„ + Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ù„Ø§ÙŠØ§ ============ */
    function getSaved(){ return userDB.get(DB_KEY, {}); }
    function setSaved(obj){ userDB.set(DB_KEY, obj || {}); }

    /* ============ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø§Ù†Ø© + Ø±Ø¨Ø· Ø§Ù„Ø­ÙØ¸ ============ */
    function makeCell(r,c, saved){
      const key = `r${r}c${c}`;
      const cellData = saved[key] || { subj:'', class:'', room:'' };

      const td = document.createElement('td');
      const wrap = document.createElement('div'); wrap.className = 'cell';

      const s = document.createElement('input');
      s.placeholder = 'Ø§Ù„Ù…Ø§Ø¯Ø©';
      s.value = cellData.subj || '';
      s.name  = `subj_r${r}_c${c}`;
      s.id    = s.name;

      const mini = document.createElement('div'); mini.className='mini';

      const cls = document.createElement('input');
      cls.placeholder = 'Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„';
      cls.value = cellData.class || '';
      cls.name  = `class_r${r}_c${c}`;
      cls.id    = cls.name;

      const room = document.createElement('input');
      room.placeholder = 'Ø§Ù„Ù‚Ø§Ø¹Ø©';
      room.value = cellData.room || '';
      room.name  = `room_r${r}_c${c}`;
      room.id    = room.name;

      mini.appendChild(cls);
      mini.appendChild(room);

      wrap.appendChild(s);
      wrap.appendChild(mini);
      td.appendChild(wrap);

      function persist(){
        const cur = getSaved();
        cur[key] = { subj:s.value, class:cls.value, room:room.value };
        setSaved(cur);
        wrap.classList.toggle('empty', !(s.value||cls.value||room.value));
        if(event?.target === s) colorizeCells();
      }
      [s,cls,room].forEach(el=> el.addEventListener('input', persist));

      // Ø­Ø§Ù„Ø© ÙØ§Ø±Øº/Ù…Ø¹Ø¨Ø£ (ÙŠÙÙŠØ¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)
      wrap.classList.toggle('empty', !(s.value||cls.value||room.value));

      return td;
    }

    /* ============ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ============ */
    function buildTable(){
      const days    = readDays();
      const periods = parseInt(periodsSel.value,10) || 7;
      const startAt = startTime.value || '07:00';
      const slotMin = parseInt(slotMinsSel.value,10) || 50;
      const times   = buildTimes(startAt, slotMin, periods);
      const saved   = getSaved();

      const orient  = orientSel.value; // periods-rows | periods-cols

      // Ø±Ø£Ø³ + Ø¬Ø³Ù…
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      if (orient === 'periods-rows'){
        // Ø§Ù„Ø£ÙˆÙ‚Ø§Øª = ØµÙÙˆÙ (Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ)
        const hr = document.createElement('tr');
        const th0 = document.createElement('th'); th0.className='time-col'; th0.textContent='Ø§Ù„ÙˆÙ‚Øª \\ Ø§Ù„ÙŠÙˆÙ…';
        hr.appendChild(th0);
        days.forEach(d => { const th = document.createElement('th'); th.className='day-col'; th.textContent=d; hr.appendChild(th); });
        thead.appendChild(hr);

        for(let r=0;r<periods;r++){
          const tr = document.createElement('tr');
          const tdTime = document.createElement('td'); tdTime.className='time-col'; tdTime.textContent = times[r] || '';
          tr.appendChild(tdTime);
          for(let c=0;c<days.length;c++){
            tr.appendChild( makeCell(r,c,saved) );
          }
          tbody.appendChild(tr);
        }
      }else{
        // Ø§Ù„Ø£ÙˆÙ‚Ø§Øª = Ø£Ø¹Ù…Ø¯Ø©
        const hr = document.createElement('tr');
        const th0 = document.createElement('th'); th0.className='day-col'; th0.textContent='Ø§Ù„ÙŠÙˆÙ… \\ Ø§Ù„ÙˆÙ‚Øª';
        hr.appendChild(th0);
        times.forEach(t => { const th = document.createElement('th'); th.className='time-col'; th.textContent=t; hr.appendChild(th); });
        thead.appendChild(hr);

        for(let c=0;c<days.length;c++){
          const tr = document.createElement('tr');
          const tdDay = document.createElement('td'); tdDay.className='day-col'; tdDay.textContent = days[c] || '';
          tr.appendChild(tdDay);
          for(let r=0;r<periods;r++){
            tr.appendChild( makeCell(r,c,saved) ); // Ù†ÙØ³ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† (r,c) Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          }
          tbody.appendChild(tr);
        }
      }

      // Ø§Ø³ØªØ¨Ø¯Ø§Ù„
      tbl.innerHTML = '';
      tbl.appendChild(thead);
      tbl.appendChild(tbody);

      // ØªÙ„ÙˆÙŠÙ† ÙˆØ­ÙØ¸ Ù…ÙŠØªØ§Ø¯Ø§ØªØ§
      colorizeCells();
      const meta = saved.__meta || {};
      meta.days    = days;
      meta.periods = periods;
      meta.startAt = startAt;
      meta.slotMin = slotMin;
      meta.orient  = orient;
      meta.colorsOn = !!window.__colorsOn;
      meta.bgTheme  = bgThemeSel.value;
      meta.tblColor = tblColorInp.value;
      saved.__meta  = meta;
      setSaved(saved);
    }

    /* ============ CSV ============ */
    function tableToCsv(){
      const saved = getSaved();
      const m  = saved.__meta || {};
      const days = m.days || readDays();
      const periods = m.periods || parseInt(periodsSel.value,10) || 7;
      const times = buildTimes(m.startAt||startTime.value||'07:00', m.slotMin||parseInt(slotMinsSel.value,10)||50, periods);

      const rows = [['Ø§Ù„ÙŠÙˆÙ…','Ø§Ù„Ø²Ù…Ù†','Ø§Ù„Ù…Ø§Ø¯Ø©','Ø§Ù„ØµÙ/Ø§Ù„ÙØµÙ„','Ø§Ù„Ù‚Ø§Ø¹Ø©']];
      for(let r=0;r<periods;r++){
        for(let c=0;c<days.length;c++){
          const key = `r${r}c${c}`;
          const cell = saved[key] || {};
          rows.push([days[c]||'', times[r]||'', cell.subj||'', cell.class||'', cell.room||'']);
        }
      }
      const bom = '\uFEFF';
      const csv = rows.map(r => r.map(x => `"${String(x||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
      return bom + csv;
    }
    function downloadCsv(){
      const blob = new Blob([tableToCsv()], { type:'text/csv;charset=utf-8;' });
      const url  = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href=url; a.download=`masar-schedule-${stamp}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /* ============ PNG ============ */
    async function saveTableAsPng(){
      try{
        const canvas = await html2canvas(tableWrap, {
          backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg') || null,
          scale: window.devicePixelRatio || 2,
          useCORS: true
        });
        const a = document.createElement('a');
        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.href = canvas.toDataURL('image/png');
        a.download = `masar-schedule-${stamp}.png`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      }catch(e){ console.error(e); if(window.toast) toast('ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©.'); }
    }

    /* ============ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ============ */
    $('#rebuild').addEventListener('click', ()=>{
      if(!confirm('Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
      userDB.remove(DB_KEY);
      buildTable();
      if(window.toast) toast('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ âœ“');
    });

    $('#addRow').addEventListener('click', ()=>{
      periodsSel.value = String((parseInt(periodsSel.value,10) || 7) + 1);
      buildTable();
    });

    // Ø¥Ø¶Ø§ÙØ© ÙŠÙˆÙ…: Ù„Ùˆ 4 Ø£ÙŠÙ‘Ø§Ù… ÙŠØ¨Ø¯Ù‘Ù„ Ø¥Ù„Ù‰ 5Ø› Ù„Ùˆ 5 ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ (Ø¨Ø¯ÙˆÙ† ØªØ®ØµÙŠØµ ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø£ÙŠØ§Ù…)
    $('#addCol').addEventListener('click', ()=>{
      daysSel.value = 'sun-thu';
      buildTable();
    });

    $('#clearAll').addEventListener('click', ()=>{
      if(!confirm('Ù…Ø³Ø­ ÙƒÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ ÙÙ‚Ø·ØŸ')) return;
      const saved = getSaved();
      Object.keys(saved).forEach(k => { if(k.startsWith('r') && k.includes('c')) delete saved[k]; });
      setSaved(saved);
      buildTable();
      if(window.toast) toast('ØªÙ… Ø§Ù„Ù…Ø³Ø­ âœ“');
    });

    $('#print').addEventListener('click', ()=> window.print());
    document.getElementById('exportCsv').addEventListener('click', downloadCsv);
    document.getElementById('savePng').addEventListener('click', saveTableAsPng);

    document.getElementById('toggleColors').addEventListener('click', ()=>{
      window.__colorsOn = !window.__colorsOn;
      document.getElementById('toggleColors').textContent = window.__colorsOn ? 'Ø¥ÙŠÙ‚Ø§Ù ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯' : 'ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯';
      const saved = getSaved();
      saved.__meta = saved.__meta || {};
      saved.__meta.colorsOn = !!window.__colorsOn;
      setSaved(saved);
      colorizeCells();
    });

    orientSel.addEventListener('change', buildTable);

    // Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙØ­Ø©
    function applyBg(theme){
      document.body.classList.remove('bg-flowers','bg-leaves');
      if(theme==='flowers') document.body.classList.add('bg-flowers');
      else if(theme==='leaves') document.body.classList.add('bg-leaves');
    }
    bgThemeSel.addEventListener('change', ()=>{
      applyBg(bgThemeSel.value);
      const saved=getSaved(); saved.__meta=saved.__meta||{}; saved.__meta.bgTheme=bgThemeSel.value; setSaved(saved);
    });

    // Ù„ÙˆÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function applyTableColor(hex){ document.documentElement.style.setProperty('--table-accent', hex||'#8b5cf6'); }
    tblColorInp.addEventListener('input', ()=>{
      applyTableColor(tblColorInp.value);
      const saved=getSaved(); saved.__meta=saved.__meta||{}; saved.__meta.tblColor=tblColorInp.value; setSaved(saved);
    });

    // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ Ù…Ø±Ø©
    document.addEventListener('DOMContentLoaded', ()=>{
      const saved = getSaved();
      const m = saved.__meta || {};

      startTime.value  = m.startAt || '07:00';
      slotMinsSel.value= String(m.slotMin || 50);
      periodsSel.value = String(m.periods || 7);
      orientSel.value  = m.orient || 'periods-rows';
      bgThemeSel.value = m.bgTheme || 'none';
      tblColorInp.value= m.tblColor || '#8b5cf6';
      applyBg(bgThemeSel.value);
      applyTableColor(tblColorInp.value);

      // Ø§Ù„Ø£ÙŠÙ‘Ø§Ù… Ù…Ù† Ø§Ù„Ù…ÙŠØªØ§Ø¯Ø§ØªØ§ ÙˆØ¥Ù„Ø§ Ù…Ù† Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
      if(Array.isArray(m.days) && m.days.length===4) daysSel.value='sun-wed';
      else daysSel.value='sun-thu';

      window.__colorsOn = (m.colorsOn!==undefined) ? !!m.colorsOn : true;
      document.getElementById('toggleColors').textContent = window.__colorsOn ? 'Ø¥ÙŠÙ‚Ø§Ù ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯' : 'ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯';

      buildTable();
    });
  })();
  </script>
</body>
</html>
